# ç»˜åˆ¶

[TOC]

## æ¦‚è¿°

ç»˜åˆ¶çš„å››å¤§è¦ç´ 

| ç±»æ¯” |   ç±»å‹   | å«ä¹‰ |
| :--: | :------: | :--: |
|  çº¸  | `Canvas` | ç”»å¸ƒ |
|  ç¬”  | `Paint`  | ç”»ç¬” |
|  å½¢  |  `Path`  | è·¯å¾„ |
|  è‰²  | `Color`  | é¢œè‰² |

## CustomPaint

åœ¨Flutterä¸­ï¼Œæä¾›äº†ä¸€ä¸ª`CustomPaint` ç»„ä»¶ï¼Œå®ƒå¯ä»¥ç»“åˆç”»ç¬”`CustomPainter`æ¥å®ç°è‡ªå®šä¹‰å›¾å½¢ç»˜åˆ¶ã€‚å…¶ä¸­ï¼Œ`CustomPaint`çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š

~~~dart
CustomPaint({
  Key key,
  this.painter, 
  this.foregroundPainter,
  this.size = Size.zero, 
  this.isComplex = false, 
  this.willChange = false, 
  Widget child, //å­èŠ‚ç‚¹ï¼Œå¯ä»¥ä¸ºç©º
})
~~~

- `painter`: èƒŒæ™¯ç”»ç¬”ï¼Œä¼šæ˜¾ç¤ºåœ¨å­èŠ‚ç‚¹åé¢;
- `foregroundPainter`: å‰æ™¯ç”»ç¬”ï¼Œä¼šæ˜¾ç¤ºåœ¨å­èŠ‚ç‚¹å‰é¢
- `size`ï¼šå½“`child`ä¸ºnullæ—¶ï¼Œç”»å¸ƒå°ºå¯¸ä¸º`size`å±æ€§æ‰€è®¾ç½®çš„æ•°å€¼ã€‚å¦‚æœæœ‰`child`åˆ™å¿½ç•¥æ­¤å‚æ•°ï¼Œç”»å¸ƒå°ºå¯¸ä¸º`child`å°ºå¯¸ã€‚
- `isComplex`ï¼šå¦‚æœä¸º`true`ï¼ŒFlutterä¼šåº”ç”¨ä¸€äº›ç¼“å­˜ç­–ç•¥æ¥å‡å°‘é‡å¤æ¸²æŸ“çš„å¼€é”€ã€‚
- `willChange`ï¼šå’Œ`isComplex`é…åˆä½¿ç”¨ï¼Œå½“å¯ç”¨ç¼“å­˜æ—¶ï¼Œè¯¥å±æ€§ä»£è¡¨åœ¨ä¸‹ä¸€å¸§ä¸­ç»˜åˆ¶æ˜¯å¦ä¼šæ”¹å˜ã€‚ 

å…¶ä¸­ï¼Œæ— éœ€è®¾ç½®`isComplex`ä¸`willChange`å±æ€§ï¼Œè®©`Flutter`å¼•æ“æ¥è‡ªä¸»å†³å®šæ˜¯å¦å¯¹`CustomPaint`è¿›è¡Œç¼“å­˜ä¼˜åŒ–ã€‚



ä¸€èˆ¬`painter`å‚æ•°æ¥æ”¶ä¸€ä¸ª`CustomPainter`ç±»å‹çš„å¯¹è±¡.

~~~dart
CustomPaint( 
	painter: PaperPainter(),
),
~~~

~~~dart
class PaperPainter extends CustomPainter {
  @override
  void paint(Canvas canvas, Size size) {
    final Paint paint = Paint();					// åˆ›å»ºç”»ç¬”
    canvas.drawCircle(Offset(100, 100), 10, paint);	// ç»˜åˆ¶åœ†
  }
    
  @override
  bool shouldRepaint(CustomPainter oldDelegate) => false;
}
~~~



ç»˜åˆ¶æ˜¯æ¯”è¾ƒæ˜‚è´µçš„æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å®ç°è‡ªç»˜æ§ä»¶æ—¶åº”è¯¥è€ƒè™‘åˆ°æ€§èƒ½å¼€é”€ï¼Œä¸‹é¢æ˜¯ä¸¤æ¡å…³äºæ€§èƒ½ä¼˜åŒ–çš„å»ºè®®ï¼š

- å°½å¯èƒ½çš„åˆ©ç”¨å¥½`shouldRepaint`è¿”å›å€¼ï¼›åœ¨UIæ ‘é‡æ–°buildæ—¶ï¼Œæ§ä»¶åœ¨ç»˜åˆ¶å‰éƒ½ä¼šå…ˆè°ƒç”¨è¯¥æ–¹æ³•ä»¥ç¡®å®šæ˜¯å¦æœ‰å¿…è¦é‡ç»˜ï¼›
- ç»˜åˆ¶å°½å¯èƒ½å¤šçš„åˆ†å±‚ã€‚
- ä½¿ç”¨`RepaintBoundary`æ§ä»¶



`CustomPainter` çš„æœ¬èº«æ˜¯ä¸€ä¸ª`Listenable` å­ç±»ï¼Œå¯ä»¥ä¼ å…¥ä¸€ä¸ª`Listenable`å¯¹è±¡, è¿™ä¸ªå¯¹è±¡è¿›è¡Œæ›´æ–°æ—¶ï¼Œä¼šè§¦å‘é€šçŸ¥è®© `CustomPainter` è¿›è¡Œé‡ç»˜ã€‚å°±ä¸éœ€è¦ä½¿ç”¨ç»„ä»¶çŠ¶æ€çš„ `setState` æ¥å®Œæˆç”»å¸ƒçš„åˆ·æ–°ã€‚ 

åœ¨`CustomPainter`å’ŒåŠ¨ç”»/`ValueListenable`æ­é…ä½¿ç”¨æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ã€‚

~~~dart
class Painter extends CustomPainter {
    
  // å®šä¹‰æˆå‘˜å˜é‡
  final Animation<double> angle; 

  // ä¼ å…¥ Listenable å¯ç›‘å¬å¯¹è±¡
  Painter(): super(repaint: angle); 

  
    void _draw(Canvas canvas, Size size) {
        // ä½¿ç”¨åŠ¨ç”»å™¨çš„å€¼
      	var a = angle.value / 180 * pi; 
       	// ...
    }
}
~~~

æ³¨ï¼šä½¿ç”¨ `Listenable.merge`å¯ä»¥åˆå¹¶å¤šä¸ªå¯ç›‘å¬å¯¹è±¡

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰`Listenable`ï¼š

~~~dart
class StampData extends ChangeNotifier {
  final List<Point> stamps = [];

  final Paint _paint = Paint();

  void clear() {
    stamps.clear();
    notifyListeners();
  }
}
~~~

å…¶ä¸­ï¼Œæœ€å…³é”®çš„æ–¹æ³•æ˜¯`notifyListeners()`ï¼Œç”¨äºé€šçŸ¥ç›‘å¬è€…ã€‚

## Canvas

Canvas çš„æ–¹æ³•å¦‚ä¸‹ï¼š

~~~dart
---->[ç”»å¸ƒçŠ¶æ€]----
void save()
void saveLayer(Rect bounds, Paint paint)
void restore()
int getSaveCount()

---->[ç”»å¸ƒå˜æ¢]----
void skew(double sx, double sy)
void rotate(double radians)
void scale(double sx, [double sy])
void translate(double dx, double dy)
void transform(Float64List matrix4)

---->[ç”»å¸ƒè£å‰ª]----
void clipRect(Rect rect, { ClipOp clipOp = ClipOp.intersect, bool doAntiAlias = true })
void clipRRect(RRect rrect, {bool doAntiAlias = true}) 
void clipPath(Path path, {bool doAntiAlias = true})

---->[ç”»å¸ƒç»˜åˆ¶--ç‚¹ç›¸å…³]----
void drawPoints(PointMode pointMode, List<Offset> points, Paint paint)
void drawRawPoints(PointMode pointMode, Float32List points, Paint paint)
void drawLine(Offset p1, Offset p2, Paint paint)
void drawVertices(Vertices vertices, BlendMode blendMode, Paint paint)

---->[ç”»å¸ƒç»˜åˆ¶--çŸ©å½¢ç›¸å…³]----
void drawRect(Rect rect, Paint paint)
void drawRRect(RRect rrect, Paint paint)
void drawDRRect(RRect outer, RRect inner, Paint paint)
  
---->[ç”»å¸ƒç»˜åˆ¶--ç±»åœ†ç›¸å…³]----
void drawOval(Rect rect, Paint paint)
void drawCircle(Offset c, double radius, Paint paint)
void drawArc(Rect rect, double startAngle, double sweepAngle, bool useCenter, Paint paint)

---->[ç”»å¸ƒç»˜åˆ¶--å›¾ç‰‡ç›¸å…³]----
void drawImage(Image image, Offset p, Paint paint)
void drawImageRect(Image image, Rect src, Rect dst, Paint paint)
void drawImageNine(Image image, Rect center, Rect dst, Paint paint)
void drawAtlas(Image atlas,List<RSTransform> transforms,List<Rect> rects,List<Color> colors,BlendMode blendMode,Rect cullRect,Paint paint)
void drawRawAtlas(Image atlas,Float32List rstTransforms,Float32List rects,Int32List colors,BlendMode blendMode,Rect cullRect,Paint paint)
  
---->[ç”»å¸ƒç»˜åˆ¶--æ–‡å­—]----
void drawParagraph(Paragraph paragraph, Offset offset)
  
---->[ç”»å¸ƒç»˜åˆ¶--å…¶ä»–]----
void drawColor(Color color, BlendMode blendMode)
void drawPath(Path path, Paint paint)
void drawPaint(Paint paint)
void drawShadow(Path path, Color color, double elevation, bool transparentOccluder)
void drawPicture(Picture picture)
~~~



### ç”»å¸ƒçš„å˜æ¢

åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼ˆä¾‹å¦‚ï¼Œé‡å¤ç”»é—´éš”ç›¸åŒçš„æ¨ªçº¿ã€æ—‹è½¬çš„å›¾å½¢ï¼‰ï¼Œé€šè¿‡ç”»å¸ƒçš„å˜æ¢å¯ä»¥è®©ç»˜åˆ¶çš„é€»è¾‘æ›´åŠ æ¸…æ™°ç®€å•ã€‚

å½“ä½¿ç”¨ `canvas.save()` æ—¶ï¼Œå½“å‰ç”»å¸ƒçš„çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œå˜æ¢çš„ä¿¡æ¯ï¼‰å°±ä¼šè¢«ä¿å­˜ã€‚å½“æ‰§è¡Œ `canvas.restore()` æ—¶ï¼Œç”»å¸ƒå°±ä¼šå›åˆ°ä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€ã€‚





ç”»å¸ƒçš„åæ ‡åŸç‚¹é»˜è®¤åœ¨å·¦ä¸Šè§’å¤„ï¼Œæˆ‘ä»¬å¯ä»¥å°†åæ ‡ç³»çš„åŸç‚¹ç§»åŠ¨åˆ°æ§ä»¶çš„ä¸­å¿ƒï¼Œè¿™æ ·æ–¹ä¾¿å®šä½ã€‚

~~~dart
canvas.translate(size.width / 2, size.height / 2);
~~~

Add a translation to the **current transform**, shifting the coordinate space horizontally by the first argument and vertically by the second argument. ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œçš„å‚æ•°æ˜¯ç›¸å¯¹åç§»é‡ï¼Œè€Œä¸æ˜¯ç»å¯¹å®šä½é‡ã€‚



å¦‚æœæƒ³è¦ç»˜åˆ¶å¯¹ç§°å›¾å½¢ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨`scale()`:

- `canvas.scale(1, -1)` ç»˜åˆ¶åŸå›¾å½¢å…³äºxè½´å¯¹ç§°çš„å›¾å½¢ï¼ˆä¸åŒ…æ‹¬åŸå›¾å½¢ï¼‰
- `canvas.scale(-1, 1)` å…³äºyè½´å¯¹ç§°ï¼ˆåŒä¸Šï¼‰
- `canvas.scale(-1, -1)`å…³äºåŸç‚¹å¯¹ç§°ï¼ˆåŒä¸Šï¼‰

ä½¿ç”¨ç”¨ä¾‹ï¼š
~~~kotlin
_drawBottomRight(canvas, size);

canvas.save();	     				// è®°å¾—ä¿å­˜çŠ¶æ€
canvas.scale(1, -1); 				// æ²¿xè½´é•œåƒ
_drawBottomRight(canvas, size);
canvas.restore();

canvas.save();
canvas.scale(-1, 1); //æ²¿yè½´é•œåƒ
_drawBottomRight(canvas, size);
canvas.restore();

canvas.save();
canvas.scale(-1, -1); //æ²¿åŸç‚¹é•œåƒ
_drawBottomRight(canvas, size);
canvas.restore();
~~~



### åŸºç¡€å›¾å½¢çš„ç»˜åˆ¶

é€šè¿‡`drawPoints()`æ¥ç»˜åˆ¶ç‚¹æˆ–è€…çº¿æ®µï¼š

- `PointMode.points`

  ![PointMode.points](assets/67003dd9005c458c905ccaad39a95245tplv-k3u1fbpfcp-jj-mark1512000q75.webp)

- `PointMode.lines`ï¼šå¦‚æœç‚¹çš„ä¸ªæ•°æ˜¯å¥‡æ•°ä¸ªï¼Œé‚£ä¹ˆæœ€åä¸€ä¸ªç‚¹ä¼šè¢«å¿½ç•¥æ‰

  ![PointMode.lines](assets/16914d013347457aa003c58eb9a5887ctplv-k3u1fbpfcp-jj-mark1512000q75.webp)

- `PointMode.polygon`

  ![PointMode.polygon](assets/e65e7fbebc28487784f07054dfc707f4tplv-k3u1fbpfcp-jj-mark1512000q75.webp)

`drawRawPoints()`ä¸`drawPoints()`ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒçš„æ•°æ®é›†ä¸æ˜¯`List<Offset>`ï¼Œè€Œæ˜¯`Float32List`





é€šè¿‡`drawLine`ä¹Ÿå¯ä»¥ç”¨äºç»˜åˆ¶çº¿æ®µ



æœ‰å…³çŸ©å½¢çš„ç»˜åˆ¶ï¼š

- `drawRect`æ¥ç»˜åˆ¶çŸ©å½¢ï¼š

  ~~~dart
  void _drawRect(Canvas canvas){
    var _paint = Paint()
        ..color = Colors.blue
        ..strokeWidth = 1.5;
      
    //çŸ©å½¢ä¸­å¿ƒæ„é€ 
    Rect rectFromCenter = Rect.fromCenter(center: Offset(0, 0),width: 160,height: 160);
    canvas.drawRect(rectFromCenter, _paint);
      
    //çŸ©å½¢å·¦ä¸Šå³ä¸‹æ„é€ 
    Rect rectFromLTRB = Rect.fromLTRB(-120, -120, -80, -80);
    canvas.drawRect(rectFromLTRB, _paint..color=Colors.red);
      
    //çŸ©å½¢å·¦ä¸Šå®½é«˜æ„é€ 
    Rect rectFromLTWH = Rect.fromLTWH(80, -120, 40, 40);
    canvas.drawRect(rectFromLTWH, _paint..color=Colors.orange);
      
    //çŸ©å½¢å†…åˆ‡åœ†æ„é€ 
    Rect rectFromCircle = Rect.fromCircle(center: Offset(100, 100),radius: 20);
    canvas.drawRect(rectFromCircle, _paint..color=Colors.green);
      
    //çŸ©å½¢ä¸¤ç‚¹æ„é€ 
    Rect rectFromPoints= Rect.fromPoints(Offset(-120 , 80),Offset(-80 , 120));
    canvas.drawRect(rectFromPoints, _paint..color=Colors.purple);
  }
  ~~~

- `drawRRect`ç»˜åˆ¶åœ†è§’çŸ©å½¢ï¼š

  ~~~dart
    void _drawRRect(Canvas canvas) {
      var _paint = Paint()
        ..color = Colors.blue
        ..strokeWidth = 1.5;
  
      //åœ†è§’çŸ©å½¢fromRectXYæ„é€ 
      Rect rectFromCenter =
          Rect.fromCenter(center: Offset(0, 0), width: 160, height: 160);
      canvas.drawRRect(
        RRect.fromRectXY(rectFromCenter, 40, 20),
        _paint,
      );
  
      //åœ†è§’çŸ©å½¢fromLTRBXYæ„é€ 
      canvas.drawRRect(
        RRect.fromLTRBXY(-120, -120, -80, -80, 10, 10),
        _paint..color = Colors.red,
      );
  
      // åœ†è§’çŸ©å½¢fromLTRBRæ„é€ 
      canvas.drawRRect(
        RRect.fromLTRBR(80, -120, 120, -80, Radius.circular(10)),
        _paint..color = Colors.orange,
      );
  
      //åœ†è§’çŸ©å½¢fromLTRBAndCornersæ„é€ 
      canvas.drawRRect(
        RRect.fromLTRBAndCorners(
          80,
          80,
          120,
          120,
          bottomRight: Radius.elliptical(10, 10),
        ),
        _paint..color = Colors.green,
      );
  
      //çŸ©å½¢ä¸¤ç‚¹æ„é€ 
      Rect rectFromPoints = Rect.fromPoints(Offset(-120, 80), Offset(-80, 120));
      canvas.drawRRect(
        RRect.fromRectAndCorners(
          rectFromPoints,
          bottomLeft: Radius.elliptical(10, 10),
        ),
        _paint..color = Colors.purple,
      );
    }
  ~~~

  

- `drawDRRect`ç»˜åˆ¶ä¸¤ä¸ªåœ†è§’çŸ©å½¢çš„å·®åŸŸï¼š

  ~~~dart
  Rect outRect =
      Rect.fromCenter(center: Offset(0, 0), width: 160, height: 160);
  Rect inRect =
      Rect.fromCenter(center: Offset(0, 0), width: 100, height: 100);
  
  canvas.drawDRRect(RRect.fromRectXY(outRect, 20, 20),
      RRect.fromRectXY(inRect, 20, 20), _paint);
  ~~~



ç»˜åˆ¶ç±»åœ†ï¼š

- `drawCircle`ç»˜åˆ¶åœ†

  ~~~dart
  canvas.drawCircle(Offset(0, 0), 60, _paint);
  ~~~

- `drawOval`ç»˜åˆ¶æ¤­åœ†

  ~~~dart
  var rect = Rect.fromCenter(center: Offset(0, 0), height: 100, width: 120);
  canvas.drawOval(rect, _paint);
  ~~~

- `drawArc`ç»˜åˆ¶åœ†å¼§

  ~~~dart
  //drawArc(çŸ©å½¢åŒºåŸŸ, èµ·å§‹å¼§åº¦, æ‰«æå¼§åº¦, æ˜¯å¦è¿ä¸­å¿ƒ, ç”»ç¬”)
  canvas.drawArc(rect, 0, pi / 2 * 3, true, _paint);
  ~~~

  ![image-20231212120105697](assets/image-20231212120105697.png)

### å…¶ä»–çš„ç»˜åˆ¶

ä½¿ç”¨`drawShadow()`æ¥ç»˜åˆ¶é˜´å½±

| å‚æ•°                | ç±»å‹   | è¯´æ˜                               |
| ------------------- | ------ | ---------------------------------- |
| path                | Path   | ç»˜åˆ¶é˜´å½±çš„è·¯å¾„                     |
| color               | Color  | é˜´å½±çš„é¢œè‰²                         |
| elevation           | double | é˜´å½±é«˜åº¦                           |
| transparentOccluder | bool   | æ˜¯å¦é€æ˜å°å µå™¨ã€‚é€šå¸¸éœ€è¦è®¾ç½®ä¸ºtrue |

`transparentOccluder`çš„æ•ˆæœ

| true                                                         | false                                                        |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![image-20231212120534535](assets/image-20231212120534535.png) | ![image-20231212120548776](assets/image-20231212120548776.png) |



`drawColor`å¯ä»¥ç†è§£ä¸ºç»™ç”»å¸ƒæ·»åŠ ä¸€å±‚æ»¤é•œï¼Œè€Œ`drawPaint`ç»™ç”»ç¬”æ·»åŠ ä¸€å±‚æ»¤é•œã€‚æš‚ä¸ä»‹ç»

~~~dart
canvas.drawColor(Colors.blue, BlendMode.lighten);

_paint.shader = ui.Gradient.linear(
    Offset(0, 0), 
    Offset(size.width, 0), 
    colors, 
    pos, 
    TileMode.clamp
);
_paint.blendMode = BlendMode.lighten;
canvas.drawPaint(_paint);
~~~



### è£å‰ª

`void clipRect(Rect rect, { ClipOp clipOp = ClipOp.intersect, bool doAntiAlias = true });`ï¼š

- `doAntiAlias`ï¼šæ˜¯å¦åº”ç”¨æŠ—é”¯é½¿
- `clipOp`
  - `ClipOp.intersect`è£å†…éƒ¨
  - `ClipOp.difference` è£å¤–éƒ¨
- rectï¼šè£å‰ªçš„åŒºåŸŸ

ä¸€ä¸ªç”»å¸ƒåœ¨è£å‰ªåï¼Œä»…ä¿ç•™è£å‰ªåŒºåŸŸå†…ï¼ˆ`ClipOp.intersect`ï¼‰çš„å†…å®¹ã€‚ å¯é€šè¿‡`save/restore`æ¥ä¿å­˜/æ¢å¤çŠ¶æ€ã€‚

### å›¾ç‰‡

ä»assetsä¸­è·å–å›¾ç‰‡æ•°æ®

~~~dart
import 'dart:ui' as ui show Codec, FrameInfo, Image;

//è¯»å– assets ä¸­çš„å›¾ç‰‡
Future<ui.Image>? loadImageFromAssets(String path) async {
  // è¯»å–æ–‡ä»¶æ•°æ® è¿™é‡Œpath = assets/images
  ByteData data = await rootBundle.load(path); 
    
  //å°†å­—èŠ‚æµè½¬æ¢ä¸ºui.Imageå¯¹è±¡
  return decodeImageFromList(data.buffer.asUint8List());
}
~~~

`canvas#drawImage`æ¥æ”¶ä¸€ä¸ª`ui.Image`å¯¹è±¡ï¼Œå¹¶å¿ å®åœ°æŒ‰ç…§åˆ†è¾¨ç‡å°†å…¶ç»˜åˆ¶å‡ºæ¥ã€‚æ­¤å¤–ï¼Œè¿˜éœ€è¦æŒ‡å®šå›¾ç‰‡å·¦ä¸Šè§’ç›¸å¯¹äºåŸç‚¹çš„åç§»é‡`Offset`ï¼Œä»¥åŠç”»ç¬”`Paint`ã€‚

~~~dart
canvas.drawImage(image!, Offset(-image!.width / 2, -image!.height / 2), _paint);
~~~



`drawImageRect`å¯ä»¥å°†å›¾ç‰‡çš„æŸä¸€å—çŸ©å½¢åŒºåŸŸï¼ˆsrcï¼‰æ˜ å°„åˆ°ç”»å¸ƒä¸Šçš„ä¸€å—çŸ©å½¢åŒºåŸŸï¼ˆdstï¼‰ï¼Œæ­¤æ—¶å›¾ç‰‡å¯èƒ½å¤±çœŸã€‚

~~~dart
canvas.drawImageRect(
    image!,
    Rect.fromCenter(
    	center: Offset(image!.width / 2, image!.height / 2),
    	width: image!.width.toDouble(),
    	height: image!.height.toDouble()),
    Rect.fromLTRB(-100, 0, 100, 300),
    _paint
);
~~~



`drawImageNine`ä»…å¯¹å›¾ç‰‡çš„æŒ‡å®šåŒºåŸŸï¼ˆCenterï¼‰è¿›è¡Œç¼©æ”¾ã€‚å…·ä½“æ¥è¯´å°±æ˜¯ï¼Œé€šè¿‡ç»˜åˆ¶ä¸¤æ¡æ°´å¹³çº¿å’Œä¸¤æ¡å‚ç›´çº¿å°†å›¾åƒåˆ†å‰²æˆ9ä¸ªéƒ¨åˆ†ï¼Œå…¶ä¸­åªæœ‰ä¸­é—´éƒ¨åˆ†æ˜¯å¯ä»¥ç¼©æ”¾çš„ï¼Œå…¶ä½™8ä¸ªéƒ¨åˆ†æŒ‰åŸå¤§å°è¿›è¡Œç»˜åˆ¶ã€‚è€Œè¿™ä¸ªä¸­é—´éƒ¨åˆ†é€šè¿‡çŸ©å½¢æ¥æŒ‡å®šçš„ï¼Œè¿™ä¸ªçŸ©å½¢çš„åæ ‡ç³»åŸç‚¹æ˜¯å›¾ç‰‡çš„å·¦ä¸Šè§’

![drawImageNine.png](assets/4f3a55a2c7d346b2896ced5b95d0e94dtplv-k3u1fbpfcp-zoom-in-crop-mark1512000.webp)

~~~dart
 canvas.drawImageNine(
    image!,
    Rect.fromCenter(center: Offset(image!.width/2, image!.height-6.0),
        width: image!.width-20.0, height: 2.0),
    Rect.fromCenter(center: Offset(0, 0,), width:300, height: 120),
    _paint
 );
~~~



`drawAtlas`å¯ä»¥åœ¨ç”»å¸ƒä¸Šç»˜åˆ¶å›¾ç‰‡ä¸Šçš„å¤šä¸ªéƒ¨åˆ†ã€‚

ç”±äºç½‘ç»œèµ„æºçš„ç‰¹æ€§ï¼Œåç«¯ç»å¸¸æŠŠå¤šä¸ªå›¾ç‰‡æ‹¼åˆåœ¨ä¸€èµ·ï¼ˆç²¾çµå›¾ï¼Œ`sprite`ï¼‰ï¼Œç„¶åå†è¿›è¡Œä¼ è¾“ã€‚åŒæ—¶è¿˜ä¼ è¾“è¿™äº›å›¾ç‰‡çš„åç§»ä¿¡æ¯ï¼Œä»¥ä¾¿äºå‰ç«¯èƒ½å¤Ÿæ ¹æ®è¿™äº›ä¿¡æ¯åˆ†å‰²å›¾ç‰‡ï¼Œä»¥è·å–æ‰€éœ€çš„å›¾ç‰‡ã€‚`drawAtlas`æ­£å¥½åˆ‡åˆäº†åˆ†å‰²å›¾ç‰‡çš„éœ€æ±‚

![image-20231212131847000](assets/image-20231212131847000.png)

~~~dart
canvas.drawAtlas(image!, transforms, rects, null, null, null, _paint);
~~~

å®ƒéœ€è¦ä¸ƒä¸ªå±æ€§ï¼š

- `Image atlas`ï¼šui.Imageå›¾ç‰‡å¯¹è±¡

- `List<RSTransform> transforms`ï¼šå°†å‰ªåˆ‡å‡ºæ¥çš„å›¾ç‰‡åº”ç”¨å¯¹åº”çš„å˜æ¢æ•ˆæœã€‚

- `List<Rect> rects`ï¼šçŸ©å½¢æ•°ç»„ï¼Œç”¨æ¥ç¡®è®¤è£å‰ªå›¾ç‰‡çš„ä½ç½®å’Œå¤§å°ï¼ˆç›¸å¯¹äºç²¾çµå›¾çš„å·¦ä¸Šè§’ï¼‰

- `List<Color>? colors`ï¼šæ··åˆæ¨¡å¼æ—¶ä½¿ç”¨çš„é¢œè‰²æ•°ç»„

- `BlendMode? blendMode`ï¼šæ··åˆæ¨¡å¼

- `Rect? cullRect`

- `Paint paint`ï¼šç»˜åˆ¶çš„ç”»ç¬”ï¼Œå¯ä»¥ç»™å›¾ç‰‡æ·»åŠ å…¶ä»–å±æ€§



`RSTransform`å¯¹è±¡æœ‰ä»¥ä¸‹å±æ€§ï¼ˆé»˜è®¤æ—‹è½¬ç‚¹ä¸º(0,0)ï¼Œä¸”åŸç‚¹ä¸ºå›¾ç‰‡çš„å·¦ä¸Šè§’ï¼‰ï¼š

- `double scos`ï¼š

- `double ssin`ï¼š

- `double tx`ï¼š

- `double ty`ï¼š

  

å®ƒè¿˜æœ‰ä¸€ä¸ª`fromComponents`æ–¹æ³•æœ€ç®€å•å®ç°å˜å½¢çš„æ–¹æ³•ï¼š

```dart
factory RSTransform.fromComponents({
    double rotation,
    double scale,
    double anchorX,			//æ—‹è½¬ç‚¹
    double anchorY,			//æ—‹è½¬ç‚¹
    double translateX,		//åç§»é‡
    double translateY		//åç§»é‡
  }) {
    final double scos = math.cos(rotation) * scale;
    final double ssin = math.sin(rotation) * scale;
    final double tx = translateX + -scos * anchorX + ssin * anchorY;
    final double ty = translateY + -ssin * anchorX - scos * anchorY;
    return RSTransform(scos, ssin, tx, ty);
  }
```

  



### æ–‡å­—

ç»˜åˆ¶æ–‡å­—çš„ä¸¤ä¸ªæ–¹æ³•

- `void drawParagraph(Paragraph, Offset)`

  ~~~dart
  // å­—ä½“å±æ€§
  var builder = ui.ParagraphBuilder(ui.ParagraphStyle(
    textAlign: TextAlign.center,
    fontSize: 40,
    textDirection: TextDirection.ltr,
    maxLines: 1,
  ));
  
  // å­—ä½“æ ·å¼
  builder.pushStyle(ui.TextStyle(
    color: Colors.black87,
    textBaseline: ui.TextBaseline.alphabetic,
  ));
  
  // å­—ä½“å†…å®¹
  builder.addText("Flutter Unit");
  
  ui.Paragraph paragraph = builder.build();
  // å­—ä½“å¸ƒå±€
  paragraph.layout(ui.ParagraphConstraints(width: 300));
  canvas.drawParagraph(paragraph, Offset(0, 0));
  ~~~

  

- `TextPainter#paint(Canvas, Offset)`ã€‚å®ƒå¯¹`drawParagraph`è¿›è¡Œäº†å°è£…

  ~~~dart
  var textPainter = TextPainter(
    text: TextSpan(
      text: 'Flutter Unit',
      style: TextStyle(fontSize: 40, color: Colors.black),
    ),
    textAlign: TextAlign.center,
    textDirection: TextDirection.ltr,
  );
  textPainter.layout(maxWidth: 280); // è¿›è¡Œå¸ƒå±€
  textPainter.paint(canvas, Offset.zero); // è¿›è¡Œç»˜åˆ¶
  ~~~

  åœ¨å¸ƒå±€å®Œæˆåï¼Œ`TextPainter`å¯ä»¥é€šè¿‡`size`å±æ€§è·å–æ–‡å­—æ‰€å çš„åŒºåŸŸ

  ~~~dart
  Size size = textPainter.size; // å°ºå¯¸å¿…é¡»åœ¨å¸ƒå±€åè·å–
  ~~~

  



## Paint

Paintçš„åˆ›å»ºä¸åˆå§‹åŒ–ï¼š

~~~dart
var paint = Paint() //åˆ›å»ºä¸€ä¸ªç”»ç¬”å¹¶é…ç½®å…¶å±æ€§
  ..isAntiAlias = true //æ˜¯å¦æŠ—é”¯é½¿
  ..style = PaintingStyle.fill //ç”»ç¬”æ ·å¼ï¼šå¡«å……
  ..color=Color(0x77cdb175);//ç”»ç¬”é¢œè‰²
~~~

Paintçš„å±æ€§ä¸€è§ˆï¼š

| å±æ€§             | ä»‹ç»       | ç±»å‹          | é»˜è®¤å€¼             |
| ---------------- | ---------- | ------------- | ------------------ |
| isAntiAlias      | æ˜¯å¦æŠ—é”¯é½¿ | bool          | true               |
| style            | ç”»ç¬”ç±»å‹   | PaintingStyle | PaintingStyle.fill |
| color            | ç”»ç¬”é¢œè‰²   | Color         | Color(0xff000000)  |
| strokeWidth      | çº¿å®½       | double        | 0.0                |
| strokeCap        | çº¿å¸½ç±»å‹   | StrokeCap     | StrokeCap.butt     |
| strokeJoin       | çº¿æ¥ç±»å‹   | StrokeJoin    | StrokeJoin.miter   |
| strokeMiterLimit | æ–œæ¥é™åˆ¶   | double        | 0.0                |
| shader           | ç€è‰²å™¨     | Shader        | null               |
| blendMode        | æ··åˆæ¨¡å¼   | BlendMode     | BlendMode.srcOver  |
| invertColors     | æ˜¯å¦åè‰²   | bool          | false              |
| colorFilter      | é¢œè‰²æ»¤é•œ   | Shader        | null               |
| maskFilter       | é®ç½©æ»¤é•œ   | MaskFilter    | null               |
| imageFilter      | å›¾ç‰‡æ»¤é•œ   | ImageFilter   | null               |
| filterQuality    | æ»¤é•œè´¨é‡   | FilterQuality | FilterQuality.none |

ä¸‹é¢æˆ‘ä»¬ä»‹ç»éƒ¨åˆ†å±æ€§ï¼š

æŠ—é”¯é½¿æ˜¯ä»¥æ€§èƒ½ä¸ºä»£ä»·æå‡å›¾å½¢ç»˜åˆ¶ç²¾ç»†ç¨‹åº¦çš„æŠ€æœ¯ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè‹¥å›¾å½¢ä¸­çš„æ›²çº¿è¾ƒå¤šï¼Œåˆ™è€ƒè™‘å¼€å¯æŠ—é”¯é½¿ã€‚

ç”»ç¬”çš„ç±»å‹æœ‰

- `PaintingStyle.fill`ï¼šå¡«å……ï¼ˆç›¸å½“äºç”»æ¡¶ğŸ›¢ï¼‰
- `PaintingStyle.stroke`ï¼šçº¿æ¡ï¼ˆçœŸæ­£æ„ä¹‰ä¸Šçš„ç”»ç¬”ğŸ–Šï¼‰

åªæœ‰ç”»ç¬”æ˜¯ `stroke` ç±»å‹æ—¶ï¼Œçº¿å®½æ‰ä¼šèµ·ä½œç”¨ã€‚



çº¿å¸½çš„ç±»å‹æœ‰ï¼š

- `StrokeCap.butt` - ä¸å‡ºå¤´
- `StrokeCap.round` - åœ†å¤´
- `StrokeCap.square` - æ–¹å¤´

![img](assets/09306c08bf9d488583aa582ef2a71a16tplv-k3u1fbpfcp-jj-mark1512000q75.webp)

![img](assets/d62bc1df454e40aabd11965fec2bf2a3tplv-k3u1fbpfcp-jj-mark1512000q75.webp)



çº¿æ¥çš„ç±»å‹æœ‰ï¼š

- `StrokeJoin.bevel`\- æ–œè§’
- `StrokeJoin.miter`- é”è§’
- `StrokeJoin.round`\- åœ†è§’

![img](assets/a003a338a19047e4965d8c530a409042tplv-k3u1fbpfcp-jj-mark1512000q75.webp)



å½“çº¿æ¥çš„ç±»å‹ä¸ºé”è§’ï¼ˆ`StrokeJoin.miter`ï¼‰æ—¶ï¼ŒstrokeMiterLimitæ‰ä¼šèµ·ä½œç”¨ã€‚å®ƒçš„å€¼è¶Šå¤§ï¼Œé”è§’å°±è¶Šå°–ã€‚ï¼ˆç¬¬ä¸€è¡Œ`strokeMiterLimit` = 2; ç¬¬äºŒè¡Œ`strokeMiterLimit` = 3;ï¼‰

![img](assets/a20df8bfa86f4de9975a45ba5c59acbdtplv-k3u1fbpfcp-jj-mark1512000q75.webp)





## Path

`Canvas` æœ€ä¸ºå…³é”®çš„æ–¹æ³•æ˜¯ `drawPath()` ï¼Œå®ƒå¯ä»¥æ ¹æ®Pathå¯¹è±¡ç»˜åˆ¶å‡ºä»»æ„å›¾å½¢ã€‚è€ŒPathçš„æ–¹æ³•å¦‚ä¸‹ï¼š

~~~dart
---->[è·¯å¾„ç»å¯¹ç§»åŠ¨]----
void moveTo(double x, double y)
void lineTo(double x, double y)
void quadraticBezierTo(double x1, double y1, double x2, double y2)
void cubicTo(double x1, double y1, double x2, double y2, double x3, double y3)
void conicTo(double x1, double y1, double x2, double y2, double w)
void arcTo(Rect rect, double startAngle, double sweepAngle, bool forceMoveTo)
void arcToPoint(Offset arcEnd, {Radius radius = Radius.zero, double rotation = 0.0, bool largeArc = false, bool clockwise = true,})

---->[è·¯å¾„ç›¸å¯¹ç§»åŠ¨]----
void relativeMoveTo(double dx, double dy)
void relativeLineTo(double dx, double dy)
void relativeQuadraticBezierTo(double x1, double y1, double x2, double y2)
void relativeCubicTo(double x1, double y1, double x2, double y2, double x3, double y3)
void relativeConicTo(double x1, double y1, double x2, double y2, double w)
void relativeArcToPoint(Offset arcEndDelta, { Radius radius = Radius.zero, double rotation = 0.0, bool largeArc = false, bool clockwise = true, })

---->[è·¯å¾„æ·»åŠ ]----
void addRect(Rect rect)
void addRRect(RRect rrect)
void addOval(Rect oval)
void addArc(Rect oval, double startAngle, double sweepAngle)
void addPolygon(List<Offset> points, bool close)
void addPath(Path path, Offset offset, {Float64List matrix4})
void extendWithPath(Path path, Offset offset, {Float64List matrix4})

---->[è·¯å¾„æ“ä½œ]----
void close()
void reset()
bool contains(Offset point)
Path shift(Offset offset)
Path transform(Float64List matrix4)
Rect getBounds()   
set fillType(PathFillType value)
static Path combine(PathOperation operation, Path path1, Path path2)
PathMetrics computeMetrics({bool forceClosed = false})
~~~

### ç”»çº¿

`MoveTo`ä¸`LineTo`éƒ½æ˜¯ç›¸å¯¹åŸç‚¹ï¼Œè€Œ`relativeLineTo`å’Œ`relativeMoveTo`æ˜¯ç›¸å¯¹äºå½“å‰è·¯å¾„ç»ˆç‚¹çš„ã€‚é™¤äº†`relativeLineTo`ï¼Œå…¶ä»–éƒ½æ”¹å˜è·¯å¾„çš„ç»ˆç‚¹

```dart
path
  ..moveTo(0, 0) //ç§»è‡³(0,0)ç‚¹
  ..lineTo(60, 80) //ä»(0,0)ç”»çº¿åˆ°(60, 80) ç‚¹
  ..lineTo(60, 0) //ä»(60,80)ç”»çº¿åˆ°(60, 0) ç‚¹
  ..lineTo(0, -80) //ä»(60, 0) ç”»çº¿åˆ°(0, -80)ç‚¹
  ..close(); //é—­åˆè·¯å¾„
canvas.drawPath(path, paint);
```

### ç”»å¼§

~~~dart
// ç»˜åˆ¶å·¦ä¾§
var rect = Rect.fromCenter(center: Offset(0, 0), width: 160, height: 100);
path.lineTo(30, 30);
path..arcTo(rect, 0, pi * 1.5, true);		// è¿™é‡Œä¸ºtrueï¼Œé‚£ä¹ˆä¹‹å‰çš„è·¯å¾„ä¸ä¸åœ†å¼§çš„èµ·ç‚¹ç›¸è¿
canvas.drawPath(path, paint);

path.reset();
canvas.translate(200, 0);
// ç»˜åˆ¶å³ä¾§
path.lineTo(30, 30);
path..arcTo(rect, 0, pi * 1.5, false); // è¿™é‡Œä¸ºfalseï¼Œé‚£ä¹ˆä¹‹å‰çš„è·¯å¾„çš„ç»ˆç‚¹é€šè¿‡ç›´çº¿ä¸åœ†å¼§çš„èµ·ç‚¹ç›¸è¿
canvas.drawPath(path, paint);
~~~

![image-20231214221430570](assets/image-20231214221430570.png)

### ç‚¹å®šå¼§

~~~dart
path.lineTo(80, -40);
//ç»˜åˆ¶ä¸­é—´
path
  ..arcToPoint(
    Offset(40, 40),
    radius: Radius.circular(80),
    largeArc: false,
  );
canvas.drawPath(path, paint);

path.reset();
canvas.translate(-150, 0);
//ç»˜åˆ¶å·¦ä¾§
path.lineTo(80, -40);
path
  ..arcToPoint(Offset(40, 40),
      radius: Radius.circular(80), largeArc: true, clockwise: false);
canvas.drawPath(path, paint);

path.reset();
canvas.translate(150 + 150.0, 0);
//ç»˜åˆ¶å³ä¾§
path.lineTo(80, -40);
path
  ..arcToPoint(
    Offset(40, 40),
    radius: Radius.circular(80),
    largeArc: true,
  );
~~~

- å·¦ä¾§: ä½¿ç”¨ä¼˜å¼§: largeArc: true ,é€†æ—¶é’ˆ:clockwise: false
- ä¸­é—´: ä½¿ç”¨åŠ£å¼§: largeArc: false ,é¡ºæ—¶é’ˆ:clockwise: true
- å³ä¾§: ä½¿ç”¨ä¼˜å¼§: largeArc: true ,é¡ºæ—¶é’ˆ:clockwise: true

![image-20231214221826844](assets/image-20231214221826844.png)

### åœ†é”¥æ›²çº¿

~~~dart
final Offset p1 = Offset(80, -100);
final Offset p2 = Offset(160, 0);

//æŠ›ç‰©çº¿
path.conicTo(p1.dx, p1.dy, p2.dx, p2.dy, 1);
canvas.drawPath(path, paint);

path.reset();
canvas.translate(-180, 0);
//æ¤­åœ†çº¿
path.conicTo(p1.dx, p1.dy, p2.dx, p2.dy, 0.5);
canvas.drawPath(path, paint);

path.reset();
canvas.translate(360, 0);
//åŒæ›²çº¿
path.conicTo(p1.dx, p1.dy, p2.dx, p2.dy, 1.5);
canvas.drawPath(path, paint);

path.reset();
canvas.translate(-560, 0);
path.conicTo(p1.dx, p1.dy, p2.dx, p2.dy, 50);
canvas.drawPath(path, paint);
~~~

![image-20231214222440744](assets/image-20231214222440744.png)

### äºŒé˜¶è´å¡å°”

~~~dart
final Offset p1 = Offset(100, -100);
final Offset p2 = Offset(160, 50);

// æ§åˆ¶ç‚¹ä¸ç»“æŸç‚¹
path.quadraticBezierTo(p1.dx, p1.dy, p2.dx, p2.dy);

// ç›¸å¯¹äºå½“å‰è·¯å¾„çš„ç»ˆç‚¹æ¥å®šä½
path.relativeQuadraticBezierTo(p1.dx, p1.dy, p2.dx, p2.dy);
canvas.drawPath(path, paint);
~~~

![img](assets/b9c2a456c4e64e8987fdc5cc4365199btplv-k3u1fbpfcp-jj-mark1512000q75.webp)





### ä¸‰é˜¶è´å¡å°”

~~~dart
//ä¸¤ä¸ªæ§åˆ¶ç‚¹ï¼Œä¸€ä¸ªç»“æŸç‚¹
path.cubicTo(p1.dx, p1.dy, p2.dx, p2.dy, p3.dx, p3.dy);

path.relativeCubicTo(p1.dx, p1.dy, p2.dx, p2.dy, p3.dx, p3.dy);
canvas.drawPath(path, paint);
~~~

![img](assets/0a55b600163340bfa14cbf2d46835e51tplv-k3u1fbpfcp-jj-mark1512000q75.webp)

### åŸºæœ¬å›¾å½¢

~~~dart
Rect rect = Rect.fromPoints(Offset(100, 100), Offset(160, 160));
path
  ..lineTo(-200, 200)
  ..addRect(rect)
  ..relativeLineTo(100, -100)
  ..addRRect(RRect.fromRectXY(rect.translate(100, -100), 10, 10));
canvas.drawPath(path, paint);
~~~

![image-20231214223307203](assets/image-20231214223307203.png)



ç»˜åˆ¶å¤šè¾¹å½¢ï¼š

~~~dart
path
  ..addPolygon([
    p0,
    p0.translate(20, -20),
    p0.translate(40, -20),
    p0.translate(60, 0),
    p0.translate(60, 20),
    p0.translate(40, 40),
    p0.translate(20, 40),
    p0.translate(0, 20),
  ], true)
  ..addPath(
      Path()..relativeQuadraticBezierTo(125, -100, 260, 0), Offset.zero);

canvas.drawPath(path, paint);
~~~

![image-20231214224433089](assets/image-20231214224433089.png)



æ­¤å¤–è¿˜æœ‰ï¼š

- addOval(rect)
- addArc(rect, 0, pi);



### è·¯å¾„çš„æ“ä½œ

- `path#close `ï¼šå°†è·¯å¾„ç»ˆç‚¹å’Œèµ·ç‚¹ç”¨ç›´çº¿ç›¸è¿ï¼Œå³è·¯å¾„å°é—­ã€‚
-  `path#reset `ï¼šç”¨äºå°†è·¯å¾„è¿›è¡Œé‡ç½®ã€‚
-  `path#shift `ï¼šè¿”å›ä¸€æ¡æ–°è·¯å¾„ï¼Œè¯¥æ–°è·¯å¾„æŒ‰ç…§ç‚¹Offsetè¿›è¡Œå¹³ç§»ã€‚ `path.shift(Offset(300, 100))`



- `Path#contains`å¯ä»¥åˆ¤æ–­è·¯å¾„ä¹‹å†…æ˜¯å¦åŒ…å«ç‚¹Offset(å¦‚ä¸‹å›¾ç´«è‰²åŒºåŸŸ)
- `Path#getBounds`å¯ä»¥è·å–å½“å‰è·¯å¾„æ‰€åœ¨çš„çŸ©å½¢åŒºåŸŸï¼Œ(å¦‚ä¸‹æ©™è‰²åŒºåŸŸ)

![image-20201031214041569](assets/ccb024b96f2448c9a158a4be145be519tplv-k3u1fbpfcp-jj-mark1512000q75.webp)

- `Path#transform`ï¼šæŒ‰ç…§`Matrix4`è¿›è¡Œå˜æ¢ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„è·¯å¾„

  ~~~kotlin
  Matrix4 m4 = Matrix4.translationValues(size.width/2, size.height/2, 0);
  
  Matrix4 back = Matrix4.translationValues(-20, -20, 0);
  Matrix4 rotateM4 = Matrix4.rotationZ(10*pi/180);
  
  m4.multiply(rotateM4);
  m4.multiply(back); 
  path = path.transform(m4.storage);
  canvas.drawPath(path, paint);
  
  ~~~

  
  
  
  
- `Path#combine`ï¼šå¯¹ä¸¤ä¸ªè·¯å¾„è¿›è¡Œé›†åˆæ“ä½œ

  ![image-20201031215722410](assets/d64edb6bcc51483688d3582b1a974e1btplv-k3u1fbpfcp-jj-mark1512000q75.webp)



### è·¯å¾„çš„æµ‹é‡

[PathMetrics](https://api.flutter.dev/flutter/dart-ui/PathMetrics-class.html) can describe various properties about the contours of the path. A [Path](https://api.flutter.dev/flutter/dart-ui/Path-class.html) is made up of zero or more contours. A contour is made up of connected curves and segments, created via methods like [lineTo](https://api.flutter.dev/flutter/dart-ui/Path/lineTo.html), [cubicTo](https://api.flutter.dev/flutter/dart-ui/Path/cubicTo.html), [arcTo](https://api.flutter.dev/flutter/dart-ui/Path/arcTo.html), [quadraticBezierTo](https://api.flutter.dev/flutter/dart-ui/Path/quadraticBezierTo.html), their relative counterparts, as well as the add* methods such as [addRect](https://api.flutter.dev/flutter/dart-ui/Path/addRect.html). 

![éšè·¯å¾„å˜æ¢](assets/0ceb5d9862f749bb8333ee8283b888betplv-k3u1fbpfcp-jj-mark1512000q75.webp)

~~~kotlin
PathMetrics pms = path.computeMetrics();

pms.forEach((pm) {
  Tangent? tangent = pm.getTangentForOffset(pm.length * progress.value);
  if(tangent == null)
    return;
  canvas.drawCircle(
      tangent.position, 
      5, 
      Paint()..color = Colors.deepOrange
  );
});

~~~

æ­¤å¤–ï¼Œé€šè¿‡`PathMetric#extractPath` å¯ä»¥æå–å‡ºæŒ‡å®šé•¿åº¦çš„è·¯å¾„ï¼Œé…åˆç€åŠ¨ç”»æ§åˆ¶å™¨ï¼ˆé€šè¿‡`repaint.value`æ¥è·å–åŠ¨ç”»å€¼ï¼‰å¯ä»¥å®ç°ä»¥ä¸‹æ•ˆæœï¼š

![run_path](assets/20b0dde608404ba1845f5d476f7e019ftplv-k3u1fbpfcp-jj-mark1512000q75.webp)

ä»£ç å¦‚ä¸‹ï¼š

~~~dart
PathMetrics pms = path.computeMetrics();
pms.forEach((pm) {
  Tangent tangent = pm.getTangentForOffset(pm.length * repaint.value);
    
  // æå–æŒ‡å®šçš„éƒ¨åˆ†è·¯å¾„
  canvas.drawPath(
      pm.extractPath(
          0, 
          pm.length * repaint.value
      ), 
      paint
  );
  canvas.drawCircle(
      tangent.position, 
      5, 
      Paint()..color = Colors.blue
  );
});
~~~



## Color



ä¸€ç§é¢œè‰²çš„åè‰²æ˜¯å…¶åœ¨è‰²ç›¸ç¯ä¸­æ­£ç›¸å¯¹çš„é¢œè‰²

![img](assets/19d218a6d9494e6d89172969a84f12a7tplv-k3u1fbpfcp-jj-mark1512000q75.webp)



Colorçš„å®šä¹‰

~~~dart
const Color(int value) : value = value & 0xFFFFFFFF;
final int value;
int get alpha => (0xff000000 & value) >> 24;
double get opacity => alpha / 0xFF;
int get red => (0x00ff0000 & value) >> 16;
int get green => (0x0000ff00 & value) >> 8;
int get blue => (0x000000ff & value) >> 0;
~~~

### æ··åˆæ¨¡å¼

æµ‹è¯•è¯´æ˜ï¼š

| dst èƒŒæ™¯                                                     | src æº                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![dst](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e82ea82cc7574176828ca66eb46b2f4d~tplv-k3u1fbpfcp-jj-mark:1512:0:0:0:q75.awebp) | ![src](assets/8107872704bf4e489dfa06eadb3dd740tplv-k3u1fbpfcp-jj-mark1512000q75.webp) |

ç»“æœè¯´æ˜ï¼š

| clear                                                        | src                                                          | dst                                                          |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![00_clear](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e3be4aad87be4cef8ce47ec2c87cb163~tplv-k3u1fbpfcp-jj-mark:1512:0:0:0:q75.awebp) | ![01_src](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f742294ae4d946cc9a84cbde6c7e2204~tplv-k3u1fbpfcp-jj-mark:1512:0:0:0:q75.awebp) | ![02_dst](assets/255af8310adc49b6ad262f716888641ctplv-k3u1fbpfcp-jj-mark1512000q75.webp) |

| srcOver                                                      | dstOver                                                      | srcIn                                                        |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![03_srcOver](assets/8d5542ec332646469ae37c44764980c2tplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![04_dstOver](assets/a54608e6b55b49c3b9ec51ae3f3c5235tplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![05_srcIn](assets/37359eb2ac1e494285a6c7d745bbb4b5tplv-k3u1fbpfcp-jj-mark1512000q75.webp) |

| dstIn                                                        | srcOut                                                       | dstOut                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![06_dstIn](assets/0b363add27ec4203a2e763e8a30196b7tplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![07_srcOut2](assets/60fa6a4423bb4275a703b4f417619063tplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![08_dstOut](assets/6acfd56398b64ebabfdff98a4acbb4b5tplv-k3u1fbpfcp-jj-mark1512000q75.webp) |

| srcATop                                                      | dstATop                                                      | xor                                                          |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![09_srcATop](assets/3354d7d9ec794771a264b39be9dbccfetplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![10_dstATop](assets/139e1f1ccc074c7ab995c85f68e897e7tplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![11_xor](assets/b772a176291844ca8368f1d53fd8567ctplv-k3u1fbpfcp-jj-mark1512000q75.webp) |

| plus                                                         | modulate                                                     | screen                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![12_plus](assets/7736faee9a0942aaa6eab947472bef68tplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![13_modulate](assets/149ccafdee334753ae8646d74103b721tplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![14_screen](assets/93779bc3de6143cba49fa2204eae47ddtplv-k3u1fbpfcp-jj-mark1512000q75.webp) |

| overlay                                                      | darken                                                       | lighten                                                      |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![15_overlay](assets/0d184c01f32044598ce8bc8fb48b63cetplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![16_darken](assets/a0cd28909721489a9be7b9ef7f2609dctplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![17_lighten](assets/d3b6b3050be941f9b36909b0b0fa5366tplv-k3u1fbpfcp-jj-mark1512000q75.webp) |

| colorDodge                                                   | colorBurn                                                    | hardLight                                                    |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![18_color_Dodge](assets/ce74602f2a3c45d381367d6a1bb3117ftplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![19_colorBurn](assets/7f242a9ede6d4c8881133f7238e95114tplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![20_hardLight](assets/0a7a5fda30ab4aa6a84c9ce615fc6776tplv-k3u1fbpfcp-jj-mark1512000q75.webp) |

| softLight                                                    | difference                                                   | exclusion                                                    |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![21_softLight](assets/c797109cc1704de79322c00b81308d09tplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![22_difference](assets/cd12017cd1114df199ca4c7eb8e62ff1tplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![23_exclusion](assets/3c1cc74569194b7a810d6d6b3988ce1atplv-k3u1fbpfcp-jj-mark1512000q75.webp) |

| multiply                                                     | hue                                                          | saturation                                                   |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![24_multiply](assets/b3e3297eaa4a4262a8514a145d2c98f6tplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![25_hue](assets/05bb875b2ce94b41b816aac5e43f6c11tplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![26_saturation](assets/cbeefe94b33d4a31b43eb92d88367b78tplv-k3u1fbpfcp-jj-mark1512000q75.webp) |

| color                                                        | luminosity                                                   |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![27_color](assets/03dcd3965cf845edb3bcde22b706b908tplv-k3u1fbpfcp-jj-mark1512000q75.webp) | ![28_luminosity](assets/7d69a0082dcf42f28c6cf12c4dcb1008tplv-k3u1fbpfcp-jj-mark1512000q75.webp) |



### ç€è‰²å™¨

å¦‚æœç”»ç¬”æ‰€ç»˜åˆ¶çš„å›¾å½¢æ­£å¥½åŒ…å«åœ¨ç”»ç¬”çš„æŸä¸ªæ¸å˜åŒºåŸŸä¸­ï¼Œé‚£ä¹ˆå›¾å½¢çš„é¢œè‰²å°±ç”±æ¸å˜å†³å®šäº†ï¼Œè€Œä¸æ˜¯ç”»ç¬”çš„é¢œè‰²ã€‚

çº¿æ€§æ¸å˜ï¼š

~~~kotlin
Gradient.linear(
    Offset from,							// èµ·ç‚¹
    Offset to,								// ç»ˆç‚¹
    List<Color> colors, [					// é¢œè‰²
    List<double>? colorStops,				// æ¸å˜ç‚¹
    TileMode tileMode = TileMode.clamp,		// æ¨¡å¼
    Float64List? matrix4,					// å˜æ¢çŸ©é˜µ
])
~~~



~~~dart
var colors = [
    Color(0xFFF60C0C),
    Color(0xFFF3B913),
    Color(0xFFE7F716),
    Color(0xFF3DF30B),
    Color(0xFF0DF6EF),
    Color(0xFF0829FB),
    Color(0xFFB709F4),
];

var pos = [1.0 / 7, 2.0 / 7, 3.0 / 7, 4.0 / 7, 5.0 / 7, 6.0 / 7, 1.0];

paint.shader = ui.Gradient.linear(
      Offset(0, 0), Offset(100, 0), colors, pos);

canvas.drawLine(
    Offset(0, 0),
    Offset(200, 0),
    paint,
);
~~~

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœç»˜åˆ¶å†…å®¹è¶…è¿‡æ¸å˜èŒƒå›´ï¼Œä½¿ç”¨`TileMode.clamp`ä½¿ç”¨æœ€åçš„é¢œè‰²ï¼Œç»§ç»­ç»˜åˆ¶ï¼ˆä¸‹å›¾ä¸­ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸¤ç§æ¨¡å¼ï¼šå¾„å‘æ¨¡å¼(ä¸‹å›¾å·¦) `TileMode.mirror`ã€é‡å¤æ¨¡å¼(ä¸‹å›¾å³)`TileMode.repeated`

![image-20201101142935322](assets/ab48e2d984554cb3abebfeaea5f7fc24tplv-k3u1fbpfcp-jj-mark1512000q75.webp)

å¦å¤–é€šè¿‡ `matrix4 `å¯ä»¥å¯¹ç”»ç¬”å¡«å……è¿›è¡Œå˜åŒ–ã€‚ä¾‹å¦‚ï¼Œä¾æ¬¡æ˜¯æ—‹è½¬ã€ç§»åŠ¨ã€å€¾æ–œ

![image-20201101144058128](assets/472a8c65cde6480d8b61d2c176a02e67tplv-k3u1fbpfcp-jj-mark1512000q75.webp)



æ¸å˜ç€è‰²å™¨ï¼š

~~~dart
 Gradient.radial(
    Offset center, 						// ä¸­å¿ƒ
    double radius, 						// åŠå¾„
    List<Color> colors,  [				// é¢œè‰²
    List<double> colorStops, 			// æ¸å˜ç‚¹
    TileMode tileMode = TileMode.clamp, // æ¨¡å¼
    Float64List matrix4,  				// å˜æ¢çŸ©é˜µ
    Offset focal, 						// ç„¦ç‚¹åæ ‡
    double focalRadius = 0.0 			// ç„¦ç‚¹åŠå¾„
]) 
~~~

ä¸‹é¢ä¸‰ä¸ªåˆ†åˆ«æ˜¯ç±»å‹ä¸º`TileMode.mirror`ã€`TileMode.clamp`ã€`TileMode.repeated`ç±»å‹

![image-20201101145513996](assets/1615293881a64abbb8acfd208597bfb5tplv-k3u1fbpfcp-jj-mark1512000q75.webp)

ç„¦ç‚¹åç§»å’Œç„¦ç‚¹åŠå¾„å¯ä»¥æ§åˆ¶æ¸å˜ã€‚å¦‚ä¸‹ï¼Œ å·¦å›¾: `Offset(15, 15), 0` ã€ä¸­å›¾: `Offset(-10, -10), 7` , å³å›¾: `Offset(-10, -10), 0` ã€‚

![image-20231215001120727](assets/image-20231215001120727.png)



æ‰«ææ¸å˜ï¼š

~~~dart
Gradient.sweep(
    Offset center, 							// ä¸­å¿ƒ
    List<Color> colors, [					// é¢œè‰²
    List<double> colorStop 					// æ¸å˜ç‚¹
    TileMode tileMode = TileMode.clamp,  	// æ¨¡å¼
    double startAngle = 0.0,				// èµ·å§‹è§’åº¦
    double endAngle = math.pi * 2,			// ç»ˆæ­¢è§’åº¦
    Float64List matrix4, 					// å˜æ¢çŸ©é˜µ
  ])
~~~

ä¸‹é¢ä¸‰ä¸ªåˆ†åˆ«æ˜¯ç±»å‹ä¸º`TileMode.mirror`ã€`TileMode.clamp`ã€`TileMode.repeated`ç±»å‹

![image-20201101151915911](assets/70d5bf73da994846a9302ad528cba00dtplv-k3u1fbpfcp-jj-mark1512000q75.webp)



å›¾ç‰‡ç€è‰²å™¨ï¼š

~~~dart
ImageShader(
    Image image,  			// å›¾ç‰‡
    TileMode tmx, 			// æ°´å¹³æ–¹å‘æ¨¡å¼
    TileMode tmy, 			// ç«–ç›´æ–¹å‘æ¨¡å¼
    Float64List matrix4  	// å˜åŒ–çŸ©é˜µ
)
    
    
// ä½¿ç”¨ç¤ºä¾‹
Paint paint = Paint()..shader = ImageShader(
    img!,
    TileMode.repeated,
    TileMode.repeated,
    Float64List.fromList([
      1, 0, 0, 0,
      0, 1, 0, 0,
      0, 0, 1, 0,
      0, 0, 0, 1,
    ]));
~~~



### æ»¤è‰²å™¨

~~~dart
// é¢œè‰²æ¨¡å¼
const ColorFilter.mode(Color color, BlendMode blendMode)
    
// é¢œè‰²çŸ©é˜µå˜æ¢
const ColorFilter.matrix(List<double> matrix) 

// ä½¿ç”¨ç¤ºä¾‹
paint.colorFilter = ColorFilter.mode(Colors.yellow, BlendMode.modulate);
const ColorFilter negative = ColorFilter.matrix(<double>[
  -1, 0, 0, 0, 255,
  0, -1, 0, 0, 255,
  0, 0, -1,0, 255,
  0, 0, 0, 1, 0
]);
paint.colorFilter = negative;
canvas.drawImageRect(
    img!, 
    Rect.fromLTRB(0, 0, imgW, imgH),
    Rect.fromLTRB(0, 0, imgW / 2, imgH / 2), 
    paint
);
~~~

`ColorFilter.matrix`é€šè¿‡ä¸€ä¸ª`5*4`çš„é¢œè‰²çŸ©é˜µæ§åˆ¶è‰²å½©å˜æ¢ã€‚
M ä»£è¡¨æˆ‘ä»¬ä¼ å…¥çš„çŸ©é˜µï¼Œ C ä»£è¡¨å›¾ç‰‡æŸä¸€åƒç´ çš„é¢œè‰²æ‰€æ„æˆçš„`1*5 `çŸ©é˜µï¼Œé‚£ä¹ˆæœ‰

![é¢œè‰²çŸ©é˜µ.png](assets/202c9d5536124ca4963e52fad600719dtplv-k3u1fbpfcp-jj-mark1512000q75.webp)



### å…¶ä»–æ»¤é•œ

é®ç½©æ»¤é•œ

~~~dart
const MaskFilter.blur(
    this._style, // ç±»å‹
    this._sigma, // é«˜æ–¯æ¨¡ç³Šçš„åå·®
) 
~~~

~~~dart

paint.maskFilter = MaskFilter.blur(BlurStyle.inner, 20);
canvas.drawImageRect(
    img!, 
    Rect.fromLTRB(0, 0, imgW, imgH),
    Rect.fromLTRB(0, 0, imgW / 2, imgH / 2), 
    paint
);
~~~

å›¾ç‰‡æ»¤é•œ

~~~dart
ImageFilter.blur({ 
    double sigmaX = 0.0, 
    double sigmaY = 0.0 
})
    
ImageFilter.matrix(
  Float64List matrix4,{ 
  FilterQuality filterQuality = FilterQuality.low 
})
    
    
// ä½¿ç”¨ç¤ºä¾‹
paint.imageFilter = ui.ImageFilter.blur(sigmaX: 0.4, sigmaY: 0.4);

~~~





## æ‰‹åŠ¿äº¤äº’

åŸºæœ¬æ¡†æ¶

~~~dart
class HandleWidget extends StatefulWidget {
    // è¯¥å›è°ƒå‡½æ•°å°†äº¤äº’è¿‡ç¨‹ä¸­æ‰€è®¡ç®—å‡ºæ¥çš„ä¿¡æ¯æš´éœ²ç»™å…¶ä»–Widgetï¼Œè¿™æ ·Widgetæ ¹æ®è¿™äº›ä¿¡æ¯æ›´æ–°è‡ªå·±çš„UI  setState()
    // å¦‚æœç”»å¸ƒä¸ä¸å…¶ä»–Widgetæœ‰è”ç³»ï¼Œé‚£ä¹ˆæŠ›å¼ƒè¿™ä¸ªå›è°ƒå‡½æ•°
    final void Function(double rotate, double distance) onMove; 
    HandleWidget({super.key, required this.onMove}) 

    @override
    _HandleWidgetState createState() => _HandleWidgetState();
}
~~~





~~~dart
class _HandleWidgetState extends State<HandleWidget> {
	ValueNotifier<Offset> _offset = ValueNotifier(Offset.zero);

    @override
    Widget build(BuildContext context) {
    	return GestureDetector(
    		onPanUpdate: parser,
    		child: CustomPaint(painter: _HandlePainter(_offset)
        );
    }
            
    parser(DragUpdateDetails details) {
        // è¿™é‡Œæ ¹æ®æ‰‹åŠ¿ä¿¡æ¯è®¡ç®—å‡º_offsetï¼Œè€ŒCustomPaintæ ¹æ®_offseté‡æ–°ç»˜åˆ¶
        // æ³¨æ„ï¼ŒDragUpdateDetailsä¸­çš„åæ ‡ä¿¡æ¯æ˜¯ç›¸å¯¹ç»„ä»¶çš„å·¦ä¸Šè§’çš„ã€‚
        _offset.value = Offset(dx, dy);
        widget.onMove(0, 0); // è°ƒç”¨å›è°ƒå‡½æ•°
    }
}
~~~

## è¾…åŠ©åæ ‡ç³»

~~~dart
@immutable
class Coordinate {
  void paint(Canvas canvas, Size size) {
    canvas.translate(size.width / 2, size.height / 2);
    canvas.scale(1, -1);
    _drawGrid(canvas, size);
  }

  void _drawGrid(Canvas canvas, Size size) {
    _drawBottomRight(canvas, size);
    canvas.save();
    canvas.scale(1, -1); //æ²¿xè½´é•œåƒ
    _drawBottomRight(canvas, size);
    canvas.restore();

    canvas.save();
    canvas.scale(-1, 1); //æ²¿yè½´é•œåƒ
    _drawBottomRight(canvas, size);
    canvas.restore();

    canvas.save();
    canvas.scale(-1, -1); //æ²¿åŸç‚¹é•œåƒ
    _drawBottomRight(canvas, size);
    canvas.restore();
  }

  void _drawBottomRight(Canvas canvas, Size size) {
    final double step = 20;
    final _gridPaint = Paint()
      ..strokeWidth = .5
      ..color = Colors.grey;
    canvas.save();
    for (int i = 0; i < size.height / 2 / step; i++) {
      canvas.drawLine(Offset(0, 0), Offset(size.width / 2, 0), _gridPaint);
      canvas.translate(0, step);
    }
    canvas.restore();

    canvas.save();
    for (int i = 0; i < size.width / 2 / step; i++) {
      canvas.drawLine(Offset(0, 0), Offset(0, size.height / 2), _gridPaint);
      canvas.translate(step, 0);
    }
    canvas.restore();
  }

  @override
  bool shouldRepaint(CustomPainter oldDelegate) => true;
}

~~~

ä½¿ç”¨ç¤ºä¾‹ï¼š

~~~dart
@override
void paint(Canvas canvas, Size size) {
	coordinate.paint(canvas, size);
}
~~~



## æ›²çº¿æ‹Ÿåˆ

ç»™å®šä¸€ç»„ç‚¹ï¼Œå¦‚ä½•æ‹Ÿåˆå‡ºçš„æ›²çº¿ï¼Ÿä¸»è¦æœ‰ä¸¤ç§æ–¹æ³•ï¼š

- è´å¡å°”æ›²çº¿

  ~~~dart
  Offset p1 = points[0];
  Path path = Path()..moveTo(p1.dx, p1.dy);
  for (var i = 1; i < points.length - 1; i++) {
    double xc = (points[i].dx + points[i + 1].dx) / 2;
    double yc = (points[i].dy + points[i + 1].dy) / 2;
    Offset p2 = points[i];
    //ç»™å®šç›¸é‚»ä¸¤ç‚¹ï¼Œæ§åˆ¶ç‚¹ä¸ºå·¦è¾¹çš„ç‚¹ï¼Œè€Œç»“æŸç‚¹ä¸ºä¸¤ç‚¹çš„ä¸­ç‚¹
    path.quadraticBezierTo(p2.dx, p2.dy, xc, yc);
  }
  ~~~

- PointMode.plygon

![img](assets/ac49c6d2f61b431fbe9860bb444ed63ctplv-k3u1fbpfcp-jj-mark1512000q75.webp)
