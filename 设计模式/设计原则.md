# è®¾è®¡åŸåˆ™

åˆ‡è®°ä¸è¦æ•™æ¡ä¸»ä¹‰ï¼Œç”Ÿæ¬ç¡¬å¥—ï¼Œé€‚å¾—å…¶åã€‚

å½“ä½ å¯¹åº”ç”¨å“ªæ¡è®¾è®¡åŸåˆ™è€Œæ‹¿ä¸å®šæ³¨æ„æ—¶ï¼Œå°±è¦è®¤è¯†åˆ°ï¼š

- è®¾è®¡åŸåˆ™æ˜¯å›´ç»•ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯å¤ç”¨æ€§ã€å¯æ‰©å±•æ€§è€ŒæœåŠ¡çš„ï¼Œç”¨äºåº”å¯¹ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚
- æ ¹æ®ç°æœ‰éœ€æ±‚å»è€ƒè™‘é—®é¢˜ï¼Œè€Œä¸è¦è¿‡åº¦è®¾è®¡ã€‚å‰ææ˜¯ï¼Œéœ€æ±‚æ˜¯åˆç†çš„ï¼



è®¾è®¡çš„è¿‡ç¨‹æ˜¯å…ˆæœ‰é—®é¢˜åæœ‰æ–¹æ¡ˆã€‚

ä¸è¦è„±ç¦»å…·ä½“çš„åœºæ™¯å»è°ˆè®¾è®¡ã€‚

ä¸€åŠ³æ°¸é€¸çš„è®¾è®¡æ˜¯æ ¹æœ¬ä¸å­˜åœ¨çš„ã€‚

ä¸å˜çš„äº‹ç‰©å°±æ˜¯å˜åŒ–æœ¬èº«ã€‚



[TOC]

## é«˜å†…èšã€æ¾è€¦åˆ

â€œé«˜å†…èšã€æ¾è€¦åˆâ€å’Œâ€œæŠ½è±¡â€ä¸€æ ·ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„è®¾è®¡æ€æƒ³ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚å®ƒå¯ä»¥ç”¨æ¥æŒ‡å¯¼ä¸åŒç²’åº¦ä»£ç çš„è®¾è®¡ä¸å¼€å‘ï¼Œæ¯”å¦‚ç³»ç»Ÿã€æ¨¡å—ã€ç±»ï¼Œç”šè‡³æ˜¯å‡½æ•°ï¼Œä¹Ÿå¯ä»¥åº”ç”¨åˆ°ä¸åŒçš„å¼€å‘åœºæ™¯ä¸­ï¼Œæ¯”å¦‚å¾®æœåŠ¡ã€æ¡†æ¶ã€ç»„ä»¶ã€ç±»åº“ç­‰ã€‚æ­¤å¤–ï¼Œ**è¿™ç§æ€æƒ³æŒ‡å¯¼ç€å¤§éƒ¨åˆ†çš„è®¾è®¡åŸåˆ™**ã€‚

**è§£è€¦è®©æˆ‘ä»¬èšç„¦äºæŸä¸€æ¨¡å—æˆ–ç±»ä¸­ï¼Œé™ä½äº†é˜…è¯»å’Œä¿®æ”¹ä»£ç çš„éš¾åº¦ï¼Œç¼©å°éœ€æ±‚å˜æ›´å¯¼è‡´çš„ä»£ç ä¿®æ”¹è¯¥èŒƒå›´ã€‚**

è¿™é‡Œæˆ‘ä»¬ä»¥ç±»ä¸ºè€ƒå¯Ÿå¯¹è±¡ï¼Œæ¥è§£é‡Šè¿™ä¸ªæ¦‚å¿µã€‚åœ¨è¿™ä¸ªè®¾è®¡æ€æƒ³ä¸­ï¼Œ**â€œé«˜å†…èšâ€ç”¨æ¥æŒ‡å¯¼ç±»æœ¬èº«çš„è®¾è®¡ï¼Œâ€œæ¾è€¦åˆâ€ç”¨æ¥æŒ‡å¯¼ç±»ä¸ç±»ä¹‹é—´ä¾èµ–å…³ç³»çš„è®¾è®¡**ã€‚å…·ä½“æ¥è¯´ï¼š

- **é«˜å†…èš**ï¼Œå°±æ˜¯æŒ‡ç›¸è¿‘çš„åŠŸèƒ½åº”è¯¥æ”¾åˆ°åŒä¸€ä¸ªç±»ä¸­ï¼Œä¸ç›¸è¿‘çš„åŠŸèƒ½ä¸è¦æ”¾åˆ°åŒä¸€ä¸ªç±»ä¸­ã€‚ç›¸è¿‘çš„åŠŸèƒ½å¾€å¾€ä¼šè¢«åŒæ—¶ä¿®æ”¹ï¼Œæ”¾åˆ°åŒä¸€ä¸ªç±»ä¸­ï¼Œä¿®æ”¹ä¼šæ¯”è¾ƒé›†ä¸­ï¼Œä»£ç å®¹æ˜“ç»´æŠ¤ã€‚å®é™…ä¸Šï¼Œå•ä¸€èŒè´£åŸåˆ™æ˜¯å®ç°ä»£ç é«˜å†…èšéå¸¸æœ‰æ•ˆçš„è®¾è®¡åŸåˆ™ã€‚
- **æ¾è€¦åˆ**ï¼Œåœ¨ä»£ç ä¸­ï¼Œç±»ä¸ç±»ä¹‹é—´çš„ä¾èµ–å…³ç³»ç®€å•æ¸…æ™°ã€‚å³ä½¿ä¸¤ä¸ªç±»æœ‰ä¾èµ–å…³ç³»ï¼Œä¸€ä¸ªç±»çš„ä»£ç æ”¹åŠ¨ä¸ä¼šæˆ–è€…å¾ˆå°‘å¯¼è‡´ä¾èµ–ç±»çš„ä»£ç æ”¹åŠ¨ã€‚å®é™…ä¸Šä¾èµ–æ³¨å…¥ã€æ¥å£éš”ç¦»ã€åŸºäºæ¥å£è€Œéå®ç°ç¼–ç¨‹ï¼Œä»¥åŠè¿ªç±³ç‰¹æ³•åˆ™ï¼Œéƒ½æ˜¯ä¸ºäº†å®ç°ä»£ç çš„æ¾è€¦åˆã€‚



é‚£ä¹ˆå¦‚ä½•è¿›è¡Œè§£è€¦ï¼Ÿ

- å°è£…ä¸æŠ½è±¡ï¼šå°è£…å’ŒæŠ½è±¡å¯ä»¥æœ‰æ•ˆåœ°éšè—å®ç°çš„å¤æ‚æ€§ï¼ˆéš”ç¦»å…³æ³¨ç‚¹ï¼‰ï¼Œéš”ç¦»å®ç°çš„æ˜“å˜æ€§ï¼Œç»™ä¾èµ–çš„æ¨¡å—æä¾›ç¨³å®šä¸”æ˜“ç”¨çš„æŠ½è±¡æ¥å£ã€‚

- ä¸­é—´å±‚ï¼šå¼•å…¥ä¸­é—´å±‚èƒ½ç®€åŒ–æ¨¡å—æˆ–ç±»ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚

  <img src="assets/cbcefa78026fd1d0cb9837dde9adae52.jpg" style="zoom: 25%;" />

- æ¨¡å—åŒ–ï¼šä¸åŒçš„æ¨¡å—ä¹‹é—´é€šè¿‡APIæ¥è¿›è¡Œé€šä¿¡ï¼Œæ¯ä¸ªæ¨¡å—ä¹‹é—´è€¦åˆå¾ˆå°ã€‚æ¯ä¸ªå›¢é˜Ÿèšç„¦äºä¸€ä¸ªç‹¬ç«‹çš„é«˜å†…èšæ¨¡å—æ¥å¼€å‘ï¼Œæœ€ç»ˆåƒæ­ç§¯æœ¨ä¸€æ ·å°†å„ä¸ªæ¨¡å—ç»„è£…èµ·æ¥ï¼Œæ„å»ºæˆä¸€ä¸ªè¶…çº§å¤æ‚çš„ç³»ç»Ÿã€‚**æ¨¡å—åŒ–çš„åº•å±‚é€»è¾‘å°±æ˜¯åˆ†è€Œæ²»ä¹‹**



## å•ä¸€èŒè´£åŸåˆ™ï¼ˆSingle Responsibility Principleï¼‰

> A class or module should have a single responsibility
>
> ä¸€ä¸ªç±»æˆ–è€…æ¨¡å—åªè´Ÿè´£å®Œæˆä¸€ä¸ªèŒè´£ã€‚



å¦‚æœæŸç±»åŒ…å«äº†è‹¥å¹²ä¸ªä¸šåŠ¡ä¸Šä¸ç›¸å…³çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆè€ƒè™‘å°†è¯¥ç±»æ‹†åˆ†æˆç²’åº¦æ›´ç»†ã€åŠŸèƒ½æ›´åŠ å•ä¸€çš„å¤šä¸ªç±»ã€‚

å¯¹äºä¸€ä¸ªç±»æ˜¯å¦ç¬¦åˆSRPï¼Œæ˜¯æ²¡æœ‰ä¸€ä¸ªéå¸¸æ˜ç¡®çš„ã€å¯ä»¥é‡åŒ–çš„æ ‡å‡†ã€‚ä¾‹å¦‚åœ¨ä¸€ä¸ªç¤¾äº¤äº§å“ä¸­ï¼Œæˆ‘ä»¬ç”¨ä¸‹é¢çš„UserInfoç±»æ¥è®°å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼š

~~~java
public class UserInfo {
  private long userId;
  private String username;
  private String email;
  private String telephone;
  private long createTime;
  private long lastLoginTime;
  private String avatarUrl;
  private String provinceOfAddress; // çœ
  private String cityOfAddress; // å¸‚
  private String regionOfAddress; // åŒº 
  private String detailedAddress; // è¯¦ç»†åœ°å€
  // ...çœç•¥å…¶ä»–å±æ€§å’Œæ–¹æ³•...
}
~~~

UserInfoç±»çš„è®¾è®¡æ˜¯å¦æ»¡è¶³å•ä¸€èŒè´£åŸåˆ™å‘¢ï¼Ÿä¸‹é¢ç»™å‡ºä¸¤ç§å¯¹ç«‹çš„è§‚ç‚¹ã€‚

- UserInfoç±»åŒ…å«çš„éƒ½æ˜¯è·Ÿç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯ï¼Œæ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³•éƒ½éš¶å±äºç”¨æˆ·è¿™æ ·ä¸€ä¸ªä¸šåŠ¡æ¨¡å‹ï¼Œæ»¡è¶³å•ä¸€èŒè´£åŸåˆ™
- åœ°å€ä¿¡æ¯åœ¨UserInfoç±»ä¸­ï¼Œæ‰€å çš„æ¯”é‡æ¯”è¾ƒé«˜ï¼Œå¯ä»¥ç»§ç»­æ‹†åˆ†æˆç‹¬ç«‹çš„UserAddressç±»ã€‚

å“ªç§è§‚ç‚¹æ›´å¯¹å‘¢ï¼Ÿå®é™…ä¸Šï¼Œè¦ä»ä¸­åšå‡ºé€‰æ‹©ï¼Œæˆ‘ä»¬**ä¸èƒ½è„±ç¦»å…·ä½“çš„åº”ç”¨åœºæ™¯**ã€‚å¦‚æœåœ¨è¿™ä¸ªç¤¾äº¤äº§å“ä¸­ï¼Œç”¨æˆ·çš„Addressä¿¡æ¯è·Ÿå…¶ä»–ä¿¡æ¯ä¸€æ ·ï¼Œåªæ˜¯å•çº¯åœ°ç”¨æ¥å±•ç¤ºï¼Œé‚£UserInfoç°åœ¨çš„è®¾è®¡å°±æ˜¯åˆç†çš„ã€‚å¦‚æœåœ°å€åœ¨å…¶ä»–æ¨¡å—ä¸­ä½¿ç”¨æ‰ï¼Œé‚£æˆ‘ä»¬æœ€å¥½å°†Addressä»UserInfoä¸­æ‹†åˆ†å‡ºæ¥ã€‚

æœ€æ¨èçš„åšæ³•æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå†™ä¸€ä¸ªæ»¡è¶³ä¸šåŠ¡éœ€æ±‚çš„ç±»ã€‚éšç€ä¸šåŠ¡çš„å‘å±•ï¼Œå¦‚æœç±»è¶Šæ¥è¶Šåºå¤§ï¼Œä»£ç è¶Šæ¥è¶Šå¤šï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¿™ä¸ªç²—ç²’åº¦çš„ç±»ï¼Œæ‹†åˆ†æˆå‡ ä¸ªæ›´ç»†ç²’åº¦çš„ç±»ã€‚è¿™å°±æ˜¯æ‰€è°“çš„æŒç»­é‡æ„ã€‚

ä¸€å‘³åœ°æ‹†åˆ†ç±»ï¼ˆå¼ºåˆ¶åº”ç”¨å•ä¸€èŒè´£åŸåˆ™ï¼‰ï¼Œåè€Œé™ä½ä»£ç çš„å¯ç»´æŠ¤æ€§ä»¥åŠå†…èšæ€§ã€‚ä¾‹å¦‚ï¼ŒSerializationç±»å®ç°äº†ä¸€ä¸ªç®€å•åè®®çš„åºåˆ—åŒ–å’Œååºåˆ—åŠŸèƒ½ï¼š

~~~java
public class Serialization {
  private static final String IDENTIFIER_STRING = "UEUEUE;";
  
  public Serialization() {}
  public String serialize(Map<String, String> object) {}
  public Map<String, String> deserialize(String text) {}
}

~~~

å¦‚æœæˆ‘ä»¬æƒ³è®©ç±»çš„èŒè´£æ›´åŠ å•ä¸€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯¹Serializationç±»è¿›ä¸€æ­¥æ‹†åˆ†ï¼Œæ‹†åˆ†æˆä¸€ä¸ªåªè´Ÿè´£åºåˆ—åŒ–å·¥ä½œçš„Serializerç±»ï¼Œå’Œå¦ä¸€ä¸ªåªè´Ÿè´£ååºåˆ—åŒ–å·¥ä½œçš„Deserializerç±»ï¼š

~~~java
public class Serializer {
  private static final String IDENTIFIER_STRING = "UEUEUE;";

  public Serializer() {}
  public String serialize(Map<String, String> object) {}
}

public class Deserializer {
  private static final String IDENTIFIER_STRING = "UEUEUE;";
  
  public Deserializer() {}
  public Map<String, String> deserialize(String text) {}
}
~~~

å¦‚æœæˆ‘ä»¬ä¿®æ”¹äº†åè®®çš„æ ¼å¼ï¼Œæ•°æ®æ ‡è¯†ä»â€œUEUEUEâ€æ”¹ä¸ºâ€œDFDFDFâ€ï¼Œé‚£Serializerç±»å’ŒDeserializerç±»éƒ½éœ€è¦åšç›¸åº”çš„ä¿®æ”¹ï¼Œä»£ç çš„å†…èšæ€§æ˜¾ç„¶æ²¡æœ‰åŸæ¥Serializationé«˜äº†ã€‚å¦‚æœè€Œå¿˜è®°äº†ä¿®æ”¹Deserializerç±»çš„ä»£ç ï¼Œé‚£å°±ä¼šå¯¼è‡´åºåˆ—åŒ–ã€ååºåˆ—åŒ–ä¸åŒ¹é…ï¼Œç¨‹åºè¿è¡Œå‡ºé”™ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‹†åˆ†ä¹‹åï¼Œä»£ç çš„å¯ç»´æŠ¤æ€§å˜å·®äº†ã€‚

è¦è®°ä½ï¼Œ**è¿™äº›åŸåˆ™ä¸ºäº†ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¤ç”¨æ€§ã€å†…èšæ€§ç­‰è€ŒæœåŠ¡**ã€‚å¦‚æœå¥—ç”¨æŸä¸ªåŸåˆ™åï¼Œå‘ç°ä»£ç çš„å¯ç»´æŠ¤æ€§ä¸‹é™äº†ï¼Œé‚£ä¹ˆå°±ä¸è¦å†ä½¿ç”¨è¯¥åŸåˆ™äº†ã€‚

## å¼€é—­åŸåˆ™ï¼ˆOpen Closed Principleï¼‰

> software entities (modules, classes, functions, etc.) should be open for extension , but closed for modification
>
> è½¯ä»¶å®ä½“ï¼ˆæ¨¡å—ã€ç±»ã€æ–¹æ³•ç­‰ï¼‰åº”è¯¥â€œå¯¹æ‰©å±•å¼€æ”¾ã€å¯¹ä¿®æ”¹å…³é—­â€ã€‚

å³æ·»åŠ ä¸€ä¸ªæ–°çš„åŠŸèƒ½åº”è¯¥æ˜¯åœ¨å·²æœ‰ä»£ç åŸºç¡€ä¸Šæ‰©å±•ä»£ç ï¼ˆæ–°å¢æ¨¡å—ã€ç±»ã€æ–¹æ³•ç­‰ï¼‰ï¼Œè€Œéä¿®æ”¹å·²æœ‰ä»£ç ï¼ˆä¿®æ”¹æ¨¡å—ã€ç±»ã€æ–¹æ³•ç­‰ï¼‰ã€‚å®ƒè§£å†³çš„æ˜¯ä»£ç çš„æ‰©å±•æ€§é—®é¢˜ã€‚

ä¸‹é¢ç»™å‡ºAPIæ¥å£ç›‘æ§å‘Šè­¦çš„ä¾‹å­ï¼š

~~~java
public class Alert {
  private AlertRule rule;						//AlertRuleå­˜å‚¨å‘Šè­¦è§„åˆ™
  private Notification notification;			//Notificationæ˜¯å‘Šè­¦é€šçŸ¥ç±»ï¼Œæ”¯æŒé‚®ä»¶ã€çŸ­ä¿¡ã€å¾®ä¿¡ã€æ‰‹æœºç­‰å¤šç§é€šçŸ¥æ¸ é“

  public Alert(AlertRule rule, Notification notification) {
    this.rule = rule;
    this.notification = notification;
  }

  public void check(String api, long requestCount, long errorCount, long durationOfSeconds) {
    long tps = requestCount / durationOfSeconds;
      
    // NotificationEmergencyLevelè¡¨ç¤ºé€šçŸ¥çš„ç´§æ€¥ç¨‹åº¦ï¼ŒåŒ…æ‹¬SEVEREï¼ˆä¸¥é‡ï¼‰ã€URGENCYï¼ˆç´§æ€¥ï¼‰ã€NORMALï¼ˆæ™®é€šï¼‰ã€TRIVIALï¼ˆæ— å…³ç´§è¦ï¼‰ï¼Œä¸åŒçš„ç´§æ€¥ç¨‹åº¦å¯¹åº”ä¸åŒçš„å‘é€æ¸ é“ã€‚
    if (tps > rule.getMatchedRule(api).getMaxTps()) {
      notification.notify(NotificationEmergencyLevel.URGENCY, "...");
    }
    if (errorCount > rule.getMatchedRule(api).getMaxErrorCount()) {
      notification.notify(NotificationEmergencyLevel.SEVERE, "...");
    }
  }
}

~~~

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªåŠŸèƒ½ï¼Œå½“æ¯ç§’é’Ÿæ¥å£è¶…æ—¶è¯·æ±‚ä¸ªæ•°ï¼Œè¶…è¿‡æŸä¸ªé¢„å…ˆè®¾ç½®çš„æœ€å¤§é˜ˆå€¼æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿè¦è§¦å‘å‘Šè­¦å‘é€é€šçŸ¥ã€‚

~~~java
//// æ”¹åŠ¨ä¸€ï¼šæ·»åŠ å‚æ•°timeoutCount
public void check(String api, long requestCount, long errorCount, long timeoutCount, long durationOfSeconds) {
    long tps = requestCount / durationOfSeconds;
    if (tps > rule.getMatchedRule(api).getMaxTps()) {
      notification.notify(NotificationEmergencyLevel.URGENCY, "...");
    }
    if (errorCount > rule.getMatchedRule(api).getMaxErrorCount()) {
      notification.notify(NotificationEmergencyLevel.SEVERE, "...");
    }
    // æ”¹åŠ¨äºŒï¼šæ·»åŠ æ¥å£è¶…æ—¶å¤„ç†é€»è¾‘
    long timeoutTps = timeoutCount / durationOfSeconds;
    if (timeoutTps > rule.getMatchedRule(api).getMaxTimeoutTps()) {
      notification.notify(NotificationEmergencyLevel.URGENCY, "...");
    }
  }
~~~

è¿™æ ·çš„ä»£ç ä¿®æ”¹å®é™…ä¸Šå­˜åœ¨æŒºå¤šé—®é¢˜çš„ã€‚ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¯¹æ¥å£è¿›è¡Œäº†ä¿®æ”¹ï¼Œè¿™å°±æ„å‘³ç€è°ƒç”¨è¿™ä¸ªæ¥å£çš„ä»£ç éƒ½è¦åšç›¸åº”çš„ä¿®æ”¹ã€‚å¦ä¸€æ–¹é¢ï¼Œä¿®æ”¹äº†check()å‡½æ•°ï¼Œç›¸åº”çš„å•å…ƒæµ‹è¯•éƒ½éœ€è¦ä¿®æ”¹ã€‚

å¦‚æœæˆ‘ä»¬éµå¾ªå¼€é—­åŸåˆ™ï¼Œæ¥å®ç°åŒæ ·çš„åŠŸèƒ½å‘¢ï¼Ÿæˆ‘ä»¬å…ˆé‡æ„ä¸€ä¸‹ä¹‹å‰çš„Alertä»£ç ï¼Œé‡æ„çš„å†…å®¹ä¸»è¦åŒ…å«ä¸¤éƒ¨åˆ†ï¼š

*   ç¬¬ä¸€éƒ¨åˆ†æ˜¯å°†check()å‡½æ•°çš„å¤šä¸ªå…¥å‚å°è£…æˆApiStatInfoç±»ï¼›
*   ç¬¬äºŒéƒ¨åˆ†æ˜¯å¼•å…¥handlerçš„æ¦‚å¿µï¼Œå°†ifåˆ¤æ–­é€»è¾‘åˆ†æ•£åœ¨å„ä¸ªhandlerä¸­ã€‚

~~~java
public class Alert {
  private List<AlertHandler> alertHandlers = new ArrayList<>();
  
  public void addAlertHandler(AlertHandler alertHandler) {
    this.alertHandlers.add(alertHandler);
  }

  public void check(ApiStatInfo apiStatInfo) {
    for (AlertHandler handler : alertHandlers) {
      handler.check(apiStatInfo);
    }
  }
}

// å°†åŸæœ¬çš„å‚æ•°æŠ½è±¡æˆä¸€ä¸ªç±»ã€‚
// è¿™å°†å‚æ•°è§£è€¦ï¼Œæ¯ä¸ªhandleçš„checkæ–¹æ³•ä½¿ç”¨è‡ªå·±æ‰€éœ€çš„å‚æ•°å³å¯ã€‚

public class ApiStatInfo {//çœç•¥constructor/getter/setteræ–¹æ³•
  private String api;
  private long requestCount;
  private long errorCount;
  private long durationOfSeconds;
}

//æ¯ä¸€ä¸ªHandleçš„checkæ–¹æ³•çš„é€»è¾‘éƒ½ä¸ä¸€æ ·ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæŠ½è±¡æ–¹æ³•æ¥è¡¨è¾¾è¿™ç§å·®å¼‚
public abstract class AlertHandler {
  protected AlertRule rule;
  protected Notification notification;
  public AlertHandler(AlertRule rule, Notification notification) {
    this.rule = rule;
    this.notification = notification;
  }
  public abstract void check(ApiStatInfo apiStatInfo);
}

//å…·ä½“å¤„ç†checkçš„é€»è¾‘
public class TpsAlertHandler extends AlertHandler {
  public TpsAlertHandler(AlertRule rule, Notification notification) {
    super(rule, notification);
  }

  @Override
  public void check(ApiStatInfo apiStatInfo) {
    long tps = apiStatInfo.getRequestCount()/ apiStatInfo.getDurationOfSeconds();
    if (tps > rule.getMatchedRule(apiStatInfo.getApi()).getMaxTps()) {
      notification.notify(NotificationEmergencyLevel.URGENCY, "...");
    }
  }
}

////å…·ä½“å¤„ç†checkçš„é€»è¾‘
public class ErrorAlertHandler extends AlertHandler {
  public ErrorAlertHandler(AlertRule rule, Notification notification){
    super(rule, notification);
  }

  @Override
  public void check(ApiStatInfo apiStatInfo) {
    if (apiStatInfo.getErrorCount() > rule.getMatchedRule(apiStatInfo.getApi()).getMaxErrorCount()) {
      notification.notify(NotificationEmergencyLevel.SEVERE, "...");
    }
  }
}


public class ApplicationContext {
  private AlertRule alertRule;
  private Notification notification;
  private Alert alert;
  
  public void initializeBeans() {
    alertRule = new AlertRule(/*.çœç•¥å‚æ•°.*/); //çœç•¥ä¸€äº›åˆå§‹åŒ–ä»£ç 
    notification = new Notification(/*.çœç•¥å‚æ•°.*/); //çœç•¥ä¸€äº›åˆå§‹åŒ–ä»£ç 
    alert = new Alert();
    //å‘alertæ³¨å†Œhandle
    alert.addAlertHandler(new TpsAlertHandler(alertRule, notification));
    alert.addAlertHandler(new ErrorAlertHandler(alertRule, notification));
  }
  public Alert getAlert() { return alert; }

  // é¥¿æ±‰å¼å•ä¾‹
  private static final ApplicationContext instance = new ApplicationContext();
  private ApplicationContext() {
    initializeBeans();
  }
  public static ApplicationContext getInstance() {
    return instance;
  }
}

public class Demo {
  public static void main(String[] args) {
    ApiStatInfo apiStatInfo = new ApiStatInfo();
    // ...çœç•¥è®¾ç½®apiStatInfoæ•°æ®å€¼çš„ä»£ç 
    ApplicationContext.getInstance().getAlert().check(apiStatInfo);
  }
}
~~~

å¦‚æœå†æ·»åŠ ä¸Šé¢è®²åˆ°çš„é‚£ä¸ªæ–°åŠŸèƒ½ï¼Œæ¯ç§’é’Ÿæ¥å£è¶…æ—¶è¯·æ±‚ä¸ªæ•°è¶…è¿‡æŸä¸ªæœ€å¤§é˜ˆå€¼å°±å‘Šè­¦ï¼Œæˆ‘ä»¬åˆè¯¥å¦‚ä½•æ”¹åŠ¨ä»£ç å‘¢ï¼Ÿ

~~~java
public class Alert { // ä»£ç æœªæ”¹åŠ¨... }
public class ApiStatInfo {//çœç•¥constructor/getter/setteræ–¹æ³•
  private String api;
  private long requestCount;
  private long errorCount;
  private long durationOfSeconds;
  private long timeoutCount; // æ”¹åŠ¨ä¸€ï¼šæ·»åŠ æ–°å­—æ®µ
}
public abstract class AlertHandler { //ä»£ç æœªæ”¹åŠ¨... }
public class TpsAlertHandler extends AlertHandler {//ä»£ç æœªæ”¹åŠ¨...}
public class ErrorAlertHandler extends AlertHandler {//ä»£ç æœªæ”¹åŠ¨...}
// æ”¹åŠ¨äºŒï¼šæ·»åŠ æ–°çš„handler
public class TimeoutAlertHandler extends AlertHandler {//çœç•¥ä»£ç ...}

public class ApplicationContext {
  private AlertRule alertRule;
  private Notification notification;
  private Alert alert;
  
  public void initializeBeans() {
    alertRule = new AlertRule(/*.çœç•¥å‚æ•°.*/); //çœç•¥ä¸€äº›åˆå§‹åŒ–ä»£ç 
    notification = new Notification(/*.çœç•¥å‚æ•°.*/); //çœç•¥ä¸€äº›åˆå§‹åŒ–ä»£ç 
    alert = new Alert();
    alert.addAlertHandler(new TpsAlertHandler(alertRule, notification));
    alert.addAlertHandler(new ErrorAlertHandler(alertRule, notification));
    // æ”¹åŠ¨ä¸‰ï¼šæ³¨å†Œhandler
    alert.addAlertHandler(new TimeoutAlertHandler(alertRule, notification));
  }
  //...çœç•¥å…¶ä»–æœªæ”¹åŠ¨ä»£ç ...
}

public class Demo {
  public static void main(String[] args) {
    ApiStatInfo apiStatInfo = new ApiStatInfo();
    // ...çœç•¥apiStatInfoçš„setå­—æ®µä»£ç 
    apiStatInfo.setTimeoutCount(289); // æ”¹åŠ¨å››ï¼šè®¾ç½®tiemoutCountå€¼
    ApplicationContext.getInstance().getAlert().check(apiStatInfo);
}

~~~

åœ¨æ·»åŠ æ–°çš„å‘Šè­¦é€»è¾‘çš„æ—¶å€™ï¼Œå°½ç®¡æ”¹åŠ¨äºŒï¼ˆæ·»åŠ æ–°çš„handlerç±»ï¼‰æ˜¯åŸºäºæ‰©å±•è€Œéä¿®æ”¹çš„æ–¹å¼æ¥å®Œæˆçš„ï¼Œä½†æ”¹åŠ¨ä¸€ã€ä¸‰ã€å››è²Œä¼¼ä¸æ˜¯åŸºäºæ‰©å±•è€Œæ˜¯åŸºäºä¿®æ”¹çš„æ–¹å¼æ¥å®Œæˆçš„ï¼Œé‚£æ”¹åŠ¨ä¸€ã€ä¸‰ã€å››ä¸å°±è¿èƒŒäº†å¼€é—­åŸåˆ™å—ï¼Ÿ

å¼€é—­åŸåˆ™å¯ä»¥åº”ç”¨åœ¨ä¸åŒç²’åº¦çš„ä»£ç ä¸­ï¼Œå¯ä»¥æ˜¯æ¨¡å—ï¼Œä¹Ÿå¯ä»¥ç±»ï¼Œè¿˜å¯ä»¥æ˜¯æ–¹æ³•ï¼ˆåŠå…¶å±æ€§ï¼‰ã€‚åŒæ ·ä¸€ä¸ªä»£ç æ”¹åŠ¨ï¼Œåœ¨ç²—ä»£ç ç²’åº¦ä¸‹ï¼Œè¢«è®¤å®šä¸ºâ€œä¿®æ”¹â€ï¼Œåœ¨ç»†ä»£ç ç²’åº¦ä¸‹ï¼Œåˆå¯ä»¥è¢«è®¤å®šä¸ºâ€œæ‰©å±•â€ã€‚é‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªä»£ç æ”¹åŠ¨æ˜¯å¦è¿èƒŒäº†å¼€æ”¾åŸåˆ™ï¼Ÿæˆ‘ä»¬è¦å›åˆ°è¿™æ¡åŸåˆ™çš„è®¾è®¡åˆè¡·ï¼š**åªè¦å®ƒæ²¡æœ‰ç ´ååŸæœ‰çš„ä»£ç çš„æ­£å¸¸è¿è¡Œï¼Œæ²¡æœ‰ç ´ååŸæœ‰çš„å•å…ƒæµ‹è¯•ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆæ ¼çš„ä»£ç æ”¹åŠ¨**ã€‚

æ·»åŠ ä¸€ä¸ªæ–°åŠŸèƒ½ï¼Œä¸å¯èƒ½ä»»ä½•æ¨¡å—ã€ç±»ã€æ–¹æ³•çš„ä»£ç éƒ½ä¸â€œä¿®æ”¹â€ï¼Œè¿™ä¸ªæ˜¯åšä¸åˆ°çš„ã€‚ç±»éœ€è¦åˆ›å»ºã€ç»„è£…ã€å¹¶ä¸”åšä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œæ‰èƒ½æ„å»ºæˆå¯è¿è¡Œçš„çš„ç¨‹åºï¼Œè¿™éƒ¨åˆ†ä»£ç çš„ä¿®æ”¹æ˜¯åœ¨æ‰€éš¾å…çš„ã€‚æˆ‘ä»¬è¦åšçš„æ˜¯å°½é‡**è®©ä¿®æ”¹æ“ä½œæ›´é›†ä¸­**ï¼Œyeè®©æœ€æ ¸å¿ƒã€æœ€å¤æ‚çš„é‚£éƒ¨åˆ†é€»è¾‘ä»£ç æ»¡è¶³å¼€é—­åŸåˆ™ã€‚æ€»ç»“æ¥è¯´å°±æ˜¯ï¼Œ**å¼€é—­åŸåˆ™å¹¶ä¸æ˜¯è¯´å®Œå…¨æœç»ä¿®æ”¹ï¼Œè€Œæ˜¯ä»¥æœ€å°çš„ä¿®æ”¹ä»£ç çš„ä»£ä»·æ¥å®Œæˆæ–°åŠŸèƒ½çš„å¼€å‘ã€‚**

æˆ‘ä»¬æ ¹æ®ç°æœ‰çš„éœ€æ±‚ï¼Œå»æ”¯æŒæ‰©å±•ç‚¹å³å¯ï¼Œ**æ²¡å¿…è¦ä¸ºå°†æ¥ä¸æ˜ç¡®è¦å®ç°çš„éœ€æ±‚æå‰ä¹°å•ï¼Œåšè¿‡åº¦è®¾è®¡**ã€‚ç­‰åˆ°ä»¥åæœ‰éœ€æ±‚é©±åŠ¨çš„æ—¶å€™ï¼Œå†é€šè¿‡é‡æ„ä»£ç çš„æ–¹å¼æ¥å®ç°æ‰©å±•çš„éœ€æ±‚ã€‚æ­¤å¤–ï¼Œå¼€é—­åŸåˆ™ä¹Ÿå¹¶ä¸æ˜¯å…è´¹çš„ã€‚æœ‰äº›æƒ…å†µä¸‹ï¼Œä»£ç çš„æ‰©å±•æ€§ä¼šè·Ÿå¯è¯»æ€§ç›¸å†²çªï¼ˆä¸Šé¢Alertå°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼‰ã€‚

## é‡Œå¼æ›¿æ¢åŸåˆ™ï¼ˆLiskov Substitution Principleï¼‰

è¿™ä¸ªåŸåˆ™æœ€æ—©æ˜¯åœ¨1986å¹´ç”±Barbara Liskovæå‡ºï¼Œä»–æ˜¯è¿™ä¹ˆæè¿°è¿™æ¡åŸåˆ™çš„

> If S is a subtype of T, then objects of type T may be replaced with objects of type S, without breaking the program
>
> å­ç±»å¯¹è±¡èƒ½å¤Ÿæ›¿æ¢ç¨‹åºä¸­çˆ¶ç±»å¯¹è±¡å‡ºç°çš„ä»»ä½•åœ°æ–¹ï¼Œå¹¶ä¸”ä¿è¯åŸæ¥ç¨‹åºçš„é€»è¾‘è¡Œä¸ºä¸å˜åŠæ­£ç¡®æ€§ä¸è¢«ç ´åã€‚

åœ¨1996å¹´ï¼ŒRobert Martinåœ¨ä»–çš„SOLIDåŸåˆ™ä¸­ï¼Œé‡æ–°æè¿°äº†è¿™ä¸ªåŸåˆ™

>Functions that use pointers of references to base classes must be able to use objects of derived classes without knowing itã€‚



~~~java
//çˆ¶ç±»Transporterä½¿ç”¨org.apache.httpåº“ä¸­çš„HttpClientç±»æ¥ä¼ è¾“ç½‘ç»œæ•°æ®ã€‚
public class Transporter {
  private HttpClient httpClient;
  
  public Transporter(HttpClient httpClient) {
    this.httpClient = httpClient;
  }

  public Response sendRequest(Request request) {
    // ...use httpClient to send request
  }
}

//å­ç±»SecurityTransporterç»§æ‰¿çˆ¶ç±»Transporterï¼Œå¢åŠ äº†é¢å¤–çš„åŠŸèƒ½ï¼Œæ”¯æŒä¼ è¾“appIdå’ŒappTokenå®‰å…¨è®¤è¯ä¿¡æ¯ã€‚
public class SecurityTransporter extends Transporter {
  private String appId;
  private String appToken;

  public SecurityTransporter(HttpClient httpClient, String appId, String appToken) {
    super(httpClient);
    this.appId = appId;
    this.appToken = appToken;
  }

  @Override
  public Response sendRequest(Request request) {
    if (StringUtils.isNotBlank(appId) && StringUtils.isNotBlank(appToken)) {
      request.addPayload("app-id", appId);
      request.addPayload("app-token", appToken);
    }
    return super.sendRequest(request);
  }
}

public class Demo {    
  public void demoFunction(Transporter transporter) {    
    Reuqest request = new Request();
    //...çœç•¥è®¾ç½®requestä¸­æ•°æ®å€¼çš„ä»£ç ...
    Response response = transporter.sendRequest(request);
    //...çœç•¥å…¶ä»–é€»è¾‘...
  }
}


Demo demo = new Demo();
// å­ç±»SecurityTransporterçš„è®¾è®¡å®Œå…¨ç¬¦åˆé‡Œå¼æ›¿æ¢åŸåˆ™ï¼Œå¯ä»¥æ›¿æ¢çˆ¶ç±»å‡ºç°çš„ä»»ä½•ä½ç½®
demo.demofunction(new SecurityTransporter(/*çœç•¥å‚æ•°*/););
~~~

ä¹ä¸€çœ‹ï¼Œè¿™ä¸å°±æ˜¯å¤šæ€å—ï¼Œå®é™…ä¸Šè¿˜æ˜¯æœ‰æ‰€å·®åˆ«çš„ã€‚å‡å¦‚æˆ‘ä»¬è¿™æ ·å®ç°SecurityTransporterå­ç±»

~~~java
public class SecurityTransporter extends Transporter {
  //...çœç•¥å…¶ä»–ä»£ç ..
  @Override
  public Response sendRequest(Request request) {
    //å¦‚æœappIdæˆ–è€…appTokenæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ç›´æ¥æŠ›å‡ºNoAuthorizationRuntimeExceptionæœªæˆæƒå¼‚å¸¸
    if (StringUtils.isBlank(appId) || StringUtils.isBlank(appToken)) {
      throw new NoAuthorizationRuntimeException(...);
    }
    request.addPayload("app-id", appId);
    request.addPayload("app-token", appToken);
    return super.sendRequest(request);
  }
}
~~~

æ­¤æ—¶ï¼Œå¦‚æœä¼ é€’è¿›demoFunction()å‡½æ•°çš„æ˜¯çˆ¶ç±»Transporterå¯¹è±¡ï¼Œé‚£demoFunction()å‡½æ•°å¹¶ä¸ä¼šæœ‰å¼‚å¸¸æŠ›å‡ºï¼Œä½†å¦‚æœä¼ é€’ç»™demoFunction()å‡½æ•°çš„æ˜¯å­ç±»SecurityTransporterå¯¹è±¡ï¼Œé‚£demoFunction()æœ‰å¯èƒ½ä¼šæœ‰å¼‚å¸¸æŠ›å‡ºã€‚æ•´ä¸ªç¨‹åºçš„é€»è¾‘è¡Œä¸ºæœ‰äº†æ”¹å˜ã€‚

å®é™…ä¸Šï¼Œé‡Œå¼æ›¿æ¢åŸåˆ™è¿˜æœ‰å¦å¤–ä¸€ä¸ªæ›´åŠ èƒ½è½åœ°ã€æ›´æœ‰æŒ‡å¯¼æ„ä¹‰çš„æè¿°ï¼Œé‚£å°±æ˜¯**â€œDesign By Contractâ€ï¼ˆæŒ‰ç…§åè®®æ¥è®¾è®¡ï¼‰**

å­ç±»åœ¨è®¾è®¡çš„æ—¶å€™ï¼Œè¦éµå®ˆçˆ¶ç±»çš„è¡Œä¸ºçº¦å®šï¼ˆæˆ–è€…å«åè®®ï¼‰ã€‚å¦‚æœçˆ¶ç±»å®šä¹‰äº†å‡½æ•°çš„è¡Œä¸ºçº¦å®šï¼Œé‚£å­ç±»ä¸èƒ½æ”¹å˜å‡½æ•°åŸæœ‰çš„è¡Œä¸ºçº¦å®šï¼Œä½†å¯ä»¥æ”¹å˜å‡½æ•°çš„å†…éƒ¨å®ç°é€»è¾‘ã€‚è¿™é‡Œçš„è¡Œä¸ºçº¦å®šåŒ…æ‹¬ï¼šå‡½æ•°å£°æ˜è¦å®ç°çš„åŠŸèƒ½ï¼›å¯¹è¾“å…¥ã€è¾“å‡ºã€å¼‚å¸¸çš„çº¦å®šï¼›ç”šè‡³åŒ…æ‹¬æ³¨é‡Šä¸­æ‰€ç½—åˆ—çš„ä»»ä½•ç‰¹æ®Šè¯´æ˜ã€‚



## æ¥å£éš”ç¦»åŸåˆ™ï¼ˆInterface Segregation Principleï¼‰

> Clients should not be forced to depend upon interfaces that they do not use
>
> ä¸åº”è¯¥å¼ºè¿«å®¢æˆ·ç«¯ä¾èµ–å®ƒä¸éœ€è¦çš„æ¥å£

åœ¨è¿™æ¡åŸåˆ™ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠâ€œæ¥å£â€ç†è§£ä¸ºä¸‹é¢ä¸‰ç§ä¸œè¥¿ï¼š

*   ä¸€ç»„APIæ¥å£é›†åˆ
*   å•ä¸ªAPIæ¥å£æˆ–å‡½æ•°
*   OOPä¸­çš„æ¥å£æ¦‚å¿µ

æ¥å£éš”ç¦»åŸåˆ™è·Ÿå•ä¸€èŒè´£åŸåˆ™æœ‰ç‚¹ç±»ä¼¼ï¼Œä¸è¿‡è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«ã€‚æ¥å£éš”ç¦»åŸåˆ™ç›¸å¯¹äºå•ä¸€èŒè´£åŸåˆ™ï¼Œå®ƒæ›´ä¾§é‡å•ä¸€èŒè´£é‡Œçš„æ¥å£è®¾è®¡ï¼Œå¹¶ä¸”å®ƒçš„æ€è€ƒçš„è§’åº¦ä¸åŒï¼Œå³é€šè¿‡è€ƒè™‘è°ƒç”¨è€…å¦‚ä½•ä½¿ç”¨æ¥å£ï¼Œæ¥é—´æ¥åœ°åˆ¤å®šæ¥å£æ˜¯å¦èŒè´£å•ä¸€ã€‚å¦‚æœè°ƒç”¨è€…åªä½¿ç”¨éƒ¨åˆ†æ¥å£æˆ–æ¥å£çš„éƒ¨åˆ†åŠŸèƒ½ï¼Œé‚£æ¥å£çš„è®¾è®¡å°±ä¸å¤ŸèŒè´£å•ä¸€ã€‚

æ¥ä¸‹æ¥ï¼Œåˆ†åˆ«æŒ‰ç…§ä¸åŒçš„ç†è§£æ–¹å¼ï¼Œæ¥è§£è¯»è¿™æ¡åŸåˆ™ï¼š

### â€œæ¥å£â€ç†è§£ä¸ºä¸€ç»„æ¥å£é›†åˆ

~~~java
//å¾®æœåŠ¡ç”¨æˆ·ç³»ç»Ÿæä¾›äº†ä¸€ç»„è·Ÿç”¨æˆ·ç›¸å…³çš„APIç»™å…¶ä»–ç³»ç»Ÿä½¿ç”¨

public interface UserService {
  boolean register(String cellphone, String password);
  boolean login(String cellphone, String password);
  UserInfo getUserInfoById(long id);
  UserInfo getUserInfoByCellphone(String cellphone);
}

public class UserServiceImpl implements UserService {
  //...
}
~~~

å¦‚æœç°åœ¨æœ‰åˆ é™¤ç”¨æˆ·çš„éœ€æ±‚ï¼Œé‚£ä¹ˆç®€å•ç›´æ¥çš„æ–¹æ³•å°±æ˜¯åœ¨UserServiceä¸­æ–°æ·»åŠ ä¸€ä¸ªdeleteUserByCellphone()æˆ–deleteUserById()æ¥å£ã€‚ä½†æ˜¯ï¼Œè¿™ä¹Ÿéšè—äº†ä¸€äº›å®‰å…¨éšæ‚£ã€‚åˆ é™¤ç”¨æˆ·æ˜¯ä¸€ä¸ªéå¸¸æ…é‡çš„æ“ä½œï¼Œæˆ‘ä»¬åªå¸Œæœ›é€šè¿‡åå°ç®¡ç†ç³»ç»Ÿæ¥æ‰§è¡Œï¼Œè€Œä¸æ˜¯æ‰€æœ‰ä½¿ç”¨åˆ°UserServiceçš„ç³»ç»Ÿã€‚æœ€å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯ä»æ¶æ„è®¾è®¡çš„å±‚é¢ï¼Œé€šè¿‡æ¥å£é‰´æƒçš„æ–¹å¼æ¥é™åˆ¶æ¥å£çš„è°ƒç”¨ã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä»ä»£ç è®¾è®¡çš„å±‚é¢ï¼Œå‚ç…§æ¥å£éš”ç¦»åŸåˆ™ï¼Œå°†åˆ é™¤æ¥å£å•ç‹¬æ”¾åˆ°å¦å¤–ä¸€ä¸ªæ¥å£RestrictedUserServiceä¸­ã€‚

~~~java
public interface UserService {
  boolean register(String cellphone, String password);
  boolean login(String cellphone, String password);
  UserInfo getUserInfoById(long id);
  UserInfo getUserInfoByCellphone(String cellphone);
}

public interface RestrictedUserService {
  boolean deleteUserByCellphone(String cellphone);
  boolean deleteUserById(long id);
}

public class UserServiceImpl implements UserService, RestrictedUserService {
  // ...çœç•¥å®ç°ä»£ç ...
}
~~~

### â€œæ¥å£â€ç†è§£ä¸ºå•ä¸ªAPIæ¥å£æˆ–å‡½æ•°

æ­¤æ—¶ï¼Œé‚£æ¥å£éš”ç¦»åŸåˆ™å°±å¯ä»¥ç†è§£ä¸ºï¼šå‡½æ•°çš„è®¾è®¡è¦åŠŸèƒ½å•ä¸€ï¼Œä¸è¦å°†å¤šä¸ªä¸åŒçš„åŠŸèƒ½é€»è¾‘åœ¨ä¸€ä¸ªå‡½æ•°ä¸­å®ç°ã€‚

~~~java
public class Statistics {
  private Long max;
  private Long min;
  private Long average;
  private Long sum;
  private Long percentile99;
  private Long percentile999;
  //...çœç•¥constructor/getter/setterç­‰æ–¹æ³•...
}

public Statistics count(Collection<Long> dataSet) {
  Statistics statistics = new Statistics();
  //...çœç•¥è®¡ç®—é€»è¾‘...
  return statistics;
}

~~~

count()åŒ…å«å¾ˆå¤šä¸åŒçš„ç»Ÿè®¡åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼Œæ±‚æœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ç­‰ç­‰ã€‚æŒ‰ç…§æ¥å£éš”ç¦»åŸåˆ™ï¼Œæˆ‘ä»¬åº”è¯¥æŠŠcount()å‡½æ•°æ‹†æˆå‡ ä¸ªæ›´å°ç²’åº¦çš„å‡½æ•°ï¼Œæ¯ä¸ªå‡½æ•°è´Ÿè´£ä¸€ä¸ªç‹¬ç«‹çš„ç»Ÿè®¡åŠŸèƒ½ã€‚æ‹†åˆ†ä¹‹åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~java
public Long max(Collection<Long> dataSet) { //... }
public Long min(Collection<Long> dataSet) { //... } 
public Long average(Colletion<Long> dataSet) { //... }
// ...çœç•¥å…¶ä»–ç»Ÿè®¡å‡½æ•°...
~~~

### â€œæ¥å£â€ç†è§£ä¸ºOOPä¸­çš„æ¥å£

å‡è®¾é¡¹ç›®ä¸­ç”¨åˆ°äº†ä¸‰ä¸ªå¤–éƒ¨ç³»ç»Ÿï¼šRedisã€MySQLã€Kafkaã€‚æ¯ä¸ªç³»ç»Ÿéƒ½å¯¹åº”ä¸€ç³»åˆ—é…ç½®ä¿¡æ¯ï¼Œæ¯”å¦‚åœ°å€ã€ç«¯å£ã€è®¿é—®è¶…æ—¶æ—¶é—´ç­‰ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åˆ†åˆ«è®¾è®¡å®ç°äº†ä¸‰ä¸ªConfigurationç±»ï¼šRedisConfigã€MysqlConfigã€KafkaConfigï¼š

~~~java
public class RedisConfig {
    private ConfigSource configSource; 	//é…ç½®ä¸­å¿ƒï¼ˆæ¯”å¦‚zookeeperï¼‰
    private String address;
    private int timeout;
    private int maxTotal;
    //çœç•¥å…¶ä»–é…ç½®: maxWaitMillis,maxIdle,minIdle...

    public RedisConfig(ConfigSource configSource) {
        this.configSource = configSource;
    }

    public String getAddress() {
        return this.address;
    }
    //...çœç•¥å…¶ä»–get()ã€init()æ–¹æ³•...

    public void update() {
      //ä»configSourceåŠ è½½é…ç½®åˆ°address/timeout/maxTotal...
    }
}

public class KafkaConfig { //...çœç•¥... }
public class MysqlConfig { //...çœç•¥... }
~~~

ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ–°çš„åŠŸèƒ½éœ€æ±‚ï¼Œå¸Œæœ›æ”¯æŒRediså’ŒKafkaé…ç½®ä¿¡æ¯çš„çƒ­æ›´æ–°ã€‚æ‰€è°“**â€œçƒ­æ›´æ–°ï¼ˆhot updateï¼‰â€**å°±æ˜¯ï¼šå¦‚æœåœ¨é…ç½®ä¸­å¿ƒé‡Œæ›´æ”¹äº†é…ç½®ä¿¡æ¯ï¼Œåœ¨ä¸ç”¨é‡å¯ç³»ç»Ÿçš„æƒ…å†µä¸‹ï¼Œå°±èƒ½å°†æœ€æ–°çš„é…ç½®ä¿¡æ¯åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ä½†æ˜¯ï¼Œå› ä¸ºæŸäº›åŸå› ï¼Œæˆ‘ä»¬å¹¶ä¸å¸Œæœ›å¯¹MySQLçš„é…ç½®ä¿¡æ¯è¿›è¡Œçƒ­æ›´æ–°ã€‚

ä¸ºäº†å®ç°è¿™æ ·ä¸€ä¸ªåŠŸèƒ½éœ€æ±‚ï¼Œæˆ‘ä»¬è®¾è®¡å®ç°äº†ä¸€ä¸ªScheduledUpdaterç±»ï¼Œä»¥å›ºå®šæ—¶é—´é¢‘ç‡ï¼ˆperiodInSecondsï¼‰æ¥è°ƒç”¨RedisConfigã€KafkaConfigçš„update()æ–¹æ³•æ›´æ–°é…ç½®ä¿¡æ¯ï¼š

~~~java
public interface Updater {
  void update();
}

public class RedisConfig implemets Updater {
  //...çœç•¥å…¶ä»–å±æ€§å’Œæ–¹æ³•...
  @Override
  public void update() { //... }
}

public class KafkaConfig implements Updater {
  //...çœç•¥å…¶ä»–å±æ€§å’Œæ–¹æ³•...
  @Override
  public void update() { //... }
}

public class MysqlConfig { //...çœç•¥å…¶ä»–å±æ€§å’Œæ–¹æ³•... }

public class ScheduledUpdater {
	//çº¿ç¨‹æ± 
    private final ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor();;
    private long initialDelayInSeconds;
    private long periodInSeconds;
    private Updater updater;

    public ScheduleUpdater(Updater updater, long initialDelayInSeconds, long periodInSeconds) {
        this.updater = updater;
        this.initialDelayInSeconds = initialDelayInSeconds;
        this.periodInSeconds = periodInSeconds;
    }

    public void run() {
        executor.scheduleAtFixedRate(new Runnable() {
            @Override
            public void run() {
                updater.update();
            }
        }, this.initialDelayInSeconds, this.periodInSeconds, TimeUnit.SECONDS);
    }
}

public class Application {
  ConfigSource configSource = new ZookeeperConfigSource(/*çœç•¥å‚æ•°*/);
  public static final RedisConfig redisConfig = new RedisConfig(configSource);
  public static final KafkaConfig kafkaConfig = new KakfaConfig(configSource);
  public static final MySqlConfig mysqlConfig = new MysqlConfig(configSource);

  public static void main(String[] args) {
    ScheduledUpdater redisConfigUpdater = new ScheduledUpdater(redisConfig, 300, 300);
    redisConfigUpdater.run();
    
  
    ScheduledUpdater kafkaConfigUpdater = new ScheduledUpdater(kafkaConfig, 60, 60);
    kafkaConfigUpdater.run();
  }
}

~~~

ç°åœ¨ï¼Œæˆ‘ä»¬åˆæœ‰äº†ä¸€ä¸ªæ–°çš„ç›‘æ§åŠŸèƒ½éœ€æ±‚ã€‚é€šè¿‡å‘½ä»¤è¡Œæ¥æŸ¥çœ‹Zookeeperä¸­çš„é…ç½®ä¿¡æ¯æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å¼€å‘ä¸€ä¸ªå†…åµŒçš„SimpleHttpServerï¼Œè¾“å‡ºé¡¹ç›®çš„é…ç½®ä¿¡æ¯åˆ°ä¸€ä¸ªå›ºå®šçš„HTTPåœ°å€ï¼Œæ¯”å¦‚ï¼š[http://127.0.0.1:2389/config](http://127.0.0.1:2389/config) ã€‚ä¸è¿‡ï¼Œå‡ºäºæŸäº›åŸå› ï¼Œæˆ‘ä»¬åªæƒ³æš´éœ²MySQLå’ŒRedisçš„é…ç½®ä¿¡æ¯ï¼Œä¸æƒ³æš´éœ²Kafkaçš„é…ç½®ä¿¡æ¯ã€‚

~~~java
public interface Updater {
  void update();
}

public interface Viewer {
  String outputInPlainText();
  Map<String, String> output();
}

public class RedisConfig implemets Updater, Viewer {
  //...çœç•¥å…¶ä»–å±æ€§å’Œæ–¹æ³•...
  @Override
  public void update() { //... }
  @Override
  public String outputInPlainText() { //... }
  @Override
  public Map<String, String> output() { //...}
}

public class KafkaConfig implements Updater {
  //...çœç•¥å…¶ä»–å±æ€§å’Œæ–¹æ³•...
  @Override
  public void update() { //... }
}

public class MysqlConfig implements Viewer {
  //...çœç•¥å…¶ä»–å±æ€§å’Œæ–¹æ³•...
  @Override
  public String outputInPlainText() { //... }
  @Override
  public Map<String, String> output() { //...}
}

public class SimpleHttpServer {
  private String host;
  private int port;
  private Map<String, List<Viewer>> viewers = new HashMap<>();
  
  public SimpleHttpServer(String host, int port) {//...}
  
  public void addViewers(String urlDirectory, Viewer viewer) {
    if (!viewers.containsKey(urlDirectory)) {
      viewers.put(urlDirectory, new ArrayList<Viewer>());
    }
    this.viewers.get(urlDirectory).add(viewer);
  }
  
  public void run() { //... }
}

public class Application {
    ConfigSource configSource = new ZookeeperConfigSource();
    public static final RedisConfig redisConfig = new RedisConfig(configSource);
    public static final KafkaConfig kafkaConfig = new KakfaConfig(configSource);
    public static final MySqlConfig mysqlConfig = new MySqlConfig(configSource);
    
    public static void main(String[] args) {
        ScheduledUpdater redisConfigUpdater =
            new ScheduledUpdater(redisConfig, 300, 300);
        redisConfigUpdater.run();
        
        ScheduledUpdater kafkaConfigUpdater =
            new ScheduledUpdater(kafkaConfig, 60, 60);
        redisConfigUpdater.run();
        
        SimpleHttpServer simpleHttpServer = new SimpleHttpServer(â€œ127.0.0.1â€, 2389);
        simpleHttpServer.addViewer("/config", redisConfig);
        simpleHttpServer.addViewer("/config", mysqlConfig);
        simpleHttpServer.run();
    }
}
~~~

Updaterå’ŒVieweræ¥å£éƒ½æ˜¯èŒè´£å•ä¸€çš„ï¼Œæ»¡è¶³æ¥å£éš”ç¦»åŸåˆ™ã€‚

## ä¾èµ–åè½¬åŸåˆ™

### æ§åˆ¶åè½¬

åœ¨ä»‹ç»ä¾èµ–åè½¬åŸåˆ™ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è®¤è¯†**â€œæ§åˆ¶åè½¬â€ï¼ˆInversion Of Controlï¼‰**ã€‚è¿™é‡Œçš„â€œæ§åˆ¶â€æŒ‡çš„æ˜¯å¯¹ç¨‹åºæ‰§è¡Œæµç¨‹çš„æ§åˆ¶ï¼Œè€Œâ€œåè½¬â€æŒ‡çš„æ˜¯è°ƒç”¨è€…ä¸è¢«è°ƒç”¨è€…ä¹‹é—´çš„æ§åˆ¶æƒè½¬ç§»ã€‚ä¾‹å¦‚ï¼Œåœ¨æ²¡æœ‰ä½¿ç”¨æ¡†æ¶ä¹‹å‰ï¼Œç¨‹åºå‘˜è‡ªå·±æ§åˆ¶æ•´ä¸ªç¨‹åºçš„æ‰§è¡Œã€‚åœ¨ä½¿ç”¨æ¡†æ¶ä¹‹åï¼Œæ•´ä¸ªç¨‹åºçš„æ‰§è¡Œæµç¨‹å¯ä»¥é€šè¿‡æ¡†æ¶æ¥æ§åˆ¶ã€‚æµç¨‹çš„æ§åˆ¶æƒä»ç¨‹åºå‘˜â€œåè½¬â€åˆ°äº†æ¡†æ¶ã€‚

~~~java
public class UserServiceTest {
  public static boolean doTest() {
    // ... 
  }
  
  public static void main(String[] args) {//è¿™éƒ¨åˆ†é€»è¾‘å¯ä»¥æ”¾åˆ°æ¡†æ¶ä¸­
    if (doTest()) {
      System.out.println("Test succeed.");
    } else {
      System.out.println("Test failed.");
    }
  }
}

~~~

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæ‰€æœ‰çš„æµç¨‹éƒ½ç”±ç¨‹åºå‘˜æ¥æ§åˆ¶ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æŠ½è±¡å‡ºä¸€ä¸ªè¿™æ ·ä¸€ä¸ªæ¡†æ¶ï¼š

~~~java
public abstract class TestCase {
  public void run() {
    if (doTest()) {
      System.out.println("Test succeed.");
    } else {
      System.out.println("Test failed.");
    }
  }
  
  public abstract boolean doTest();
}

public class JunitApplication {
  private static final List<TestCase> testCases = new ArrayList<>();
  
  public static void register(TestCase testCase) {
    testCases.add(testCase);
  }
  
  public static final void main(String[] args) {
    for (TestCase case: testCases) {
      case.run();
    }
  }
}
~~~

æŠŠè¿™ä¸ªç®€åŒ–ç‰ˆæœ¬çš„æµ‹è¯•æ¡†æ¶å¼•å…¥åˆ°å·¥ç¨‹ä¸­ä¹‹åï¼Œæˆ‘ä»¬å‘doTestå¡«å……å…·ä½“çš„æµ‹è¯•ä»£ç å³å¯ï¼Œè€Œæ— éœ€è€ƒè™‘ç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼š

~~~java
public class UserServiceTest extends TestCase {
  @Override
  public boolean doTest() {
    // ... 
  }
}

// æ³¨å†Œæ“ä½œè¿˜å¯ä»¥é€šè¿‡é…ç½®çš„æ–¹å¼æ¥å®ç°ï¼Œä¸éœ€è¦ç¨‹åºå‘˜æ˜¾ç¤ºè°ƒç”¨register()
JunitApplication.register(new UserServiceTest();
~~~

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†æ¨¡æ¿è®¾è®¡æ¨¡å¼ï¼Œæ¥å®ç°äº†æ§åˆ¶åè½¬ã€‚æ­¤å¤–ï¼Œæ§åˆ¶åè½¬ä¹Ÿå¯ä»¥é€šè¿‡ä¾èµ–æ³¨å…¥ç­‰æ–¹æ³•æ¥å®ç°ã€‚

### ä¾èµ–æ³¨å…¥

**ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰**ï¼šä¸é€šè¿‡new()çš„æ–¹å¼åœ¨ç±»å†…éƒ¨åˆ›å»ºä¾èµ–ç±»å¯¹è±¡ï¼Œè€Œæ˜¯å°†ä¾èµ–çš„ç±»å¯¹è±¡åœ¨å¤–éƒ¨åˆ›å»ºå¥½ä¹‹åï¼Œé€šè¿‡æ„é€ å‡½æ•°ã€å‡½æ•°å‚æ•°ç­‰æ–¹å¼ä¼ é€’ï¼ˆæˆ–æ³¨å…¥ï¼‰ç»™ç±»ä½¿ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå°†å¯¹è±¡çš„åˆ›å»ºåè½¬ç»™ä¸Šå±‚æ¥å¤„ç†ã€‚è¯»è€…å¯èƒ½è®¤ä¸ºè¿™æ ·åšç ´åäº†å°è£…æ€§ï¼Œå®åˆ™ä¸ç„¶ï¼Œå› ä¸ºä»…ä»…æ˜¯å°†ç§æœ‰çŠ¶æ€çš„åˆå§‹åŒ–æ“ä½œäº¤ç»™è°ƒç”¨è€…æ¥è´Ÿè´£è€Œå·²ï¼Œå¹¶æœªæš´éœ²è¯¥çŠ¶æ€çš„ä¿®æ”¹æ–¹æ³•ã€‚

æˆ‘ä»¬ç°åœ¨è¦è®¾è®¡è´Ÿè´£æ¶ˆæ¯æ¨é€çš„Notificationç±»ã€‚å®ƒä¾èµ–MessageSenderç±»ï¼Œæ¥å®ç°æ¨é€å•†å“ä¿ƒé”€ã€éªŒè¯ç ç­‰æ¶ˆæ¯ç»™ç”¨æˆ·çš„åŠŸèƒ½ã€‚æˆ‘ä»¬åˆ†åˆ«ç”¨ä¾èµ–æ³¨å…¥å’Œéä¾èµ–æ³¨å…¥ä¸¤ç§æ–¹å¼æ¥å®ç°ä¸€ä¸‹ï¼š

~~~java
// éä¾èµ–æ³¨å…¥å®ç°æ–¹å¼
public class Notification {
  private MessageSender messageSender;
  
  public Notification() {
    this.messageSender = new MessageSender(); //æ­¤å¤„æœ‰ç‚¹åƒhardcode
  }
  
  public void sendMessage(String cellphone, String message) {
    //...çœç•¥æ ¡éªŒé€»è¾‘ç­‰...
    this.messageSender.send(cellphone, message);
  }
}

public class MessageSender {
  public void send(String cellphone, String message) {
    //....
  }
}
// ä½¿ç”¨Notification
Notification notification = new Notification();
~~~



~~~java
// ä¾èµ–æ³¨å…¥çš„å®ç°æ–¹å¼
public class Notification {
  private MessageSender messageSender;
  
  // é€šè¿‡æ„é€ å‡½æ•°å°†messageSenderä¼ é€’è¿›æ¥
  public Notification(MessageSender messageSender) {
    this.messageSender = messageSender;
  }
  
  public void sendMessage(String cellphone, String message) {
    //...çœç•¥æ ¡éªŒé€»è¾‘ç­‰...
    this.messageSender.send(cellphone, message);
  }
}
//ä½¿ç”¨Notification
MessageSender messageSender = new MessageSender();
Notification notification = new Notification(messageSender);
~~~

ä¾èµ–æ³¨å…¥çš„å®ç°æ–¹å¼æé«˜äº†ä»£ç çš„æ‰©å±•æ€§ï¼Œæˆ‘ä»¬å¯ä»¥çµæ´»åœ°æ›¿æ¢ä¾èµ–çš„ç±»ï¼Œè¿™æ˜¯ç¬¦åˆå¼€é—­åŸåˆ™çš„ã€‚åˆ›å»ºå¯¹è±¡ã€ç»„è£…ï¼ˆæˆ–æ³¨å…¥ï¼‰å¯¹è±¡çš„å·¥ä½œä»…ä»…æ˜¯ç”±æ›´ä¸Šå±‚ä»£ç æ¥è´Ÿè´£è€Œå·²ï¼Œè¿™è¿˜æ˜¯éœ€è¦ç¨‹åºå‘˜è‡ªå·±æ¥å®Œæˆè¿™äº›å·¥ä½œï¼š

~~~java
public class Demo {
  public static final void main(String args[]) {
    MessageSender sender = new SmsSender(); //åˆ›å»ºå¯¹è±¡
    Notification notification = new Notification(sender);//ä¾èµ–æ³¨å…¥
    notification.sendMessage("13918942177", "çŸ­ä¿¡éªŒè¯ç ï¼š2346");
  }
}
~~~

åœ¨å®é™…çš„è½¯ä»¶å¼€å‘ä¸­ï¼Œä¸€äº›é¡¹ç›®å¯èƒ½ä¼šæ¶‰åŠå‡ åã€ä¸Šç™¾ã€ç”šè‡³å‡ ç™¾ä¸ªç±»ï¼Œç±»å¯¹è±¡çš„åˆ›å»ºå’Œä¾èµ–æ³¨å…¥ä¼šå˜å¾—éå¸¸å¤æ‚ã€‚è€Œå¯¹è±¡åˆ›å»ºå’Œä¾èµ–æ³¨å…¥çš„å·¥ä½œï¼Œæœ¬èº«è·Ÿå…·ä½“çš„ä¸šåŠ¡æ— å…³ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æŠ½è±¡æˆæ¡†æ¶æ¥è‡ªåŠ¨å®Œæˆï¼Œå‡å°‘æ‰‹åŠ¨è£…é…å‡ºé”™çš„å¯èƒ½æ€§ã€‚

å®é™…ä¸Šï¼Œç°æˆçš„ä¾èµ–æ³¨å…¥æ¡†æ¶æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚Google Guiceã€Java Springã€Pico Containerã€Butterfly Containerç­‰ã€‚

### ä¾èµ–åè½¬åŸåˆ™

>High-level modules shouldnâ€™t depend on low-level modules. Both modules should depend on abstractions. In addition, abstractions shouldnâ€™t depend on details. Details depend on abstractions.
>
>é«˜å±‚æ¨¡å—ä¸è¦ä¾èµ–ä½å±‚æ¨¡å—ã€‚é«˜å±‚æ¨¡å—å’Œä½å±‚æ¨¡å—åº”è¯¥é€šè¿‡æŠ½è±¡æ¥äº’ç›¸ä¾èµ–ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒæŠ½è±¡ä¸è¦ä¾èµ–å…·ä½“å®ç°ç»†èŠ‚ï¼Œå…·ä½“å®ç°ç»†èŠ‚ä¾èµ–æŠ½è±¡ã€‚



æ‰€è°“é«˜å±‚æ¨¡å—å’Œä½å±‚æ¨¡å—çš„åˆ’åˆ†ï¼Œç®€å•æ¥è¯´å°±æ˜¯ï¼Œåœ¨è°ƒç”¨é“¾ä¸Šï¼Œè°ƒç”¨è€…å±äºé«˜å±‚ï¼Œè¢«è°ƒç”¨è€…å±äºä½å±‚ã€‚åœ¨å¹³æ—¶çš„ä¸šåŠ¡ä»£ç å¼€å‘ä¸­ï¼Œé«˜å±‚æ¨¡å—ä¾èµ–åº•å±‚æ¨¡å—æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ã€‚å®é™…ä¸Šï¼Œè¿™æ¡åŸåˆ™ä¸»è¦è¿˜æ˜¯ç”¨æ¥æŒ‡å¯¼æ¡†æ¶å±‚é¢çš„è®¾è®¡ã€‚æˆ‘ä»¬æ‹¿Tomcatè¿™ä¸ªServletå®¹å™¨ä½œä¸ºä¾‹å­æ¥è§£é‡Šä¸€ä¸‹ã€‚

æŒ‰ç…§ä¹‹å‰çš„åˆ’åˆ†åŸåˆ™ï¼ŒTomcatå°±æ˜¯é«˜å±‚æ¨¡å—ï¼Œæˆ‘ä»¬ç¼–å†™çš„Webåº”ç”¨ç¨‹åºä»£ç å°±æ˜¯ä½å±‚æ¨¡å—ã€‚Tomcatå’Œåº”ç”¨ç¨‹åºä»£ç ä¹‹é—´å¹¶æ²¡æœ‰ç›´æ¥çš„ä¾èµ–å…³ç³»ï¼Œä¸¤è€…éƒ½ä¾èµ–åŒä¸€ä¸ªâ€œæŠ½è±¡â€ï¼Œä¹Ÿå°±æ˜¯Servletè§„èŒƒã€‚Servletè§„èŒƒä¸ä¾èµ–å…·ä½“çš„Tomcatå®¹å™¨å’Œåº”ç”¨ç¨‹åºçš„å®ç°ç»†èŠ‚ï¼Œè€ŒTomcatå®¹å™¨å’Œåº”ç”¨ç¨‹åºä¾èµ–Servletè§„èŒƒã€‚

è¿™ä¸ªè§„èŒƒæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒå°†ä¸¤ä¸ªå˜åŒ–çš„éƒ¨åˆ†éš”ç¦»å¼€æ¥ï¼Œè‡ªèº«æ˜¯ä¸€ä¸ªä¸å˜çš„éƒ¨åˆ†ã€‚

## KISS

KISSåŸåˆ™çš„è‹±æ–‡æè¿°æœ‰å¥½å‡ ä¸ªç‰ˆæœ¬

>*   Keep It Simple and Stupid.
>*   Keep It Short and Simple.
>*   Keep It Simple and Straightforward

å®ƒä»¬çš„æ ¸å¿ƒæ„æ€éƒ½æ˜¯ï¼šå°½é‡ä¿æŒç®€å•ã€‚

KISSåŸåˆ™å°±æ˜¯ä¿æŒä»£ç å¯è¯»å’Œå¯ç»´æŠ¤çš„é‡è¦æ‰‹æ®µã€‚ä»£ç è¶³å¤Ÿç®€å•ï¼Œä¹Ÿå°±æ„å‘³ç€å¾ˆå®¹æ˜“è¯»æ‡‚ï¼Œå³ä¾¿å‡ºç°bugï¼Œä¿®å¤èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ã€‚ä¸è¦è§‰å¾—ç®€å•çš„ä¸œè¥¿å°±æ²¡æœ‰æŠ€æœ¯å«é‡ã€‚å®é™…ä¸Šï¼Œè¶Šæ˜¯èƒ½ç”¨ç®€å•çš„æ–¹æ³•è§£å†³å¤æ‚çš„é—®é¢˜ï¼Œè¶Šèƒ½ä½“ç°ä¸€ä¸ªäººçš„èƒ½åŠ›ã€‚

### ä»£ç è¡Œæ•°è¶Šå°‘è¶Šç®€å•å—ï¼Ÿ

ä¸‹é¢ç»™å‡ºä¸€ä¸ªä¾‹å­ï¼Œæ£€æŸ¥è¾“å…¥çš„å­—ç¬¦ä¸²ipAddressæ˜¯å¦æ˜¯åˆæ³•çš„IPåœ°å€ï¼š

~~~java
// ç¬¬ä¸€ç§å®ç°æ–¹å¼: ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼
public boolean isValidIpAddressV1(String ipAddress) {
  if (StringUtils.isBlank(ipAddress)) return false;
  String regex = "^(1\\d{2}|2[0-4]\\d|25[0-5]|[1-9]\\d|[1-9])\\."
          + "(1\\d{2}|2[0-4]\\d|25[0-5]|[1-9]\\d|\\d)\\."
          + "(1\\d{2}|2[0-4]\\d|25[0-5]|[1-9]\\d|\\d)\\."
          + "(1\\d{2}|2[0-4]\\d|25[0-5]|[1-9]\\d|\\d)$";
  return ipAddress.matches(regex);
}

// ç¬¬äºŒç§å®ç°æ–¹å¼: ä½¿ç”¨ç°æˆçš„å·¥å…·ç±»
public boolean isValidIpAddressV2(String ipAddress) {
  if (StringUtils.isBlank(ipAddress)) return false;
  String[] ipUnits = StringUtils.split(ipAddress, '.');
  if (ipUnits.length != 4) {
    return false;
  }
  for (int i = 0; i < 4; ++i) {
    int ipUnitIntValue;
    try {
      ipUnitIntValue = Integer.parseInt(ipUnits[i]);
    } catch (NumberFormatException e) {
      return false;
    }
    if (ipUnitIntValue < 0 || ipUnitIntValue > 255) {
      return false;
    }
    if (i == 0 && ipUnitIntValue == 0) {
      return false;
    }
  }
  return true;
}

// ç¬¬ä¸‰ç§å®ç°æ–¹å¼: ä¸ä½¿ç”¨ä»»ä½•å·¥å…·ç±»
public boolean isValidIpAddressV3(String ipAddress) {
  char[] ipChars = ipAddress.toCharArray();
  int length = ipChars.length;
  int ipUnitIntValue = -1;
  boolean isFirstUnit = true;
  int unitsCount = 0;
  for (int i = 0; i < length; ++i) {
    char c = ipChars[i];
    if (c == '.') {
      if (ipUnitIntValue < 0 || ipUnitIntValue > 255) return false;
      if (isFirstUnit && ipUnitIntValue == 0) return false;
      if (isFirstUnit) isFirstUnit = false;
      ipUnitIntValue = -1;
      unitsCount++;
      continue;
    }
    if (c < '0' || c > '9') {
      return false;
    }
    if (ipUnitIntValue == -1) ipUnitIntValue = 0;
    ipUnitIntValue = ipUnitIntValue * 10 + (c - '0');
  }
  if (ipUnitIntValue < 0 || ipUnitIntValue > 255) return false;
  if (unitsCount != 3) return false;
  return true;
}
~~~

å…ˆè¯´ç»“è®ºï¼Œç¬¬äºŒç§å®ç°æ–¹å¼æ›´ç¬¦åˆKISSåŸåˆ™ã€‚ç¬¬ä¸€ç§æ–¹å¼è™½ç„¶è¡Œæ•°æœ€å°‘ï¼Œä½†æ˜¯å®ƒä½¿ç”¨äº†å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚è€Œç¬¬ä¸‰ç§æ–¹å¼æ¯”ç¬¬äºŒç§ï¼Œå®ç°èµ·æ¥æ›´åŠ æœ‰éš¾åº¦ï¼Œå®¹æ˜“å‡ºç°bugã€‚

ä½†æ˜¯ä»æ€§èƒ½ä¸Šæ¥è¯´ï¼Œç¬¬ä¸‰ç§è¦æ¯”ç¬¬äºŒç§å¥½ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå·¥å…·ç±»çš„åŠŸèƒ½éƒ½æ¯”è¾ƒé€šç”¨å’Œå…¨é¢ï¼Œæ‰€ä»¥ï¼Œåœ¨ä»£ç å®ç°ä¸Šï¼Œéœ€è¦è€ƒè™‘å’Œå¤„ç†æ›´å¤šçš„ç»†èŠ‚ï¼Œæ‰§è¡Œæ•ˆç‡å°±ä¼šæœ‰æ‰€å½±å“ã€‚

ä¸è¿‡ï¼Œæœ€ç»ˆè¿˜æ˜¯é€‰æ‹©ç¬¬äºŒç§å®ç°æ–¹æ³•ã€‚å› ä¸ºç¬¬ä¸‰ç§å®é™…ä¸Šæ˜¯ä¸€ç§è¿‡åº¦ä¼˜åŒ–ã€‚é™¤éisValidIpAddress()å‡½æ•°æ˜¯å½±å“ç³»ç»Ÿæ€§èƒ½çš„ç“¶é¢ˆä»£ç ï¼Œå¦åˆ™ï¼Œè¿™æ ·ä¼˜åŒ–çš„æŠ•å…¥äº§å‡ºæ¯”å¹¶ä¸é«˜ï¼Œå¢åŠ äº†ä»£ç å®ç°çš„éš¾åº¦ã€ç‰ºç‰²äº†ä»£ç çš„å¯è¯»æ€§ï¼Œæ€§èƒ½ä¸Šçš„æå‡å´å¹¶ä¸æ˜æ˜¾ã€‚

### ä»£ç é€»è¾‘å¤æ‚å°±è¿èƒŒKISSåŸåˆ™å—ï¼Ÿ

æˆ‘ä»¬å…ˆæ¥çœ‹KMPç®—æ³•çš„å®ç°ï¼š

~~~java
// KMP algorithm: a, båˆ†åˆ«æ˜¯ä¸»ä¸²å’Œæ¨¡å¼ä¸²ï¼›n, måˆ†åˆ«æ˜¯ä¸»ä¸²å’Œæ¨¡å¼ä¸²çš„é•¿åº¦ã€‚
public static int kmp(char[] a, int n, char[] b, int m) {
  int[] next = getNexts(b, m);
  int j = 0;
  for (int i = 0; i < n; ++i) {
    while (j > 0 && a[i] != b[j]) { // ä¸€ç›´æ‰¾åˆ°a[i]å’Œb[j]
      j = next[j - 1] + 1;
    }
    if (a[i] == b[j]) {
      ++j;
    }
    if (j == m) { // æ‰¾åˆ°åŒ¹é…æ¨¡å¼ä¸²çš„äº†
      return i - m + 1;
    }
  }
  return -1;
}

// bè¡¨ç¤ºæ¨¡å¼ä¸²ï¼Œmè¡¨ç¤ºæ¨¡å¼ä¸²çš„é•¿åº¦
private static int[] getNexts(char[] b, int m) {
  int[] next = new int[m];
  next[0] = -1;
  int k = -1;
  for (int i = 1; i < m; ++i) {
    while (k != -1 && b[k + 1] != b[i]) {
      k = next[k];
    }
    if (b[k + 1] == b[i]) {
      ++k;
    }
    next[i] = k;
  }
  return next;
}
~~~

è¿™æ®µä»£ç å®Œå…¨ç¬¦åˆæˆ‘ä»¬åˆšæåˆ°çš„é€»è¾‘å¤æ‚ã€å®ç°éš¾åº¦å¤§ã€å¯è¯»æ€§å·®çš„ç‰¹ç‚¹ï¼Œä½†å®ƒå¹¶ä¸è¿åKISSåŸåˆ™ã€‚å› ä¸ºç”¨å¤æ‚çš„æ–¹æ³•æ¥è§£å†³æœ¬èº«å°±å¤æ‚çš„é—®é¢˜ï¼Œå¹¶ä¸è¿èƒŒKISSåŸåˆ™ã€‚åˆ«æŒ‡æœ›ç”¨å‡ ç™¾è¡Œä»£ç å®ç°ä¸€ä¸ªæ“ä½œç³»ç»Ÿ ğŸ¤£ã€‚

### YAGNI

> You Ainâ€™t Gonna Need It
>
> ä½ ä¸ä¼šéœ€è¦å®ƒ

è¿™ä¸ªåŸåˆ™çš„æ„æ€æ˜¯ï¼Œä¸è¦å»è®¾è®¡å½“å‰ç”¨ä¸åˆ°çš„åŠŸèƒ½ï¼Œå³ä¸è¦åšè¿‡åº¦è®¾è®¡ã€‚

åœ¨å¼€å‘ä¸­ï¼Œæœ‰äº›åŒäº‹ä¸ºäº†é¿å…å¼€å‘ä¸­libraryåŒ…ç¼ºå¤±è€Œé¢‘ç¹åœ°ä¿®æ”¹Mavenæˆ–è€…Gradleé…ç½®æ–‡ä»¶ï¼Œæå‰å¾€é¡¹ç›®é‡Œå¼•å…¥å¤§é‡å¸¸ç”¨çš„libraryåŒ…ã€‚å®é™…ä¸Šï¼Œè¿™æ ·çš„åšæ³•ä¹Ÿæ˜¯è¿èƒŒYAGNIåŸåˆ™çš„ã€‚

YAGNIåŸåˆ™è·ŸKISSåŸåˆ™å¹¶éä¸€å›äº‹å„¿ã€‚KISSåŸåˆ™è®²çš„æ˜¯â€œå¦‚ä½•åšâ€çš„é—®é¢˜ï¼ˆå°½é‡ä¿æŒç®€å•ï¼‰ï¼Œè€ŒYAGNIåŸåˆ™è¯´çš„æ˜¯â€œè¦ä¸è¦åšâ€çš„é—®é¢˜ï¼ˆå½“å‰ä¸éœ€è¦çš„å°±ä¸è¦åšï¼‰ã€‚

## DRY

>Donâ€™t Repeat Yourself
>
>ä¸è¦é‡å¤è‡ªå·±ï¼ˆä¸è¦é‡å¤é€ è½®å­ï¼‰



ä¸‰ç§å…¸å‹çš„ä»£ç é‡å¤æƒ…å†µï¼š

- å®ç°é€»è¾‘é‡å¤
- åŠŸèƒ½è¯­ä¹‰é‡å¤
- ä»£ç æ‰§è¡Œé‡å¤

æˆ‘ä»¬çœ‹çœ‹è¿™äº›é‡å¤æƒ…å†µæ˜¯å¦è¿åDRY

### å®ç°é€»è¾‘é‡å¤

~~~java
public class UserAuthenticator {
  public void authenticate(String username, String password) {
    if (!isValidUsername(username)) {
      // ...throw InvalidUsernameException...
    }
    if (!isValidPassword(password)) {
      // ...throw InvalidPasswordException...
    }
    //...çœç•¥å…¶ä»–ä»£ç ...
  }

  private boolean isValidUsername(String username) {
    // check not null, not empty
    if (StringUtils.isBlank(username)) {
      return false;
    }
    // check length: 4~64
    int length = username.length();
    if (length < 4 || length > 64) {
      return false;
    }
    // contains only lowcase characters
    if (!StringUtils.isAllLowerCase(username)) {
      return false;
    }
    // contains only a~z,0~9,dot
    for (int i = 0; i < length; ++i) {
      char c = username.charAt(i);
      if (!(c >= 'a' && c <= 'z') || (c >= '0' && c <= '9') || c == '.') {
        return false;
      }
    }
    return true;
  }

  private boolean isValidPassword(String password) {
    // check not null, not empty
    if (StringUtils.isBlank(password)) {
      return false;
    }
    // check length: 4~64
    int length = password.length();
    if (length < 4 || length > 64) {
      return false;
    }
    // contains only lowcase characters
    if (!StringUtils.isAllLowerCase(password)) {
      return false;
    }
    // contains only a~z,0~9,dot
    for (int i = 0; i < length; ++i) {
      char c = password.charAt(i);
      if (!(c >= 'a' && c <= 'z') || (c >= '0' && c <= '9') || c == '.') {
        return false;
      }
    }
    return true;
  }
}

~~~

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæœ‰ä¸¤å¤„é‡å¤çš„ä»£ç ç‰‡æ®µï¼šisValidUserName()å‡½æ•°å’ŒisValidPassword()å‡½æ•°ã€‚çœ‹èµ·æ¥è¿åäº†DRYåŸåˆ™ã€‚ä½†å®åˆ™ä¸ç„¶ï¼Œå¦‚æœæˆ‘ä»¬å°†ä¸¤ä¸ªå‡½æ•°åˆå¹¶ä¸ºä¸€ä¸ªå‡½æ•°`isValidUsernameOrPassword`

~~~java
public class UserAuthenticatorV2 {

  public void authenticate(String userName, String password) {
    if (!isValidUsernameOrPassword(userName)) {
      // ...throw InvalidUsernameException...
    }

    if (!isValidUsernameOrPassword(password)) {
      // ...throw InvalidPasswordException...
    }
  }

  private boolean isValidUsernameOrPassword(String usernameOrPassword) {
    //çœç•¥å®ç°é€»è¾‘
    //è·ŸåŸæ¥çš„isValidUsername()æˆ–isValidPassword()çš„å®ç°é€»è¾‘ä¸€æ ·...
    return true;
  }
}
~~~

é‡æ„ä¹‹åï¼Œè™½ç„¶æ¶ˆé™¤äº†å†—ä½™ä»£ç ï¼Œä½†æ˜¯è¿åäº†â€œå•ä¸€èŒè´£åŸåˆ™â€å’Œâ€œæ¥å£éš”ç¦»åŸåˆ™â€ã€‚å¦‚æœå°†æ¥éœ€æ±‚å‘ç”Ÿå˜æ›´ï¼ˆä¾‹å¦‚ï¼Œå…è®¸å¯†ç çš„é•¿åº¦ä¸º8åˆ°64ä¸ªå­—ç¬¦ï¼‰ï¼Œé‚£è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¿˜è¦æŠŠåˆå¹¶åçš„å‡½æ•°ï¼Œé‡æ–°æ‹†æˆåˆå¹¶å‰çš„é‚£ä¸¤ä¸ªå‡½æ•°ã€‚

å°½ç®¡ä»£ç çš„å®ç°é€»è¾‘æ˜¯ç›¸åŒçš„ï¼Œä½†è¯­ä¹‰ä¸åŒï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è®¤ä¸ºè¿™æ®µä»£ç å¹¶ä¸è¿åDRYåŸåˆ™ã€‚å¯¹äºåŒ…å«é‡å¤ä»£ç çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠ½è±¡æˆæ›´ç»†ç²’åº¦å‡½æ•°çš„æ–¹å¼æ¥è§£å†³ã€‚

### åŠŸèƒ½è¯­ä¹‰é‡å¤

æ˜¾ç„¶ï¼Œè¿™ç§æƒ…å†µæ˜¯è¿åDRYåŸåˆ™çš„ã€‚ä¸å†é˜è¿°ã€‚

### ä»£ç æ‰§è¡Œé‡å¤

~~~java
public class UserService {
  private UserRepo userRepo;//é€šè¿‡ä¾èµ–æ³¨å…¥æˆ–è€…IOCæ¡†æ¶æ³¨å…¥
    
  //æ ¡éªŒç”¨æˆ·ç™»å½•æ˜¯å¦æˆåŠŸï¼Œå¦‚æœå¤±è´¥ï¼Œå°±è¿”å›å¼‚å¸¸ï¼›å¦‚æœæˆåŠŸï¼Œå°±è¿”å›ç”¨æˆ·ä¿¡æ¯
  public User login(String email, String password) {
    boolean existed = userRepo.checkIfUserExisted(email, password);
    if (!existed) {
      // ... throw AuthenticationFailureException...
    }
    User user = userRepo.getUserByEmail(email);
    return user;
  }
}

public class UserRepo {
  public boolean checkIfUserExisted(String email, String password) {
    if (!EmailValidation.validate(email)) {
      // ... throw InvalidEmailException...
    }

    if (!PasswordValidation.validate(password)) {
      // ... throw InvalidPasswordException...
    }

    //...query db to check if email&password exists...
  }

  public User getUserByEmail(String email) {
    if (!EmailValidation.validate(email)) {
      // ... throw InvalidEmailException...
    }
    //è¿™é‡Œæœ‰ä¸ªæ•°æ®ä¸€è‡´æ€§å‡è®¾ï¼šå¦‚æœé‚®ç®±å­˜åœ¨ï¼Œé‚£ä¹ˆå¯¹åº”çš„ç”¨æˆ·ä¹Ÿå­˜åœ¨ã€‚
    //...query db to get user by email...
  }
}
~~~

ä¸Šé¢è¿™æ®µä»£ç ï¼Œæ—¢æ²¡æœ‰é€»è¾‘é‡å¤ï¼Œä¹Ÿæ²¡æœ‰è¯­ä¹‰é‡å¤ï¼Œä½†ä»ç„¶è¿åäº†DRYåŸåˆ™ã€‚è¿™æ˜¯å› ä¸ºä»£ç ä¸­å­˜åœ¨â€œæ‰§è¡Œé‡å¤â€ã€‚åœ¨login()å‡½æ•°ä¸­ï¼Œemailçš„æ ¡éªŒé€»è¾‘è¢«æ‰§è¡Œäº†ä¸¤æ¬¡ã€‚ä¸€æ¬¡æ˜¯åœ¨è°ƒç”¨checkIfUserExisted()å‡½æ•°çš„æ—¶å€™ï¼Œå¦ä¸€æ¬¡æ˜¯è°ƒç”¨getUserByEmail()å‡½æ•°çš„æ—¶å€™ã€‚

æ­¤å¤–ï¼Œlogin()å‡½æ•°å¹¶ä¸éœ€è¦è°ƒç”¨checkIfUserExisted()å‡½æ•°ï¼Œåªéœ€è¦è°ƒç”¨ä¸€æ¬¡getUserByEmail()å‡½æ•°ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯ååšå¯¹æ¯”å³å¯ã€‚è¿™æ ·çš„ä¼˜åŒ–æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚å› ä¸ºcheckIfUserExisted()å‡½æ•°å’ŒgetUserByEmail()å‡½æ•°éƒ½éœ€è¦æŸ¥è¯¢æ•°æ®åº“ï¼Œè€Œæ•°æ®åº“è¿™ç±»çš„I/Oæ“ä½œæ˜¯æ¯”è¾ƒè€—æ—¶çš„ã€‚æˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œåº”å½“å°½é‡å‡å°‘è¿™ç±»I/Oæ“ä½œã€‚

~~~java
public class UserService {
  private UserRepo userRepo;//é€šè¿‡ä¾èµ–æ³¨å…¥æˆ–è€…IOCæ¡†æ¶æ³¨å…¥

  public User login(String email, String password) {
    if (!EmailValidation.validate(email)) {
      // ... throw InvalidEmailException...
    }
    if (!PasswordValidation.validate(password)) {
      // ... throw InvalidPasswordException...
    }
    User user = userRepo.getUserByEmail(email);
    if (user == null || !password.equals(user.getPassword()) {
      // ... throw AuthenticationFailureException...
    }
    return user;
  }
}

public class UserRepo {
  public boolean checkIfUserExisted(String email, String password) {
    //...query db to check if email&password exists
  }

  public User getUserByEmail(String email) {
    //...query db to get user by email...
  }
}
~~~

### ä»£ç å¤ç”¨

æˆ‘ä»¬é¦–å…ˆæ¥åŒºåˆ†ä¸‰ä¸ªæ¦‚å¿µï¼š**ä»£ç å¤ç”¨æ€§ï¼ˆCode Reusabilityï¼‰**ã€**ä»£ç å¤ç”¨ï¼ˆCode Resueï¼‰**å’Œ**DRYåŸåˆ™**ã€‚

- ä»£ç å¤ç”¨è¡¨ç¤ºä¸€ç§è¡Œä¸ºï¼šæˆ‘ä»¬åœ¨å¼€å‘æ–°åŠŸèƒ½çš„æ—¶å€™ï¼Œå°½é‡å¤ç”¨å·²ç»å­˜åœ¨çš„ä»£ç ã€‚
- ä»£ç çš„å¯å¤ç”¨æ€§è¡¨ç¤ºä¸€æ®µä»£ç å¯è¢«å¤ç”¨çš„ç‰¹æ€§æˆ–èƒ½åŠ›ï¼šæˆ‘ä»¬åœ¨ç¼–å†™ä»£ç çš„æ—¶å€™ï¼Œè®©ä»£ç å°½é‡å¯å¤ç”¨ã€‚
- DRYåŸåˆ™æ˜¯ä¸€æ¡åŸåˆ™ï¼šä¸è¦å†™é‡å¤çš„ä»£ç ã€‚

å®é™…ä¸Šï¼Œè¿™ä¸‰ä¸ªæ¦‚å¿µåŒºåˆ«è¿˜æ˜¯å¾ˆå¤§çš„ï¼š

- **â€œä¸é‡å¤â€å¹¶ä¸ä»£è¡¨â€œå¯å¤ç”¨â€**ï¼šä¸å­˜åœ¨ä»»ä½•é‡å¤çš„ä»£ç ï¼Œå¹¶ä¸è¡¨ç¤ºé‡Œé¢æœ‰å¯å¤ç”¨çš„ä»£ç ã€‚
- **â€œå¤ç”¨â€å’Œâ€œå¯å¤ç”¨æ€§â€å…³æ³¨è§’åº¦ä¸åŒ**ï¼šä»£ç â€œå¯å¤ç”¨æ€§â€æ˜¯ä»ä»£ç å¼€å‘è€…çš„è§’åº¦æ¥è®²çš„ï¼Œâ€œå¤ç”¨â€æ˜¯ä»ä»£ç ä½¿ç”¨è€…çš„è§’åº¦æ¥è®²çš„ã€‚æ¯”å¦‚ï¼ŒAåŒäº‹ç¼–å†™äº†ä¸€ä¸ªUrlUtilsç±»ï¼Œä»£ç çš„â€œå¯å¤ç”¨æ€§â€å¾ˆå¥½ã€‚BåŒäº‹åœ¨å¼€å‘æ–°åŠŸèƒ½çš„æ—¶å€™ï¼Œç›´æ¥â€œå¤ç”¨â€AåŒäº‹ç¼–å†™çš„UrlUtilsç±»ã€‚

ä½†è¿™ä¸‰è€…çš„ç›®çš„æ˜¯ç›¸åŒçš„ï¼šå‡å°‘ä»£ç é‡ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§ã€‚

## è¿ªç±³ç‰¹æ³•åˆ™ï¼ˆLaw of Demeterï¼‰



>Each unit should have only limited knowledge about other units: only units â€œcloselyâ€ related to the current unit. Or: Each unit should only talk to its friends; Donâ€™t talk to strangers.
>
>æ¯ä¸ªæ¨¡å—åªåº”è¯¥äº†è§£é‚£äº›ä¸å®ƒå…³ç³»å¯†åˆ‡çš„æ¨¡å—çš„æœ‰é™çŸ¥è¯†ã€‚æˆ–è€…è¯´ï¼Œæ¯ä¸ªæ¨¡å—åªå’Œè‡ªå·±çš„æœ‹å‹â€œè¯´è¯â€ï¼Œä¸å’Œé™Œç”Ÿäººâ€œè¯´è¯â€ã€‚

è¿ªç±³ç‰¹æ³•åˆ™æ˜¯å¸Œæœ›å‡å°‘ç±»ä¹‹é—´çš„è€¦åˆï¼Œè®©ç±»è¶Šç‹¬ç«‹è¶Šå¥½ã€‚æ¯ä¸ªç±»éƒ½åº”è¯¥å°‘äº†è§£ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†ã€‚ä¸€æ—¦å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦äº†è§£è¿™ä¸€å˜åŒ–çš„ç±»å°±ä¼šæ¯”è¾ƒå°‘ã€‚

ä¸Šè¿°åŸåˆ™æ¯”è¾ƒæŠ½è±¡ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥è§£è¯»ä¸ºï¼š**ä¸åº”è¯¥æœ‰ç›´æ¥ä¾èµ–å…³ç³»çš„ç±»ä¹‹é—´ï¼Œå°±ä¸è¦æœ‰ä¾èµ–ï¼›æœ‰ä¾èµ–å…³ç³»çš„ç±»ä¹‹é—´ï¼Œå°½é‡åªä¾èµ–å¿…è¦çš„æ¥å£ï¼ˆä¹Ÿå°±æ˜¯å®šä¹‰ä¸­çš„â€œæœ‰é™çŸ¥è¯†â€ï¼‰ã€‚**

è¿˜æ˜¯æ¯”è¾ƒæŠ½è±¡æ˜¯å§ğŸ˜­ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡å‡ ä¸ªä¾‹å­æ¥è¯´æ˜ï¼š



æˆ‘ä»¬å…ˆæ¥è§£é‡Š**ä¸åº”è¯¥æœ‰ç›´æ¥ä¾èµ–å…³ç³»çš„ç±»ä¹‹é—´ï¼Œå°±ä¸è¦æœ‰ä¾èµ–**çš„å«ä¹‰

ç®€åŒ–ç‰ˆçš„æœç´¢å¼•æ“çˆ¬å–ç½‘é¡µã€‚ä»£ç ä¸­åŒ…å«ä¸‰ä¸ªä¸»è¦çš„ç±»ã€‚å…¶ä¸­ï¼ŒNetworkTransporterç±»è´Ÿè´£åº•å±‚ç½‘ç»œé€šä¿¡ï¼Œæ ¹æ®è¯·æ±‚è·å–æ•°æ®ï¼›HtmlDownloaderç±»ç”¨æ¥é€šè¿‡URLè·å–ç½‘é¡µï¼›Documentè¡¨ç¤ºç½‘é¡µæ–‡æ¡£ï¼Œåç»­çš„ç½‘é¡µå†…å®¹æŠ½å–ã€åˆ†è¯ã€ç´¢å¼•éƒ½æ˜¯ä»¥æ­¤ä¸ºå¤„ç†å¯¹è±¡ã€‚

~~~java
public class NetworkTransporter {
    // çœç•¥å±æ€§å’Œå…¶ä»–æ–¹æ³•...
    public Byte[] send(HtmlRequest htmlRequest) {
      //...
    }
}

public class HtmlDownloader {
  private NetworkTransporter transporter;//é€šè¿‡æ„é€ å‡½æ•°æˆ–IOCæ³¨å…¥
  
  public Html downloadHtml(String url) {
    Byte[] rawHtml = transporter.send(new HtmlRequest(url));
    return new Html(rawHtml);
  }
}

public class Document {
  private Html html;
  private String url;
  
  public Document(String url) {
    this.url = url;
    HtmlDownloader downloader = new HtmlDownloader();
    this.html = downloader.downloadHtml(url);
  }
  //...
}
~~~

**é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹NetworkTransporterç±»ã€‚**ä½œä¸ºä¸€ä¸ªåº•å±‚ç½‘ç»œé€šä¿¡ç±»ï¼ˆéœ€æ±‚æ˜ç¡®ï¼‰ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒçš„åŠŸèƒ½å°½å¯èƒ½é€šç”¨ï¼Œè€Œä¸åªæ˜¯æœåŠ¡äºä¸‹è½½HTMLã€‚å› æ­¤å°†NetworkTransporteré‡æ„ä¸º

~~~java
public class NetworkTransporter {
    // çœç•¥å±æ€§å’Œå…¶ä»–æ–¹æ³•...
    public Byte[] send(String address, Byte[] data) {
      //...
    }
}

~~~

**æˆ‘ä»¬å†æ¥çœ‹HtmlDownloaderç±»ã€‚**è¿™ä¸ªç±»çš„è®¾è®¡æ²¡æœ‰é—®é¢˜ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†NetworkTransporterçš„send()å‡½æ•°çš„å®šä¹‰ï¼Œè€Œè¿™ä¸ªç±»ç”¨åˆ°äº†send()å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹å®ƒåšç›¸åº”çš„ä¿®æ”¹ï¼Œä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~java
public class HtmlDownloader {
  private NetworkTransporter transporter;//é€šè¿‡æ„é€ å‡½æ•°æˆ–IOCæ³¨å…¥
  
  // HtmlDownloaderè¿™é‡Œä¹Ÿè¦æœ‰ç›¸åº”çš„ä¿®æ”¹
  public Html downloadHtml(String url) {
    HtmlRequest htmlRequest = new HtmlRequest(url);
    Byte[] rawHtml = transporter.send(
      htmlRequest.getAddress(), htmlRequest.getContent().getBytes());
    return new Html(rawHtml);
  }
}
~~~

**æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹Documentç±»ã€‚**è¿™ä¸ªç±»çš„é—®é¢˜æ¯”è¾ƒå¤šï¼Œä¸»è¦æœ‰ä¸‰ç‚¹ï¼š

1. æ„é€ å‡½æ•°ä¸­çš„downloader.downloadHtml()é€»è¾‘å¤æ‚ï¼Œè€—æ—¶é•¿
2. HtmlDownloaderå¯¹è±¡åœ¨æ„é€ å‡½æ•°ä¸­é€šè¿‡newæ¥åˆ›å»ºï¼Œè¿åäº†åŸºäºæ¥å£è€Œéå®ç°ç¼–ç¨‹çš„è®¾è®¡æ€æƒ³
3. ä»ä¸šåŠ¡å«ä¹‰ä¸Šæ¥è®²ï¼ŒDocumentç½‘é¡µæ–‡æ¡£æ²¡å¿…è¦ä¾èµ–HtmlDownloaderç±»ï¼Œè¿èƒŒäº†è¿ªç±³ç‰¹æ³•åˆ™ã€‚

é‡æ„ä»£ç å¦‚ä¸‹ï¼š

~~~java
public class Document {
  private Html html;
  private String url;
  
  public Document(String url, Html html) {
    this.html = html;
    this.url = url;
  }
  //...
}

// é€šè¿‡ä¸€ä¸ªå·¥å‚æ–¹æ³•æ¥åˆ›å»ºDocument
public class DocumentFactory {
  private HtmlDownloader downloader;
  
  public DocumentFactory(HtmlDownloader downloader) {
    this.downloader = downloader;
  }
  
  public Document createDocument(String url) {
    Html html = downloader.downloadHtml(url);
    return new Document(url, html);
  }
}
~~~





æˆ‘ä»¬å†æ¥è§£é‡Šä¸€ä¸‹ååŠéƒ¨åˆ†â€œæœ‰ä¾èµ–å…³ç³»çš„ç±»ä¹‹é—´ï¼Œå°½é‡åªä¾èµ–å¿…è¦çš„æ¥å£â€çš„å«ä¹‰

Serializationç±»è´Ÿè´£å¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼š

~~~java
public class Serialization {
  public String serialize(Object object) {
    String serializedResult = ...;
    //...
    return serializedResult;
  }
  
  public Object deserialize(String str) {
    Object deserializedResult = ...;
    //...
    return deserializedResult;
  }
}
~~~

å‡è®¾åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œæœ‰äº›ç±»åªç”¨åˆ°äº†åºåˆ—åŒ–æ“ä½œï¼Œè€Œå¦ä¸€äº›ç±»åªç”¨åˆ°ååºåˆ—åŒ–æ“ä½œã€‚æ ¹æ®è¿ªç±³ç‰¹æ³•åˆ™ï¼Œæˆ‘ä»¬åº”è¯¥å°†Serializationç±»æ‹†åˆ†ä¸ºä¸¤ä¸ªæ›´å°ç²’åº¦çš„ç±»ï¼Œä¸€ä¸ªåªè´Ÿè´£åºåˆ—åŒ–ï¼ˆSerializerç±»ï¼‰ï¼Œä¸€ä¸ªåªè´Ÿè´£ååºåˆ—åŒ–ï¼ˆDeserializerç±»ï¼‰ï¼š

~~~java
public class Serializer {
  public String serialize(Object object) {
    String serializedResult = ...;
    ...
    return serializedResult;
  }
}

public class Deserializer {
  public Object deserialize(String str) {
    Object deserializedResult = ...;
    ...
    return deserializedResult;
  }
}
~~~

å°½ç®¡æ‹†åˆ†ä¹‹åçš„ä»£ç æ›´èƒ½æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™ï¼Œä½†å´è¿èƒŒäº†é«˜å†…èšçš„è®¾è®¡æ€æƒ³ã€‚å¦‚æœæˆ‘ä»¬ä¿®æ”¹äº†åºåˆ—åŒ–çš„å®ç°æ–¹å¼ï¼Œæ¯”å¦‚ä»JSONæ¢æˆäº†XMLï¼Œé‚£ååºåˆ—åŒ–çš„å®ç°é€»è¾‘ä¹Ÿéœ€è¦ä¸€å¹¶ä¿®æ”¹ã€‚åœ¨æœªæ‹†åˆ†çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ä¸€ä¸ªç±»å³å¯ã€‚åœ¨æ‹†åˆ†ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸¤ä¸ªç±»ã€‚æ˜¾ç„¶ï¼Œè¿™ç§è®¾è®¡æ€è·¯çš„ä»£ç æ”¹åŠ¨èŒƒå›´å˜å¤§äº†ã€‚

é€šè¿‡å¼•å…¥ä¸¤ä¸ªæ¥å£ï¼Œå°±å¯ä»¥æ—¢ä¸è¿èƒŒé«˜å†…èšçš„è®¾è®¡æ€æƒ³ï¼Œä¹Ÿä¸è¿èƒŒè¿ªç±³ç‰¹æ³•åˆ™ï¼š

~~~java
public interface Serializable {
  String serialize(Object object);
}

public interface Deserializable {
  Object deserialize(String text);
}

public class Serialization implements Serializable, Deserializable {
  @Override
  public String serialize(Object object) {
    String serializedResult = ...;
    ...
    return serializedResult;
  }
  
  @Override
  public Object deserialize(String str) {
    Object deserializedResult = ...;
    ...
    return deserializedResult;
  }
}

public class DemoClass_1 {
  private Serializable serializer;
  
  public Demo(Serializable serializer) {
    this.serializer = serializer;
  }
  //...
}

public class DemoClass_2 {
  private Deserializable deserializer;
  
  public Demo(Deserializable deserializer) {
    this.deserializer = deserializer;
  }
  //...
}
~~~



## å®æˆ˜ï¼šé’ˆå¯¹ä¸šåŠ¡ç³»ç»Ÿçš„å¼€å‘ï¼Œå¦‚ä½•åšéœ€æ±‚åˆ†æå’Œè®¾è®¡ï¼Ÿ

æˆ‘ä»¬ä»¥ä¸€ä¸ªç§¯åˆ†å…‘æ¢ç³»ç»Ÿï¼Œæ¥è®²è§£è¿™ä¸€éƒ¨åˆ†å†…å®¹ã€‚

æŠ€æœ¯äººä¹Ÿè¦æœ‰ä¸€äº›äº§å“æ€ç»´ã€‚å¯¹äºäº§å“è®¾è®¡ã€éœ€æ±‚åˆ†æï¼Œæˆ‘ä»¬è¦å­¦ä¼šâ€œå€Ÿé‰´â€å·²æœ‰çš„ã€æˆç†Ÿçš„äº§å“ã€‚

### éœ€æ±‚åˆ†æ

ç§¯åˆ†ç³»ç»Ÿå°±ä¸¤ä¸ªå¤§çš„åŠŸèƒ½ç‚¹

- èµšå–ç§¯åˆ†
  - ç§¯åˆ†èµšå–æ¸ é“ï¼šä¸‹è®¢å•ã€æ¯æ—¥ç­¾åˆ°ã€è¯„è®ºç­‰
  - ç§¯åˆ†å…‘æ¢è§„åˆ™ï¼šæ¯”å¦‚è®¢å•é‡‘é¢ä¸ç§¯åˆ†çš„å…‘æ¢æ¯”ä¾‹ï¼Œæ¯æ—¥ç­¾åˆ°èµ é€å¤šå°‘ç§¯åˆ†ç­‰
- æ¶ˆè´¹ç§¯åˆ†
  - ç§¯åˆ†æ¶ˆè´¹æ¸ é“ï¼šæŠµæ‰£è®¢å•é‡‘é¢ã€å…‘æ¢ä¼˜æƒ åˆ¸ã€ç§¯åˆ†æ¢è´­ã€å‚ä¸æ´»åŠ¨æ‰£ç§¯åˆ†
  - ç§¯åˆ†å…‘æ¢è§„åˆ™ï¼šå¤šå°‘ç§¯åˆ†å¯ä»¥æ¢ç®—æˆæŠµæ‰£è®¢å•çš„å¤šå°‘é‡‘é¢ï¼Œä¸€å¼ ä¼˜æƒ åˆ¸éœ€è¦å¤šå°‘ç§¯åˆ†æ¥å…‘æ¢

åˆšåˆšç»™å‡ºçš„åªæ˜¯éå¸¸ç¬¼ç»Ÿã€ç²—ç³™çš„åŠŸèƒ½éœ€æ±‚ã€‚åœ¨å®é™…æƒ…å†µä¸­ï¼Œè¿˜éœ€è¦è€ƒè™‘ä¸€äº›ä¸šåŠ¡ç»†èŠ‚ï¼Œæ¯”å¦‚ç§¯åˆ†çš„æœ‰æ•ˆæœŸé—®é¢˜ã€æŸ¥è¯¢ç§¯åˆ†ã€èµšå–æˆ–æ¶ˆè€—ç§¯åˆ†çš„å†å²è®°å½•ã€‚

### ç³»ç»Ÿè®¾è®¡

ç³»ç»Ÿè®¾è®¡å®é™…ä¸Šå°±æ˜¯å°†åˆé€‚çš„åŠŸèƒ½æ”¾åˆ°åˆé€‚çš„æ¨¡å—ä¸­ã€‚åˆç†åœ°åˆ’åˆ†æ¨¡å—ä¹Ÿå¯ä»¥åšåˆ°æ¨¡å—å±‚é¢çš„é«˜å†…èšã€ä½è€¦åˆï¼Œæ¶æ„æ•´æ´æ¸…æ™°ã€‚ç³»ç»Ÿè®¾è®¡ä¸é¢å‘å¯¹è±¡è®¾è®¡æœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„ã€‚é¢å‘å¯¹è±¡è®¾è®¡èšç„¦åœ¨ä»£ç å±‚é¢ï¼ˆä¸»è¦æ˜¯é’ˆå¯¹ç±»ï¼‰ï¼Œé‚£ç³»ç»Ÿè®¾è®¡å°±æ˜¯èšç„¦åœ¨æ¶æ„å±‚é¢ï¼ˆä¸»è¦æ˜¯é’ˆå¯¹æ¨¡å—ï¼‰ã€‚å¾ˆå¤šè®¾è®¡åŸåˆ™å’Œæ€æƒ³ï¼Œè¿˜èƒ½ç”¨åˆ°æ¶æ„è®¾è®¡ä¸­ã€‚

å¯¹äºå‰é¢ç½—åˆ—çš„æ‰€æœ‰åŠŸèƒ½ç‚¹ï¼Œæˆ‘ä»¬æœ‰ä¸‹é¢ä¸‰ç§æ¨¡å—åˆ’åˆ†æ–¹æ³•ï¼š

- æ•´ä¸ªç³»ç»Ÿåˆ’åˆ†ä¸ºç§¯åˆ†ç³»ç»Ÿä¸è¥é”€ç³»ç»Ÿã€‚å…¶ä¸­è¥é”€ç³»ç»Ÿè´Ÿè´£

  - ç§¯åˆ†èµšå–æ¸ é“åŠå…‘æ¢è§„åˆ™
  - æ¶ˆè´¹æ¸ é“åŠå…‘æ¢è§„åˆ™çš„ç®¡ç†å’Œç»´æŠ¤ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰

  è€Œç§¯åˆ†ç³»ç»Ÿåªè´Ÿè´£å¢åŠ ç§¯åˆ†ã€å‡å°‘ç§¯åˆ†ã€æŸ¥è¯¢ç§¯åˆ†ã€æŸ¥è¯¢ç§¯åˆ†æ˜ç»†ç­‰è¿™å‡ ä¸ªå·¥ä½œã€‚

- ä¸Šè¿°çš„è¥é”€ç³»ç»Ÿåˆ†æ•£åœ¨å„ä¸ªç›¸å…³ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œæ¯”å¦‚è®¢å•ç³»ç»Ÿã€è¯„è®ºç³»ç»Ÿã€ç­¾åˆ°ç³»ç»Ÿã€æ¢è´­å•†åŸã€ä¼˜æƒ åˆ¸ç³»ç»Ÿç­‰

- æ‰€æœ‰çš„åŠŸèƒ½éƒ½åˆ’åˆ†åˆ°ç§¯åˆ†ç³»ç»Ÿä¸­

ä¸ºäº†é¿å…ä¸šåŠ¡çŸ¥è¯†çš„è€¦åˆï¼Œè®©ä¸‹å±‚ç³»ç»Ÿæ›´åŠ é€šç”¨ï¼Œä¸€èˆ¬æ¥è®²ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›ä¸‹å±‚ç³»ç»Ÿï¼ˆä¹Ÿå°±æ˜¯è¢«è°ƒç”¨çš„ç³»ç»Ÿï¼‰åŒ…å«å¤ªå¤šä¸Šå±‚ç³»ç»Ÿï¼ˆä¹Ÿå°±æ˜¯è°ƒç”¨ç³»ç»Ÿï¼‰çš„ä¸šåŠ¡ä¿¡æ¯ï¼Œä½†æ˜¯ï¼Œå¯ä»¥æ¥å—ä¸Šå±‚ç³»ç»ŸåŒ…å«ä¸‹å±‚ç³»ç»Ÿçš„ä¸šåŠ¡ä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œè®¢å•ç³»ç»Ÿã€ä¼˜æƒ åˆ¸ç³»ç»Ÿã€æ¢è´­å•†åŸç­‰ä½œä¸ºè°ƒç”¨ç§¯åˆ†ç³»ç»Ÿçš„ä¸Šå±‚ç³»ç»Ÿï¼Œå¯ä»¥åŒ…å«ä¸€äº›ç§¯åˆ†ç›¸å…³çš„ä¸šåŠ¡ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œåè¿‡æ¥ï¼Œç§¯åˆ†ç³»ç»Ÿä¸­æœ€å¥½ä¸è¦åŒ…å«å¤ªå¤šè·Ÿè®¢å•ã€ä¼˜æƒ åˆ¸ã€æ¢è´­ç­‰ç›¸å…³çš„ä¿¡æ¯ã€‚æ‰€ä»¥ï¼Œç»¼åˆè€ƒè™‘ï¼Œæˆ‘ä»¬æ›´å€¾å‘äºç¬¬ä¸€ç§å’Œç¬¬äºŒç§æ¨¡å—åˆ’åˆ†æ–¹å¼ã€‚





ç³»ç»ŸèŒè´£åˆ’åˆ†å¥½ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è®¾è®¡ç³»ç»Ÿä¹‹é—´çš„äº¤äº’ã€‚æ¯”è¾ƒå¸¸è§çš„ç³»ç»Ÿä¹‹é—´çš„äº¤äº’æ–¹å¼æœ‰ä¸¤ç§ï¼š

- åŒæ­¥æ¥å£è°ƒç”¨ï¼šç®€å•ç›´æ¥
- æ¶ˆæ¯ä¸­é—´ä»¶å¼‚æ­¥è°ƒç”¨ï¼šè§£è€¦æ•ˆæœæ›´å¥½

ä¸Šä¸‹å±‚ç³»ç»Ÿä¹‹é—´çš„è°ƒç”¨å€¾å‘äºé€šè¿‡åŒæ­¥æ¥å£ï¼ŒåŒå±‚ä¹‹é—´çš„è°ƒç”¨å€¾å‘äºå¼‚æ­¥æ¶ˆæ¯è°ƒç”¨ã€‚





æ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹ï¼Œæ¨¡å—æœ¬èº«å¦‚ä½•æ¥è®¾è®¡ï¼Ÿå®ƒåŒ…æ‹¬ä»¥ä¸‹ä¸‰éƒ¨åˆ†å†…å®¹ï¼š

- æ¥å£è®¾è®¡ï¼ˆå¯¹å…¶ä»–æ¨¡å—æš´éœ²çš„æ¥å£ï¼‰ï¼šæ¥å£è®¾è®¡è¦ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™ï¼Œç²’åº¦è¶Šå°é€šç”¨æ€§å°±è¶Šå¥½ã€‚ä½†æ˜¯ï¼Œæ¥å£ç²’åº¦å¤ªå°ä¹Ÿä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªåŠŸèƒ½çš„å®ç°è¦è°ƒç”¨å¤šä¸ªå°æ¥å£ï¼Œä¸€æ–¹é¢å¦‚æœæ¥å£è°ƒç”¨èµ°ç½‘ç»œï¼ˆç‰¹åˆ«æ˜¯å…¬ç½‘ï¼‰ï¼Œå¤šæ¬¡è¿œç¨‹æ¥å£è°ƒç”¨ä¼šå½±å“æ€§èƒ½ï¼›å¦ä¸€æ–¹é¢ï¼Œæœ¬è¯¥åœ¨ä¸€ä¸ªæ¥å£ä¸­å®Œæˆçš„åŸå­æ“ä½œï¼Œç°åœ¨åˆ†æ‹†æˆå¤šä¸ªå°æ¥å£æ¥å®Œæˆï¼Œå°±å¯èƒ½ä¼šæ¶‰åŠåˆ†å¸ƒå¼äº‹åŠ¡çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªæ¥å£æ‰§è¡ŒæˆåŠŸäº†ï¼Œä½†å¦ä¸€ä¸ªæ¥å£æ‰§è¡Œå¤±è´¥äº†ï¼‰ã€‚æ‰€ä»¥ï¼Œä¸ºäº†å…¼é¡¾æ˜“ç”¨æ€§å’Œæ€§èƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿé‰´facadeï¼ˆå¤–è§‚ï¼‰è®¾è®¡æ¨¡å¼ï¼Œåœ¨èŒè´£å•ä¸€çš„ç»†ç²’åº¦æ¥å£ä¹‹ä¸Šï¼Œå†å°è£…ä¸€å±‚ç²—ç²’åº¦çš„æ¥å£ç»™å¤–éƒ¨ä½¿ç”¨ã€‚
- æ•°æ®åº“è®¾è®¡
- ä¸šåŠ¡æ¨¡å‹è®¾è®¡ï¼ˆä¹Ÿå°±æ˜¯ä¸šåŠ¡é€»è¾‘ï¼‰ï¼šå¤§éƒ¨åˆ†ä¸šåŠ¡ç³»ç»Ÿçš„å¼€å‘éƒ½å¯ä»¥åˆ†ä¸ºControllerã€Serviceã€Repositoryä¸‰å±‚ã€‚MVCæ¶æ„æœ‰ä¸¤ç§å¼€å‘æ¨¡å¼
  - åŸºäºè´«è¡€æ¨¡å‹çš„ä¼ ç»Ÿå¼€å‘æ¨¡å¼
  - åŸºäºå……è¡€æ¨¡å‹çš„DDDå¼€å‘æ¨¡å¼

å…¶ä¸­ï¼Œæ•°æ®åº“å’Œæ¥å£çš„è®¾è®¡éå¸¸é‡è¦ï¼Œä¸€æ—¦è®¾è®¡å¥½å¹¶æŠ•å…¥ä½¿ç”¨ä¹‹åï¼Œè¿™ä¸¤éƒ¨åˆ†éƒ½ä¸èƒ½è½»æ˜“æ”¹åŠ¨ã€‚æ”¹åŠ¨æ•°æ®åº“è¡¨ç»“æ„ï¼Œéœ€è¦æ¶‰åŠæ•°æ®çš„è¿ç§»å’Œé€‚é…ï¼›æ”¹åŠ¨æ¥å£ï¼Œéœ€è¦è®©æ¥å£çš„ä½¿ç”¨è€…ä½œç›¸åº”çš„ä»£ç ä¿®æ”¹ã€‚ç›¸åï¼Œä¸šåŠ¡é€»è¾‘ä»£ç ä¾§é‡å†…éƒ¨å®ç°ï¼Œä¸æ¶‰åŠè¢«å¤–éƒ¨ä¾èµ–çš„æ¥å£ï¼Œä¹Ÿä¸åŒ…å«æŒä¹…åŒ–çš„æ•°æ®ï¼Œæ‰€ä»¥å¯¹æ”¹åŠ¨çš„å®¹å¿æ€§æ›´å¤§ã€‚





ä¸ºä»€ä¹ˆè¦åˆ†MVCä¸‰å±‚å¼€å‘ï¼Ÿ

*   **ä»£ç å¤ç”¨**ï¼šåŒä¸€ä¸ªRepositoryå¯èƒ½ä¼šè¢«å¤šä¸ªServiceæ¥è°ƒç”¨ï¼ŒåŒä¸€ä¸ªServiceå¯èƒ½ä¼šè¢«å¤šä¸ªControllerè°ƒç”¨ã€‚
*   **éš”ç¦»å˜åŒ–**ï¼šåˆ†å±‚ä½“ç°äº†ä¸€ç§æŠ½è±¡å’Œå°è£…çš„è®¾è®¡æ€æƒ³ã€‚
*   **éš”ç¦»å…³æ³¨ç‚¹**ï¼šRepositoryå±‚åªå…³æ³¨æ•°æ®çš„è¯»å†™ã€‚Serviceå±‚åªå…³æ³¨ä¸šåŠ¡é€»è¾‘ï¼Œä¸å…³æ³¨æ•°æ®çš„æ¥æºã€‚Controllerå±‚åªå…³æ³¨ä¸å¤–ç•Œæ‰“äº¤é“ï¼Œæ•°æ®æ ¡éªŒã€å°è£…ã€æ ¼å¼è½¬æ¢ï¼Œå¹¶ä¸å…³å¿ƒä¸šåŠ¡é€»è¾‘ã€‚ä¸‰å±‚ä¹‹é—´çš„å…³æ³¨ç‚¹ä¸åŒ
*   **æé«˜ä»£ç çš„å¯æµ‹è¯•æ€§**



é’ˆå¯¹Controllerã€Serviceã€Repositoryä¸‰å±‚ï¼Œæ¯å±‚éƒ½ä¼šå®šä¹‰ç›¸åº”çš„æ•°æ®å¯¹è±¡ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯VOï¼ˆView Objectï¼‰ã€BOï¼ˆBusiness Objectï¼‰ã€Entityã€‚åœ¨å®é™…çš„å¼€å‘ä¸­ï¼ŒVOã€BOã€Entityå¯èƒ½å­˜åœ¨å¤§é‡çš„é‡å¤å­—æ®µï¼Œè¿™æ˜¯å¦è¿èƒŒDRYåŸåˆ™å‘¢ï¼Ÿ

- VOã€BOã€Entityä¸‰ä¸ªç±»è™½ç„¶ä»£ç é‡å¤ï¼Œä½†åŠŸèƒ½è¯­ä¹‰ä¸é‡å¤ï¼Œä»èŒè´£ä¸Šè®²æ˜¯ä¸ä¸€æ ·çš„ã€‚å¦‚æœä½ çœŸçš„æœ‰ä»£ç æ´ç™–ï¼Œçœ‹ä¸æƒ¯è¿™äº›ä»£ç é‡å¤ï¼Œå¯ä»¥é€šè¿‡ç»§æ‰¿æ¥è§£å†³ã€‚å…·ä½“æ€è·¯æ˜¯ï¼Œè®©VOã€BOã€Entityéƒ½ç»§æ‰¿è¿™ä¸ªçˆ¶ç±»ï¼Œå„è‡ªåªå®šä¹‰ç‰¹æœ‰çš„å­—æ®µã€‚å› ä¸ºè¿™é‡Œçš„ç»§æ‰¿å±‚æ¬¡å¾ˆæµ…ï¼Œä¹Ÿä¸å¤æ‚ï¼Œæ‰€ä»¥ä½¿ç”¨ç»§æ‰¿å¹¶ä¸ä¼šå½±å“ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
- ä¸ºäº†å°½é‡å‡å°‘æ¯å±‚ä¹‹é—´çš„è€¦åˆï¼ŒæŠŠèŒè´£è¾¹ç•Œåˆ’åˆ†æ˜ç¡®ï¼Œæ¯å±‚éƒ½ä¼šç»´æŠ¤è‡ªå·±çš„æ•°æ®å¯¹è±¡ï¼Œå±‚ä¸å±‚ä¹‹é—´é€šè¿‡æ¥å£äº¤äº’ã€‚å¯¹äºéå¸¸å¤§çš„é¡¹ç›®æ¥è¯´ï¼Œç»“æ„æ¸…æ™°æ˜¯ç¬¬ä¸€ä½çš„ï¼

ä¸åŒåˆ†å±‚ä¹‹é—´çš„æ•°æ®å¯¹è±¡è¯¥å¦‚ä½•äº’ç›¸è½¬åŒ–å‘¢ï¼Ÿæœ€ç®€å•çš„è½¬åŒ–æ–¹å¼æ˜¯æ‰‹åŠ¨å¤åˆ¶ã€‚è‡ªå·±å†™ä»£ç åœ¨ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´ï¼Œä¸€ä¸ªå­—æ®µä¸€ä¸ªå­—æ®µçš„èµ‹å€¼ã€‚ä½†è¿™æ ·çš„åšæ³•æ˜¾ç„¶æ˜¯æ²¡æœ‰æŠ€æœ¯å«é‡çš„ä½çº§åŠ³åŠ¨ã€‚Javaä¸­æä¾›äº†å¤šç§æ•°æ®å¯¹è±¡è½¬åŒ–å·¥å…·ï¼Œæ¯”å¦‚BeanUtilsã€Dozerç­‰ï¼Œå¯ä»¥å¤§å¤§ç®€åŒ–ç¹ççš„å¯¹è±¡è½¬åŒ–å·¥ä½œã€‚



## å®æˆ˜ï¼šé’ˆå¯¹éä¸šåŠ¡çš„é€šç”¨æ¡†æ¶å¼€å‘ï¼Œå¦‚ä½•åšéœ€æ±‚åˆ†æå’Œè®¾è®¡ï¼Ÿ

æˆ‘ä»¬ä»¥æ”¯æŒå„ç§ç»Ÿè®¡è§„åˆ™çš„æ€§èƒ½è®¡æ•°å™¨é¡¹ç›®ï¼Œæ¥è®²è§£è¿™ä¸€éƒ¨åˆ†å†…å®¹ã€‚

### éœ€æ±‚åˆ†æ

æˆ‘ä»¬å¸Œæœ›è®¾è®¡å¼€å‘ä¸€ä¸ªå°çš„æ¡†æ¶ï¼Œèƒ½å¤Ÿè·å–æ¥å£è°ƒç”¨çš„å„ç§ç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼Œå“åº”æ—¶é—´çš„æœ€å¤§å€¼ï¼ˆmaxï¼‰ã€æœ€å°å€¼ï¼ˆminï¼‰ã€å¹³å‡å€¼ï¼ˆavgï¼‰ã€ç™¾åˆ†ä½å€¼ï¼ˆpercentileï¼‰ï¼›æ¥å£è°ƒç”¨æ¬¡æ•°ï¼ˆcountï¼‰ä»¥åŠé¢‘ç‡ï¼ˆtpsï¼‰ ç­‰ï¼Œå¹¶ä¸”æ”¯æŒå°†ç»Ÿè®¡ç»“æœä»¥å„ç§æ˜¾ç¤ºæ ¼å¼ï¼ˆæ¯”å¦‚ï¼šJSONæ ¼å¼ã€ç½‘é¡µæ ¼å¼ã€è‡ªå®šä¹‰æ˜¾ç¤ºæ ¼å¼ç­‰ï¼‰è¾“å‡ºåˆ°å„ç§ç»ˆç«¯ï¼ˆConsoleå‘½ä»¤è¡Œã€HTTPç½‘é¡µã€Emailã€æ—¥å¿—æ–‡ä»¶ã€è‡ªå®šä¹‰è¾“å‡ºç»ˆç«¯ç­‰ï¼‰ï¼Œä»¥æ–¹ä¾¿æŸ¥çœ‹ã€‚

è€Œä½œä¸ºå¯è¢«å¤ç”¨çš„æ¡†æ¶ï¼Œé™¤äº†åŠŸèƒ½æ€§éœ€æ±‚ä¹‹å¤–ï¼ŒéåŠŸèƒ½æ€§éœ€æ±‚ä¹Ÿéå¸¸é‡è¦ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†åˆ«ä»è¿™ä¸¤ä¸ªæ–¹é¢æ¥åšéœ€æ±‚åˆ†æã€‚

#### åŠŸèƒ½æ€§éœ€æ±‚åˆ†æ

*   æ¥å£ç»Ÿè®¡ä¿¡æ¯ï¼šåŒ…æ‹¬æ¥å£å“åº”æ—¶é—´çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œä»¥åŠæ¥å£è°ƒç”¨æ¬¡æ•°çš„ç»Ÿè®¡ä¿¡æ¯ç­‰ã€‚
*   ç»Ÿè®¡ä¿¡æ¯çš„ç±»å‹ï¼šmaxã€minã€avgã€percentileã€countã€tpsç­‰ã€‚
*   ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºæ ¼å¼ï¼šJsonã€Htmlã€è‡ªå®šä¹‰æ˜¾ç¤ºæ ¼å¼ã€‚
*   ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºç»ˆç«¯ï¼šConsoleã€Emailã€HTTPç½‘é¡µã€æ—¥å¿—ã€è‡ªå®šä¹‰æ˜¾ç¤ºç»ˆç«¯ã€‚

æˆ‘ä»¬è¿˜æŒ–æ˜å‡ºäº†ä¸‹é¢å‡ ä¸ªéšè—çš„éœ€æ±‚ï¼š

- ç»Ÿè®¡è§¦å‘æ–¹å¼ï¼š
  - ä¸»åŠ¨ï¼šä»¥ä¸€å®šçš„é¢‘ç‡å®šæ—¶ç»Ÿè®¡æ•°æ®
  - è¢«åŠ¨ï¼šç”±ç”¨æˆ·è§¦å‘
- ç»Ÿè®¡æ—¶é—´åŒºé—´

#### éåŠŸèƒ½æ€§éœ€æ±‚åˆ†æ

- **æ˜“ç”¨æ€§**ï¼šæ¡†æ¶æ˜¯å¦æ˜“é›†æˆã€æ˜“æ’æ‹”ã€è·Ÿä¸šåŠ¡ä»£ç æ˜¯å¦æ¾è€¦åˆã€æä¾›çš„æ¥å£æ˜¯å¦å¤Ÿçµæ´»ç­‰ç­‰
- **æ€§èƒ½**
- **æ‰©å±•æ€§**ï¼šä½¿ç”¨è€…å¯ä»¥åœ¨ä¸ä¿®æ”¹æ¡†æ¶æºç ï¼Œç”šè‡³ä¸æ‹¿åˆ°æ¡†æ¶æºç çš„æƒ…å†µä¸‹ï¼Œä¸ºæ¡†æ¶æ‰©å±•æ–°çš„åŠŸèƒ½ã€‚è¿™å°±æœ‰ç‚¹ç±»ä¼¼ç»™æ¡†æ¶å¼€å‘æ’ä»¶ã€‚
- **é€šç”¨æ€§**ï¼šèƒ½å¤Ÿçµæ´»åº”ç”¨åˆ°å„ç§åœºæ™¯ä¸­ã€‚

### æ¡†æ¶è®¾è®¡

å¯¹äºç¨å¾®å¤æ‚ç³»ç»Ÿçš„å¼€å‘ï¼Œå¯ä»¥è·µè¡Œ**TDDï¼ˆæµ‹è¯•é©±åŠ¨å¼€å‘ï¼‰**å’Œ**Prototypeï¼ˆæœ€å°åŸå‹ï¼‰**çš„æ€æƒ³ï¼Œå…ˆèšç„¦äºä¸€ä¸ªç®€å•çš„åº”ç”¨åœºæ™¯ï¼ŒåŸºäºæ­¤è®¾è®¡å®ç°ä¸€ä¸ªç®€å•çš„åŸå‹ã€‚å°½ç®¡è¿™ä¸ªåŸå‹åœ¨åŠŸèƒ½å’ŒéåŠŸèƒ½ç‰¹æ€§ä¸Šéƒ½ä¸å®Œå–„ã€‚ä½†æ˜¯å®ƒå…·è±¡åŒ–äº†æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå¸®åŠ©æˆ‘ä»¬ç¼•æ¸…å¤æ‚çš„è®¾è®¡æ€è·¯ã€‚ç„¶åä¸æ–­è¿­ä»£ç›´è‡³æ»¡è¶³éœ€æ±‚ã€‚

å…ˆç»™å‡ºåº”ç”¨åœºæ™¯çš„ä»£ç ã€‚å…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~java
//åº”ç”¨åœºæ™¯ï¼šç»Ÿè®¡ä¸‹é¢ä¸¤ä¸ªæ¥å£(æ³¨å†Œå’Œç™»å½•ï¼‰çš„å“åº”æ—¶é—´å’Œè®¿é—®æ¬¡æ•°
public class UserController {
  public void register(UserVo user) {
    //...
  }
  
  public UserVo login(String telephone, String password) {
    //...
  }
}
~~~

æœ€å°åŸå‹çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~java
public class Metrics {
  // Mapçš„keyæ˜¯æ¥å£åç§°ï¼Œvalueå¯¹åº”æ¥å£è¯·æ±‚çš„å“åº”æ—¶é—´æˆ–æ—¶é—´æˆ³ï¼›
  private Map<String, List<Double>> responseTimes = new HashMap<>();
  private Map<String, List<Double>> timestamps = new HashMap<>();
    
  private ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor();
  
  //è®°å½•æ¥å£è¯·æ±‚çš„å“åº”æ—¶é—´
  public void recordResponseTime(String apiName, double responseTime) {
    responseTimes.putIfAbsent(apiName, new ArrayList<>());
    responseTimes.get(apiName).add(responseTime);
  }

  //è®°å½•æ¥å£è¯·æ±‚çš„è®¿é—®æ—¶é—´
  public void recordTimestamp(String apiName, double timestamp) {
    timestamps.putIfAbsent(apiName, new ArrayList<>());
    timestamps.get(apiName).add(timestamp);
  }

  //ä»¥æŒ‡å®šçš„é¢‘ç‡ç»Ÿè®¡æ•°æ®å¹¶è¾“å‡ºç»“æœã€‚
  public void startRepeatedReport(long period, TimeUnit unit){
    executor.scheduleAtFixedRate(new Runnable() {
      @Override
      public void run() {
        Gson gson = new Gson();
        Map<String, Map<String, Double>> stats = new HashMap<>();
        for (Map.Entry<String, List<Double>> entry : responseTimes.entrySet()) {
          String apiName = entry.getKey();
          List<Double> apiRespTimes = entry.getValue();
          stats.putIfAbsent(apiName, new HashMap<>());
          stats.get(apiName).put("max", max(apiRespTimes));
          stats.get(apiName).put("avg", avg(apiRespTimes));
        }
  
        for (Map.Entry<String, List<Double>> entry : timestamps.entrySet()) {
          String apiName = entry.getKey();
          List<Double> apiTimestamps = entry.getValue();
          stats.putIfAbsent(apiName, new HashMap<>());
          stats.get(apiName).put("count", (double)apiTimestamps.size());
        }
        System.out.println(gson.toJson(stats));
      }
    }, 0, period, unit);
  }

  private double max(List<Double> dataset) {//çœç•¥ä»£ç å®ç°}
  private double avg(List<Double> dataset) {//çœç•¥ä»£ç å®ç°}
}
~~~

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ï¼Œå¦‚ä½•ç”¨å®ƒæ¥ç»Ÿè®¡æ³¨å†Œã€ç™»å½•æ¥å£çš„å“åº”æ—¶é—´å’Œè®¿é—®æ¬¡æ•°ã€‚å…·ä½“çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~java
//åº”ç”¨åœºæ™¯ï¼šç»Ÿè®¡ä¸‹é¢ä¸¤ä¸ªæ¥å£(æ³¨å†Œå’Œç™»å½•ï¼‰çš„å“åº”æ—¶é—´å’Œè®¿é—®æ¬¡æ•°
public class UserController {
  private Metrics metrics = new Metrics();
  
  public UserController() {
    metrics.startRepeatedReport(60, TimeUnit.SECONDS);
  }

  public void register(UserVo user) {
    long startTimestamp = System.currentTimeMillis();
    metrics.recordTimestamp("regsiter", startTimestamp);
    //...
    long respTime = System.currentTimeMillis() - startTimestamp;
    metrics.recordResponseTime("register", respTime);
  }

  public UserVo login(String telephone, String password) {
    long startTimestamp = System.currentTimeMillis();
    metrics.recordTimestamp("login", startTimestamp);
    //...
    long respTime = System.currentTimeMillis() - startTimestamp;
    metrics.recordResponseTime("login", respTime);
  }
}
~~~

æ ¹æ®è¿™ä¸ªæœ€å°åŸå‹ï¼Œæˆ‘ä»¬å¯ä»¥ç»™å‡ºä¸€ä¸ªç²—ç•¥çš„ç³»ç»Ÿè®¾è®¡å›¾ï¼š

![](assets/926561b82b49c937dcf4a2b9e6b35c16.jpg)

æˆ‘ä»¬æŠŠæ•´ä¸ªæ¡†æ¶åˆ†ä¸ºå››ä¸ªæ¨¡å—ï¼šæ•°æ®é‡‡é›†ã€å­˜å‚¨ã€èšåˆç»Ÿè®¡ã€æ˜¾ç¤ºã€‚è¿™äº›æ¨¡å—çš„å…·ä½“å·¥ä½œå¦‚ä¸‹ï¼š

- æ•°æ®é‡‡é›†ï¼šè´Ÿè´£æ‰“ç‚¹é‡‡é›†åŸå§‹æ•°æ®ï¼ŒåŒ…æ‹¬è®°å½•æ¯æ¬¡æ¥å£è¯·æ±‚çš„å“åº”æ—¶é—´å’Œè¯·æ±‚æ—¶é—´ã€‚
- å­˜å‚¨ï¼šè´Ÿè´£å°†é‡‡é›†çš„åŸå§‹æ•°æ®ä¿å­˜ä¸‹æ¥ï¼Œä»¥ä¾¿åé¢åšèšåˆç»Ÿè®¡ã€‚
- èšåˆç»Ÿè®¡ï¼šè´Ÿè´£å°†åŸå§‹æ•°æ®èšåˆä¸ºç»Ÿè®¡æ•°æ®
- æ˜¾ç¤ºï¼šè´Ÿè´£å°†ç»Ÿè®¡æ•°æ®ä»¥æŸç§æ ¼å¼æ˜¾ç¤ºåˆ°ç»ˆç«¯



æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¸æ–­è¿­ä»£è¿™ä¸ªæœ€å°çš„åŸå‹ç³»ç»Ÿã€‚



### é¢å‘å¯¹è±¡è®¾è®¡ä¸å®ç°

æ ¹æ®éœ€æ±‚æè¿°ï¼Œæˆ‘ä»¬æŠ½è±¡å‡ºä»¥ä¸‹å‡ ä¸ªç±»ï¼š

- MetricsCollectorç±»è´Ÿè´£æä¾›APIï¼Œæ¥é‡‡é›†æ¥å£è¯·æ±‚çš„åŸå§‹æ•°æ®ã€‚
- MetricsStorageæ¥å£è´Ÿè´£åŸå§‹æ•°æ®å­˜å‚¨ï¼ŒRedisMetricsStorageç±»å®ç°MetricsStorageæ¥å£ã€‚
- Aggregatorç±»è´Ÿè´£æ ¹æ®åŸå§‹æ•°æ®è®¡ç®—ç»Ÿè®¡æ•°æ®ã€‚
- ConsoleReporterç±»ã€EmailReporterç±»åˆ†åˆ«è´Ÿè´£ä»¥ä¸€å®šé¢‘ç‡ç»Ÿè®¡å¹¶å‘é€ç»Ÿè®¡æ•°æ®åˆ°å‘½ä»¤è¡Œå’Œé‚®ä»¶ã€‚è‡³äºConsoleReporterå’ŒEmailReporteræ˜¯å¦å¯ä»¥æŠ½è±¡å‡ºå¯å¤ç”¨çš„æŠ½è±¡ç±»ï¼Œæˆ‘ä»¬æš‚æ—¶è¿˜ä¸èƒ½ç¡®å®šã€‚



MetricsCollectorç±»çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~java
public class MetricsCollector {
  private MetricsStorage metricsStorage;//åŸºäºæ¥å£è€Œéå®ç°ç¼–ç¨‹

  //ä¾èµ–æ³¨å…¥
  public MetricsCollector(MetricsStorage metricsStorage) {
    this.metricsStorage = metricsStorage;
  }

  //ç”¨ä¸€ä¸ªå‡½æ•° + RequestInfoå‚æ•° ä»£æ›¿äº†æœ€å°åŸå‹ä¸­çš„ä¸¤ä¸ªå‡½æ•°
  public void recordRequest(RequestInfo requestInfo) {
    if (requestInfo == null || StringUtils.isBlank(requestInfo.getApiName())) {
      return;
    }
    metricsStorage.saveRequestInfo(requestInfo);
  }
}

//RequestInfoç±»å°è£…åŸå§‹æ•°æ®ä¿¡æ¯
public class RequestInfo {
  private String apiName;
  private double responseTime;
  private long timestamp;
  //...çœç•¥constructor/getter/setteræ–¹æ³•...
}
~~~

MetricsStorageç±»å’ŒRedisMetricsStorageç±»çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~java
public interface MetricsStorage {
  void saveRequestInfo(RequestInfo requestInfo);

  List<RequestInfo> getRequestInfos(String apiName, long startTimeInMillis, long endTimeInMillis);

  Map<String, List<RequestInfo>> getRequestInfos(long startTimeInMillis, long endTimeInMillis);
}

public class RedisMetricsStorage implements MetricsStorage {
  //...çœç•¥å±æ€§å’Œæ„é€ å‡½æ•°ç­‰...
  @Override
  public void saveRequestInfo(RequestInfo requestInfo) {}

  @Override
  public List<RequestInfo> getRequestInfos(String apiName, long startTimestamp, long endTimestamp) {}

  @Override
  public Map<String, List<RequestInfo>> getRequestInfos(long startTimestamp, long endTimestamp) {}
}
~~~

æ³¨æ„ï¼Œæ‹‰å–è¾ƒé•¿æ—¶é—´åŒºé—´çš„æ•°æ®ï¼Œå¯èƒ½è§¦å‘OOMå¼‚å¸¸ã€‚å³ä¾¿ä¸å‡ºç°OOMï¼Œä¹Ÿä¼šå¯¼è‡´é¢‘ç¹çš„GCã€‚è¿›è€Œå¯¼è‡´ç³»ç»Ÿæ¥å£è¯·æ±‚å¤„ç†å˜æ…¢ï¼Œè¿™ä¸ªé—®é¢˜ç•™åˆ°ä»¥åå†è§£å†³ã€‚

~~~java
//èšåˆæ•°æ®
public class Aggregator {
  public static RequestStat aggregate(List<RequestInfo> requestInfos, long durationInMillis) {
    double maxRespTime = Double.MIN_VALUE;
    double minRespTime = Double.MAX_VALUE;
    double avgRespTime = -1;
    double p999RespTime = -1;
    double p99RespTime = -1;
    double sumRespTime = 0;
    long count = 0;
    for (RequestInfo requestInfo : requestInfos) {
      ++count;
      double respTime = requestInfo.getResponseTime();
      if (maxRespTime < respTime) {
        maxRespTime = respTime;
      }
      if (minRespTime > respTime) {
        minRespTime = respTime;
      }
      sumRespTime += respTime;
    }
    if (count != 0) {
      avgRespTime = sumRespTime / count;
    }
    long tps = (long)(count / durationInMillis * 1000);
    Collections.sort(requestInfos, new Comparator<RequestInfo>() {
      @Override
      public int compare(RequestInfo o1, RequestInfo o2) {
        double diff = o1.getResponseTime() - o2.getResponseTime();
        if (diff < 0.0) {
          return -1;
        } else if (diff > 0.0) {
          return 1;
        } else {
          return 0;
        }
      }
    });
    int idx999 = (int)(count * 0.999);
    int idx99 = (int)(count * 0.99);
    if (count != 0) {
      p999RespTime = requestInfos.get(idx999).getResponseTime();
      p99RespTime = requestInfos.get(idx99).getResponseTime();
    }
    RequestStat requestStat = new RequestStat();
    requestStat.setMaxResponseTime(maxRespTime);
    requestStat.setMinResponseTime(minRespTime);
    requestStat.setAvgResponseTime(avgRespTime);
    requestStat.setP999ResponseTime(p999RespTime);
    requestStat.setP99ResponseTime(p99RespTime);
    requestStat.setCount(count);
    requestStat.setTps(tps);
    return requestStat;
  }
}

public class RequestStat {
  private double maxResponseTime;
  private double minResponseTime;
  private double avgResponseTime;
  private double p999ResponseTime;
  private double p99ResponseTime;
  private long count;
  private long tps;
  //...çœç•¥getter/setteræ–¹æ³•...
}

~~~

å®é™…ä¸Šï¼Œaggregateæ–¹æ³•èŒè´£å¹¶ä¸å•ä¸€ï¼Œå¯ç»´æŠ¤æ€§è¾ƒå·®ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ConsoleReporterå’ŒEmailReporter



~~~java
public class ConsoleReporter {
  private MetricsStorage metricsStorage;
  private ScheduledExecutorService executor;

  //éœ€è¦æŒ‡å®šæ•°æ®æº
  public ConsoleReporter(MetricsStorage metricsStorage) {
    this.metricsStorage = metricsStorage;
    this.executor = Executors.newSingleThreadScheduledExecutor();
  }
  
  // ç¬¬4ä¸ªä»£ç é€»è¾‘ï¼šå®šæ—¶è§¦å‘ç¬¬1ã€2ã€3ä»£ç é€»è¾‘çš„æ‰§è¡Œï¼›
  public void startRepeatedReport(long periodInSeconds, long durationInSeconds) {
    executor.scheduleAtFixedRate(new Runnable() {
      @Override
      public void run() {
        // ç¬¬1ä¸ªä»£ç é€»è¾‘ï¼šæ ¹æ®ç»™å®šçš„æ—¶é—´åŒºé—´ï¼Œä»æ•°æ®åº“ä¸­æ‹‰å–æ•°æ®ï¼›
        long durationInMillis = durationInSeconds * 1000;
        long endTimeInMillis = System.currentTimeMillis();
        long startTimeInMillis = endTimeInMillis - durationInMillis;
        Map<String, List<RequestInfo>> requestInfos =
                metricsStorage.getRequestInfos(startTimeInMillis, endTimeInMillis);
        Map<String, RequestStat> stats = new HashMap<>();
          
        for (Map.Entry<String, List<RequestInfo>> entry : requestInfos.entrySet()) {
          String apiName = entry.getKey();
          List<RequestInfo> requestInfosPerApi = entry.getValue();
          // ç¬¬2ä¸ªä»£ç é€»è¾‘ï¼šæ ¹æ®åŸå§‹æ•°æ®ï¼Œè®¡ç®—å¾—åˆ°ç»Ÿè®¡æ•°æ®ï¼›
          RequestStat requestStat = Aggregator.aggregate(requestInfosPerApi, durationInMillis);
          stats.put(apiName, requestStat);
        }
        
        // ç¬¬3ä¸ªä»£ç é€»è¾‘ï¼šå°†ç»Ÿè®¡æ•°æ®æ˜¾ç¤ºåˆ°ç»ˆç«¯ï¼›
        System.out.println("Time Span: [" + startTimeInMillis + ", " + endTimeInMillis + "]");
        Gson gson = new Gson();
        System.out.println(gson.toJson(stats));
      }
    }, 0, periodInSeconds, TimeUnit.SECONDS);
  }
}



public class EmailReporter {
  private static final Long DAY_HOURS_IN_SECONDS = 86400L;

  private MetricsStorage metricsStorage;
  private EmailSender emailSender;
  private List<String> toAddresses = new ArrayList<>();

  public EmailReporter(MetricsStorage metricsStorage) {
    this(metricsStorage, new EmailSender(/*çœç•¥å‚æ•°*/));
  }

  public EmailReporter(MetricsStorage metricsStorage, EmailSender emailSender) {
    this.metricsStorage = metricsStorage;
    this.emailSender = emailSender;
  }

  public void addToAddress(String address) {
    toAddresses.add(address);
  }

  public void startDailyReport() {
    Calendar calendar = Calendar.getInstance();
    calendar.add(Calendar.DATE, 1);
    calendar.set(Calendar.HOUR_OF_DAY, 0);
    calendar.set(Calendar.MINUTE, 0);
    calendar.set(Calendar.SECOND, 0);
    calendar.set(Calendar.MILLISECOND, 0);
    Date firstTime = calendar.getTime();
    Timer timer = new Timer();
    timer.schedule(new TimerTask() {
      @Override
      public void run() {
        long durationInMillis = DAY_HOURS_IN_SECONDS * 1000;
        long endTimeInMillis = System.currentTimeMillis();
        long startTimeInMillis = endTimeInMillis - durationInMillis;
        Map<String, List<RequestInfo>> requestInfos =
                metricsStorage.getRequestInfos(startTimeInMillis, endTimeInMillis);
        Map<String, RequestStat> stats = new HashMap<>();
        for (Map.Entry<String, List<RequestInfo>> entry : requestInfos.entrySet()) {
          String apiName = entry.getKey();
          List<RequestInfo> requestInfosPerApi = entry.getValue();
          RequestStat requestStat = Aggregator.aggregate(requestInfosPerApi, durationInMillis);
          stats.put(apiName, requestStat);
        }
        // TODO: æ ¼å¼åŒ–ä¸ºhtmlæ ¼å¼ï¼Œå¹¶ä¸”å‘é€é‚®ä»¶
      }
    }, firstTime, DAY_HOURS_IN_SECONDS * 1000);
  }
}

~~~

ConsoleReporterå’ŒEmailReporterä¸­å­˜åœ¨ä»£ç é‡å¤é—®é¢˜ï¼Œè¿åäº†DRYåŸåˆ™ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå› ä¸ºä»£ç ä¸­æ¶‰åŠçº¿ç¨‹æ“ä½œï¼Œå¹¶ä¸”è°ƒç”¨äº†Aggregatorçš„é™æ€å‡½æ•°ï¼ˆæ•°æ®ä¸è¡Œä¸ºåˆ†ç¦»ï¼‰ï¼Œæ‰€ä»¥ä»£ç çš„å¯æµ‹è¯•æ€§ä¸å¥½ã€‚æˆ‘ä»¬ä¹‹åå†æ…¢æ…¢ä¼˜åŒ–ã€‚

æœ€åï¼Œå°†ç±»ç»„è£…èµ·æ¥å¹¶æä¾›æ‰§è¡Œå…¥å£ã€‚è¿™ä¸ªæ¡†æ¶æœ‰ä¸¤ä¸ªæ‰§è¡Œå…¥å£ï¼šä¸€ä¸ªæ˜¯MetricsCollectorç±»ï¼Œæä¾›äº†ä¸€ç»„APIæ¥é‡‡é›†åŸå§‹æ•°æ®ï¼›å¦ä¸€ä¸ªæ˜¯ConsoleReporterç±»å’ŒEmailReporterç±»ï¼Œç”¨æ¥è§¦å‘ç»Ÿè®¡æ˜¾ç¤ºã€‚

~~~java
public class Demo {
  public static void main(String[] args) {
    //å®ä¾‹åŒ–æ•°æ®æº
    MetricsStorage storage = new RedisMetricsStorage();
      
    //å®šæ—¶å°†ç»Ÿè®¡æ•°æ®å‘é€åˆ°ç»ˆç«¯ä¸Š
    ConsoleReporter consoleReporter = new ConsoleReporter(storage);
    consoleReporter.startRepeatedReport(60, 60);
	
    //å®šæ—¶å°†ç»Ÿè®¡æ•°æ®å‘é€åˆ°ç»ˆç«¯ä¸Š
    EmailReporter emailReporter = new EmailReporter(storage);
    emailReporter.addToAddress("wangzheng@xzg.com");
    emailReporter.startDailyReport();
	
      
    //é€šè¿‡collectoræ”¶é›†æ•°æ®
    MetricsCollector collector = new MetricsCollector(storage);
    collector.recordRequest(new RequestInfo("register", 123, 10234));
    collector.recordRequest(new RequestInfo("register", 223, 11234));
    collector.recordRequest(new RequestInfo("register", 323, 12334));
    collector.recordRequest(new RequestInfo("login", 23, 12434));
    collector.recordRequest(new RequestInfo("login", 1223, 14234));

    try {
      Thread.sleep(100000);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
  }
}

~~~
