# è¡Œä¸ºæ¨¡å¼

è¡Œä¸ºå‹è®¾è®¡æ¨¡å¼ä¸»è¦è§£å†³çš„å°±æ˜¯â€œç±»æˆ–å¯¹è±¡ä¹‹é—´çš„äº¤äº’â€é—®é¢˜ã€‚

[TOC]

æ¨¡æ¿æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ã€èŒè´£é“¾æ¨¡å¼å…·æœ‰ç›¸åŒçš„ä½œç”¨ï¼šå¤ç”¨å’Œæ‰©å±•ã€‚ç‰¹åˆ«æ˜¯æ¡†æ¶å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒä»¬æ¥æä¾›æ¡†æ¶çš„æ‰©å±•ç‚¹ï¼Œèƒ½å¤Ÿè®©æ¡†æ¶çš„ä½¿ç”¨è€…åœ¨ä¸ä¿®æ”¹æ¡†æ¶æºç çš„æƒ…å†µä¸‹ï¼ŒåŸºäºæ‰©å±•ç‚¹å®šåˆ¶åŒ–æ¡†æ¶çš„åŠŸèƒ½ã€‚



ä¸ºä»€ä¹ˆå¤§é‡æ¡†æ¶ä½¿ç”¨é…ç½®æ–‡ä»¶æ¥æä¾›åŠŸèƒ½ç‰¹æ€§ï¼Ÿé…ç½®æ–‡ä»¶å…·æœ‰ä»¥ä¸‹ä¸¤ä¸ªä¼˜åŠ¿ï¼š

- å°†ä¿®æ”¹çš„é€»è¾‘éƒ½é›†ä¸­åœ¨äº†ä¸€èµ·
- ç¬¦åˆè§£è€¦çš„æ€æƒ³

å¤§é‡ä½¿ç”¨é…ç½®æ–‡ä»¶ä¼šä½¿ä»£ç çš„å†…èšæ€§é™ä½ï¼Œé…ç½®èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚ä¸ºæ­¤ï¼ŒåŸºäºæ³¨è§£çš„æ–¹å¼åœ¨ä¸€äº›åœºåˆä¸‹ä»£æ›¿é…ç½®æ–‡ä»¶ã€‚ä½†æ˜¯åŸºäºæ³¨è§£çš„æ–¹å¼å°†ä¿®æ”¹é€»è¾‘åˆ†æ•£åˆ°å„ä¸ªclassæ–‡ä»¶ä¸­ï¼Œå¯ç»´æŠ¤æ€§é™ä½

## è§‚å¯Ÿè€…æ¨¡å¼

### åŸç†åŠåº”ç”¨åœºæ™¯å‰–æ



> Define a one-to-many dependency between objects so that when one object changes state, all its dependents are notified and updated automatically.
>
> åœ¨å¯¹è±¡ä¹‹é—´å®šä¹‰ä¸€ä¸ªä¸€å¯¹å¤šçš„ä¾èµ–ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çŠ¶æ€æ”¹å˜çš„æ—¶å€™ï¼Œæ‰€æœ‰ä¾èµ–çš„å¯¹è±¡éƒ½ä¼šè‡ªåŠ¨æ”¶åˆ°é€šçŸ¥ã€‚

**è§‚å¯Ÿè€…æ¨¡å¼**ï¼ˆObserver Design Patternï¼‰ä¹Ÿè¢«ç§°ä¸º**å‘å¸ƒè®¢é˜…æ¨¡å¼**ï¼ˆPublish-Subscribe Design Patternï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¢«ä¾èµ–çš„å¯¹è±¡å«ä½œ**è¢«è§‚å¯Ÿè€…**ï¼ˆObservableï¼‰ï¼Œä¾èµ–çš„å¯¹è±¡å«ä½œ**è§‚å¯Ÿè€…**ï¼ˆObserverï¼‰ã€‚å®ƒä»¬è¿˜æœ‰ç€å…¶ä»–ç§°è°“ï¼Œä¾‹å¦‚ï¼ŒSubject-Observerã€Publisher-Subscriberã€Producer-Consumerã€EventEmitter-EventListenerã€Dispatcher-Listenerã€‚

ä¸åŒçš„åº”ç”¨åœºæ™¯å’Œéœ€æ±‚ä¸‹ï¼Œè¿™ä¸ªæ¨¡å¼æœ‰æˆªç„¶ä¸åŒçš„å®ç°æ–¹å¼ã€‚ä¾‹å¦‚ï¼ŒåŒæ­¥é˜»å¡ã€å¼‚æ­¥éé˜»å¡ã€è¿›ç¨‹å†…çš„ã€è¿›ç¨‹é—´çš„ã€‚

æˆ‘ä»¬æœ‰æ›´åŠ ä¼˜é›…ã€æ›´åŠ å¸¸ç”¨çš„æ–¹å¼æ¥å®ç°è§‚å¯Ÿè€…æ¨¡å¼ï¼Œé‚£å°±æ˜¯**åŸºäºæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queue**ï¼‰æ¥å®ç°ã€‚å®ƒä¸ä»…ä»…å¯ä»¥å®ç°è¿›ç¨‹é—´çš„è®¢é˜…ï¼Œè€Œä¸”è¿˜æ›´åŠ å½»åº•åœ°è§£è€¦è¢«è§‚å¯Ÿè€…å’Œè§‚å¯Ÿè€…ã€‚

ä¸‹é¢ç»™å‡ºè§‚å¯Ÿè€…æ¨¡å¼çš„åŒæ­¥é˜»å¡å¼â€œæ¨¡æ¿ä»£ç â€ï¼š

~~~java
public interface Subject {
  void registerObserver(Observer observer);
  void removeObserver(Observer observer);
  void notifyObservers(Message message);
}

public interface Observer {
  void update(Message message);
}

public class ConcreteSubject implements Subject {
  //ä¿å­˜è®¢é˜…è€…
  private List<Observer> observers = new ArrayList<Observer>();

  @Override
  public void registerObserver(Observer observer) {
    observers.add(observer);
  }

  @Override
  public void removeObserver(Observer observer) {
    observers.remove(observer);
  }

  @Override
  public void notifyObservers(Message message) {
    for (Observer observer : observers) {
      observer.update(message);
    }
  }

}

public class ConcreteObserverOne implements Observer {
  @Override
  public void update(Message message) {
    //TODO: è·å–æ¶ˆæ¯é€šçŸ¥ï¼Œæ‰§è¡Œè‡ªå·±çš„é€»è¾‘...
    System.out.println("ConcreteObserverOne is notified.");
  }
}

public class ConcreteObserverTwo implements Observer {
  @Override
  public void update(Message message) {
    //TODO: è·å–æ¶ˆæ¯é€šçŸ¥ï¼Œæ‰§è¡Œè‡ªå·±çš„é€»è¾‘...
    System.out.println("ConcreteObserverTwo is notified.");
  }
}

public class Demo {
  public static void main(String[] args) {
    ConcreteSubject subject = new ConcreteSubject();
    subject.registerObserver(new ConcreteObserverOne());
    subject.registerObserver(new ConcreteObserverTwo());
    subject.notifyObservers(new Message());
  }
}

~~~

ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…·ä½“æ¡ˆä¾‹ï¼šå‡è®¾æˆ‘ä»¬åœ¨å¼€å‘ä¸€ä¸ªP2PæŠ•èµ„ç†è´¢ç³»ç»Ÿï¼Œç”¨æˆ·æ³¨å†ŒæˆåŠŸä¹‹åï¼Œæˆ‘ä»¬ä¼šç»™ç”¨æˆ·å‘æ”¾æŠ•èµ„ä½“éªŒé‡‘ã€‚

~~~java
public class UserController {
  private UserService userService; // ä¾èµ–æ³¨å…¥
  private PromotionService promotionService; // ä¾èµ–æ³¨å…¥

  public Long register(String telephone, String password) {
    long userId = userService.register(telephone, password);	//æ³¨å†Œ
    promotionService.issueNewUserExperienceCash(userId);		//å‘æ”¾ä½“éªŒé‡‘
    return userId;
  }
}

~~~

æ˜¾ç„¶ï¼Œregisterè¿åå•ä¸€èŒè´£åŸåˆ™ã€‚è€Œä¸”ï¼Œå¦‚æœéœ€æ±‚å‘ç”Ÿå˜åŠ¨ï¼Œä¸å†å‘æ”¾ä½“éªŒé‡‘ï¼Œè€Œæ˜¯æ”¹ä¸ºå‘æ”¾ä¼˜æƒ åˆ¸ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¿®æ”¹register()å‡½æ•°ä¸­çš„ä»£ç ã€‚è¿™è¿åå¼€é—­åŸåˆ™ã€‚

æˆ‘ä»¬åˆ©ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼Œå¯¹ä¸Šé¢ä»£ç é‡æ„ï¼š

~~~java
public interface RegObserver {				//è§‚å¯Ÿè€…
  void handleRegSuccess(long userId);
}

//å‘æ”¾ä½“éªŒé‡‘
public class RegPromotionObserver implements RegObserver {
  private PromotionService promotionService; // ä¾èµ–æ³¨å…¥

  @Override
  public void handleRegSuccess(long userId) {
    promotionService.issueNewUserExperienceCash(userId);
  }
}

//å‘é€ä¸€å°â€œæ¬¢è¿æ³¨å†ŒæˆåŠŸâ€çš„ç«™å†…ä¿¡
public class RegNotificationObserver implements RegObserver {
  private NotificationService notificationService;

  @Override
  public void handleRegSuccess(long userId) {
    notificationService.sendInboxMessage(userId, "Welcome...");
  }
}

public class UserController {
  private UserService userService; // ä¾èµ–æ³¨å…¥
  private List<RegObserver> regObservers = new ArrayList<>();

  // ä¸€æ¬¡æ€§è®¾ç½®å¥½ï¼Œä¹‹åä¹Ÿä¸å¯èƒ½åŠ¨æ€çš„ä¿®æ”¹
  public void setRegObservers(List<RegObserver> observers) {
    regObservers.addAll(observers);
  }

  public Long register(String telephone, String password) {
    long userId = userService.register(telephone, password);

    for (RegObserver observer : regObservers) {
      observer.handleRegSuccess(userId);
    }

    return userId;
  }
}
~~~

å½“æˆ‘ä»¬éœ€è¦æ·»åŠ æ–°çš„è§‚å¯Ÿè€…çš„æ—¶å€™ï¼ŒUserControllerç±»çš„register()å‡½æ•°å®Œå…¨ä¸éœ€è¦ä¿®æ”¹ï¼Œåªéœ€è¦å†æ·»åŠ ä¸€ä¸ªå®ç°äº†RegObserveræ¥å£çš„ç±»ï¼Œå¹¶ä¸”é€šè¿‡setRegObservers()å‡½æ•°å°†å®ƒæ³¨å†Œåˆ°UserControllerç±»ä¸­å³å¯ã€‚

### å¼‚æ­¥éé˜»å¡çš„EventBusæ¡†æ¶

ä¸Šè¿°`UserController`çš„è§‚å¯Ÿè€…æ¨¡å¼å®ç°æ˜¯ä¸€ç§åŒæ­¥é˜»å¡çš„ï¼Œå³è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ä»£ç åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…æ‰§è¡Œï¼Œè¢«è§‚å¯Ÿè€…ä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æ‰€æœ‰çš„è§‚å¯Ÿè€…ä»£ç éƒ½æ‰§è¡Œå®Œæˆä¹‹åï¼Œæ‰æ‰§è¡Œåç»­çš„ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸€ä¸ªè§‚å¯Ÿè€…åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œæ¥å®ç°å¼‚æ­¥éé˜»å¡å¼è§‚å¯Ÿè€…æ¨¡å¼ã€‚

~~~java
// ç¬¬ä¸€ç§å®ç°æ–¹å¼ï¼Œå…¶ä»–ç±»ä»£ç ä¸å˜ï¼Œå°±æ²¡æœ‰å†é‡å¤ç½—åˆ—
public class RegPromotionObserver implements RegObserver {
  private PromotionService promotionService; // ä¾èµ–æ³¨å…¥

  @Override
  public void handleRegSuccess(Long userId) {
    Thread thread = new Thread(new Runnable() {
      @Override
      public void run() {
        promotionService.issueNewUserExperienceCash(userId);
      }
    });
    thread.start();
  }
}

// ç¬¬äºŒç§å®ç°æ–¹å¼ï¼Œå…¶ä»–ç±»ä»£ç ä¸å˜ï¼Œå°±æ²¡æœ‰å†é‡å¤ç½—åˆ—
public class UserController {
  private UserService userService; // ä¾èµ–æ³¨å…¥
  private List<RegObserver> regObservers = new ArrayList<>();
  private Executor executor;

  public UserController(Executor executor) {
    this.executor = executor;
  }

  public void setRegObservers(List<RegObserver> observers) {
    regObservers.addAll(observers);
  }

  public Long register(String telephone, String password) {
    //çœç•¥è¾“å…¥å‚æ•°çš„æ ¡éªŒä»£ç 
    //çœç•¥userService.register()å¼‚å¸¸çš„try-catchä»£ç 
    long userId = userService.register(telephone, password);

    for (RegObserver observer : regObservers) {
      executor.execute(new Runnable() {
        @Override
        public void run() {
          observer.handleRegSuccess(userId);
        }
      });
    }

    return userId;
  }
}

~~~

å¯¹äºç¬¬ä¸€ç§å®ç°æ–¹å¼ï¼Œé¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹æ¯”è¾ƒè€—æ—¶ï¼Œå¹¶ä¸”å¹¶å‘çº¿ç¨‹æ•°æ— æ³•æ§åˆ¶ï¼Œåˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹ä¼šå¯¼è‡´å †æ ˆæº¢å‡ºã€‚ç¬¬äºŒç§å®ç°æ–¹å¼ï¼Œå°½ç®¡åˆ©ç”¨äº†çº¿ç¨‹æ± è§£å†³äº†ç¬¬ä¸€ç§å®ç°æ–¹å¼çš„é—®é¢˜ï¼Œä½†çº¿ç¨‹æ± ã€å¼‚æ­¥æ‰§è¡Œé€»è¾‘éƒ½è€¦åˆåœ¨äº†register()å‡½æ•°ä¸­ï¼Œå¢åŠ äº†è¿™éƒ¨åˆ†ä¸šåŠ¡ä»£ç çš„ç»´æŠ¤æˆæœ¬ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨EventBusæ¡†æ¶æ¥è§£å†³ä¸Šè¿°é—®é¢˜ã€‚Google Guava EventBuså°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒè‘—åçš„EventBusæ¡†æ¶ã€‚

~~~java
public class UserController {
  private UserService userService; // ä¾èµ–æ³¨å…¥

  private EventBus eventBus;		//ä¾èµ–æ³¨å…¥
  private static final int DEFAULT_EVENTBUS_THREAD_POOL_SIZE = 20;

  public UserController() {
    // åŒæ­¥é˜»å¡æ¨¡å¼
    // eventBus = new EventBus(); 
    
    // å¼‚æ­¥éé˜»å¡æ¨¡å¼
    eventBus = new AsyncEventBus(Executors.newFixedThreadPool(DEFAULT_EVENTBUS_THREAD_POOL_SIZE)); 
  }

  public void setRegObservers(List<Object> observers) {
    for (Object observer : observers) {
      eventBus.register(observer);
    }
  }

  public Long register(String telephone, String password) {
    long userId = userService.register(telephone, password);
    eventBus.post(userId);			//å‘é€é€šçŸ¥
    return userId;
  }
}

public class RegPromotionObserver {
  private PromotionService promotionService; // ä¾èµ–æ³¨å…¥

  //é€šçŸ¥è§¦å‘æ—¶ï¼Œéœ€è¦è°ƒç”¨çš„æ–¹æ³•
  @Subscribe
  public void handleRegSuccess(Long userId) {
    promotionService.issueNewUserExperienceCash(userId);
  }
}

public class RegNotificationObserver {
  private NotificationService notificationService;

  @Subscribe
  public void handleRegSuccess(Long userId) {
    notificationService.sendInboxMessage(userId, "...");
  }
}

~~~

åŸºäºEventBusï¼Œæˆ‘ä»¬ä¸éœ€è¦å®šä¹‰Observeræ¥å£ï¼Œä»»æ„ç±»å‹çš„å¯¹è±¡éƒ½å¯ä»¥æ³¨å†Œåˆ°EventBusä¸­ï¼Œé€šè¿‡@Subscribeæ³¨è§£æ¥æ ‡æ˜ç±»ä¸­å“ªä¸ªå‡½æ•°å¯ä»¥å¤„ç†Subjectå‘é€çš„æ¶ˆæ¯ã€‚

è¿™é‡Œéœ€è¦ç‰¹åˆ«è¯´æ˜ä»¥ä¸‹post()å‡½æ•°ï¼Œå®ƒçš„å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š

~~~java
public void post(Object event);
~~~

å½“post()å‘åŒ¹é…eventå¯¹è±¡ç±»å‹çš„è§‚å¯Ÿè€…å‘é€æ¶ˆæ¯ã€‚è¿™é‡Œã€ŒåŒ¹é…ã€æ˜¯æŒ‡ï¼Œèƒ½æ¥æ”¶çš„æ¶ˆæ¯ç±»å‹æ˜¯å‘é€æ¶ˆæ¯ï¼ˆeventå¯¹è±¡ï¼‰ç±»å‹çš„çˆ¶ç±»ã€‚



ç°åœ¨æˆ‘ä»¬å°±å®ç°ä¸€ä¸ªç®€å•çš„EventBusæ¡†æ¶ï¼Œæ ¸å¿ƒæ–¹æ³•å°±æ˜¯registerä¸post

![](assets/ce842666fa3dc92bb8f4f2d8e75d12c6.jpg)

![](assets/bf7ef52a40b1e35b18f369265caca645.jpg)



é¦–å…ˆå®šä¹‰Subscribeæ³¨è§£ï¼š

~~~java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.METHOD)
@Beta
public @interface Subscribe {}
~~~

ObserverActionç±»ç”¨æ¥è¡¨ç¤º@Subscribeæ³¨è§£çš„æ–¹æ³•ã€‚

~~~java
public class ObserverAction {
  private Object target;			//è§‚å¯Ÿè€…ç±»
  private Method method;			

  public ObserverAction(Object target, Method method) {
    this.target = Preconditions.checkNotNull(target);
    this.method = method;
    this.method.setAccessible(true);
  }

  public void execute(Object event) { // eventæ˜¯methodæ–¹æ³•çš„å‚æ•°
    try {
      method.invoke(target, event);
    } catch (InvocationTargetException | IllegalAccessException e) {
      e.printStackTrace();
    }
  }
}
~~~

ObserverRegistryç±»å°±æ˜¯Observeræ³¨å†Œè¡¨

~~~java
public class ObserverRegistry {
  //æ¯ä¸€ä¸ªClassï¼Œéƒ½æœ‰å¯¹åº”çš„ObserverAction Seté›†åˆ
  private ConcurrentMap<Class<?>, CopyOnWriteArraySet<ObserverAction>> registry = new ConcurrentHashMap<>();

  public void register(Object observer) {
    Map<Class<?>, Collection<ObserverAction>> observerActions = findAllObserverActions(observer);
      
    //è¿™é‡Œå¯¹registryçš„æ›´æ–°ç­–ç•¥ä¸º
    for (Map.Entry<Class<?>, Collection<ObserverAction>> entry : observerActions.entrySet()) {
      Class<?> eventType = entry.getKey();
      Collection<ObserverAction> eventActions = entry.getValue();
        

      CopyOnWriteArraySet<ObserverAction> registeredEventActions = registry.get(eventType);
      if (registeredEventActions == null) {
        registry.putIfAbsent(eventType, new CopyOnWriteArraySet<>());
        registeredEventActions = registry.get(eventType);
      }
      registeredEventActions.addAll(eventActions);
    }
  }

  //è¿”å›ä¸€ä¸ªæ–°çš„ã€åŒ…å«æ‰€æœ‰æŒ‡å®šå¯¹è±¡observerçš„@Subscribeæ–¹æ³•çš„ObserverAction
  private Map<Class<?>, Collection<ObserverAction>> findAllObserverActions(Object observer) {
    Map<Class<?>, Collection<ObserverAction>> observerActions = new HashMap<>();
      
    //è·å–è§‚å¯Ÿè€…çš„ç±»å‹
    Class<?> clazz = observer.getClass();
    //æ›´æ–°ObserverAction Seté›†åˆ
    for (Method method : getAnnotatedMethods(clazz)) {
      Class<?>[] parameterTypes = method.getParameterTypes();
      Class<?> eventType = parameterTypes[0];
      if (!observerActions.containsKey(eventType)) {
        observerActions.put(eventType, new ArrayList<>());
      }
      observerActions.get(eventType).add(new ObserverAction(observer, method));
    }
    return observerActions;
  }

  //è¿”å›æ‰€æœ‰åœ¨Classå¯¹è±¡ä¸­çš„@Subscribeæ–¹æ³•
  private List<Method> getAnnotatedMethods(Class<?> clazz) {
    List<Method> annotatedMethods = new ArrayList<>();
    for (Method method : clazz.getDeclaredMethods()) {
      if (method.isAnnotationPresent(Subscribe.class)) {
        Class<?>[] parameterTypes = method.getParameterTypes();
        //å‚æ•°çš„ä¸ªæ•°åªèƒ½æ˜¯ä¸€ä¸ª
        Preconditions.checkArgument(parameterTypes.length == 1,
                "Method %s has @Subscribe annotation but has %s parameters."
                        + "Subscriber methods must have exactly 1 parameter.",
                method, parameterTypes.length);
        annotatedMethods.add(method);
      }
    }
    return annotatedMethods;
  }
    
  public List<ObserverAction> getMatchedObserverActions(Object event) {
    List<ObserverAction> matchedObservers = new ArrayList<>();
    Class<?> postedEventType = event.getClass();
    for (Map.Entry<Class<?>, CopyOnWriteArraySet<ObserverAction>> entry : registry.entrySet()) {
      Class<?> eventType = entry.getKey();
      Collection<ObserverAction> eventActions = entry.getValue();
      if (postedEventType.isAssignableFrom(eventType)) {
        matchedObservers.addAll(eventActions);
      }
    }
    return matchedObservers;
  }
}
~~~



è¿™é‡Œä½¿ç”¨CopyOnWriteArraySeté›†åˆæ¥ä¿è¯å¤šçº¿ç¨‹ä¸‹çš„æ­£ç¡®æ€§ï¼Œå®ƒçš„æ ¸å¿ƒå±æ€§æœ‰ä¸¤ä¸ªï¼Œ

~~~java
final transient ReentrantLock lock = new ReentrantLock();
private transient volatile Object[] array;
~~~

åŸºæœ¬æ€æƒ³æ˜¯ï¼šå½“è¦å®¹å™¨è¦æ‰§è¡Œå†™æ“ä½œæ—¶ï¼ŒåŸºäºå½“å‰å®¹å™¨å¤åˆ¶å‡ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œç„¶ååœ¨æ–°å®¹å™¨é‡Œå˜æ›´ï¼Œæœ€åå°†æ—§å®¹å™¨çš„å¼•ç”¨æŒ‡å‘æ–°å®¹å™¨ã€‚ReentrantLockä¸volatileçš„é…åˆä¿è¯äº†å®¹å™¨çš„çº¿ç¨‹å®‰å…¨ã€‚å…¶ä¸­é”ğŸ”’çš„èŒƒå›´æ˜¯ä¿®æ”¹æ“ä½œï¼Œè€Œä¸æ˜¯è¯»æ“ä½œã€‚



~~~java
public class EventBus {
  private Executor executor;
  private ObserverRegistry registry = new ObserverRegistry();

  //åœ¨ä¿è¯æ˜“ç”¨æ€§çš„å‰æä¸‹ï¼Œæå‡äº†å¯æµ‹æ€§
  public EventBus() {
    this(MoreExecutors.directExecutor());
  }

  protected EventBus(Executor executor) {
    this.executor = executor;
  }

  public void register(Object object) {
    registry.register(object);
  }

  public void post(Object event) {
    List<ObserverAction> observerActions = registry.getMatchedObserverActions(event);
    for (ObserverAction observerAction : observerActions) {
      executor.execute(new Runnable() {
        @Override
        public void run() {
          observerAction.execute(event);
        }
      });
    }
  }
}
~~~

EventBuså®ç°çš„æ˜¯é˜»å¡åŒæ­¥çš„è§‚å¯Ÿè€…æ¨¡å¼ï¼Œè€Œä½¿ç”¨äº†çº¿ç¨‹æ± Executorï¼Œåªä¸è¿‡Executoråªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™æ˜¯ä¸ºäº†è·ŸAsyncEventBusç»Ÿä¸€ä»£ç é€»è¾‘ï¼Œåšåˆ°ä»£ç å¤ç”¨ã€‚

~~~java
public class AsyncEventBus extends EventBus {
  public AsyncEventBus(Executor executor) {
    super(executor);
  }
}
~~~

è¿™ä¸ªæ˜¯[Google Guava EventBusçš„æºç ](https://github.com/google/guava)ï¼Œ



## æ¨¡æ¿æ¨¡å¼

**æ¨¡æ¿æ¨¡å¼ï¼ˆTemplate Method Design Patternï¼‰**

> Define the skeleton of an algorithm in an operation, deferring some steps to subclasses. Template Method lets subclasses redefine certain steps of an algorithm without changing the algorithmâ€™s structure.
>
> æ¨¡æ¿æ–¹æ³•æ¨¡å¼åœ¨ä¸€ä¸ªæ–¹æ³•ä¸­å®šä¹‰ä¸€ä¸ªç®—æ³•éª¨æ¶ï¼Œå¹¶å°†æŸäº›æ­¥éª¤æ¨è¿Ÿåˆ°å­ç±»ä¸­å®ç°ã€‚æ¨¡æ¿æ–¹æ³•æ¨¡å¼å¯ä»¥è®©å­ç±»åœ¨ä¸æ”¹å˜ç®—æ³•æ•´ä½“ç»“æ„çš„æƒ…å†µä¸‹ï¼Œé‡æ–°å®šä¹‰ç®—æ³•ä¸­çš„æŸäº›æ­¥éª¤

è¿™é‡Œçš„ã€Œç®—æ³•ã€ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºã€Œä¸šåŠ¡é€»è¾‘ã€ã€‚



ä¸‹é¢å°±æ˜¯æ¨¡æ¿ä»£ç çš„å¤§è‡´å®ç°ï¼š

~~~java
public abstract class AbstractClass {
  public final void templateMethod() {
    // ç®—æ³•éª¨æ¶
    //...
    method1();
    //...
    method2();
    //...
  }
  
  protected abstract void method1();		
  protected abstract void method2();
}

public class ConcreteClass1 extends AbstractClass {
  @Override
  protected void method1() {
    //...
  }
  
  @Override
  protected void method2() {
    //...
  }
}

public class ConcreteClass2 extends AbstractClass {
  @Override
  protected void method1() {
    //...
  }
  
  @Override
  protected void method2() {
    //...
  }
}

AbstractClass demo = ConcreteClass1();
demo.templateMethod();

~~~

æ¨¡æ¿æ¨¡å¼æœ‰ä¸¤å¤§ä½œç”¨ï¼šå¤ç”¨å’Œæ‰©å±•ã€‚æˆ‘ä»¬å…ˆæ¥è€ƒå¯Ÿå®ƒçš„ç¬¬ä¸€ä¸ªä½œç”¨â€”â€”å¤ç”¨

### ä½œç”¨ä¸€ï¼šå¤ç”¨

æ¨¡æ¿æ¨¡å¼æŠŠä¸€ä¸ªç®—æ³•ä¸­ä¸å˜çš„æµç¨‹æŠ½è±¡åˆ°çˆ¶ç±»çš„æ¨¡æ¿æ–¹æ³•templateMethod()ä¸­ï¼Œå°†å¯å˜çš„éƒ¨åˆ†method1()ã€method2()ç•™ç»™å­ç±»ContreteClass1å’ŒContreteClass2æ¥å®ç°ã€‚

InputStreamç±»å°±ä½“ç°äº†æ¨¡æ¿æ¨¡å¼çš„å¤ç”¨ï¼š

~~~java
public abstract class InputStream implements Closeable {
  //...çœç•¥å…¶ä»–ä»£ç ...
  
  public int read(byte b[], int off, int len) throws IOException {
    if (b == null) {
      throw new NullPointerException();
    } else if (off < 0 || len < 0 || len > b.length - off) {
      throw new IndexOutOfBoundsException();
    } else if (len == 0) {
      return 0;
    }

    int c = read();
    if (c == -1) {
      return -1;
    }
    b[off] = (byte)c;

    int i = 1;
    try {
      for (; i < len ; i++) {
        c = read();
        if (c == -1) {
          break;
        }
        b[off + i] = (byte)c;
      }
    } catch (IOException ee) {
    }
    return i;
  }
  
  public abstract int read() throws IOException;
}

public class ByteArrayInputStream extends InputStream {
  //...çœç•¥å…¶ä»–ä»£ç ...
  
  @Override
  public synchronized int read() {
    return (pos < count) ? (buf[pos++] & 0xff) : -1;
  }
}

~~~

 AbstractListç±»ä¹Ÿæ˜¯å¦‚æ­¤
~~~java
public boolean addAll(int index, Collection<? extends E> c) {
    rangeCheckForAdd(index);
    boolean modified = false;
    for (E e : c) {
        add(index++, e);
        modified = true;
    }
    return modified;
}

//add()æ˜¯å­ç±»éœ€è¦é‡å†™çš„æ–¹æ³•ï¼Œå°½ç®¡æ²¡æœ‰å£°æ˜ä¸ºabstractçš„ï¼Œä½†å‡½æ•°å®ç°ç›´æ¥æŠ›å‡ºäº†UnsupportedOperationExceptionå¼‚å¸¸
public void add(int index, E element) {
    throw new UnsupportedOperationException();
}
~~~



### ä½œç”¨äºŒï¼šæ‰©å±•

æˆ‘ä»¬å†æ¥çœ‹å®ƒçš„ç¬¬äºŒä¸ªä½œç”¨â€”â€”æ‰©å±•

è¿™é‡Œçš„æ‰©å±•ï¼Œå¹¶ä¸æ˜¯æŒ‡ä»£ç çš„æ‰©å±•æ€§ï¼Œè€Œæ˜¯æŒ‡æ¡†æ¶çš„æ‰©å±•æ€§ã€‚è¿™ç›¸å½“äºç»™æ¡†æ¶å¼€å‘æ’ä»¶ï¼Œæˆ–è€…å®šåˆ¶åŒ–æ¡†æ¶çš„æŸä¸ªåŠŸèƒ½ã€‚

æˆ‘ä»¬é€šè¿‡`Java Servlet`è¿™ä¸ªä¾‹å­æ¥è§£é‡Šä¸€ä¸‹ã€‚æˆ‘ä»¬ç°åœ¨ä½¿ç”¨Servletæ¥å¼€å‘Webé¡¹ç›®ï¼Œé‚£ä¹ˆéœ€è¦å®šä¹‰ä¸€ä¸ªç»§æ‰¿HttpServletçš„ç±»ï¼Œå¹¶ä¸”é‡å†™å…¶ä¸­çš„doGet()ï¼Œæ¥å¤„ç†getè¯·æ±‚ã€‚

~~~java
public class HelloServlet extends HttpServlet {
  @Override
  protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    this.doPost(req, resp);
  }
  
  @Override
  protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    resp.getWriter().write("Hello World.");
  }
}

~~~

è¿˜éœ€è¦åœ¨é…ç½®æ–‡ä»¶web.xmlä¸­åšå¦‚ä¸‹é…ç½®ï¼š

~~~xml
<!--å®šä¹‰äº†URLå’ŒServletä¹‹é—´çš„æ˜ å°„å…³ç³»-->
<servlet>
    <servlet-name>HelloServlet</servlet-name>
    <servlet-class>com.xzg.cd.HelloServlet</servlet-class>
</servlet>

<servlet-mapping>
    <servlet-name>HelloServlet</servlet-name>
    <url-pattern>/hello</url-pattern>
</servlet-mapping>
~~~

HttpServletçš„service()æ–¹æ³•å°±æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œå®ƒå®ç°äº†æ•´ä¸ªHTTPè¯·æ±‚çš„æ‰§è¡Œæµç¨‹ï¼ŒdoGet()ã€doPost()æ˜¯æ¨¡æ¿ä¸­å¯ä»¥ç”±å­ç±»æ¥å®šåˆ¶çš„éƒ¨åˆ†ã€‚å®é™…ä¸Šï¼Œè¿™å°±ç›¸å½“äºServletæ¡†æ¶æä¾›äº†ä¸€ä¸ªæ‰©å±•ç‚¹ï¼ˆdoGet()ã€doPost()æ–¹æ³•ï¼‰ï¼Œè®©æ¡†æ¶ç”¨æˆ·åœ¨ä¸ç”¨ä¿®æ”¹Servletæ¡†æ¶æºç çš„æƒ…å†µä¸‹ï¼Œå°†ä¸šåŠ¡ä»£ç é€šè¿‡æ‰©å±•ç‚¹é•¶åµŒåˆ°æ¡†æ¶ä¸­æ‰§è¡Œã€‚

~~~java
public void service(ServletRequest req, ServletResponse res)
    throws ServletException, IOException
{
    HttpServletRequest  request;
    HttpServletResponse response;
    if (!(req instanceof HttpServletRequest &&
            res instanceof HttpServletResponse)) {
        throw new ServletException("non-HTTP request or response");
    }
    request = (HttpServletRequest) req;
    response = (HttpServletResponse) res;
    service(request, response);
}

protected void service(HttpServletRequest req, HttpServletResponse resp)
    throws ServletException, IOException
{
    String method = req.getMethod();
    if (method.equals(METHOD_GET)) {
        long lastModified = getLastModified(req);
        if (lastModified == -1) {
            // servlet doesn't support if-modified-since, no reason
            // to go through further expensive logic
            doGet(req, resp);
        } else {
            long ifModifiedSince = req.getDateHeader(HEADER_IFMODSINCE);
            if (ifModifiedSince < lastModified) {
                // If the servlet mod time is later, call doGet()
                // Round down to the nearest second for a proper compare
                // A ifModifiedSince of -1 will always be less
                maybeSetLastModified(resp, lastModified);
                doGet(req, resp);
            } else {
                resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
            }
        }
    } else if (method.equals(METHOD_HEAD)) {
        long lastModified = getLastModified(req);
        maybeSetLastModified(resp, lastModified);
        doHead(req, resp);
    } else if (method.equals(METHOD_POST)) {
        doPost(req, resp);
    } else if (method.equals(METHOD_PUT)) {
        doPut(req, resp);
    } else if (method.equals(METHOD_DELETE)) {
        doDelete(req, resp);
    } else if (method.equals(METHOD_OPTIONS)) {
        doOptions(req,resp);
    } else if (method.equals(METHOD_TRACE)) {
        doTrace(req,resp);
    } else {
        String errMsg = lStrings.getString("http.method_not_implemented");
        Object[] errArgs = new Object[1];
        errArgs[0] = method;
        errMsg = MessageFormat.format(errMsg, errArgs);
        resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);
    }
}

~~~



### æ¨¡æ¿æ¨¡å¼ä¸Callbackçš„åŒºåˆ«å’Œè”ç³»

å›è°ƒæ˜¯ä¸€ç§åŒå‘è°ƒç”¨å…³ç³»ï¼ŒAç±»äº‹å…ˆæ³¨å†ŒæŸä¸ªå‡½æ•°Fåˆ°Bç±»ï¼ŒAç±»åœ¨è°ƒç”¨Bç±»çš„På‡½æ•°çš„æ—¶å€™ï¼ŒBç±»åè¿‡æ¥è°ƒç”¨Aç±»æ³¨å†Œç»™å®ƒçš„Få‡½æ•°ã€‚è¿™é‡Œçš„Få‡½æ•°å°±æ˜¯â€œå›è°ƒå‡½æ•°â€ã€‚Aè°ƒç”¨Bï¼ŒBåè¿‡æ¥åˆè°ƒç”¨Aï¼Œè¿™ç§è°ƒç”¨æœºåˆ¶å°±å«ä½œâ€œå›è°ƒâ€ã€‚å›è°ƒå‡½æ•°çš„å‚æ•°æ˜¯Aç±»å‘Bç±»æ‰€æš´éœ²çš„çŠ¶æ€ã€‚



åœ¨Javaä¸­ï¼Œå›è°ƒçš„å½¢å¼å¦‚ä¸‹ï¼š

~~~java
public interface ICallback {
  void methodToCallback();
}

public class BClass {
  public void process(ICallback callback) {
    //...
    callback.methodToCallback();
    //...
  }
}

public class AClass {
  public static void main(String[] args) {
    BClass b = new BClass();
    b.process(new ICallback() { //å›è°ƒå¯¹è±¡
      @Override
      public void methodToCallback() {
        System.out.println("Call back me.");
      }
    });
  }
}
~~~

å›è°ƒå¯ä»¥åˆ†ä¸º**åŒæ­¥å›è°ƒ**å’Œ**å¼‚æ­¥å›è°ƒ**

ä»åº”ç”¨åœºæ™¯ä¸Šæ¥çœ‹ï¼ŒåŒæ­¥å›è°ƒè·Ÿæ¨¡æ¿æ¨¡å¼å‡ ä¹ä¸€è‡´ã€‚å®ƒä»¬éƒ½æ˜¯åœ¨ä¸€ä¸ªå¤§çš„ç®—æ³•éª¨æ¶ä¸­ï¼Œè‡ªç”±æ›¿æ¢å…¶ä¸­çš„æŸä¸ªæ­¥éª¤ï¼Œèµ·åˆ°ä»£ç å¤ç”¨å’Œæ‰©å±•çš„ç›®çš„ã€‚è€Œå¼‚æ­¥å›è°ƒè·Ÿæ¨¡æ¿æ¨¡å¼æœ‰è¾ƒå¤§å·®åˆ«ï¼Œæ›´åƒæ˜¯è§‚å¯Ÿè€…æ¨¡å¼ã€‚

ä»ä»£ç å®ç°ä¸Šæ¥çœ‹ï¼Œå›è°ƒå’Œæ¨¡æ¿æ¨¡å¼å®Œå…¨ä¸åŒã€‚å›è°ƒåŸºäºç»„åˆå…³ç³»æ¥å®ç°ï¼ŒæŠŠä¸€ä¸ªå¯¹è±¡ä¼ é€’ç»™å¦ä¸€ä¸ªå¯¹è±¡ï¼Œæ˜¯ä¸€ç§å¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼›æ¨¡æ¿æ¨¡å¼åŸºäºç»§æ‰¿å…³ç³»æ¥å®ç°ï¼Œå­ç±»é‡å†™çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œæ˜¯ä¸€ç§ç±»ä¹‹é—´çš„å…³ç³»ã€‚

æ­¤å¤–ï¼Œåœ¨ä»£ç å®ç°ä¸Šï¼Œå›è°ƒç›¸å¯¹äºæ¨¡æ¿æ¨¡å¼ä¼šæ›´åŠ çµæ´»ï¼Œä¸»è¦ä½“ç°åœ¨ä¸‹é¢å‡ ç‚¹ï¼š

- Javaä»…æ”¯æŒå•ç»§æ‰¿ï¼Œå¦‚æœä¸€ä¸ªç±»å·²ç»æœ‰äº†çˆ¶ç±»ï¼Œé‚£ä¹ˆå°±ä¸èƒ½é€šè¿‡æ¨¡æ¿æ¨¡å¼æ¥è¦†å†™æ‰©å±•ç‚¹äº†
- é€šè¿‡æ¨¡æ¿æ–¹æ³•ï¼Œå­ç±»å¿…é¡»è¦†å†™æ‰€æœ‰çš„æŠ½è±¡æ–¹æ³•ï¼Œå³ä½¿è¿™ä¸ªæŠ½è±¡æ–¹æ³•å®ƒä¸éœ€è¦ï¼›è€Œé€šè¿‡å›è°ƒï¼Œåªéœ€è¦å¾€ç”¨åˆ°çš„æ¨¡æ¿æ–¹æ³•ä¸­æ³¨å†Œå›è°ƒå¯¹è±¡å³å¯



ä¸å›è°ƒå‡½æ•°ç±»ä¼¼çš„æ¦‚å¿µå°±æ˜¯**é’©å­å‡½æ•°ï¼ˆHookï¼‰**ã€‚Callbackæ›´ä¾§é‡è¯­æ³•æœºåˆ¶çš„æè¿°ï¼ŒHookæ›´åŠ ä¾§é‡åº”ç”¨åœºæ™¯çš„æè¿°ã€‚è¿˜æœ‰ä¸€ç§è§‚ç‚¹è®¤ä¸ºæ˜¯è¿™ä¸¤è€…çš„å·®åˆ«åœ¨è°ƒç”¨æ—¶æœºä¸åŒï¼ŒCallbackåœ¨æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œè€ŒHookåœ¨æ–¹æ³•æ‰§è¡Œå‰åè¢«è°ƒç”¨ã€‚

Hookæ¯”è¾ƒç»å…¸çš„åº”ç”¨åœºæ™¯æ˜¯Tomcatå’ŒJVMçš„shutdown hookã€‚æˆ‘ä»¬æ¥çœ‹çœ‹JVMçš„Runtime.addShutdownHook(Thread hook)æ–¹æ³•ï¼Œå®ƒæ³¨å†Œäº†ä¸€ä¸ªJVMå…³é—­çš„Hookã€‚

~~~java
public class ShutdownHookDemo {

  private static class ShutdownHook extends Thread {
    public void run() {
      System.out.println("I am called during shutting down.");
    }
  }

  public static void main(String[] args) {
    //å‘JVMæ³¨å†Œè¿™ä¸ªHook
    Runtime.getRuntime().addShutdownHook(new ShutdownHook());
  }

}

~~~

æˆ‘ä»¬å†æ¥çœ‹addShutdownHook()çš„ä»£ç å®ç°ï¼š
~~~java
public class Runtime {
  public void addShutdownHook(Thread hook) {
    SecurityManager sm = System.getSecurityManager();
    if (sm != null) {
      sm.checkPermission(new RuntimePermission("shutdownHooks"));
    }
    //æœ‰å…³Hookçš„é€»è¾‘éƒ½è¢«å°è£…åˆ°ApplicationShutdownHooksç±»
    ApplicationShutdownHooks.add(hook);
  }
}

class ApplicationShutdownHooks {
    /* The set of registered hooks */
    private static IdentityHashMap<Thread, Thread> hooks;
    static {
            hooks = new IdentityHashMap<>();
        } catch (IllegalStateException e) {
            hooks = null;
        }
    }

    static synchronized void add(Thread hook) {
        if(hooks == null)
            throw new IllegalStateException("Shutdown in progress");

        if (hook.isAlive())
            throw new IllegalArgumentException("Hook already running");

        if (hooks.containsKey(hook))
            throw new IllegalArgumentException("Hook previously registered");

        hooks.put(hook, hook);
    }

	//å½“åº”ç”¨ç¨‹åºå…³é—­çš„æ—¶å€™ï¼ŒJVMä¼šè°ƒç”¨è¿™ä¸ªç±»çš„runHooks()æ–¹æ³•ï¼Œåˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œå¹¶å‘åœ°æ‰§è¡Œå¤šä¸ªHook
    static void runHooks() {
        Collection<Thread> threads;
        synchronized(ApplicationShutdownHooks.class) {
            threads = hooks.keySet();
            hooks = null;
        }

        for (Thread hook : threads) {
            hook.start();
        }
        for (Thread hook : threads) {
            while (true) {
                try {
                    hook.join();
                    break;
                } catch (InterruptedException ignored) {
                }
            }
        }
    }
}

~~~



## ç­–ç•¥æ¨¡å¼



> Define a family of algorithms, encapsulate each one, and make them interchangeable. Strategy lets the algorithm vary independently from clients that use it.
>
> å®šä¹‰ä¸€æ—ç®—æ³•ç±»ï¼Œå°†æ¯ä¸ªç®—æ³•åˆ†åˆ«å°è£…èµ·æ¥ï¼Œè®©å®ƒä»¬å¯ä»¥äº’ç›¸æ›¿æ¢ã€‚ç­–ç•¥æ¨¡å¼å¯ä»¥ä½¿ç®—æ³•çš„å˜åŒ–ç‹¬ç«‹äºä½¿ç”¨å®ƒä»¬çš„å®¢æˆ·ç«¯ï¼ˆè¿™é‡Œçš„å®¢æˆ·ç«¯ä»£æŒ‡ä½¿ç”¨ç®—æ³•çš„ä»£ç ï¼‰



**ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Design Patternï¼‰**è§£è€¦çš„æ˜¯ç­–ç•¥çš„å®šä¹‰ã€åˆ›å»ºã€ä½¿ç”¨è¿™ä¸‰éƒ¨åˆ†.



### å®šä¹‰

ç­–ç•¥ç±»çš„å®šä¹‰åŒ…å«ä¸€ä¸ªç­–ç•¥æ¥å£å’Œä¸€ç»„å®ç°è¿™ä¸ªæ¥å£çš„ç­–ç•¥ç±»ã€‚å› ä¸ºæ‰€æœ‰çš„ç­–ç•¥ç±»éƒ½å®ç°ç›¸åŒçš„æ¥å£ã€‚å› æ­¤ï¼Œå®¢æˆ·ç«¯ä»£ç å¯ä»¥åŸºäºæ¥å£è€Œéå®ç°ç¼–ç¨‹ï¼Œä»è€Œçµæ´»åœ°æ›¿æ¢ä¸åŒçš„ç­–ç•¥ã€‚

~~~java
public interface Strategy {
  void algorithmInterface();
}

public class ConcreteStrategyA implements Strategy {
  @Override
  public void  algorithmInterface() {
    //å…·ä½“çš„ç®—æ³•...
  }
}

public class ConcreteStrategyB implements Strategy {
  @Override
  public void  algorithmInterface() {
    //å…·ä½“çš„ç®—æ³•...
  }
}
~~~

### åˆ›å»º

ç­–ç•¥æ¨¡å¼ä¼šåŒ…å«ä¸€ç»„ç­–ç•¥ï¼Œä¸€èˆ¬åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ç±»å‹ï¼ˆtypeï¼‰æ¥é€‰æ‹©æ€§åœ°åˆ›å»ºç­–ç•¥ç±»ã€‚è¿™æ˜¯å·¥å‚ç±»å…¸å‹çš„ä½¿ç”¨åœºæ™¯ï¼š

~~~java
public class StrategyFactory {
  private static final Map<String, Strategy> strategies = new HashMap<>();

  static {
    strategies.put("A", new ConcreteStrategyA());
    strategies.put("B", new ConcreteStrategyB());
  }

  public static Strategy getStrategy(String type) {
    if (type == null || type.isEmpty()) {
      throw new IllegalArgumentException("type should not be empty.");
    }
    return strategies.get(type);
  }
}

~~~

å¦‚æœç­–ç•¥ç±»æ˜¯æ— çŠ¶æ€çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šè¿°ç¼“å­˜ç‰ˆæœ¬çš„å·¥å‚ç±»ã€‚å¦‚æœç­–ç•¥ç±»æ˜¯æœ‰çŠ¶æ€çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æŒ‰ç…§å¦‚ä¸‹æ–¹å¼æ¥å®ç°ç­–ç•¥å·¥å‚ç±»ã€‚

~~~java
public class StrategyFactory {
  public static Strategy getStrategy(String type) {
    if (type == null || type.isEmpty()) {
      throw new IllegalArgumentException("type should not be empty.");
    }

    if (type.equals("A")) {
      return new ConcreteStrategyA();
    } else if (type.equals("B")) {
      return new ConcreteStrategyB();
    }

    return null;
  }
}

~~~

### ä½¿ç”¨

å®¢æˆ·ç«¯ä¸€èˆ¬åœ¨è¿è¡Œæ—¶ï¼Œæ ¹æ®é…ç½®æ–‡ä»¶ã€ç”¨æˆ·è¾“å…¥ç­‰è¿™äº›ä¸ç¡®å®šå› ç´ ï¼Œæ¥åŠ¨æ€ç¡®å®šä½¿ç”¨å“ªç§ç­–ç•¥ã€‚

~~~java
// ç­–ç•¥æ¥å£ï¼šEvictionStrategy
// ç­–ç•¥ç±»ï¼šLruEvictionStrategyã€FifoEvictionStrategyã€LfuEvictionStrategy...
// ç­–ç•¥å·¥å‚ï¼šEvictionStrategyFactory

public class UserCache {
  private Map<String, User> cacheData = new HashMap<>();
  private EvictionStrategy eviction;

  public UserCache(EvictionStrategy eviction) {
    this.eviction = eviction;
  }

  //...
}

// è¿è¡Œæ—¶åŠ¨æ€ç¡®å®šï¼Œæ ¹æ®é…ç½®æ–‡ä»¶çš„é…ç½®å†³å®šä½¿ç”¨å“ªç§ç­–ç•¥
public class Application {
  public static void main(String[] args) throws Exception {
    EvictionStrategy evictionStrategy = null;
    Properties props = new Properties();
    props.load(new FileInputStream("./config.properties"));
    String type = props.getProperty("eviction_type");
    evictionStrategy = EvictionStrategyFactory.getEvictionStrategy(type);	//åŠ¨æ€åœ°é€‰æ‹©ä¸åŒçš„ç­–ç•¥
    UserCache userCache = new UserCache(evictionStrategy);
    //...
  }
}

// éè¿è¡Œæ—¶åŠ¨æ€ç¡®å®šï¼Œåœ¨ä»£ç ä¸­æŒ‡å®šä½¿ç”¨å“ªç§ç­–ç•¥
public class Application {
  public static void main(String[] args) {
    //...
    EvictionStrategy evictionStrategy = new LruEvictionStrategy();
    UserCache userCache = new UserCache(evictionStrategy);
    //...
  }
}
~~~

åœ¨ã€Œéè¿è¡Œæ—¶åŠ¨æ€ç¡®å®šã€çš„åœºæ™¯ä¸­ï¼Œç­–ç•¥æ¨¡å¼å®é™…ä¸Šé€€åŒ–æˆäº†â€œé¢å‘å¯¹è±¡çš„å¤šæ€ç‰¹æ€§â€æˆ–â€œåŸºäºæ¥å£è€Œéå®ç°ç¼–ç¨‹åŸåˆ™â€ã€‚

### å¦‚ä½•åˆ©ç”¨ç­–ç•¥æ¨¡å¼é¿å…åˆ†æ”¯åˆ¤æ–­ï¼Ÿ

æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªå¤§é‡ä½¿ç”¨if-elseçš„ä¾‹å­ï¼š

~~~java
public class OrderService {
  public double discount(Order order) {
    double discount = 0.0;
    OrderType type = order.getType();
    if (type.equals(OrderType.NORMAL)) { // æ™®é€šè®¢å•
      //...çœç•¥æŠ˜æ‰£è®¡ç®—ç®—æ³•ä»£ç 
    } else if (type.equals(OrderType.GROUPON)) { // å›¢è´­è®¢å•
      //...çœç•¥æŠ˜æ‰£è®¡ç®—ç®—æ³•ä»£ç 
    } else if (type.equals(OrderType.PROMOTION)) { // ä¿ƒé”€è®¢å•
      //...çœç•¥æŠ˜æ‰£è®¡ç®—ç®—æ³•ä»£ç 
    }
    return discount;
  }
}
~~~

æ­¤æ—¶æˆ‘ä»¬ä½¿ç”¨ç­–ç•¥æ¨¡å¼å¯¹ä¸Šé¢çš„ä»£ç é‡æ„ï¼Œå°†ä¸åŒç±»å‹è®¢å•çš„æ‰“æŠ˜ç­–ç•¥è®¾è®¡æˆç­–ç•¥ç±»ï¼Œå¹¶ç”±å·¥å‚ç±»æ¥è´Ÿè´£åˆ›å»ºç­–ç•¥å¯¹è±¡ã€‚

~~~java
// ç­–ç•¥çš„å®šä¹‰
public interface DiscountStrategy {
  double calDiscount(Order order);
}
// çœç•¥NormalDiscountStrategyã€GrouponDiscountStrategyã€PromotionDiscountStrategyç±»ä»£ç ...

// ç­–ç•¥çš„åˆ›å»º
public class DiscountStrategyFactory {
  private static final Map<OrderType, DiscountStrategy> strategies = new HashMap<>();

  static {
    strategies.put(OrderType.NORMAL, new NormalDiscountStrategy());
    strategies.put(OrderType.GROUPON, new GrouponDiscountStrategy());
    strategies.put(OrderType.PROMOTION, new PromotionDiscountStrategy());
  }

  public static DiscountStrategy getDiscountStrategy(OrderType type) {
    return strategies.get(type);
  }
}

// ç­–ç•¥çš„ä½¿ç”¨
public class OrderService {
  public double discount(Order order) {
    OrderType type = order.getType();
    DiscountStrategy discountStrategy = DiscountStrategyFactory.getDiscountStrategy(type);
    return discountStrategy.calDiscount(order);
  }
}
~~~

ä½†æ˜¯ï¼Œå¦‚æœä¸šåŠ¡åœºæ™¯éœ€è¦æ¯æ¬¡éƒ½åˆ›å»ºä¸åŒçš„ç­–ç•¥å¯¹è±¡ï¼ˆæœ‰çŠ¶æ€ï¼‰ï¼Œæˆ‘ä»¬å°±è¦ç”¨å¦å¤–ä¸€ç§å·¥å‚ç±»çš„å®ç°æ–¹å¼äº†ã€‚å…·ä½“çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~java
public class DiscountStrategyFactory {
  public static DiscountStrategy getDiscountStrategy(OrderType type) {
    if (type == null) {
      throw new IllegalArgumentException("Type should not be null.");
    }
    if (type.equals(OrderType.NORMAL)) {
      return new NormalDiscountStrategy();
    } else if (type.equals(OrderType.GROUPON)) {
      return new GrouponDiscountStrategy();
    } else if (type.equals(OrderType.PROMOTION)) {
      return new PromotionDiscountStrategy();
    }
    return null;
  }
}
~~~

è¿™ç§å®ç°æ–¹å¼ç›¸å½“äºæŠŠåŸæ¥çš„if-elseåˆ†æ”¯é€»è¾‘ï¼Œä»OrderServiceç±»ä¸­è½¬ç§»åˆ°äº†å·¥å‚ç±»ä¸­ï¼Œå®é™…ä¸Šå¹¶æ²¡æœ‰çœŸæ­£å°†å®ƒç§»é™¤ã€‚è¿™ä¸ªé—®é¢˜è¯¥å¦‚ä½•è§£å†³å‘¢ï¼ŸæŸ¥è¡¨æ³•ï¼

### å¦‚ä½•å®ç°ä¸€ä¸ªæ”¯æŒç»™ä¸åŒå¤§å°æ–‡ä»¶æ’åºçš„å°ç¨‹åºï¼Ÿ

#### éœ€æ±‚åˆ†æ

å®ç°å¯¹ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œæ’åºçš„åŠŸèƒ½ã€‚æ–‡ä»¶ä¸­åªåŒ…å«æ•´å‹æ•°ï¼Œå¹¶ä¸”ï¼Œç›¸é‚»çš„æ•°å­—é€šè¿‡é€—å·æ¥åŒºéš”ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬æœ‰éåŠŸèƒ½æ€§éœ€æ±‚ï¼š

- æ–‡ä»¶æœ‰10GBæ—¶ï¼Œä½¿ç”¨å¤–éƒ¨æ’åºç®—æ³•
- æ–‡ä»¶æœ‰100GBæ—¶ï¼Œåœ¨å¤–éƒ¨æ’åºçš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨å¤šçº¿ç¨‹å¹¶å‘æ’åº
- æ–‡ä»¶æœ‰1TBæ—¶ï¼Œä½¿ç”¨MapReduceæ¡†æ¶



å…ˆç»™å‡ºä¸€ä¸ªåŸå‹è®¾è®¡ï¼š

~~~java
public class Sorter {
  private static final long GB = 1000 * 1000 * 1000;

  public void sortFile(String filePath) {
    // çœç•¥æ ¡éªŒé€»è¾‘
    File file = new File(filePath);
    long fileSize = file.length();
    if (fileSize < 6 * GB) { // [0, 6GB)
      quickSort(filePath);
    } else if (fileSize < 10 * GB) { // [6GB, 10GB)
      externalSort(filePath);
    } else if (fileSize < 100 * GB) { // [10GB, 100GB)
      concurrentExternalSort(filePath);
    } else { // [100GB, ~)
      mapreduceSort(filePath);
    }
  }

  private void quickSort(String filePath) {
    // å¿«é€Ÿæ’åº
  }

  private void externalSort(String filePath) {
    // å¤–éƒ¨æ’åº
  }

  private void concurrentExternalSort(String filePath) {
    // å¤šçº¿ç¨‹å¤–éƒ¨æ’åº
  }

  private void mapreduceSort(String filePath) {
    // åˆ©ç”¨MapReduceå¤šæœºæ’åº
  }
}

public class SortingTool {
  public static void main(String[] args) {
    Sorter sorter = new Sorter();
    sorter.sortFile(args[0]);
  }
}
~~~

å†ç”¨ç­–ç•¥æ¨¡å¼æ¥é‡æ„ä¸Šè¿°ä»£ç ï¼š

~~~java
public interface ISortAlg {
  void sort(String filePath);
}

public class QuickSort implements ISortAlg {
  @Override
  public void sort(String filePath) {
    //...
  }
}

public class ExternalSort implements ISortAlg {
  @Override
  public void sort(String filePath) {
    //...
  }
}

public class ConcurrentExternalSort implements ISortAlg {
  @Override
  public void sort(String filePath) {
    //...
  }
}

public class MapReduceSort implements ISortAlg {
  @Override
  public void sort(String filePath) {
    //...
  }
}

public class Sorter {
  private static final long GB = 1000 * 1000 * 1000;

  public void sortFile(String filePath) {
    // çœç•¥æ ¡éªŒé€»è¾‘
    File file = new File(filePath);
    long fileSize = file.length();
    ISortAlg sortAlg;
    if (fileSize < 6 * GB) { // [0, 6GB)
      sortAlg = new QuickSort();
    } else if (fileSize < 10 * GB) { // [6GB, 10GB)
      sortAlg = new ExternalSort();
    } else if (fileSize < 100 * GB) { // [10GB, 100GB)
      sortAlg = new ConcurrentExternalSort();
    } else { // [100GB, ~)
      sortAlg = new MapReduceSort();
    }
    sortAlg.sort(filePath);
  }
}

~~~

è¿™æ ·ï¼Œæˆ‘ä»¬æŠŠç­–ç•¥çš„å®šä¹‰åˆ†ç¦»å‡ºæ¥ã€‚ç„¶åä½¿ç”¨å·¥å‚æ¨¡å¼å°†ç­–ç•¥ç±»çš„åˆ›å»ºé€»è¾‘æŠ½ç¦»å‡ºæ¥ï¼š

~~~java
public class SortAlgFactory {
  private static final Map<String, ISortAlg> algs = new HashMap<>();

  static {
    algs.put("QuickSort", new QuickSort());
    algs.put("ExternalSort", new ExternalSort());
    algs.put("ConcurrentExternalSort", new ConcurrentExternalSort());
    algs.put("MapReduceSort", new MapReduceSort());
  }

  public static ISortAlg getSortAlg(String type) {
    if (type == null || type.isEmpty()) {
      throw new IllegalArgumentException("type should not be empty.");
    }
    return algs.get(type);
  }
}

public class Sorter {
  private static final long GB = 1000 * 1000 * 1000;

  public void sortFile(String filePath) {
    // çœç•¥æ ¡éªŒé€»è¾‘
    File file = new File(filePath);
    long fileSize = file.length();
    ISortAlg sortAlg;
    if (fileSize < 6 * GB) { // [0, 6GB)
      sortAlg = SortAlgFactory.getSortAlg("QuickSort");
    } else if (fileSize < 10 * GB) { // [6GB, 10GB)
      sortAlg = SortAlgFactory.getSortAlg("ExternalSort");
    } else if (fileSize < 100 * GB) { // [10GB, 100GB)
      sortAlg = SortAlgFactory.getSortAlg("ConcurrentExternalSort");
    } else { // [100GB, ~)
      sortAlg = SortAlgFactory.getSortAlg("MapReduceSort");
    }
    sortAlg.sort(filePath);
  }
}

~~~

æˆ‘ä»¬å†ç”¨æŸ¥è¡¨æ³•ï¼Œå°†ç­–ç•¥ç±»ä½¿ç”¨é€»è¾‘ä¸­çš„if-elseä»£æ›¿æ‰ï¼š

~~~java
public class Sorter {
  private static final long GB = 1000 * 1000 * 1000;
  private static final List<AlgRange> algs = new ArrayList<>();
  static {
    algs.add(new AlgRange(0, 6*GB, SortAlgFactory.getSortAlg("QuickSort")));
    algs.add(new AlgRange(6*GB, 10*GB, SortAlgFactory.getSortAlg("ExternalSort")));
    algs.add(new AlgRange(10*GB, 100*GB, SortAlgFactory.getSortAlg("ConcurrentExternalSort")));
    algs.add(new AlgRange(100*GB, Long.MAX_VALUE, SortAlgFactory.getSortAlg("MapReduceSort")));
  }

  public void sortFile(String filePath) {
    // çœç•¥æ ¡éªŒé€»è¾‘
    File file = new File(filePath);
    long fileSize = file.length();
    ISortAlg sortAlg = null;
    for (AlgRange algRange : algs) {
      if (algRange.inRange(fileSize)) {
        sortAlg = algRange.getAlg();
        break;
      }
    }
    sortAlg.sort(filePath);
  }

  private static class AlgRange {
    private long start;
    private long end;
    private ISortAlg alg;

    public AlgRange(long start, long end, ISortAlg alg) {
      this.start = start;
      this.end = end;
      this.alg = alg;
    }

    public ISortAlg getAlg() {
      return alg;
    }

    public boolean inRange(long size) {
      return size >= start && size < end;
    }
  }
~~~

è¿™æ ·æˆ‘ä»¬æŠŠå¯å˜çš„éƒ¨åˆ†éš”ç¦»åˆ°äº†ç­–ç•¥å·¥å‚ç±»å’ŒSorterç±»ä¸­çš„é™æ€ä»£ç æ®µä¸­ï¼Œå°†ä»£ç æ”¹åŠ¨æœ€å°åŒ–ã€é›†ä¸­åŒ–äº†ã€‚

æˆ‘ä»¬å¯ä»¥åšå¾—æ›´åŠ æè‡´ï¼Œé€šè¿‡åå°„æ¥é¿å…å¯¹ç­–ç•¥å·¥å‚ç±»çš„ä¿®æ”¹ã€‚æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªé…ç½®æ–‡ä»¶æ ‡æ³¨éƒ½æœ‰å“ªäº›ç­–ç•¥ç±»ï¼›ç­–ç•¥å·¥å‚ç±»è¯»å–é…ç½®æ–‡ä»¶ï¼Œç„¶åé€šè¿‡åå°„åŠ¨æ€åœ°åŠ è½½è¿™äº›ç­–ç•¥ç±»ã€åˆ›å»ºç­–ç•¥å¯¹è±¡ï¼›åŒæ ·å¯¹äºSorteræ¥è¯´ï¼Œæˆ‘ä»¬é€šè¿‡å°†æ–‡ä»¶å¤§å°åŒºé—´å’Œç®—æ³•ä¹‹é—´çš„å¯¹åº”å…³ç³»æ”¾åˆ°é…ç½®æ–‡ä»¶ä¸­ã€‚å½“æ·»åŠ æ–°çš„æ’åºç®—æ³•æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦æ”¹åŠ¨é…ç½®æ–‡ä»¶å³å¯ï¼Œä¸éœ€è¦æ”¹åŠ¨ä»£ç ã€‚

å®é™…ä¸Šï¼Œå¯ä»¥ç”¨æ³¨è§£æ¥ä»£æ›¿é…ç½®æ–‡ä»¶ï¼Œè¿™æ ·æ›´å®¹æ˜“ç»´æŠ¤ã€‚

## èŒè´£é“¾æ¨¡å¼

**èŒè´£é“¾æ¨¡å¼ï¼ˆChain Of Responsibility Design Patternï¼‰**

> Avoid coupling the sender of a request to its receiver by giving more than one object a chance to handle the request. Chain the receiving objects and pass the request along the chain until an object handles it.
>
> å°†è¯·æ±‚çš„å‘é€å’Œæ¥æ”¶è§£è€¦ï¼Œè®©å¤šä¸ªæ¥æ”¶å¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚å°†è¿™äº›æ¥æ”¶å¯¹è±¡ä¸²æˆä¸€æ¡é“¾ï¼Œå¹¶æ²¿ç€è¿™æ¡é“¾ä¼ é€’è¿™ä¸ªè¯·æ±‚ï¼Œç›´åˆ°é“¾ä¸Šçš„æŸä¸ªæ¥æ”¶å¯¹è±¡èƒ½å¤Ÿå¤„ç†å®ƒä¸ºæ­¢ã€‚



åœ¨èŒè´£é“¾æ¨¡å¼ä¸­ï¼Œå¤šä¸ªå¤„ç†å™¨ä¾æ¬¡å¤„ç†åŒä¸€ä¸ªè¯·æ±‚ã€‚ä¸€ä¸ªè¯·æ±‚å…ˆç»è¿‡Aå¤„ç†å™¨å¤„ç†ï¼Œç„¶åå†æŠŠè¯·æ±‚ä¼ é€’ç»™Bå¤„ç†å™¨ï¼ŒBå¤„ç†å™¨å¤„ç†å®Œåå†ä¼ é€’ç»™Cå¤„ç†å™¨ï¼Œä»¥æ­¤ç±»æ¨ï¼Œå½¢æˆä¸€ä¸ªé“¾æ¡ã€‚é“¾æ¡ä¸Šçš„æ¯ä¸ªå¤„ç†å™¨å„è‡ªæ‰¿æ‹…å„è‡ªçš„å¤„ç†èŒè´£ï¼Œæ‰€ä»¥å«ä½œèŒè´£é“¾æ¨¡å¼ã€‚

èŒè´£é“¾æ¨¡å¼æœ‰å¤šç§å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ç§ï¼ˆé“¾è¡¨ï¼‰ï¼š

~~~java
public abstract class Handler {
  protected Handler successor = null;

  public void setSuccessor(Handler successor) {
    this.successor = successor;
  }

  public final void handle() {
    boolean handled = doHandle();
    if (successor != null && !handled) {
      successor.handle();
    }
  }

  protected abstract boolean doHandle();		//æ¨¡æ¿æ–¹æ³•
}

public class HandlerA extends Handler {
  @Override
  protected boolean doHandle() {
    boolean handled = false;
    //...
    return handled;
  }
}

public class HandlerB extends Handler {
  @Override
  protected boolean doHandle() {
    boolean handled = false;
    //...
    return handled;
  }
}

public class HandlerChain {
  private Handler head = null;
  private Handler tail = null;

  public void addHandler(Handler handler) {
    handler.setSuccessor(null);

    if (head == null) {
      head = handler;
      tail = handler;
      return;
    }

    tail.setSuccessor(handler);
    tail = handler;
  }

  public void handle() {
    if (head != null) {
      head.handle();
    }
  }
}

// ä½¿ç”¨ä¸¾ä¾‹
public class Application {
  public static void main(String[] args) {
    HandlerChain chain = new HandlerChain();
    chain.addHandler(new HandlerA());
    chain.addHandler(new HandlerB());
    chain.handle();
  }
}
~~~

æˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒç§å®ç°æ–¹å¼ï¼ˆæ•°ç»„ï¼‰ï¼š

~~~java
public interface IHandler {
  boolean handle();
}

public class HandlerA implements IHandler {
  @Override
  public boolean handle() {
    boolean handled = false;
    //...
    return handled;
  }
}

public class HandlerB implements IHandler {
  @Override
  public boolean handle() {
    boolean handled = false;
    //...
    return handled;
  }
}

public class HandlerChain {
  private List<IHandler> handlers = new ArrayList<>();

  public void addHandler(IHandler handler) {
    this.handlers.add(handler);
  }

  public void handle() {
    for (IHandler handler : handlers) {
      boolean handled = handler.handle();
      if (handled) {
        break;
      }
    }
  }
}

// ä½¿ç”¨ä¸¾ä¾‹
public class Application {
  public static void main(String[] args) {
    HandlerChain chain = new HandlerChain();
    chain.addHandler(new HandlerA());
    chain.addHandler(new HandlerB());
    chain.handle();
  }
}

~~~



å®é™…ä¸Šï¼ŒèŒè´£é“¾æ¨¡å¼è¿˜æœ‰ä¸€ç§å˜ä½“ï¼Œé‚£å°±æ˜¯è¯·æ±‚ä¼šè¢«æ‰€æœ‰çš„å¤„ç†å™¨éƒ½å¤„ç†ä¸€éï¼Œä¸å­˜åœ¨ä¸­é€”ç»ˆæ­¢çš„æƒ…å†µã€‚å°†ä¸Šé¢ä¸¤ä¸ªå®ç°æ–¹å¼ç¨åŠ ä¿®æ”¹å³å¯ã€‚

è€Œä¸”ï¼Œè¿™é‡Œæˆ‘ä»¬ä»…ä»…å®ç°äº†å•å‘è¿‡æ»¤ï¼Œå®é™…ä¸Šè¿˜å¯ä»¥é€šè¿‡é€’å½’æ¥å®ç°åŒå‘è¿‡æ»¤ï¼Œå…·ä½“å®ç°è¯·è§ä¸‹é¢çš„`Servlet Filter`

### æ•æ„Ÿä¿¡æ¯è¿‡æ»¤æ¡†æ¶

å¯¹äºæ”¯æŒUGCï¼ˆUser Generated Contentï¼Œç”¨æˆ·ç”Ÿæˆå†…å®¹ï¼‰çš„åº”ç”¨æ¥è¯´ï¼Œæˆ‘ä»¬è¦è¿‡æ»¤å¯èƒ½ä¼šåŒ…å«æ•æ„Ÿè¯ã€‚è¿™é‡Œæˆ‘ä»¬å¯¹äºæ•æ„Ÿè¯çš„å¤„ç†ç­–ç•¥ä¸ºç›´æ¥ç¦æ­¢å‘å¸ƒã€‚

~~~java
public interface SensitiveWordFilter {
  boolean doFilter(Content content);
}

public class SexyWordFilter implements SensitiveWordFilter {
  @Override
  public boolean doFilter(Content content) {
    boolean legal = true;
    //...
    return legal;
  }
}

// PoliticalWordFilterã€AdsWordFilterç±»ä»£ç ç»“æ„ä¸SexyWordFilterç±»ä¼¼

public class SensitiveWordFilterChain {
  //æ•°ç»„å­˜å‚¨
  private List<SensitiveWordFilter> filters = new ArrayList<>();

  public void addFilter(SensitiveWordFilter filter) {
    this.filters.add(filter);
  }

  // return true if content doesn't contain sensitive words.
  public boolean filter(Content content) {
    for (SensitiveWordFilter filter : filters) {
      if (!filter.doFilter(content)) {
        return false;
      }
    }
    return true;
  }
}

public class ApplicationDemo {
  public static void main(String[] args) {
    SensitiveWordFilterChain filterChain = new SensitiveWordFilterChain();
    filterChain.addFilter(new AdsWordFilter());
    filterChain.addFilter(new SexyWordFilter());
    filterChain.addFilter(new PoliticalWordFilter());

    boolean legal = filterChain.filter(new Content());
    if (!legal) {
      // ä¸å‘è¡¨
    } else {
      // å‘è¡¨
    }
  }
}
~~~

ä½ å¯èƒ½ä¼šè¿™æ ·å®ç°æ•æ„Ÿè¯è¿‡æ»¤åŠŸèƒ½ï¼Œè€Œä¸”ä»ä»£ç ç»“æ„ä¸Šæ¥è¯´æ›´åŠ ç®€å•ï¼š

~~~java
public class SensitiveWordFilter {
  // return true if content doesn't contain sensitive words.
  public boolean filter(Content content) {
    if (!filterSexyWord(content)) {
      return false;
    }

    if (!filterAdsWord(content)) {
      return false;
    }

    if (!filterPoliticalWord(content)) {
      return false;
    }

    return true;
  }

  private boolean filterSexyWord(Content content) {
    //....
  }

  private boolean filterAdsWord(Content content) {
    //...
  }

  private boolean filterPoliticalWord(Content content) {
    //...
  }
}
~~~

å†æ¬¡å¼ºè°ƒï¼Œåº”ç”¨è®¾è®¡æ¨¡å¼ä¸»è¦æ˜¯ä¸ºäº†åº”å¯¹ä»£ç çš„å¤æ‚æ€§ï¼Œè®©å…¶æ»¡è¶³å¼€é—­åŸåˆ™ï¼Œæé«˜ä»£ç çš„æ‰©å±•æ€§ï¼Œè€Œä¸æ˜¯å‡å°‘ä»£ç è¡Œæ•°çš„ã€‚è¿™é‡Œåº”ç”¨èŒè´£é“¾æ¨¡å¼ä¹Ÿä¸ä¾‹å¤–ã€‚

- å°†å¤§å—ä»£ç é€»è¾‘æ‹†åˆ†æˆå‡½æ•°ï¼Œå°†å¤§ç±»æ‹†åˆ†æˆå°ç±»ï¼Œæ˜¯åº”å¯¹ä»£ç å¤æ‚æ€§çš„å¸¸ç”¨æ–¹æ³•ã€‚åº”ç”¨èŒè´£é“¾æ¨¡å¼ï¼Œæˆ‘ä»¬æŠŠå„ä¸ªæ•æ„Ÿè¯è¿‡æ»¤å‡½æ•°ç»§ç»­æ‹†åˆ†å‡ºæ¥ï¼Œè®¾è®¡æˆç‹¬ç«‹çš„ç±»ï¼Œè¿›ä¸€æ­¥ç®€åŒ–äº†SensitiveWordFilterç±»ï¼Œè®©SensitiveWordFilterç±»çš„ä»£ç ä¸ä¼šè¿‡å¤šï¼Œè¿‡å¤æ‚ã€‚
- å½“æˆ‘ä»¬è¦æ‰©å±•æ–°çš„è¿‡æ»¤ç®—æ³•çš„æ—¶å€™ï¼ŒæŒ‰ç…§ä¸Šè¿°ä»£ç å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹SensitiveWordFilterçš„ä»£ç ï¼Œè¿åå¼€é—­åŸåˆ™ã€‚ä¸è¿‡ï¼Œè¿™æ ·çš„ä¿®æ”¹è¿˜ç®—æ¯”è¾ƒé›†ä¸­ï¼Œä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚è€ŒèŒè´£é“¾æ¨¡å¼çš„å®ç°æ–¹å¼æ›´åŠ ä¼˜é›…ï¼Œåªéœ€è¦æ–°æ·»åŠ ä¸€ä¸ªFilterç±»ï¼Œå¹¶ä¸”é€šè¿‡addFilter()å‡½æ•°å°†å®ƒæ·»åŠ åˆ°FilterChainä¸­å³å¯ï¼Œå…¶ä»–ä»£ç å®Œå…¨ä¸éœ€è¦ä¿®æ”¹ã€‚



### Servlet Filter

Servlet Filteræ˜¯Java Servletè§„èŒƒä¸­å®šä¹‰çš„ç»„ä»¶ï¼Œå®ƒå¯ä»¥å®ç°å¯¹HTTPè¯·æ±‚çš„è¿‡æ»¤åŠŸèƒ½ï¼Œæ¯”å¦‚é‰´æƒã€é™æµã€è®°å½•æ—¥å¿—ã€éªŒè¯å‚æ•°ç­‰ç­‰ã€‚

![](assets/3296abd63a61ebdf4eff3a6530979e21.jpg)

å¦‚ä½•ä½¿ç”¨Servlet Filterå‘¢ï¼Ÿ

~~~java
//å®ç°javax.servlet.Filteræ¥å£çš„è¿‡æ»¤å™¨ç±»
public class LogFilter implements Filter {
  @Override
  public void init(FilterConfig filterConfig) throws ServletException {
    // åœ¨åˆ›å»ºFilteræ—¶è‡ªåŠ¨è°ƒç”¨ï¼Œ
    // å…¶ä¸­filterConfigåŒ…å«è¿™ä¸ªFilterçš„é…ç½®å‚æ•°ï¼Œæ¯”å¦‚nameä¹‹ç±»çš„ï¼ˆä»é…ç½®æ–‡ä»¶ä¸­è¯»å–çš„ï¼‰
  }

  @Override
  public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
    System.out.println("æ‹¦æˆªå®¢æˆ·ç«¯å‘é€æ¥çš„è¯·æ±‚.");
    chain.doFilter(request, response);
    System.out.println("æ‹¦æˆªå‘é€ç»™å®¢æˆ·ç«¯çš„å“åº”.");
  }

  @Override
  public void destroy() {
    // åœ¨é”€æ¯Filteræ—¶è‡ªåŠ¨è°ƒç”¨
  }
}
~~~

åœ¨web.xmlæ–‡ä»¶ä¸­åšå¦‚ä¸‹é…ç½®ï¼š

~~~xml
<!--ç»™è¿‡æ»¤å™¨å”¯ä¸€æ ‡è¯†-->
<filter>
  <filter-name>logFilter</filter-name>
  <filter-class>com.xzg.cd.LogFilter</filter-class>
</filter>

<!--ç»™è¿‡æ»¤å™¨çš„URLåŒ¹é…è§„åˆ™-->
<filter-mapping>
    <filter-name>logFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>
~~~

æ·»åŠ è¿‡æ»¤å™¨éå¸¸æ–¹ä¾¿ï¼Œä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä»£ç ï¼Œå®šä¹‰ä¸€ä¸ªå®ç°javax.servlet.Filterçš„ç±»ï¼Œå†ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ï¼Œå®Œå…¨ç¬¦åˆå¼€é—­åŸåˆ™ã€‚

Servletè§„èŒƒä¸­å®šä¹‰äº†FilterChainæ¥å£ç±»ï¼Œå®ƒå°±æ˜¯å¤„ç†å™¨é“¾ã€‚è€ŒTomcatæä¾›çš„FilterChainçš„å®ç°ç±»ä¸ºApplicationFilterChainï¼Œå®ƒçš„æºç å¦‚ä¸‹ï¼š

~~~java
public final class ApplicationFilterChain implements FilterChain {
  private int pos = 0; 		//å½“å‰æ‰§è¡Œåˆ°äº†å“ªä¸ªfilter
  private int n; 			//filterçš„ä¸ªæ•°
  private ApplicationFilterConfig[] filters;		//filterå°±åœ¨filterConfigä¸­ä¿å­˜ç€
  private Servlet servlet;
  
  @Override
  public void doFilter(ServletRequest request, ServletResponse response) {
    if (pos < n) {
      ApplicationFilterConfig filterConfig = filters[pos++];
      Filter filter = filterConfig.getFilter();
      filter.doFilter(request, response, this);
      //å®é™…ä¸Šè¿™é‡ŒdoFilteræ˜¯ä¸€ä¸ªé€’å½’è°ƒç”¨ï¼Œæˆ‘ä»¬å°†doFilterå±•å¼€åå¾—åˆ°
      /**
      	* System.out.println("æ‹¦æˆªå®¢æˆ·ç«¯å‘é€æ¥çš„è¯·æ±‚.");
    	  chain.doFilter(request, response);
          System.out.println("æ‹¦æˆªå‘é€ç»™å®¢æˆ·ç«¯çš„å“åº”.");
		*/
      // è¿™é‡Œçš„chainå°±æ˜¯thisï¼ˆApplicationFilterChainï¼‰
      // è¿™æ ·å°±æ”¯æŒåŒå‘æ‹¦æˆªï¼Œæ—¢èƒ½æ‹¦æˆªå®¢æˆ·ç«¯å‘é€æ¥çš„è¯·æ±‚ï¼Œä¹Ÿèƒ½æ‹¦æˆªå‘é€ç»™å®¢æˆ·ç«¯çš„å“åº”
    } else {
      // filteréƒ½å¤„ç†å®Œæ¯•åï¼Œæ‰§è¡Œservlet
      servlet.service(request, response);
    }
  }
  
  public void addFilter(ApplicationFilterConfig filterConfig) {
    for (ApplicationFilterConfig filter : filters)
      if (filter == filterConfig)			//filterConfigåœ¨filtersä¸­å·²ç»å­˜åœ¨ï¼Œæ— éœ€å†æ¬¡æ·»åŠ 
         return;

    if (n == filters.length) {//æ‰©å®¹
      ApplicationFilterConfig[] newFilters = new ApplicationFilterConfig[n + INCREMENT];
      System.arraycopy(filters, 0, newFilters, 0, n);
      filters = newFilters;
    }
    filters[n++] = filterConfig;
  }
}

~~~



### Spring Interceptor

Spring Interceptorä¹Ÿæ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œä½†å®ƒæ˜¯Spring MVCæ¡†æ¶çš„ä¸€éƒ¨åˆ†ã€‚æ‰€ä»¥å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼Œä¼šå…ˆç»è¿‡Servlet Filterï¼Œç„¶åå†ç»è¿‡Spring Interceptorï¼Œæœ€ååˆ°è¾¾å…·ä½“çš„ä¸šåŠ¡ä»£ç ä¸­ã€‚

![](assets/febaa9220cb9ad2f0aafd4e5c3c19868.jpg)

å¦‚ä½•ä½¿ç”¨Spring Interceptorå‘¢ï¼Ÿ

~~~java
public class LogInterceptor implements HandlerInterceptor {

  @Override
  public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
    System.out.println("æ‹¦æˆªå®¢æˆ·ç«¯å‘é€æ¥çš„è¯·æ±‚.");
    return true; // ç»§ç»­åç»­çš„å¤„ç†
  }

  @Override
  public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
    System.out.println("æ‹¦æˆªå‘é€ç»™å®¢æˆ·ç«¯çš„å“åº”.");
  }

  @Override
  public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
    System.out.println("è¿™é‡Œæ€»æ˜¯è¢«æ‰§è¡Œ.");
  }
}
~~~

åœ¨Spring MVCé…ç½®æ–‡ä»¶ä¸­é…ç½®interceptors

~~~xml
<mvc:interceptors>
   <mvc:interceptor>
       <mvc:mapping path="/*"/>
       <bean class="com.xzg.cd.LogInterceptor" />
   </mvc:interceptor>
</mvc:interceptors>
~~~

Spring Interceptoråº•å±‚ä¹Ÿæ˜¯åŸºäºèŒè´£é“¾æ¨¡å¼å®ç°çš„ï¼ŒHandlerExecutionChainç±»æ˜¯èŒè´£é“¾æ¨¡å¼ä¸­çš„å¤„ç†å™¨é“¾ã€‚å®ƒçš„å®ç°ç›¸è¾ƒäºTomcatä¸­çš„ApplicationFilterChainæ¥è¯´ï¼Œé€»è¾‘æ›´åŠ æ¸…æ™°ï¼Œä¸éœ€è¦ä½¿ç”¨é€’å½’æ¥å®ç°ï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒå°†è¯·æ±‚å’Œå“åº”çš„æ‹¦æˆªå·¥ä½œï¼Œæ‹†åˆ†åˆ°äº†ä¸¤ä¸ªå‡½æ•°ä¸­å®ç°ã€‚

~~~java
public class HandlerExecutionChain {
 private final Object handler;
 private HandlerInterceptor[] interceptors;
 
 public void addInterceptor(HandlerInterceptor interceptor) {
  initInterceptorList().add(interceptor);
 }

 boolean applyPreHandle(HttpServletRequest request, HttpServletResponse response) throws Exception {
  HandlerInterceptor[] interceptors = getInterceptors();
  if (!ObjectUtils.isEmpty(interceptors)) {
   for (int i = 0; i < interceptors.length; i++) {
    HandlerInterceptor interceptor = interceptors[i];
    if (!interceptor.preHandle(request, response, this.handler)) {
     //æ‹¦æˆªæˆåŠŸåï¼Œä»ç„¶ä¼šæ‰§è¡ŒAfterCompletion
     triggerAfterCompletion(request, response, null);
     return false;
    }
   }
  }
  return true;
 }

 void applyPostHandle(HttpServletRequest request, HttpServletResponse response, ModelAndView mv) throws Exception {
  HandlerInterceptor[] interceptors = getInterceptors();
  if (!ObjectUtils.isEmpty(interceptors)) {
   for (int i = interceptors.length - 1; i >= 0; i--) {
    HandlerInterceptor interceptor = interceptors[i];
    interceptor.postHandle(request, response, this.handler, mv);
   }
  }
 }

 void triggerAfterCompletion(HttpServletRequest request, HttpServletResponse response, Exception ex)
   throws Exception {
  HandlerInterceptor[] interceptors = getInterceptors();
  if (!ObjectUtils.isEmpty(interceptors)) {
   for (int i = this.interceptorIndex; i >= 0; i--) {
    HandlerInterceptor interceptor = interceptors[i];
    try {
     interceptor.afterCompletion(request, response, this.handler, ex);
    } catch (Throwable ex2) {
     logger.error("HandlerInterceptor.afterCompletion threw exception", ex2);
    }
   }
  }
 }
}
~~~



## çŠ¶æ€æ¨¡å¼

çŠ¶æ€æ¨¡å¼ä¸€èˆ¬ç”¨æ¥å®ç°æœ‰é™çŠ¶æ€æœºï¼Œæ­¤å¤–ï¼Œæœ‰é™çŠ¶æ€æœºè¿˜å¯ä»¥ç”¨åˆ†æ”¯é€»è¾‘æ³•ã€æŸ¥è¡¨æ³•æ¥å®ç°ã€‚

### ä»€ä¹ˆæ˜¯æœ‰é™çŠ¶æ€æœºï¼Ÿ

æœ‰é™çŠ¶æ€æœºï¼ˆFinite State Machineï¼‰ç”±3ä¸ªç»„æˆéƒ¨åˆ†ï¼š

- **çŠ¶æ€ï¼ˆStateï¼‰**
- **äº‹ä»¶ï¼ˆEventï¼‰**ï¼Œä¹Ÿç§°ä¸ºè½¬ç§»æ¡ä»¶ï¼ˆTransition Conditionï¼‰
- **åŠ¨ä½œï¼ˆActionï¼‰**ï¼šåœ¨å‘ç”Ÿè½¬ç§»æ—¶ï¼Œè¦æ‰§è¡Œçš„è¡Œä¸º



ä¸‹é¢ç»™å‡ºä¸€ä¸ªâ€œè¶…çº§é©¬é‡Œå¥¥â€æ¸¸æˆçš„ä¾‹å­ã€‚åœ¨æ¸¸æˆä¸­ï¼Œé©¬é‡Œå¥¥å¯ä»¥å˜èº«ä¸ºå¤šç§å½¢æ€ï¼Œæ¯”å¦‚å°é©¬é‡Œå¥¥ï¼ˆSmall Marioï¼‰ã€è¶…çº§é©¬é‡Œå¥¥ï¼ˆSuper Marioï¼‰ã€ç«ç„°é©¬é‡Œå¥¥ï¼ˆFire Marioï¼‰ã€æ–—ç¯·é©¬é‡Œå¥¥ï¼ˆCape Marioï¼‰ç­‰ç­‰ã€‚åœ¨ä¸åŒçš„æ¸¸æˆæƒ…èŠ‚ä¸‹ï¼Œå„ä¸ªå½¢æ€ä¼šäº’ç›¸è½¬åŒ–ï¼Œå¹¶ç›¸åº”çš„å¢å‡ç§¯åˆ†ã€‚çŠ¶æ€è½¬ç§»å›¾å¦‚ä¸‹ï¼š

![](assets/5aa0310b9b3ea08794cfc2f376c8f96c.jpg)



ä¸‹é¢ï¼Œæˆ‘ä»¬åˆ†åˆ«ç»™å‡ºä¸åŒçš„çŠ¶æ€æœºå®ç°ã€‚

### å®ç°ä¸€ï¼šåˆ†æ”¯é€»è¾‘æ³•

å…ˆæˆ‘ä»¬ç»™å‡ºçŠ¶æ€çš„å®šä¹‰ï¼š

~~~java
public enum State {
  SMALL(0),
  SUPER(1),
  FIRE(2),
  CAPE(3);

  private int value;

  private State(int value) {
    this.value = value;
  }

  public int getValue() {
    return this.value;
  }
}
~~~

å†ç»™å‡ºçŠ¶æ€æœºçš„å¤§ä½“æ¡†æ¶ï¼š

~~~java
public class MarioStateMachine {
  private int score;
  private State currentState;

  public MarioStateMachine() {
    this.score = 0;
    this.currentState = State.SMALL;
  }

  public void obtainMushRoom() {
    if (currentState.equals(State.SMALL)) {
       score += 100;
       currentState = State.SUPER;
    }
  }

  public void obtainCape() {
    if (currentState.equals(State.SMALL) || currentState.equals(State.SUPER) ) {
      this.currentState = State.CAPE;
      this.score += 200;
    }
  }

  public void obtainFireFlower() {
    if (currentState.equals(State.SMALL) || currentState.equals(State.SUPER) ) {
      this.currentState = State.FIRE;
      this.score += 300;
    }
  }

  public void meetMonster() {
    if (currentState.equals(State.SUPER)) {
      this.currentState = State.SMALL;
      this.score -= 100;
      return;
    }

    if (currentState.equals(State.CAPE)) {
      this.currentState = State.SMALL;
      this.score -= 200;
      return;
    }

    if (currentState.equals(State.FIRE)) {
      this.currentState = State.SMALL;
      this.score -= 300;
      return;
    }
  }

  public int getScore() {
    return this.score;
  }

  public State getCurrentState() {
    return this.currentState;
  }
}

~~~

æœ€åå†ç»™å‡ºä½¿ç”¨æ–¹å¼ï¼š

~~~java
public class ApplicationDemo {
  public static void main(String[] args) {
    MarioStateMachine mario = new MarioStateMachine();
    mario.obtainMushRoom();
    int score = mario.getScore();
    State state = mario.getCurrentState();
    System.out.println("mario score: " + score + "; state: " + state);
  }
}
~~~



è¿™ç§å®ç°æ–¹å¼ï¼Œå……æ–¥ç€å¤§é‡çš„if-elseæˆ–è€…switch-caseåˆ†æ”¯åˆ¤æ–­é€»è¾‘ï¼Œå¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§éƒ½å¾ˆå·®ã€‚

### å®ç°äºŒï¼šæŸ¥è¡¨æ³•

çŠ¶æ€æœºé™¤äº†ç”¨çŠ¶æ€è½¬ç§»å›¾æ¥è¡¨ç¤ºä¹‹å¤–ï¼Œè¿˜å¯ä»¥ç”¨äºŒç»´è¡¨æ¥è¡¨ç¤º

![](assets/4f4ea3787bd955918578181e18173491.jpg)

å®ç°æ–¹å¼å¦‚ä¸‹ï¼š

~~~java
public enum Event {
  GOT_MUSHROOM(0),
  GOT_CAPE(1),
  GOT_FIRE(2),
  MET_MONSTER(3);

  private int value;

  private Event(int value) {
    this.value = value;
  }

  public int getValue() {
    return this.value;
  }
}

public class MarioStateMachine {
  private int score;
  private State currentState;

  // è¿™é‡Œ ã€Œ/ã€ è¡¨ç¤ºä»»æ„ä¸€ä¸ªæšä¸¾å¯¹è±¡
  private static final State[][] transitionTable = {
          {SUPER, 	CAPE, 	FIRE, 	/},
          {/, 		CAPE, 	FIRE, 	SMALL},
          {/, 		/, 		/, 		SMALL},
          {/, 		/, 		/. 		SMALL}
  };

  private static final int[][] actionTable = {
          {+100,+200, 	+300, 	+0},
          {+0, 	+200, 	+300, 	-100},
          {+0, 	+0, 	+0, 	-200},
          {+0, 	+0, 	+0, 	-300}
  };

  public MarioStateMachine() {
    this.score = 0;
    this.currentState = State.SMALL;
  }

  public void obtainMushRoom() {
    executeEvent(Event.GOT_MUSHROOM);
  }

  public void obtainCape() {
    executeEvent(Event.GOT_CAPE);
  }

  public void obtainFireFlower() {
    executeEvent(Event.GOT_FIRE);
  }

  public void meetMonster() {
    executeEvent(Event.MET_MONSTER);
  }

  private void executeEvent(Event event) {
    int stateValue = currentState.getValue();		//è·å–å½“å‰çŠ¶æ€å¯¹åº”çš„æšä¸¾å€¼
    
    int eventValue = event.getValue();			    //è·å–äº‹ä»¶å¯¹åº”çš„æšä¸¾å€¼
    this.currentState = transitionTable[stateValue][eventValue];
    this.score += actionTable[stateValue][eventValue];
  }

  public int getScore() {
    return this.score;
  }

  public State getCurrentState() {
    return this.currentState;
  }

}
~~~

ç›¸å¯¹äºåˆ†æ”¯é€»è¾‘çš„å®ç°æ–¹å¼ï¼ŒæŸ¥è¡¨æ³•çš„ä»£ç å®ç°æ›´åŠ æ¸…æ™°ï¼Œå¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§æ›´å¥½ã€‚å½“ä¿®æ”¹çŠ¶æ€æœºæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹transitionTableå’ŒactionTableä¸¤ä¸ªäºŒç»´æ•°ç»„å³å¯ã€‚

å¦‚æœä»¬æŠŠè¿™ä¸¤ä¸ªäºŒç»´æ•°ç»„å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆåªéœ€ç»´æŠ¤é…ç½®æ–‡ä»¶å³å¯ï¼Œä¸ç”¨ä¿®æ”¹ä»£ç ã€‚

### å®ç°ä¸‰ï¼šçŠ¶æ€æ¨¡å¼

å½“äº‹ä»¶è§¦å‘çš„åŠ¨ä½œæ¯”è¾ƒå¤æ‚æ—¶ï¼ˆå†™æ•°æ®åº“ã€å‘é€æ¶ˆæ¯é€šçŸ¥ç­‰ç­‰ï¼‰ï¼ŒæŸ¥è¡¨æ³•å°±ä¸å†é€‚ç”¨äº†ã€‚

çŠ¶æ€æ¨¡å¼é€šè¿‡å°†äº‹ä»¶è§¦å‘çš„çŠ¶æ€è½¬ç§»å’ŒåŠ¨ä½œæ‰§è¡Œï¼Œæ‹†åˆ†åˆ°ä¸åŒçš„çŠ¶æ€ç±»ä¸­ï¼Œæ¥é¿å…åˆ†æ”¯åˆ¤æ–­é€»è¾‘ã€‚

IMarioæ˜¯çŠ¶æ€çš„æ¥å£ï¼Œå®ƒå®šä¹‰äº†å½“äº‹ä»¶è§¦å‘æ—¶ï¼Œå½“å‰çŠ¶æ€åº”è¯¥æ‰§è¡Œä½•ç§åŠ¨ä½œã€‚SmallMarioã€SuperMarioã€CapeMarioã€FireMarioæ˜¯IMarioæ¥å£çš„å®ç°ç±»ï¼Œåˆ†åˆ«å¯¹åº”çŠ¶æ€æœºä¸­çš„4ä¸ªçŠ¶æ€ã€‚

~~~java
public interface IMario { //æ‰€æœ‰çŠ¶æ€ç±»çš„æ¥å£
  State getName();
  //ä»¥ä¸‹æ˜¯å®šä¹‰çš„äº‹ä»¶
  void obtainMushRoom();
  void obtainCape();
  void obtainFireFlower();
  void meetMonster();
}


public class SmallMario implements IMario {
  private MarioStateMachine stateMachine;

  public SmallMario(MarioStateMachine stateMachine) {
    this.stateMachine = stateMachine;
  }

  @Override
  public State getName() {
    return State.SMALL;
  }

  @Override
  public void obtainMushRoom() {
    stateMachine.setCurrentState(new SuperMario(stateMachine));
    stateMachine.setScore(stateMachine.getScore() + 100);
  }

  @Override
  public void obtainCape() {
    stateMachine.setCurrentState(new CapeMario(stateMachine));
    stateMachine.setScore(stateMachine.getScore() + 200);
  }

  @Override
  public void obtainFireFlower() {
    stateMachine.setCurrentState(new FireMario(stateMachine));
    stateMachine.setScore(stateMachine.getScore() + 300);
  }

  @Override
  public void meetMonster() {
    // do nothing...
  }
}

public class SuperMario implements IMario {
  private MarioStateMachine stateMachine;

  public SuperMario(MarioStateMachine stateMachine) {
    this.stateMachine = stateMachine;
  }

  @Override
  public State getName() {
    return State.SUPER;
  }

  @Override
  public void obtainMushRoom() {
    // do nothing...
  }

  @Override
  public void obtainCape() {
    stateMachine.setCurrentState(new CapeMario(stateMachine));
    stateMachine.setScore(stateMachine.getScore() + 200);
  }

  @Override
  public void obtainFireFlower() {
    stateMachine.setCurrentState(new FireMario(stateMachine));
    stateMachine.setScore(stateMachine.getScore() + 300);
  }

  @Override
  public void meetMonster() {
    stateMachine.setCurrentState(new SmallMario(stateMachine));
    stateMachine.setScore(stateMachine.getScore() - 100);
  }
}

// çœç•¥CapeMarioã€FireMarioç±»...

public class MarioStateMachine {
  private int score;
  private IMario currentState; // ä¸å†ä½¿ç”¨æšä¸¾æ¥è¡¨ç¤ºçŠ¶æ€

  public MarioStateMachine() {
    this.score = 0;
    this.currentState = new SmallMario(this);
  }

  public void obtainMushRoom() {
    this.currentState.obtainMushRoom();
  }

  public void obtainCape() {
    this.currentState.obtainCape();
  }

  public void obtainFireFlower() {
    this.currentState.obtainFireFlower();
  }

  public void meetMonster() {
    this.currentState.meetMonster();
  }

  public int getScore() {
    return this.score;
  }

  public State getCurrentState() {
    return this.currentState.getName();
  }

  public void setScore(int score) {
    this.score = score;
  }

  public void setCurrentState(IMario currentState) {
    this.currentState = currentState;
  }
}

~~~

`MarioStateMachine`å’Œå„ä¸ªçŠ¶æ€ç±»ä¹‹é—´æ˜¯åŒå‘ä¾èµ–å…³ç³»ã€‚`MarioStateMachine`ä¾èµ–å„ä¸ªçŠ¶æ€ç±»æ˜¯ç†æ‰€å½“ç„¶çš„ï¼Œè€Œå„ä¸ªçŠ¶æ€ç±»ä¾èµ–`MarioStateMachine`æ˜¯ä¸ºäº†æ›´æ–°`MarioStateMachine`ä¸­çš„ä¸¤ä¸ªå˜é‡ï¼Œ`score`å’Œ`currentState`ã€‚

ç”±äºï¼Œæˆ‘ä»¬å¯ä»¥æŠŠçŠ¶æ€ç±»è®¾è®¡æˆå•ä¾‹ï¼Œé¿å…çŠ¶æ€åˆ‡æ¢æ—¶åå¤çš„åˆ›å»ºå’Œé”€æ¯ã€‚

~~~java
public interface IMario {
  State getName();
  void obtainMushRoom(MarioStateMachine stateMachine);
  void obtainCape(MarioStateMachine stateMachine);
  void obtainFireFlower(MarioStateMachine stateMachine);
  void meetMonster(MarioStateMachine stateMachine);
}

public class SmallMario implements IMario {
  private static final SmallMario instance = new SmallMario();
  private SmallMario() {}
  public static SmallMario getInstance() {
    return instance;
  }

  @Override
  public State getName() {
    return State.SMALL;
  }

  @Override
  public void obtainMushRoom(MarioStateMachine stateMachine) {
    stateMachine.setCurrentState(SuperMario.getInstance());
    stateMachine.setScore(stateMachine.getScore() + 100);
  }

  @Override
  public void obtainCape(MarioStateMachine stateMachine) {
    stateMachine.setCurrentState(CapeMario.getInstance());
    stateMachine.setScore(stateMachine.getScore() + 200);
  }

  @Override
  public void obtainFireFlower(MarioStateMachine stateMachine) {
    stateMachine.setCurrentState(FireMario.getInstance());
    stateMachine.setScore(stateMachine.getScore() + 300);
  }

  @Override
  public void meetMonster(MarioStateMachine stateMachine) {
    // do nothing...
  }
}

// çœç•¥SuperMarioã€CapeMarioã€FireMarioç±»...

public class MarioStateMachine {
  private int score;
  private IMario currentState;

  public MarioStateMachine() {
    this.score = 0;
    this.currentState = SmallMario.getInstance();
  }

  public void obtainMushRoom() {
    this.currentState.obtainMushRoom(this);
  }

  public void obtainCape() {
    this.currentState.obtainCape(this);
  }

  public void obtainFireFlower() {
    this.currentState.obtainFireFlower(this);
  }

  public void meetMonster() {
    this.currentState.meetMonster(this);
  }

  public int getScore() {
    return this.score;
  }

  public State getCurrentState() {
    return this.currentState.getName();
  }

  public void setScore(int score) {
    this.score = score;
  }

  public void setCurrentState(IMario currentState) {
    this.currentState = currentState;
  }
}

~~~



## è¿­ä»£å™¨æ¨¡å¼

**è¿­ä»£å™¨æ¨¡å¼ï¼ˆIterator Design Patternï¼‰**ï¼Œä¹Ÿå«ä½œ**æ¸¸æ ‡æ¨¡å¼ï¼ˆCursor Design Patternï¼‰**ã€‚å®ƒæŠŠéå†æ“ä½œä»é›†åˆç±»ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œæ”¾åˆ°è¿­ä»£å™¨ç±»ä¸­ï¼Œè®©ä¸¤è€…çš„èŒè´£æ›´åŠ å•ä¸€ã€‚è¿­ä»£å™¨å’Œé›†åˆç±»çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º

![](assets/cb72b5921681ac13d4fc05237597d2ec.jpg)

ä¸‹é¢ï¼Œæˆ‘ä»¬å¯¹ArrayListå’ŒLinkedListä¸¤ä¸ªå®¹å™¨ï¼Œå®ç°å¯¹åº”çš„è¿­ä»£å™¨ã€‚æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š

~~~java
// æ¥å£å®šä¹‰æ–¹å¼ä¸€
public interface Iterator<E> {
  boolean hasNext();
  void next();
  E currentItem();
}

// æ¥å£å®šä¹‰æ–¹å¼äºŒ
public interface Iterator<E> {
  boolean hasNext();
  E next();
}
~~~

ArrayIteratorçš„å®ç°å¦‚ä¸‹ï¼š

~~~java
public class ArrayIterator<E> implements Iterator<E> {
  private int cursor;
  private ArrayList<E> arrayList;			//è¿­ä»£å™¨ä¾èµ–çš„å®¹å™¨

  public ArrayIterator(ArrayList<E> arrayList) {
    this.cursor = 0;
    this.arrayList = arrayList;
  }

  @Override
  public boolean hasNext() {
    return cursor != arrayList.size(); //æ³¨æ„è¿™é‡Œï¼Œcursoråœ¨æŒ‡å‘æœ€åä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼ŒhasNext()ä»æ—§è¿”å›trueã€‚
  }

  @Override
  public void next() {
    cursor++;
  }

  @Override
  public E currentItem() {
    if (cursor >= arrayList.size()) {
      throw new NoSuchElementException();
    }
    return arrayList.get(cursor);
  }
}

public class Demo {
  public static void main(String[] args) {
    ArrayList<String> names = new ArrayList<>();
    names.add("xzg");
    names.add("wang");
    names.add("zheng");
    
    Iterator<String> iterator = new ArrayIterator(names);
    while (iterator.hasNext()) {
      System.out.println(iterator.currentItem());
      iterator.next();
    }
  }
}

~~~

åœ¨ä¸Šé¢çš„ä»£ç å®ç°ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†å¾…éå†çš„å®¹å™¨å¯¹è±¡ï¼Œé€šè¿‡æ„é€ å‡½æ•°ä¼ é€’ç»™è¿­ä»£å™¨ç±»ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å®¹å™¨ä¸­å®šä¹‰ä¸€ä¸ªiterator()æ–¹æ³•ï¼Œæ¥åˆ›å»ºå¯¹åº”çš„è¿­ä»£å™¨ã€‚

~~~java
public interface List<E> {
  Iterator iterator();
  //...çœç•¥å…¶ä»–æ¥å£å‡½æ•°...
}

public class ArrayList<E> implements List<E> {
  //...
  public Iterator iterator() {
    return new ArrayIterator(this);
  }
  //...çœç•¥å…¶ä»–ä»£ç 
}

public class Demo {
  public static void main(String[] args) {
    List<String> names = new ArrayList<>();
    names.add("xzg");
    names.add("wang");
    names.add("zheng");
    
    Iterator<String> iterator = names.iterator();
    while (iterator.hasNext()) {
      System.out.println(iterator.currentItem());
      iterator.next();
    }
  }
}

~~~



![](assets/b685b61448aaa638b03b5bf3d9d93330.jpg)

### åœ¨éå†æ—¶ï¼Œä¿®æ”¹é›†åˆå…ƒç´ ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

åœ¨éå†æ—¶ï¼Œå¢åˆ é›†åˆå…ƒç´ ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿè¿™å–å†³äºæ•°æ®ç»“æ„ã€è¿­ä»£å™¨æ˜¯å¦‚ä½•å®ç°çš„ã€‚

æˆ‘ä»¬é€šè¿‡ä¸‹é¢ä¸€ä¸ªä»£ç ç‰‡æ®µæ¥è®¤è¯†è¿™ä¸€ç‚¹

~~~java
public class Demo {
  public static void main(String[] args) {
    List<String> names = new ArrayList<>();
    names.add("a");
    names.add("b");
    names.add("c");
    names.add("d");

    Iterator<String> iterator = names.iterator();
    iterator.next();
    names.add(0, "x");
  }
}
~~~

åœ¨æ‰§è¡Œå®Œç¬¬10è¡Œä»£ç ä¹‹åï¼Œè¿­ä»£å™¨æŒ‡å‘`b`å…ƒç´ ã€‚æ­¤æ—¶ï¼Œè‹¥å°†`x`æ’å…¥åˆ°ä¸‹æ ‡ä¸º0çš„ä½ç½®ï¼Œé‚£ä¹ˆè¿­ä»£å™¨ä¼šé‡æ–°æŒ‡å‘äº†`a`å…ƒç´ ï¼Œè¿™å¹¶ä¸ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚

![](assets/4cd27c2dcdb2be169ef30194899c19d2.jpg)

æœ‰ä¸¤ç§ç›´æ¥çš„è§£å†³æ–¹æ¡ˆï¼š

- **éå†çš„æ—¶å€™ä¸å…è®¸å¢åˆ å…ƒç´ **ã€‚åœ¨è·å–è¿­ä»£å™¨æ—¶ï¼Œå°±ç«‹å³ç¦æ­¢é›†åˆçš„ä¿®æ”¹æ“ä½œã€‚å½“ç¨‹åºå‘˜ä½¿ç”¨å®Œè¿­ä»£å™¨åï¼Œä¸»åŠ¨è°ƒç”¨`finishIteration()`æ–¹æ³•ï¼Œå…è®¸é›†åˆçš„ä¿®æ”¹æ“ä½œã€‚

- **å¢åˆ å…ƒç´ ä¹‹åè®©éå†æŠ¥é”™**ï¼Œè¿™ä¹Ÿæ­£æ˜¯Javaé›†åˆåº“æ‰€é‡‡ç”¨çš„æ–¹æ¡ˆã€‚

  åœ¨å®¹å™¨ä¸­å®šä¹‰ä¸€ä¸ªå±æ€§modCountï¼Œè®°å½•é›†åˆè¢«ä¿®æ”¹çš„æ¬¡æ•°ã€‚å½“åˆ›å»ºè¿­ä»£å™¨æ—¶ï¼Œè¿­ä»£å™¨çš„expectedModCountå±æ€§åˆå§‹åŒ–ä¸ºmodCountã€‚æ¯æ¬¡è°ƒç”¨è¿­ä»£å™¨çš„hasNext()ã€next()ã€currentItem()æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šæ£€æŸ¥é›†åˆä¸Šçš„modCountæ˜¯å¦ç­‰äºexpectedModCountã€‚

  è‹¥ä¸ç›¸ç­‰ï¼Œåˆ™è¯´æ˜é›†åˆè¢«ä¿®æ”¹äº†ï¼Œè¿­ä»£å™¨å¯èƒ½äº§ç”Ÿä¸ç¬¦åˆé¢„æœŸçš„ç»“æœã€‚æ­¤æ—¶ï¼Œç›´æ¥ä¸€ä¸ªfail-fastï¼ŒæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ã€‚



### æ”¯æŒâ€œå¿«ç…§â€åŠŸèƒ½çš„iterator

å½“æˆ‘ä»¬è·å–è¿­ä»£å™¨æ—¶ï¼Œåˆ›å»ºå½“å‰å®¹å™¨çš„ä¸€ä¸ªã€Œå¿«ç…§ã€ã€‚è¿­ä»£å™¨éå†çš„å¯¹è±¡æ˜¯å¿«ç…§è€Œéå®¹å™¨ï¼Œè¿™æ ·å°±é¿å…äº†åœ¨ä½¿ç”¨è¿­ä»£å™¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œå¢åˆ å®¹å™¨ä¸­çš„å…ƒç´ è€Œå¯¼è‡´çš„ä¸å¯é¢„æœŸçš„ç»“æœã€‚

æœ€ç®€å•çš„å®ç°æ–¹å¼å°±æ˜¯ç›´æ¥å¤åˆ¶å®¹å™¨ï¼š

~~~java
public class SnapshotArrayIterator<E> implements Iterator<E> {
  private int cursor;
  private ArrayList<E> snapshot;							//ç”¨äºä¿å­˜å¿«ç…§

  public SnapshotArrayIterator(ArrayList<E> arrayList) {
    this.cursor = 0;
    this.snapshot = new ArrayList<>();
    this.snapshot.addAll(arrayList);						//æµ…å¤åˆ¶å®¹å™¨
  }

  @Override
  public boolean hasNext() {
    return cursor < snapshot.size();
  }

  @Override
  public E next() {
    E currentItem = snapshot.get(cursor);
    cursor++;
    return currentItem;
  }
}
~~~

æ˜¾ç„¶ï¼Œæ¯æ¬¡åˆ›å»ºè¿­ä»£å™¨æ—¶ï¼Œéƒ½è¦å¤åˆ¶ä¸€ä»½æ•°æ®åˆ°å¿«ç…§ä¸­ï¼Œè¿™æ¯”è¾ƒæµªè´¹èµ„æºã€‚

ç¬¬äºŒç§è§£å†³æ–¹æ³•å°±ç¼“è§£äº†ä¸Šè¿°é—®é¢˜ã€‚åœ¨å®¹å™¨ä¸­ï¼Œä¸ºæ¯ä¸ªå…ƒç´ ä¿å­˜æ·»åŠ æ—¶é—´æˆ³`addTimestamp`å’Œåˆ é™¤æ—¶é—´æˆ³`delTimestamp`ã€‚å½“å‘é›†åˆæ·»åŠ å…ƒç´ æ—¶ï¼Œæˆ‘ä»¬å°†è¯¥å…ƒç´ çš„`addTimestamp`è®¾ç½®ä¸ºå½“å‰æ—¶é—´ï¼Œå°†`delTimestamp`è®¾ç½®æˆæœ€å¤§é•¿æ•´å‹å€¼ï¼ˆLong.MAX\_VALUEï¼‰ã€‚å½“å…ƒç´ è¢«åˆ é™¤æ—¶ï¼Œæˆ‘ä»¬å°†delTimestampæ›´æ–°ä¸ºå½“å‰æ—¶é—´ï¼Œæ ‡è®°ä¸ºåˆ é™¤ï¼Œä½†å¹¶ä¸å°†å®ƒä»å®¹å™¨ä¸­ç§»é™¤ã€‚

åŒæ—¶ï¼Œæ¯ä¸ªè¿­ä»£å™¨ä¹Ÿä¿å­˜ä¸€ä¸ªè¿­ä»£å™¨åˆ›å»ºæ—¶é—´æˆ³`snapshotTimestamp`ã€‚å½“ä½¿ç”¨è¿­ä»£å™¨æ¥éå†å®¹å™¨çš„æ—¶å€™ï¼Œåªæœ‰æ»¡è¶³çº¦æŸå…³ç³»$addTimestamp<snapshotTimestamp<delTimestamp$çš„å…ƒç´ ï¼Œæ‰æ˜¯å±äºè¿™ä¸ªè¿­ä»£å™¨çš„å¿«ç…§ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªç‰ˆæœ¬çš„ArrayListå®ç°ï¼š

~~~java
public class ArrayList<E> implements List<E> {
  private static final int DEFAULT_CAPACITY = 10;

  private int actualSize; //ä¸åŒ…å«æ ‡è®°åˆ é™¤å…ƒç´ 
  private int totalSize; //åŒ…å«æ ‡è®°åˆ é™¤å…ƒç´ 

  private Object[] elements;
  private long[] addTimestamps;
  private long[] delTimestamps;

  public ArrayList() {
    this.elements = new Object[DEFAULT_CAPACITY];
    this.addTimestamps = new long[DEFAULT_CAPACITY];
    this.delTimestamps = new long[DEFAULT_CAPACITY];
    this.totalSize = 0;
    this.actualSize = 0;
  }

  @Override
  public void add(E obj) {
    // æ³¨æ„ï¼Œæ·»åŠ æ“ä½œå¹¶ä¸åƒåŸå§‹ç‰ˆæœ¬é‚£æ ·ï¼Œéœ€è¦æ•´ä½“ç§»åŠ¨å…ƒç´ ã€‚è€Œæ˜¯ç›´æ¥æ”¾åœ¨æœ€å
    // è¿™å·§å¦™åœ°è§„é¿äº†ä¿®æ”¹æ“ä½œå¯¹éå†æ“ä½œçš„å½±å“
    elements[totalSize] = obj;
    addTimestamps[totalSize] = System.currentTimeMillis();
    delTimestamps[totalSize] = Long.MAX_VALUE;
    totalSize++;
    actualSize++;
  }

  @Override
  public void remove(E obj) {
    for (int i = 0; i < totalSize; ++i) {
      if (elements[i].equals(obj)) {
        delTimestamps[i] = System.currentTimeMillis();
        actualSize--;
      }
    }
  }

  public int actualSize() {
    return this.actualSize;
  }

  public int totalSize() {
    return this.totalSize;
  }

  public E get(int i) {
    if (i >= totalSize) {
      throw new IndexOutOfBoundsException();
    }
    return (E)elements[i];
  }

  public long getAddTimestamp(int i) {
    if (i >= totalSize) {
      throw new IndexOutOfBoundsException();
    }
    return addTimestamps[i];
  }

  public long getDelTimestamp(int i) {
    if (i >= totalSize) {
      throw new IndexOutOfBoundsException();
    }
    return delTimestamps[i];
  }
}

public class SnapshotArrayIterator<E> implements Iterator<E> {
  private long snapshotTimestamp;
  private int cursorInAll; 		// åœ¨æ•´ä¸ªå®¹å™¨ä¸­çš„ä¸‹æ ‡ï¼Œè€Œéå¿«ç…§ä¸­çš„ä¸‹æ ‡
  private int leftCount; 		// å¿«ç…§ä¸­è¿˜æœ‰å‡ ä¸ªå…ƒç´ æœªè¢«éå†
  private ArrayList<E> arrayList;

  public SnapshotArrayIterator(ArrayList<E> arrayList) {
    this.snapshotTimestamp = System.currentTimeMillis();
    this.cursorInAll = 0;
    this.leftCount = arrayList.actualSize();
    this.arrayList = arrayList;

    justNext(); // å…ˆè·³åˆ°è¿™ä¸ªè¿­ä»£å™¨å¿«ç…§çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
  }

  @Override
  public boolean hasNext() {
    //leftCountç®—æ˜¯ä¸€ä¸ªå°ä¼˜åŒ–å§ï¼Œå®ƒç›´æ¥å°†åæ·»åŠ çš„å…ƒç´ ç›´æ¥å¿½ç•¥æ‰äº†ã€‚
    return this.leftCount >= 0; 
  }

  @Override
  public E next() {
    E currentItem = arrayList.get(cursorInAll);
    justNext();
    return currentItem;
  }

  private void justNext() {
    while (cursorInAll < arrayList.totalSize()) {
      long addTimestamp = arrayList.getAddTimestamp(cursorInAll);
      long delTimestamp = arrayList.getDelTimestamp(cursorInAll);
      if (snapshotTimestamp > addTimestamp && snapshotTimestamp < delTimestamp) {
        leftCount--;
        break;
      }
      cursorInAll++;
    }
  }
}
~~~

å®é™…ä¸Šï¼Œè¿™ç§è§£å†³æ–¹æ¡ˆåˆå¼•å…¥äº†å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œä¸æ”¯æŒéšæœºè®¿é—®äº†ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨ArrayListä¸­ç»´æŠ¤ä¸¤ä¸ªæ•°ç»„æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä¸€ä¸ªæ”¯æŒæ ‡è®°åˆ é™¤çš„ï¼Œç”¨æ¥å®ç°å¿«ç…§éå†åŠŸèƒ½ï¼›ä¸€ä¸ªä¸æ”¯æŒæ ‡è®°åˆ é™¤çš„ï¼Œç”¨æ¥æ”¯æŒéšæœºè®¿é—®ã€‚



## è®¿é—®è€…æ¨¡å¼

è®¿é—®è€…æ¨¡å¼éš¾ä»¥ç†è§£ï¼Œå¾ˆå°‘è¢«åº”ç”¨ï¼Œå› æ­¤äº†è§£å³å¯ã€‚

> Allows for one or more operation to be applied to a set of objects at runtime, decoupling the operations from the object structure.
>
> å…è®¸ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ“ä½œåº”ç”¨åˆ°ä¸€ç»„å¯¹è±¡ä¸Šï¼Œè§£è€¦æ“ä½œå’Œå¯¹è±¡æœ¬èº«ã€‚

å®ƒæœ¬è´¨ä¸Šæ˜¯ç”¨Single Dispatchæ¥æ¨¡æ‹ŸDouble Dispatchçš„



ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªéœ€æ±‚ï¼Œè®¾è®¡ä¸€ä¸ªå·¥å…·ï¼Œå°†PDFã€PPTã€Wordæ–‡ä»¶ä¸­çš„å†…å®¹æŠ½å–å‡ºæ¥æ”¾åœ¨txtæ–‡ä»¶ä¸­ã€‚è¿™ä¸ªå·¥å…·çš„ç®€æ˜“å®ç°å¦‚ä¸‹ï¼š

~~~java
public abstract class ResourceFile {
  protected String filePath;

  public ResourceFile(String filePath) {
    this.filePath = filePath;
  }

  public abstract void extract2txt();
}


public class PPTFile extends ResourceFile {
  public PPTFile(String filePath) {
    super(filePath);
  }

  @Override
  public void extract2txt() {
    // TODO
  }
}


public class PdfFile extends ResourceFile {
  public PdfFile(String filePath) {
    super(filePath);
  }

  @Override
  public void extract2txt() {
    // TODO
  }
}


public class WordFile extends ResourceFile {
  public WordFile(String filePath) {
    super(filePath);
  }

  @Override
  public void extract2txt() {
    // TODO
  }
}


public class ToolApplication {
  public static void main(String[] args) {
    List<ResourceFile> resourceFiles = listAllResourceFiles(args[0]);
    for (ResourceFile resourceFile : resourceFiles) {
      resourceFile.extract2txt();
    }
  }

  // ä»æŒ‡å®šçš„ç›®å½•ä¸‹ï¼Œè¯»å–.pdf .word .pptæ–‡ä»¶åˆ°List<ResourceFile>ä¸­
  private static List<ResourceFile> listAllResourceFiles(String resourceDirectory) {
    // TODO
  }
}
~~~

å¦‚æœå·¥å…·çš„åŠŸèƒ½ä¸åœåœ°æ‰©å±•ï¼Œè¿˜è¦æ±‚æ”¯æŒå‹ç¼©ã€æå–æ–‡ä»¶å…ƒä¿¡æ¯ã€æ„å»ºç´¢å¼•ç­‰ä¸€ç³»åˆ—çš„åŠŸèƒ½ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬ç»§ç»­æŒ‰ç…§ä¸Šé¢çš„å®ç°æ€è·¯ï¼Œå°±ä¼šå­˜åœ¨è¿™æ ·å‡ ä¸ªé—®é¢˜ï¼š

- è¿èƒŒå¼€é—­åŸåˆ™ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„åŠŸèƒ½ï¼Œæ‰€æœ‰ç±»çš„ä»£ç éƒ½è¦ä¿®æ”¹ï¼›
- åŠŸèƒ½å¢å¤šï¼Œæ¯ä¸ªç±»çš„ä»£ç éƒ½ä¸æ–­è†¨èƒ€ï¼Œå¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§éƒ½å˜å·®äº†ï¼›
- æŠŠæ‰€æœ‰æ¯”è¾ƒä¸Šå±‚çš„ä¸šåŠ¡é€»è¾‘éƒ½è€¦åˆåˆ°PdfFileã€PPTFileã€WordFileç±»ä¸­ï¼Œå¯¼è‡´è¿™äº›ç±»çš„èŒè´£ä¸å¤Ÿå•ä¸€ï¼›



é’ˆå¯¹ä¸Šé¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬æŠŠä¸šåŠ¡æ“ä½œè·Ÿå…·ä½“çš„æ•°æ®ç»“æ„è§£è€¦ï¼Œè®¾è®¡æˆç‹¬ç«‹çš„ç±»ã€‚

~~~java
public abstract class ResourceFile {
  protected String filePath;
  public ResourceFile(String filePath) {
    this.filePath = filePath;
  }
}

public class PdfFile extends ResourceFile {
  public PdfFile(String filePath) {
    super(filePath);
  }
}

//...PPTFileã€WordFileä»£ç çœç•¥...
public class Extractor {
  public void extract2txt(PPTFile pptFile) {
    // TODO
  }

  public void extract2txt(PdfFile pdfFile) {
    // TODO
  }

  public void extract2txt(WordFile wordFile) {
    // TODO
  }
}

public class ToolApplication {
  public static void main(String[] args) {
    Extractor extractor = new Extractor();
    List<ResourceFile> resourceFiles = listAllResourceFiles(args[0]);
    for (ResourceFile resourceFile : resourceFiles) {
      extractor.extract2txt(resourceFile);
    }
  }

  private static List<ResourceFile> listAllResourceFiles(String resourceDirectory) {
    // TODO
  }
}
~~~

æˆ‘ä»¬æŠŠæŠ½å–æ–‡æœ¬å†…å®¹çš„æ“ä½œï¼Œè®¾è®¡æˆäº†ä¸‰ä¸ªé‡è½½å‡½æ•°ã€‚é—æ†¾çš„æ˜¯ï¼Œè¿™ç§å®ç°æ–¹å¼ä¼šç¼–è¯‘æŠ¥é”™ã€‚åœ¨Javaä¸­ï¼Œå‡½æ•°é‡è½½æ˜¯ä¸€ç§é™æ€ç»‘å®šï¼Œåœ¨ç¼–è¯‘æ—¶å¹¶ä¸èƒ½è·å–å¯¹è±¡çš„å®é™…ç±»å‹ã€‚è¿™æ˜¯å› ä¸ºJavaåªæ”¯æŒå•åˆ†æ´¾ã€‚æ‰€è°“çš„**å•åˆ†æ´¾ï¼ˆSingle Dispatchï¼‰**å°±æ˜¯ï¼šæ‰§è¡Œã€Œå“ªä¸ªå¯¹è±¡ã€çš„æ–¹æ³•ï¼Œæ ¹æ®å¯¹è±¡çš„è¿è¡Œæ—¶ç±»å‹æ¥å†³å®šï¼›æ‰§è¡Œå¯¹è±¡çš„ã€Œå“ªä¸ªæ–¹æ³•ã€ï¼Œæ ¹æ®**æ–¹æ³•å‚æ•°çš„ç¼–è¯‘æ—¶ç±»å‹**æ¥å†³å®šã€‚

è€Œ**åŒåˆ†æ´¾ï¼ˆDouble Dispatchï¼‰**çš„å«ä¹‰ï¼šæ‰§è¡Œã€Œå“ªä¸ªå¯¹è±¡ã€çš„æ–¹æ³•ï¼Œæ ¹æ®å¯¹è±¡çš„è¿è¡Œæ—¶ç±»å‹æ¥å†³å®šï¼›æ‰§è¡Œå¯¹è±¡çš„ã€Œå“ªä¸ªæ–¹æ³•ã€ï¼Œæ ¹æ®**æ–¹æ³•å‚æ•°çš„è¿è¡Œæ—¶ç±»å‹**æ¥å†³å®šã€‚

Single Dispatchå’ŒDouble Dispatchè·Ÿå¤šæ€å’Œå‡½æ•°é‡è½½ç›´æ¥ç›¸å…³ã€‚å½“å‰ä¸»æµçš„é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ï¼ˆæ¯”å¦‚ï¼ŒJavaã€C++ã€C#ï¼‰éƒ½åªæ”¯æŒSingle Dispatchã€‚

ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­ï¼Œæ¥è¯´æ˜Single Dispatchåœ¨Javaä¸­çš„ä½“ç°ï¼š

~~~java
public class ParentClass {
  public void f() {
    System.out.println("I am ParentClass's f().");
  }
}

public class ChildClass extends ParentClass {
  public void f() {
    System.out.println("I am ChildClass's f().");
  }
}

public class SingleDispatchClass {
  public void polymorphismFunction(ParentClass p) {
    p.f();
  }

  public void overloadFunction(ParentClass p) {
    System.out.println("I am overloadFunction(ParentClass p).");
  }

  public void overloadFunction(ChildClass c) {
    System.out.println("I am overloadFunction(ChildClass c).");
  }
}

public class DemoMain {
  public static void main(String[] args) {
    SingleDispatchClass demo = new SingleDispatchClass();
    ParentClass p = new ChildClass();
    demo.polymorphismFunction(p);	//æ‰§è¡Œå“ªä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼Œç”±å¯¹è±¡çš„å®é™…ç±»å‹å†³å®š
    demo.overloadFunction(p);		//æ‰§è¡Œå¯¹è±¡çš„å“ªä¸ªæ–¹æ³•ï¼Œç”±å‚æ•°å¯¹è±¡çš„å£°æ˜ç±»å‹å†³å®š
  }
}

//ä»£ç æ‰§è¡Œç»“æœ:
/**
* I am ChildClass's f().
* I am overloadFunction(ParentClass p).
*/
~~~

å¦‚æœJavaæ”¯æŒåŒåˆ†æ´¾æ¨¡å¼ï¼Œé‚£ä¹ˆå°±ä¸ç”¨å®ç°æ¥ä¸‹æ¥çš„è®¿é—®è€…æ¨¡å¼äº†ã€‚



~~~java
public abstract class ResourceFile {
  protected String filePath;
  public ResourceFile(String filePath) {
    this.filePath = filePath;
  }
  abstract public void accept(Extractor extractor);
}

public class PdfFile extends ResourceFile {
  public PdfFile(String filePath) {
    super(filePath);
  }

  @Override
  public void accept(Extractor extractor) {
    extractor.extract2txt(this);
  }

  //...
}

//...PPTFileã€WordFileè·ŸPdfFileç±»ä¼¼ï¼Œè¿™é‡Œå°±çœç•¥äº†...
//...Extractorä»£ç ä¸å˜...

public class ToolApplication {
  public static void main(String[] args) {
    Extractor extractor = new Extractor();
    List<ResourceFile> resourceFiles = listAllResourceFiles(args[0]);
    for (ResourceFile resourceFile : resourceFiles) {
      resourceFile.accept(extractor);
    }
  }

  private static List<ResourceFile> listAllResourceFiles(String resourceDirectory) {

  }
}

~~~

åœ¨æ‰§è¡Œ`resourceFile.accept(extractor);`æ—¶ï¼Œç¨‹åºæ ¹æ®å¤šæ€ç‰¹æ€§ï¼Œä¼šè°ƒç”¨å®é™…ç±»å‹çš„`accept()`æ–¹æ³•ã€‚ä»¥`PdfFile`çš„`accept`æ–¹æ³•ä¸ºä¾‹ï¼Œæ‰§è¡Œ`extractor.extract2txt(this)`æ—¶ï¼Œ`this`çš„ç±»å‹åœ¨ç¼–è¯‘æœŸæ—¶å°±ç¡®å®šä¸‹æ¥ï¼Œä¹‹åå°±ä¼šè°ƒç”¨`extractor`çš„`extract2txt(PdfFile pdfFile)`è¿™ä¸ªé‡è½½å‡½æ•°ã€‚æ˜¯ä¸æ˜¯å¾ˆæœ‰æŠ€å·§æ€§ï¼Œä½†è¿˜æ²¡ç»“æŸğŸ˜¥ã€‚

ä¸Šé¢ä»£ç è¿˜å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œå¦‚æœè¦æ·»åŠ ä¸€ä¸ªæ–°çš„ä¸šåŠ¡ï¼Œè¿˜æ˜¯éœ€è¦ä¿®æ”¹æ¯ä¸ªèµ„æºæ–‡ä»¶ç±»ï¼Œè¿™è¿åäº†å¼€é—­åŸåˆ™ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æŠ½è±¡å‡ºæ¥ä¸€ä¸ªVisitoræ¥å£ï¼Œå®ƒåŒ…å«ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«å¤„ç†ä¸‰ç§ä¸åŒç±»å‹çš„èµ„æºæ–‡ä»¶ã€‚

~~~java
public abstract class ResourceFile {
  protected String filePath;
  public ResourceFile(String filePath) {
    this.filePath = filePath;
  }
  abstract public void accept(Visitor vistor);
}


public class PdfFile extends ResourceFile {
  public PdfFile(String filePath) {
    super(filePath);
  }

  @Override
  public void accept(Visitor visitor) {
    visitor.visit(this);
  }
}


public interface Visitor {
  void visit(PdfFile pdfFile);
  void visit(PPTFile pdfFile);
  void visit(WordFile pdfFile);
}

public class Extractor implements Visitor {
  @Override
  public void visit(PPTFile pptFile) {
    // TODO
  }

  @Override
  public void visit(PdfFile pdfFile) {
    // TODO
  }

  @Override
  public void visit(WordFile wordFile) {
    // TODO
  }
}

public class Compressor implements Visitor {
  @Override
  public void visit(PPTFile pptFile) {
    // TODO
  }

  @Override
  public void visit(PdfFile pdfFile) {
    // TODO
  }

  @Override
  public void visit(WordFile wordFile) {
    // TODO
  }

}

public class ToolApplication {
  public static void main(String[] args) {
    Extractor extractor = new Extractor();
    List<ResourceFile> resourceFiles = listAllResourceFiles(args[0]);
    for (ResourceFile resourceFile : resourceFiles) {
      resourceFile.accept(extractor);		//å¯¹è±¡æ¥å—è¿™ä¸ªæ“ä½œ
    }

    Compressor compressor = new Compressor();
    for(ResourceFile resourceFile : resourceFiles) {
      resourceFile.accept(compressor);
    }
  }

  private static List<ResourceFile> listAllResourceFiles(String resourceDirectory) {
      // TODO
  }
}

~~~

è¿™æ ·ï¼Œå½“æˆ‘ä»¬æ–°æ·»åŠ ä¸€ä¸ªä¸šåŠ¡åŠŸèƒ½çš„æ—¶å€™ï¼Œèµ„æºæ–‡ä»¶ç±»ä¸éœ€è¦åšä»»ä½•ä¿®æ”¹ã€‚

![](assets/c42c636c5384da5bd5343618305db865.jpg)

ä¸€èˆ¬æ¥è¯´ï¼Œè®¿é—®è€…æ¨¡å¼é’ˆå¯¹çš„æ˜¯ä¸€ç»„ç±»å‹ä¸åŒçš„å¯¹è±¡ï¼ˆPdfFileã€PPTFileã€WordFileï¼‰ã€‚æˆ‘ä»¬éœ€è¦å¯¹è¿™ç»„å¯¹è±¡è¿›è¡Œä¸€ç³»åˆ—ä¸ç›¸å…³çš„ä¸šåŠ¡æ“ä½œï¼ˆæŠ½å–æ–‡æœ¬ã€å‹ç¼©ç­‰ï¼‰ï¼Œä½†ä¸ºäº†é¿å…ä¸æ–­æ·»åŠ åŠŸèƒ½å¯¼è‡´ç±»ï¼ˆPdfFileã€PPTFileã€WordFileï¼‰ä¸æ–­è†¨èƒ€ï¼ŒèŒè´£è¶Šæ¥è¶Šä¸å•ä¸€ï¼Œä»¥åŠé¿å…é¢‘ç¹åœ°æ·»åŠ åŠŸèƒ½å¯¼è‡´çš„é¢‘ç¹ä»£ç ä¿®æ”¹ï¼Œæˆ‘ä»¬ä½¿ç”¨è®¿é—®è€…æ¨¡å¼ï¼Œå°†å¯¹è±¡ä¸æ“ä½œè§£è€¦ï¼Œå°†è¿™äº›ä¸šåŠ¡æ“ä½œæŠ½ç¦»å‡ºæ¥ï¼Œå®šä¹‰åœ¨ç‹¬ç«‹ç»†åˆ†çš„è®¿é—®è€…ç±»ï¼ˆExtractorã€Compressorï¼‰ä¸­ã€‚



å®é™…ä¸Šï¼Œä¸Šè¿°çš„ä¾‹å­æˆ‘ä»¬è¿˜æœ‰å…¶ä»–çš„å®ç°æ–¹æ³•ï¼Œä¾‹å¦‚ç­–ç•¥æ¨¡å¼ï¼ˆä¸€å¼€å§‹æˆ‘å°±æƒ³åˆ°è¿™ç§æ–¹æ³•äº† ğŸ¤­ï¼‰ã€‚
~~~Java
public abstract class ResourceFile {
  protected String filePath;
  public ResourceFile(String filePath) {
    this.filePath = filePath;
  }
  public abstract ResourceFileType getType();
}

public class PdfFile extends ResourceFile {
  public PdfFile(String filePath) {
    super(filePath);
  }

  @Override
  public ResourceFileType getType() {
    return ResourceFileType.PDF;
  }

  //...
}


//å°†extracté€»è¾‘æŠ½ç¦»åˆ°Extractoræ¥å£ä¸­
public interface Extractor {
  void extract2txt(ResourceFile resourceFile);
}

public class PdfExtractor implements Extractor {
  @Override
  public void extract2txt(ResourceFile resourceFile) {
    //...
  }
}



public class ExtractorFactory {
  private static final Map<ResourceFileType, Extractor> extractors = new HashMap<>();
  static {
    extractors.put(ResourceFileType.PDF, new PdfExtractor());
    extractors.put(ResourceFileType.PPT, new PPTExtractor());
    extractors.put(ResourceFileType.WORD, new WordExtractor());
  }

  public static Extractor getExtractor(ResourceFileType type) {
    return extractors.get(type);
  }
}


public class ToolApplication {
  public static void main(String[] args) {
    List<ResourceFile> resourceFiles = listAllResourceFiles(args[0]);
    for (ResourceFile resourceFile : resourceFiles) {
      //æ ¹æ®èµ„æºçš„ç±»å‹ï¼Œåˆ›å»ºå¯¹åº”çš„æ‰§è¡Œé€»è¾‘
      Extractor extractor = ExtractorFactory.getExtractor(resourceFile.getType());
      //æ‰§è¡Œ
      extractor.extract2txt(resourceFile);
    }
  }

  private static List<ResourceFile> listAllResourceFiles(String resourceDirectory) {
	// TODO
  }
}
~~~

ä»£ç ç»“æ„ç›¸æ¯”è®¿é—®è€…æ¨¡å¼æ›´åŠ ç®€æ´ã€æ˜“æ‡‚ã€‚å”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯ï¼Œå½“åŠŸèƒ½å¢å¤šæ—¶ï¼Œæ‰€è¦åˆ›å»ºçš„ç±»è¦æ¯”è®¿é—®è€…æ¨¡å¼å¤šã€‚

## å¤‡å¿˜å½•æ¨¡å¼

**å¤‡å¿˜å½•æ¨¡å¼ï¼ˆMemento Design Patternï¼‰**ï¼Œåˆç§°ä¸º**å¿«ç…§ï¼ˆSnapshotï¼‰**æ¨¡å¼ã€‚

>Captures and externalizes an objectâ€™s internal state so that it can be restored later, all without violating encapsulation.
>
>åœ¨ä¸è¿èƒŒå°è£…åŸåˆ™çš„å‰æä¸‹ï¼Œæ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶åœ¨è¯¥å¯¹è±¡ä¹‹å¤–ä¿å­˜è¿™ä¸ªçŠ¶æ€ï¼Œä»¥ä¾¿ä¹‹åæ¢å¤å¯¹è±¡ä¸ºå…ˆå‰çš„çŠ¶æ€ã€‚

æˆ‘ä»¬è¦å›ç­”ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š

- ä¸ºä»€ä¹ˆå­˜å‚¨å’Œæ¢å¤å‰¯æœ¬ä¼šè¿èƒŒå°è£…åŸåˆ™ï¼Ÿ
- å¤‡å¿˜å½•æ¨¡å¼æ˜¯å¦‚ä½•åšåˆ°ä¸è¿èƒŒå°è£…åŸåˆ™çš„ï¼Ÿ

ç°åœ¨æˆ‘ä»¬è¦å®ç°è¿™ä¸ªéœ€æ±‚ï¼šç¼–å†™ä¸€ä¸ªå°ç¨‹åºï¼Œå¯ä»¥æ¥æ”¶å‘½ä»¤è¡Œçš„è¾“å…¥ã€‚ç”¨æˆ·è¾“å…¥æ–‡æœ¬æ—¶ï¼Œç¨‹åºå°†å…¶è¿½åŠ å­˜å‚¨åœ¨å†…å­˜æ–‡æœ¬ä¸­ï¼›ç”¨æˆ·è¾“å…¥â€œ:listâ€ï¼Œç¨‹åºåœ¨å‘½ä»¤è¡Œä¸­è¾“å‡ºå†…å­˜æ–‡æœ¬çš„å†…å®¹ï¼›ç”¨æˆ·è¾“å…¥â€œ:undoâ€ï¼Œç¨‹åºä¼šæ’¤é”€ä¸Šä¸€æ¬¡è¾“å…¥çš„æ–‡æœ¬ï¼Œä¹Ÿå°±æ˜¯ä»å†…å­˜æ–‡æœ¬ä¸­å°†ä¸Šæ¬¡è¾“å…¥çš„æ–‡æœ¬åˆ é™¤æ‰ã€‚

~~~
>hello
>:list
hello
>world
>:list
helloworld
>:undo
>:list
hello
~~~

ä¸€ä¸ªç®€å•çš„å®ç°å¦‚ä¸‹ï¼š

~~~java
//æ ¸å¿ƒæ€è·¯ä½¿ç”¨æ ˆæ¥ä¿å­˜
public class InputText {
  private StringBuilder text = new StringBuilder();

  public String getText() {
    return text.toString();
  }

  public void append(String input) {
    text.append(input);
  }

  public void setText(String text) {
    this.text.replace(0, this.text.length(), text);
  }
}

public class SnapshotHolder {
  private Stack<InputText> snapshots = new Stack<>();

  public InputText popSnapshot() {
    return snapshots.pop();
  }

  public void pushSnapshot(InputText inputText) {
    InputText deepClonedInputText = new InputText();
    deepClonedInputText.setText(inputText.getText());
    snapshots.push(deepClonedInputText);
  }
}

public class ApplicationMain {
  public static void main(String[] args) {
    InputText inputText = new InputText();
    SnapshotHolder snapshotsHolder = new SnapshotHolder();
    Scanner scanner = new Scanner(System.in);
    while (scanner.hasNext()) {
      String input = scanner.next();
      if (input.equals(":list")) {
        System.out.println(inputText.getText());
      } else if (input.equals(":undo")) {
        InputText snapshot = snapshotsHolder.popSnapshot();
        inputText.setText(snapshot.getText());
      } else {
        snapshotsHolder.pushSnapshot(inputText);
        inputText.append(input);
      }
    }
  }
}

~~~

ä¸Šé¢çš„ä»£ç æœ‰ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š

- è¿èƒŒäº†å°è£…åŸåˆ™ï¼Œä¸ºäº†èƒ½ç”¨å¿«ç…§æ¢å¤InputTextå¯¹è±¡ï¼Œæˆ‘ä»¬åœ¨InputTextç±»ä¸­å®šä¹‰äº†setText()å‡½æ•°ã€‚
- ç†è®ºä¸Šè®²ï¼Œ

## å‘½ä»¤æ¨¡å¼

## è§£é‡Šå™¨æ¨¡å¼

## ä¸­ä»‹æ¨¡å¼
