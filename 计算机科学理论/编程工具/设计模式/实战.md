# å®æˆ˜

[TOC]

## IDç”Ÿæˆå™¨ä»£ç 

> æŒç»­é‡æ„ã€å•å…ƒæµ‹è¯•ã€ä»£ç çš„å¯æµ‹è¯•æ€§ã€è§£è€¦ã€ç¼–ç è§„èŒƒçš„åº”ç”¨

### éœ€æ±‚åˆ†æ

ä¸ºæ¯ä¸ªè¯·æ±‚æ·»åŠ IDã€‚åœ¨æ‰“å°æ—¥è®°æ—¶ï¼Œå¯ä»¥æŒ‡å®šè¯·æ±‚çš„IDï¼Œè·å–å…¶æ‰€æœ‰çš„è®°å½•ã€‚

### ä¸€ä»½èƒ½ç”¨çš„ä»£ç å®ç°

~~~java
public class IdGenerator {
  private static final Logger logger = LoggerFactory.getLogger(IdGenerator.class);

  public static String generate() {
    String id = "";
    try {
      String hostName = InetAddress.getLocalHost().getHostName();
      String[] tokens = hostName.split("\\.");
      if (tokens.length > 0) {
        hostName = tokens[tokens.length - 1];
      }
        
      char[] randomChars = new char[8];
      int count = 0;
      Random random = new Random();
      while (count < 8) {
        int randomAscii = random.nextInt(122);
        if (randomAscii >= 48 && randomAscii <= 57) {
          randomChars[count] = (char)('0' + (randomAscii - 48));
          count++;
        } else if (randomAscii >= 65 && randomAscii <= 90) {
          randomChars[count] = (char)('A' + (randomAscii - 65));
          count++;
        } else if (randomAscii >= 97 && randomAscii <= 122) {
          randomChars[count] = (char)('a' + (randomAscii - 97));
          count++;
        }
      }
      id = String.format("%s-%d-%s", hostName,
              System.currentTimeMillis(), new String(randomChars));
    } catch (UnknownHostException e) {
      logger.warn("Failed to get the host name.", e);
    }
    return id;
  }
}

/** 
æœ¬æœºåçš„æœ€åä¸€ä¸ªå­—æ®µ-ç²¾ç¡®åˆ°æ¯«ç§’çš„æ—¶é—´æˆ³-8ä½çš„éšæœºå­—ç¬¦ä¸²
103-1577456311467-3nR3Do45
103-1577456311468-0wnuV5yw
103-1577456311468-sdrnkFxN
103-1577456311468-8lwk0BP0
*/
~~~

è¿™ä»½ä»£ç åªèƒ½ç®—å¾—ä¸Šâ€œèƒ½ç”¨â€ï¼Œå‹‰å¼ºåŠæ ¼ã€‚å› ä¸º

- è°ƒç”¨è€…ç›´æ¥ä¾èµ–å®ç°è€Œéæ¥å£ï¼Œå¦‚æœåªæœ‰ä¸€ç§IDç”Ÿæˆç®—æ³•ï¼Œé‚£å°±æ— æ‰€è°“ã€‚ä½†æ˜¯åŒæ—¶å­˜åœ¨å¤šç§IDç”Ÿæˆç®—æ³•ï¼Œå°±è¿èƒŒäº†ã€ŒåŸºäºæ¥å£è€Œéå®ç°ç¼–ç¨‹ã€çš„è®¾è®¡åŸåˆ™ã€‚
- æŠŠIdGeneratorçš„generate()å‡½æ•°å®šä¹‰ä¸ºé™æ€å‡½æ•°ï¼Œä¼šå½±å“ä½¿ç”¨è¯¥å‡½æ•°çš„ä»£ç çš„å¯æµ‹è¯•æ€§ï¼ˆæ— æ³•é‡è½½ï¼‰ã€‚
- ä»£ç å®Œå…¨æ²¡æœ‰æ³¨é‡Šï¼Œç”Ÿæˆç®—æ³•æ¯”è¾ƒéš¾è¯»æ‡‚ï¼Œè€Œä¸”è¿˜æ»¥ç”¨magic numberã€‚å› æ­¤å¯è¯»æ€§å·®



### é‡æ„

æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦è¿›è¡Œé‡æ„äº†ã€‚æ³¨æ„ä¸€å®šè¦åˆ†é˜¶æ®µã€å¾ªåºæ¸è¿›åœ°è¿›è¡Œé‡æ„ã€‚

*   ç¬¬ä¸€è½®é‡æ„ï¼šæé«˜ä»£ç çš„å¯è¯»æ€§
*   ç¬¬äºŒè½®é‡æ„ï¼šæé«˜ä»£ç çš„å¯æµ‹è¯•æ€§
*   ç¬¬ä¸‰è½®é‡æ„ï¼šç¼–å†™å®Œå–„çš„å•å…ƒæµ‹è¯•
*   ç¬¬å››è½®é‡æ„ï¼šæ‰€æœ‰é‡æ„å®Œæˆä¹‹åæ·»åŠ æ³¨é‡Š



#### ç¬¬ä¸€è½®é‡æ„ï¼šæé«˜ä»£ç çš„å¯è¯»æ€§

å¯¹IdGeneratorç±»é‡å‘½åï¼Œå¹¶ä¸”æŠ½è±¡å‡ºå¯¹åº”çš„æ¥å£ã€‚ä¸‹é¢æœ‰ä¸‰ç§ç±»çš„å‘½åæ–¹å¼ï¼š

![](assets/8f0de72351eeb9138c7a3b8199767a6b.jpg)

ç¬¬ä¸€ç§æ–¹å¼æ˜¯ä¸åˆç†çš„ï¼Œå› ä¸ºå®ç°ç±»çš„å‘½åå¤ªè¿‡é€šç”¨äº†ï¼Œé‚£ä¹‹åæ–°çš„å®ç°ç±»å°±ä¸å¥½å–åäº†ã€‚

ç¬¬äºŒç§æ–¹å¼ä¹Ÿæ˜¯ä¸åˆç†çš„ï¼Œå› ä¸ºHostNameMillisIdGeneratorçš„å‘½åæš´éœ²äº†å¤ªå¤šå®ç°ç»†èŠ‚ï¼Œåªè¦ä»£ç ç¨å¾®æœ‰æ‰€æ”¹åŠ¨ï¼Œå°±ä¼šå¯èƒ½éœ€è¦æ”¹åŠ¨å‘½åï¼Œæ¥åŒ¹é…å®ç°ã€‚

ç»¼ä¸Šï¼Œç¬¬ä¸‰ç§æ–¹å¼æ˜¯åˆç†çš„ï¼Œä¸ºæ­¤æˆ‘ä»¬æŠ½è±¡å‡ºä¸¤ä¸ªæ¥å£ï¼Œä¸€ä¸ªæ˜¯IdGeneratorï¼Œä¸€ä¸ªæ˜¯LogTraceIdGeneratorï¼ŒLogTraceIdGeneratorç»§æ‰¿IdGeneratorã€‚å®ç°ç±»å®ç°æ¥å£LogTraceIdGeneratorï¼Œå‘½åä¸ºRandomIdGeneratorã€SequenceIdGeneratorç­‰ã€‚é‡æ„ä¹‹åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~java
public interface IdGenerator {
  String generate();
}

public interface LogTraceIdGenerator extends IdGenerator {}

public class RandomIdGenerator implements LogTraceIdGenerator {
  private static final Logger logger = LoggerFactory.getLogger(RandomIdGenerator.class);

  @Override
  public String generate() {
    String substrOfHostName = getLastfieldOfHostName();
    long currentTimeMillis = System.currentTimeMillis();
    String randomString = generateRandomAlphameric(8);
    String id = String.format("%s-%d-%s",
            substrOfHostName, currentTimeMillis, randomString);
    return id;
  }

  private String getLastfieldOfHostName() {
    String substrOfHostName = null;
    try {
      String hostName = InetAddress.getLocalHost().getHostName();
      substrOfHostName = getLastSubstrSplittedByDot(hostName);
    } catch (UnknownHostException e) {
      logger.warn("Failed to get the host name.", e);
    }
    return substrOfHostName;
  }

  private String getLastSubstrSplittedByDot(String hostName) {
    String[] tokens = hostName.split("\\.");
    String substrOfHostName = tokens[tokens.length - 1];
    return substrOfHostName;
  }
    
  private String generateRandomAlphameric(int length) {
    char[] randomChars = new char[length];
    int count = 0;
    Random random = new Random();
    while (count < length) {
      int maxAscii = 'z';
      int randomAscii = random.nextInt(maxAscii);
      boolean isDigit= randomAscii >= '0' && randomAscii <= '9';
      boolean isUppercase= randomAscii >= 'A' && randomAscii <= 'Z';
      boolean isLowercase= randomAscii >= 'a' && randomAscii <= 'z';
      if (isDigit|| isUppercase || isLowercase) {
        randomChars[count] = (char) (randomAscii);
        ++count;
      }
    }
    return new String(randomChars);
  }
}

//ä»£ç ä½¿ç”¨ä¸¾ä¾‹
LogTraceIdGenerator logTraceIdGenerator = new RandomIdGenerator();
~~~



#### ç¬¬äºŒè½®é‡æ„ï¼šæé«˜ä»£ç çš„å¯æµ‹è¯•æ€§

å…³äºä»£ç å¯æµ‹è¯•æ€§çš„é—®é¢˜ï¼Œä¸»è¦åŒ…å«ä¸‹é¢ä¸¤ä¸ªæ–¹é¢ï¼š

*   generate()å‡½æ•°å®šä¹‰ä¸ºé™æ€å‡½æ•°ï¼Œä¼šå½±å“ä½¿ç”¨è¯¥å‡½æ•°çš„ä»£ç çš„å¯æµ‹è¯•æ€§ï¼›
*   generate()å‡½æ•°çš„ä»£ç å®ç°ä¾èµ–è¿è¡Œç¯å¢ƒï¼ˆæœ¬æœºåï¼‰ã€æ—¶é—´å‡½æ•°ã€éšæœºå‡½æ•°

å¯¹äºç¬¬ä¸€ç‚¹ï¼Œæˆ‘ä»¬å·²ç»åœ¨ç¬¬ä¸€è½®é‡æ„ä¸­è§£å†³äº†ï¼Œå³å°†RandomIdGeneratorç±»ä¸­çš„generate()é™æ€å‡½æ•°ï¼Œé‡æ–°å®šä¹‰æˆäº†æ™®é€šå‡½æ•°ã€‚å¯¹äºç¬¬äºŒç‚¹ï¼Œæˆ‘ä»¬é€šè¿‡é‡è½½çš„æ–¹å¼è¿›è¡Œé‡æ„ï¼š

~~~java
public class RandomIdGenerator implements LogTraceIdGenerator {
  private static final Logger logger = LoggerFactory.getLogger(RandomIdGenerator.class);

  @Override
  public String generate() {
    String substrOfHostName = getLastfieldOfHostName();
    long currentTimeMillis = System.currentTimeMillis();
    String randomString = generateRandomAlphameric(8);
    String id = String.format("%s-%d-%s",
            substrOfHostName, currentTimeMillis, randomString);
    return id;
  }

  private String getLastfieldOfHostName() {
    String substrOfHostName = null;
    try {
      String hostName = InetAddress.getLocalHost().getHostName();
      substrOfHostName = getLastSubstrSplittedByDot(hostName);
    } catch (UnknownHostException e) {
      logger.warn("Failed to get the host name.", e);
    }
    return substrOfHostName;
  }

  @VisibleForTesting
  protected String getLastSubstrSplittedByDot(String hostName) {
    String[] tokens = hostName.split("\\.");
    String substrOfHostName = tokens[tokens.length - 1];
    return substrOfHostName;
  }

  @VisibleForTesting
  protected String generateRandomAlphameric(int length) {
    char[] randomChars = new char[length];
    int count = 0;
    Random random = new Random();
    while (count < length) {
      int maxAscii = 'z';
      int randomAscii = random.nextInt(maxAscii);
      boolean isDigit= randomAscii >= '0' && randomAscii <= '9';
      boolean isUppercase= randomAscii >= 'A' && randomAscii <= 'Z';
      boolean isLowercase= randomAscii >= 'a' && randomAscii <= 'z';
      if (isDigit|| isUppercase || isLowercase) {
        randomChars[count] = (char) (randomAscii);
        ++count;
      }
    }
    return new String(randomChars);
  }
}
~~~

#### ç¬¬ä¸‰è½®é‡æ„ï¼šç¼–å†™å®Œå–„çš„å•å…ƒæµ‹è¯•

ç°åœ¨ï¼Œæˆ‘ä»¬æ¥è¡¥å…¨ä»£ç çš„å•å…ƒæµ‹è¯•ã€‚RandomIdGeneratorç±»ä¸­æœ‰4ä¸ªå‡½æ•°

~~~java
public String generate();

private String getLastfieldOfHostName();

@VisibleForTesting
protected String getLastSubstrSplittedByDot(String hostName);

@VisibleForTesting
protected String generateRandomAlphameric(int length);
~~~

åä¸¤ä¸ªå‡½æ•°åŒ…å«çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæ˜¯æˆ‘ä»¬æµ‹è¯•çš„é‡ç‚¹ï¼š

~~~java
public class RandomIdGeneratorTest {
  @Test
  public void testGetLastSubstrSplittedByDot() {
    RandomIdGenerator idGenerator = new RandomIdGenerator();
    String actualSubstr = idGenerator.getLastSubstrSplittedByDot("field1.field2.field3");
    Assert.assertEquals("field3", actualSubstr);

    actualSubstr = idGenerator.getLastSubstrSplittedByDot("field1");
    Assert.assertEquals("field1", actualSubstr);

    actualSubstr = idGenerator.getLastSubstrSplittedByDot("field1#field2$field3");
    Assert.assertEquals("field1#field2#field3", actualSubstr);
  }

  // æ­¤å•å…ƒæµ‹è¯•ä¼šå¤±è´¥ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä»£ç ä¸­æ²¡æœ‰å¤„ç†hostNameä¸ºnullæˆ–ç©ºå­—ç¬¦ä¸²çš„æƒ…å†µ
  // è¿™éƒ¨åˆ†ä¼˜åŒ–ç•™åœ¨ç¬¬36ã€37èŠ‚è¯¾ä¸­è®²è§£
  @Test
  public void testGetLastSubstrSplittedByDot_nullOrEmpty() {
    RandomIdGenerator idGenerator = new RandomIdGenerator();
    String actualSubstr = idGenerator.getLastSubstrSplittedByDot(null);
    Assert.assertNull(actualSubstr);

    actualSubstr = idGenerator.getLastSubstrSplittedByDot("");
    Assert.assertEquals("", actualSubstr);
  }

  @Test
  public void testGenerateRandomAlphameric() {
    RandomIdGenerator idGenerator = new RandomIdGenerator();
    String actualRandomString = idGenerator.generateRandomAlphameric(6);
    Assert.assertNotNull(actualRandomString);
    Assert.assertEquals(6, actualRandomString.length());
    for (char c : actualRandomString.toCharArray()) {
      Assert.assertTrue(('0' < c && c < '9') || ('a' < c && c < 'z') || ('A' < c && c < 'Z'));
    }
  }

  // æ­¤å•å…ƒæµ‹è¯•ä¼šå¤±è´¥ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä»£ç ä¸­æ²¡æœ‰å¤„ç†length<=0çš„æƒ…å†µ
  // è¿™éƒ¨åˆ†ä¼˜åŒ–ç•™åœ¨ç¬¬36ã€37èŠ‚è¯¾ä¸­è®²è§£
  @Test
  public void testGenerateRandomAlphameric_lengthEqualsOrLessThanZero() {
    RandomIdGenerator idGenerator = new RandomIdGenerator();
    String actualRandomString = idGenerator.generateRandomAlphameric(0);
    Assert.assertEquals("", actualRandomString);

    actualRandomString = idGenerator.generateRandomAlphameric(-1);
    Assert.assertNull(actualRandomString);
  }
}

~~~

#### ç¬¬å››è½®é‡æ„ï¼šæ·»åŠ æ³¨é‡Š

è¿™éƒ¨åˆ†å†…å®¹è¿‡äºç®€å•ï¼Œä¸å†ä»‹ç»

#### ç¬¬äº”è½®é‡æ„ï¼šå¤„ç†å¼‚å¸¸

ä¸»æœºåçš„è·å–å¯èƒ½å¤±è´¥ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡å¼‚å¸¸é€šçŸ¥åˆ°è°ƒç”¨è€…ã€‚

ç°åœ¨çš„å¤„ç†æ–¹å¼æ˜¯å½“ä¸»æœºåè·å–å¤±è´¥çš„æ—¶å€™ï¼ŒgetLastFieldOfHostName()å‡½æ•°è¿”å›nullå€¼ï¼Œå¹¶ä¸”å°†UnknownHostExceptionå¼‚å¸¸åœ¨å‡½æ•°å†…éƒ¨åæ‰ã€‚ä½†æ˜¯æˆ‘ä»¬è§‚å¯Ÿåˆ°UnknownHostExceptionå’ŒgetLastFieldOfHostNameæ˜¯ä¸šåŠ¡ç›¸å…³çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥throwæ‰ï¼Œè€Œä¸æ˜¯åæ‰ï¼š

~~~java
 private String getLastFieldOfHostName() throws UnknownHostException{
    String substrOfHostName = null;
    String hostName = InetAddress.getLocalHost().getHostName();
    substrOfHostName = getLastSubstrSplittedByDot(hostName);
    return substrOfHostName;
 }
~~~

è€Œgenerate()éœ€è¦åŒ…è£…UnknownHostExceptionå¼‚å¸¸ï¼Œç„¶åå†æŠ›å‡ºï¼Œå› ä¸ºï¼š

- è°ƒç”¨è€…åœ¨ä½¿ç”¨generate()å‡½æ•°çš„æ—¶å€™ï¼Œåªéœ€è¦çŸ¥é“å®ƒç”Ÿæˆçš„æ˜¯éšæœºå”¯ä¸€IDï¼Œå¹¶ä¸å…³å¿ƒIDæ˜¯å¦‚ä½•ç”Ÿæˆçš„ã€‚ä¹Ÿå°±è¯´æ˜¯ï¼Œè¿™æ˜¯ä¾èµ–æŠ½è±¡è€Œéå®ç°ç¼–ç¨‹ã€‚å¦‚æœgenerate()å‡½æ•°ç›´æ¥æŠ›å‡ºUnknownHostExceptionå¼‚å¸¸ï¼Œå®é™…ä¸Šæ˜¯æš´éœ²äº†å®ç°ç»†èŠ‚ã€‚
- UnknownHostExceptionå¼‚å¸¸è·Ÿgenerate()å‡½æ•°ï¼Œåœ¨ä¸šåŠ¡æ¦‚å¿µä¸Šæ²¡æœ‰ç›¸å…³æ€§ã€‚

~~~java
  public String generate() throws IdGenerationFailureException {
    String substrOfHostName = null;
    try {
      substrOfHostName = getLastFieldOfHostName();
    } catch (UnknownHostException e) {
      throw new IdGenerationFailureException("host name is empty.");
    }
    long currentTimeMillis = System.currentTimeMillis();
    String randomString = generateRandomAlphameric(8);
    String id = String.format("%s-%d-%s",
            substrOfHostName, currentTimeMillis, randomString);
    return id;
  }
~~~

ä»¿ç…§è¿™ä¸ªæ€è·¯ï¼Œå¯ä»¥é‡æ„generateRandomAlphameric()ã€getLastSubstrSplittedByDot()ï¼Œè®©å®ƒä»¬æ­£ç¡®åœ°è¿›è¡Œå¼‚å¸¸å¤„ç†ã€‚                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  

è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†ID Generatorçš„é‡æ„ğŸ‰ğŸ‰ğŸ‰

## ç¨‹åºå‡ºé”™åº”è¯¥è¿”å›å•¥ï¼Ÿ

å½“æ–¹æ³•å‡ºé”™æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé€šè¿‡è¿”å›å€¼ï¼ˆnullã€é”™è¯¯ç ã€ç©ºå¯¹è±¡ï¼‰æˆ–è€…å¼‚å¸¸ï¼Œæ¥é€šçŸ¥è°ƒç”¨è€…æ–¹æ³•æ‰§è¡Œå¤±è´¥ã€‚

å¯¹äºé€šè¿‡è¿”å›å€¼è·å–é”™è¯¯ä¿¡æ¯çš„æ–¹å¼æ¥è¯´ï¼Œè¦ç¡®ä¿æ­£ç¡®ç»“æœå€¼çš„èŒƒå›´å’Œé”™è¯¯å€¼çš„èŒƒå›´æ˜¯ä¸é‡å çš„ã€‚

æ€»ä¹‹ï¼Œé™¤äº†é”™è¯¯ç çš„å¤„ç†æ–¹å¼ï¼Œå…¶ä»–éƒ½æ˜¯å¯ä»¥æ¥å—çš„ã€‚å¦‚æœé”™è¯¯çš„å«ä¹‰æ˜¯ã€Œä¸å­˜åœ¨ã€çš„è¯ï¼Œé‚£ä¹ˆæ¨èè¿”å›nullæˆ–è€…ç©ºå¯¹è±¡ã€‚å…¶ä½™æƒ…å†µä¸€å¾‹æŠ›å‡ºå¼‚å¸¸ã€‚

### è¿”å›é”™è¯¯ç 

åœ¨ç°ä»£è¯­è¨€ä¸­ï¼ˆC++ã€Javaã€Pythonï¼‰ä¸­ï¼Œä¸æ¨èä½¿ç”¨è¿™ç§æ–¹å¼æ¥è¡¨ç¤ºé”™è¯¯ã€‚

é”™è¯¯ç çš„è¿”å›æ–¹å¼æœ‰ä¸¤ç§ï¼š

- å‡½æ•°çš„è¿”å›å€¼è¡¨ç¤ºé”™è¯¯ç ï¼Œè€Œé€šè¿‡å‚æ•°æ¥è¿”å›ï¼Œå‡½æ•°æ­£å¸¸æ‰§è¡Œçš„ç»“æœå€¼ã€‚

  ~~~java
  //è¿™é‡Œfdè¡¨ç¤ºè¿”å›å€¼
  int open(const char *pathname, int flags, mode_t mode, int* fd) {
    if (/*æ–‡ä»¶ä¸å­˜åœ¨*/) {return EEXIST;}
    
    if (/*æ²¡æœ‰è®¿é—®æƒé™*/) {return EACCESS;}
    
    if (/*æ‰“å¼€æ–‡ä»¶æˆåŠŸ*/) {
      return SUCCESS; //Cè¯­è¨€ä¸­çš„å®å®šä¹‰ï¼š#define SUCCESS 0
    }
    // ...
  }
  
  //ä½¿ç”¨ä¸¾ä¾‹
  int fd;
  int result = open(â€œc:\test.txtâ€, O_RDWR, S_IRWXU|S_IRWXG|S_IRWXO, &fd);
  if (result == SUCCESS) {
    // å–å‡ºfdä½¿ç”¨
  } else if (result == EEXIST) {
    //...
  } else if (result == EACESS) {
    //...
  }
  ~~~

- å°†é”™è¯¯ç å®šä¹‰åœ¨å…¨å±€å˜é‡ä¸­

  ~~~java
  int errno; // çº¿ç¨‹å®‰å…¨çš„å…¨å±€å˜é‡
  int open(const char *pathname, int flags, mode_t modeï¼‰{
    if (/*æ–‡ä»¶ä¸å­˜åœ¨*/) {
      errno = EEXIST;
      return -1;
    }
    
    if (/*æ²¡æœ‰è®¿é—®æƒé™*/) {
      errno = EACCESS;
      return -1;
    }
    
    // ...
  }
           
  // ä½¿ç”¨ä¸¾ä¾‹
  int hFile = open(â€œc:\test.txtâ€, O_RDWR, S_IRWXU|S_IRWXG|S_IRWXO);
  if (-1 == hFile) {
    printf("Failed to open file, error no: %d.\n", errno);
    if (errno == EEXIST ) {
      // ...        
    } else if(errno == EACCESS) {
      // ...    
    }
    // ...
  }
   
  ~~~

### è¿”å›null

`null`ä¸€èˆ¬è¡¨ç¤ºâ€œä¸å­˜åœ¨â€è¿™ç§è¯­ä¹‰ã€‚ä½†æ˜¯ä¸æ¨èä½¿ç”¨è¿™ç§æ–¹å¼æ¥è¡¨ç¤ºå‡ºé”™ï¼Œå› ä¸ºï¼š

- å¦‚æœå¿˜è®°å¯¹å‡½æ•°çš„è¿”å›å€¼åšnullåˆ¤æ–­ï¼Œé‚£ä¹ˆå¯èƒ½æŠ›å‡º**ç©ºæŒ‡é’ˆå¼‚å¸¸**ï¼ˆNull Pointer Exceptionï¼‰
- ä»£ç ä¸­å°±ä¼šå……æ–¥ç€å¤§é‡çš„NULLå€¼åˆ¤æ–­é€»è¾‘ï¼Œä¸€æ–¹é¢å†™èµ·æ¥æ¯”è¾ƒç¹çï¼Œå¦ä¸€æ–¹é¢å®ƒä»¬è·Ÿæ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘è€¦åˆåœ¨ä¸€èµ·ï¼Œä¼šå½±å“ä»£ç çš„å¯è¯»æ€§ã€‚

~~~java
public class UserService {
  private UserRepo userRepo; // ä¾èµ–æ³¨å…¥
  
  public User getUser(String telephone) {
    // å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›null
    return null;
  }
}

// ä½¿ç”¨å‡½æ•°getUser()
User user = userService.getUser("18917718965");
if (user != null) { // åšNULLå€¼åˆ¤æ–­ï¼Œå¦åˆ™æœ‰å¯èƒ½ä¼šæŠ¥NPE
  String email = user.getEmail();
  if (email != null) { // åšNULLå€¼åˆ¤æ–­ï¼Œå¦åˆ™æœ‰å¯èƒ½ä¼šæŠ¥NPE
    String escapedEmail = email.replaceAll("@", "#");
  }
}
~~~

### è¿”å›ç©ºå¯¹è±¡

åº”å¯¹è¿™ä¸ªé—®é¢˜æœ‰ä¸€ä¸ªæ¯”è¾ƒç»å…¸çš„ç­–ç•¥ï¼Œé‚£å°±æ˜¯åº”ç”¨ç©ºå¯¹è±¡è®¾è®¡æ¨¡å¼ï¼ˆNull Object Design Patternï¼‰ã€‚è¿™ä¸ªæ¨¡å¼ç•™åœ¨ä»¥åè®²è§£ã€‚

å½“å‡½æ•°è¿”å›çš„æ•°æ®æ˜¯å­—ç¬¦ä¸²ç±»å‹æˆ–è€…é›†åˆç±»å‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ç©ºå­—ç¬¦ä¸²æˆ–ç©ºé›†åˆæ›¿ä»£NULLå€¼ï¼Œæ¥è¡¨ç¤ºä¸å­˜åœ¨çš„æƒ…å†µï¼Œè¿™æ ·é¿å…äº†nullåˆ¤æ–­ã€‚

~~~java
// ä½¿ç”¨ç©ºé›†åˆæ›¿ä»£NULL
public class UserService {
  private UserRepo userRepo; // ä¾èµ–æ³¨å…¥
  
  public List<User> getUsers(String telephonePrefix) {
   // æ²¡æœ‰æŸ¥æ‰¾åˆ°æ•°æ®
    return Collections.emptyList();
  }
}
// getUsersä½¿ç”¨ç¤ºä¾‹
List<User> users = userService.getUsers("189");
for (User user : users) { //è¿™é‡Œä¸éœ€è¦åšNULLå€¼åˆ¤æ–­
  // ...
}
~~~



~~~java
// ä½¿ç”¨ç©ºå­—ç¬¦ä¸²æ›¿ä»£NULL
public String retrieveUppercaseLetters(String text) {
  // å¦‚æœtextä¸­æ²¡æœ‰å¤§å†™å­—æ¯ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œè€ŒéNULLå€¼
  return "";
}
// retrieveUppercaseLetters()ä½¿ç”¨ä¸¾ä¾‹
String uppercaseLetters = retrieveUppercaseLetters("wangzheng");
int length = uppercaseLetters.length();// ä¸éœ€è¦åšNULLå€¼åˆ¤æ–­ 
System.out.println("Contains " + length + " upper case letters.");
~~~



### æŠ›å‡ºå¼‚å¸¸å¯¹è±¡

Javaæ”¯æŒä¸¤ç§å¼‚å¸¸ç±»å‹ï¼š**è¿è¡Œæ—¶å¼‚å¸¸ï¼ˆRuntime Exceptionï¼‰**å’Œ**ç¼–è¯‘æ—¶å¼‚å¸¸ï¼ˆCompile Exceptionï¼‰**

å®é™…ä¸Šï¼ŒJavaæ”¯æŒçš„ç¼–è¯‘æ—¶å¼‚å¸¸ä¸€ç›´è¢«äººè¯Ÿç—…ã€‚æœ‰ç§è§‚ç‚¹å°±æ˜¯è®¤ä¸ºï¼Œæ‰€æœ‰çš„å¼‚å¸¸æƒ…å†µéƒ½åº”è¯¥ä½¿ç”¨è¿è¡Œæ—¶å¼‚å¸¸ã€‚æ”¯æŒè¿™ç§è§‚ç‚¹çš„ç†ç”±ä¸»è¦æœ‰ï¼š

- è¿åå¼€é—­åŸåˆ™ï¼Œå¦‚æœæˆ‘ä»¬ç»™æŸä¸ªå‡½æ•°æ–°å¢ä¸€ä¸ªç¼–è¯‘æ—¶å¼‚å¸¸ï¼Œè¿™ä¸ªå‡½æ•°æ‰€åœ¨çš„å‡½æ•°è°ƒç”¨é“¾ä¸Šçš„æ‰€æœ‰ä½äºå…¶ä¹‹ä¸Šçš„å‡½æ•°éƒ½éœ€è¦åšç›¸åº”çš„ä»£ç ä¿®æ”¹ï¼Œç›´åˆ°è°ƒç”¨é“¾ä¸­çš„æŸä¸ªå‡½æ•°å°†è¿™ä¸ªæ–°å¢çš„å¼‚å¸¸try-catchå¤„ç†æ‰ä¸ºæ­¢ã€‚è€Œæ–°å¢çš„è¿è¡Œæ—¶å¼‚å¸¸å¯ä»¥ä¸æ”¹åŠ¨è°ƒç”¨é“¾ä¸Šçš„ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥çµæ´»åœ°é€‰æ‹©åœ¨æŸä¸ªå‡½æ•°ä¸­é›†ä¸­å¤„ç†ï¼Œæ¯”å¦‚åœ¨Springä¸­çš„AOPåˆ‡é¢ä¸­é›†ä¸­å¤„ç†å¼‚å¸¸ã€‚
- ç¼–è¯‘å™¨å¼ºåˆ¶æˆ‘ä»¬å¤„ç†å¼‚å¸¸ï¼ˆtry-catchã€throwsï¼‰ï¼Œç¼–å†™å‡ºçš„ä»£ç æ¯”è¾ƒç¹çï¼Œå¯è¯»æ€§ä¸‹é™ã€‚

æ³¨æ„ï¼Œè¿è¡Œæ—¶å¼‚å¸¸çš„çµæ´»æ€§ä¹Ÿæ„å‘³ç€ä¸å¯æ§ï¼Œè¿™å¯èƒ½é€ æˆé—æ¼ä¸€äº›æœ¬åº”è¯¥æ•è·å¤„ç†çš„å¼‚å¸¸ã€‚è‡³äºå¦‚ä½•é€‰æ‹©ï¼Œæˆ‘çš„æ„è§æ˜¯ï¼š

- å¯¹äºä¸å¯æ¢å¤å¼‚å¸¸ï¼Œæˆ‘ä»¬è¦fail-fastï¼Œä¹Ÿå°±æ˜¯è¯´ç›´æ¥æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ï¼Œå°†ç¨‹åºç»ˆæ­¢æ‰ã€‚
- å¯¹äºå¯æ¢å¤å¼‚å¸¸ã€ä¸šåŠ¡å¼‚å¸¸ï¼Œæ¯”å¦‚æç°é‡‘é¢å¤§äºä½™é¢çš„å¼‚å¸¸ï¼Œæˆ‘ä»¬æ›´å€¾å‘äºä½¿ç”¨ç¼–è¯‘æ—¶å¼‚å¸¸



ä¸‹é¢æ˜¯ä¸‰ç§å¸¸ç”¨çš„å¤„ç†å¼‚å¸¸çš„æ–¹æ³•ï¼š

- ç›´æ¥åæ‰ã€‚

  ~~~java
  public void func1() throws Exception1 {// ...}
  
  public void func2() {
    try {
      func1();
    } catch(Exception1 e) {
      log.warn("...", e); //åæ‰ï¼štry-catchæ‰“å°æ—¥å¿—
    }
  }
  ~~~

- åŸå°ä¸åŠ¨åœ°re-throw

  ~~~java
  public void func1() throws Exception1 {// ...}
  
  
  public void func2() throws Exception1 {//åŸå°ä¸åŠ¨çš„re-throw Exception1
    func1();
  }
  ~~~

- åŒ…è£…æˆæ–°çš„å¼‚å¸¸re-throwã€‚æ˜¯å¦éœ€è¦åŒ…è£…æˆæ–°çš„å¼‚å¸¸æŠ›å‡ºï¼Œè¦çœ‹è¯¥å¼‚å¸¸çš„å«ä¹‰å’Œå½“å‰å‡½æ•°çš„åŠŸèƒ½æ˜¯å¦ç›¸å…³ã€‚å¦‚æœç›¸å…³åˆ™ç›´æ¥æŠ›å‡ºï¼Œå¦åˆ™é‡æ–°åŒ…è£…åæŠ›å‡ºã€‚

  ~~~java
  public void func1() throws Exception1 {// ...}
  
  public void func2() throws Exception2 {
    try {
      func1();
    } catch(Exception1 e) {
     throw new Exception2("...", e); // wrapæˆæ–°çš„Exception2ç„¶åre-throw
    }
  }
  ~~~



## æ€§èƒ½è®¡æ•°å™¨

åœ¨[è®¾è®¡åŸåˆ™](è®¾è®¡åŸåˆ™.md)ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»è¿‡æ€§èƒ½è®¡æ•°å™¨é¡¹ç›®ã€‚ç°åœ¨æˆ‘ä»¬å¯¹å®ƒè¿›è¡Œé‡æ„ã€‚

`Aggregator`ç±»çš„é—®é¢˜æ˜¯é‡Œé¢åªæœ‰ä¸€ä¸ªé™æ€å‡½æ•°`aggregate`ï¼Œå®ƒé›†æˆäº†æ‰€æœ‰ç»Ÿè®¡åŠŸèƒ½ã€‚è¿™è¿åäº†èŒè´£å•ä¸€åŸåˆ™ã€‚

`ConsoleReporter`ã€`EmailReporter`çš„é—®é¢˜å¦‚ä¸‹ï¼š

- `ConsoleReporter`å’Œ`EmailReporter`ä¸¤ä¸ªç±»ä¸­å­˜åœ¨ä»£ç é‡å¤é—®é¢˜ã€‚åœ¨è¿™ä¸¤ä¸ªç±»ä¸­ï¼Œä»åšç»Ÿè®¡çš„é€»è¾‘ã€è¯­ä¹‰éƒ½æ˜¯ç›¸åŒçš„ï¼Œè¿™è¿åäº†DRYåŸåˆ™ã€‚
- å®ƒä»¬éƒ½åŒæ—¶è´Ÿè´£è·å–æ•°æ®ã€è®¡ç®—ã€æ˜¾ç¤ºæ•°æ®çš„å·¥ä½œï¼ŒèŒè´£ä¸å¤Ÿå•ä¸€ã€‚
- ä»£ç ä¸­æ¶‰åŠçº¿ç¨‹æ“ä½œï¼Œå¹¶ä¸”è°ƒç”¨äº†`Aggregator`çš„é™æ€å‡½æ•°ï¼Œæ‰€ä»¥ä»£ç çš„å¯æµ‹è¯•æ€§ä¹Ÿæœ‰å¾…æé«˜ã€‚



ä¸ºæ­¤ï¼Œæˆ‘ä»¬é‡æ„ä»£ç å¦‚ä¸‹ï¼šå°†`Reporter`ç±»ä¸­åšç»Ÿè®¡çš„é€»è¾‘æŠ½ç¦»åˆ°`Aggregator`ç±»ä¸­

~~~java
public class Aggregator {
  //å¯¹æ‰€æœ‰apiçš„æ•°æ®åšç»Ÿè®¡
  public Map<String, RequestStat> aggregate(
          Map<String, List<RequestInfo>> requestInfos, long durationInMillis) {
      
    Map<String, RequestStat> requestStats = new HashMap<>();
    for (Map.Entry<String, List<RequestInfo>> entry : requestInfos.entrySet()) {
      String apiName = entry.getKey();
      List<RequestInfo> requestInfosPerApi = entry.getValue();
      RequestStat requestStat = doAggregate(requestInfosPerApi, durationInMillis);
      requestStats.put(apiName, requestStat);
    }
    return requestStats;
  }

  //å¯¹æŸä¸ªapiçš„æ•°æ®åšç»Ÿè®¡
  private RequestStat doAggregate(List<RequestInfo> requestInfos, long durationInMillis) {
    List<Double> respTimes = new ArrayList<>();
    for (RequestInfo requestInfo : requestInfos) {
      double respTime = requestInfo.getResponseTime();
      respTimes.add(respTime);
    }

    RequestStat requestStat = new RequestStat();
    requestStat.setMaxResponseTime(max(respTimes));
    requestStat.setMinResponseTime(min(respTimes));
    requestStat.setAvgResponseTime(avg(respTimes));
    requestStat.setP999ResponseTime(percentile999(respTimes));
    requestStat.setP99ResponseTime(percentile99(respTimes));
    requestStat.setCount(respTimes.size());
    requestStat.setTps((long) tps(respTimes.size(), durationInMillis/1000));
    return requestStat;
  }

  // ä»¥ä¸‹çš„å‡½æ•°çš„ä»£ç å®ç°å‡çœç•¥...
  private double max(List<Double> dataset) {}
  private double min(List<Double> dataset) {}
  private double avg(List<Double> dataset) {}
  private double tps(int count, double duration) {}
  private double percentile999(List<Double> dataset) {}
  private double percentile99(List<Double> dataset) {}
  private double percentile(List<Double> dataset, double ratio) {}
}
~~~

æˆ‘ä»¬æŠŠã€Œç»Ÿè®¡æ•°æ®æ˜¾ç¤ºåˆ°ç»ˆç«¯ã€è¿™éƒ¨åˆ†é€»è¾‘å‰¥ç¦»å‡ºæ¥ï¼Œè®¾è®¡æˆä¸¤ä¸ªç±»ï¼šConsoleViewerç±»å’ŒEmailViewerç±»ï¼š

~~~java
public interface StatViewer {
  void output(Map<String, RequestStat> requestStats, long startTimeInMillis, long endTimeInMills);
}

public class ConsoleViewer implements StatViewer {
  public void output(
          Map<String, RequestStat> requestStats, long startTimeInMillis, long endTimeInMills) {
    System.out.println("Time Span: [" + startTimeInMillis + ", " + endTimeInMills + "]");
    Gson gson = new Gson();
    System.out.println(gson.toJson(requestStats));
  }
}

public class EmailViewer implements StatViewer {
  private EmailSender emailSender;
  private List<String> toAddresses = new ArrayList<>();

  public EmailViewer() {
    this.emailSender = new EmailSender(/*çœç•¥å‚æ•°*/);
  }

  public EmailViewer(EmailSender emailSender) {
    this.emailSender = emailSender;
  }

  public void addToAddress(String address) {
    toAddresses.add(address);
  }

  public void output(
          Map<String, RequestStat> requestStats, long startTimeInMillis, long endTimeInMills) {
    // format the requestStats to HTML style.
    // send it to email toAddresses.
  }
}
~~~

ç»„è£…ç±»ï¼ˆConsoleReporter ã€EmailReporterï¼‰åªè´Ÿè´£ç»„è£…å„ä¸ªç±»ï¼ˆMetricsStorageã€Aggegratorã€StatViewerï¼‰æ¥å®Œæˆæ•´ä¸ªå·¥ä½œæµç¨‹ï¼š

~~~java
public class ConsoleReporter {
  private MetricsStorage metricsStorage;
  private Aggregator aggregator;
  private StatViewer viewer;
  private ScheduledExecutorService executor;

  public ConsoleReporter(MetricsStorage metricsStorage, Aggregator aggregator, StatViewer viewer) {
    this.metricsStorage = metricsStorage;
    this.aggregator = aggregator;
    this.viewer = viewer;
    this.executor = Executors.newSingleThreadScheduledExecutor();
  }

  public void startRepeatedReport(long periodInSeconds, long durationInSeconds) {
    executor.scheduleAtFixedRate(new Runnable() {
      @Override
      public void run() {
        long durationInMillis = durationInSeconds * 1000;
        long endTimeInMillis = System.currentTimeMillis();
        long startTimeInMillis = endTimeInMillis - durationInMillis;
        Map<String, List<RequestInfo>> requestInfos =
                metricsStorage.getRequestInfos(startTimeInMillis, endTimeInMillis);
        //åŸæœ¬åšç»Ÿè®¡çš„å·¥ä½œæŠ½ç¦»åˆ°aggregator.aggregate()
        Map<String, RequestStat> requestStats = aggregator.aggregate(requestInfos, durationInMillis);
        //è¾“å‡ºé€»è¾‘æŠ½ç¦»åˆ°viewer
        viewer.output(requestStats, startTimeInMillis, endTimeInMillis);
      }
    }, 0L, periodInSeconds, TimeUnit.SECONDS);
  }

}

public class EmailReporter {
  private static final Long DAY_HOURS_IN_SECONDS = 86400L;

  private MetricsStorage metricsStorage;
  private Aggregator aggregator;
  private StatViewer viewer;

  public EmailReporter(MetricsStorage metricsStorage, Aggregator aggregator, StatViewer viewer) {
    this.metricsStorage = metricsStorage;
    this.aggregator = aggregator;
    this.viewer = viewer;
  }

  public void startDailyReport() {
    Calendar calendar = Calendar.getInstance();
    calendar.add(Calendar.DATE, 1);
    calendar.set(Calendar.HOUR_OF_DAY, 0);
    calendar.set(Calendar.MINUTE, 0);
    calendar.set(Calendar.SECOND, 0);
    calendar.set(Calendar.MILLISECOND, 0);
    Date firstTime = calendar.getTime();
    Timer timer = new Timer();
    timer.schedule(new TimerTask() {
      @Override
      public void run() {
        long durationInMillis = DAY_HOURS_IN_SECONDS * 1000;
        long endTimeInMillis = System.currentTimeMillis();
        long startTimeInMillis = endTimeInMillis - durationInMillis;
        Map<String, List<RequestInfo>> requestInfos =
                metricsStorage.getRequestInfos(startTimeInMillis, endTimeInMillis);
        Map<String, RequestStat> stats = aggregator.aggregate(requestInfos, durationInMillis);
        viewer.output(stats, startTimeInMillis, endTimeInMillis);
      }
    }, firstTime, DAY_HOURS_IN_SECONDS * 1000);
  }
} 
~~~

ç»è¿‡ä¸Šé¢çš„é‡æ„ä¹‹åï¼Œæˆ‘ä»¬ç°åœ¨å†æ¥çœ‹ä¸€ä¸‹ï¼Œç°åœ¨æ¡†æ¶è¯¥å¦‚ä½•æ¥ä½¿ç”¨ã€‚

~~~java
public class PerfCounterTest {
  public static void main(String[] args) {
    MetricsStorage storage = new RedisMetricsStorage();
    Aggregator aggregator = new Aggregator();

    // å®šæ—¶è§¦å‘ç»Ÿè®¡å¹¶å°†ç»“æœæ˜¾ç¤ºåˆ°ç»ˆç«¯
    ConsoleViewer consoleViewer = new ConsoleViewer();
    ConsoleReporter consoleReporter = new ConsoleReporter(storage, aggregator, consoleViewer);
    consoleReporter.startRepeatedReport(60, 60);

    // å®šæ—¶è§¦å‘ç»Ÿè®¡å¹¶å°†ç»“æœè¾“å‡ºåˆ°é‚®ä»¶
    EmailViewer emailViewer = new EmailViewer();
    emailViewer.addToAddress("wangzheng@xzg.com");
    EmailReporter emailReporter = new EmailReporter(storage, aggregator, emailViewer);
    emailReporter.startDailyReport();

    // æ”¶é›†æ¥å£è®¿é—®æ•°æ®
    MetricsCollector collector = new MetricsCollector(storage);
    collector.recordRequest(new RequestInfo("register", 123, 10234));
    collector.recordRequest(new RequestInfo("register", 223, 11234));
    collector.recordRequest(new RequestInfo("register", 323, 12334));
    collector.recordRequest(new RequestInfo("login", 23, 12434));
    collector.recordRequest(new RequestInfo("login", 1223, 14234));

    try {
      Thread.sleep(100000);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
  }
}

~~~



MetricsStorageã€Aggregatorã€StatViewerä¸‰ä¸ªç±»çš„è®¾è®¡ä¹Ÿç¬¦åˆè¿ªç±³ç‰¹æ³•åˆ™ã€‚å®ƒä»¬åªä¸è·Ÿè‡ªå·±æœ‰ç›´æ¥ç›¸å…³çš„æ•°æ®è¿›è¡Œäº¤äº’ã€‚

![](assets/1303d16f75c7266cef9105f540c54834.jpg)



ç»è¿‡ä¸Šä¸€æ¬¡é‡æ„ä¼˜åŒ–åï¼Œä»£ç ç»“æ„æ›´åŠ æ¸…æ™°ã€‚ä½†æ˜¯åœ¨ç»†èŠ‚æ–¹é¢è¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ConsoleReporterã€EmailReporterç±»ä»ç„¶å­˜åœ¨ä»£ç é‡å¤ã€å¯æµ‹è¯•æ€§å·®çš„é—®é¢˜ã€‚



æˆ‘ä»¬å¯ä»¥å°†ConsoleReporterå’ŒEmailReporterä¸­çš„ç›¸åŒä»£ç é€»è¾‘ï¼Œæå–åˆ°çˆ¶ç±»ScheduledReporterä¸­ï¼Œä»¥è§£å†³ä»£ç é‡å¤é—®é¢˜ã€‚è¿™æ ·åšçš„å‰ææ˜¯ConsoleReporterå’ŒEmailReporteræ˜¯ç¬¦åˆç»§æ‰¿è¯­ä¹‰çš„ï¼Œå¦åˆ™åº”è¯¥æå–åˆ°ä¸€ä¸ªé™æ€ç±»ä¸­çš„ã€‚

~~~java
public abstract class ScheduledReporter {
  protected MetricsStorage metricsStorage;
  protected Aggregator aggregator;
  protected StatViewer viewer;

  public ScheduledReporter(MetricsStorage metricsStorage, Aggregator aggregator, StatViewer viewer) {
    this.metricsStorage = metricsStorage;
    this.aggregator = aggregator;
    this.viewer = viewer;
  }

  protected void doStatAndReport(long startTimeInMillis, long endTimeInMillis) {
    long durationInMillis = endTimeInMillis -  startTimeInMillis;
    Map<String, List<RequestInfo>> requestInfos =
            metricsStorage.getRequestInfos(startTimeInMillis, endTimeInMillis);
    Map<String, RequestStat> requestStats = aggregator.aggregate(requestInfos, durationInMillis);
    viewer.output(requestStats, startTimeInMillis, endTimeInMillis);
  }

}
~~~

å°†é‡å¤ä»£ç æå–åˆ°çˆ¶ç±»ScheduledReporterä¹‹åï¼ŒEmailReporterä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~java
public class EmailReporter extends ScheduledReporter {
  private static final Long DAY_HOURS_IN_SECONDS = 86400L;

  private MetricsStorage metricsStorage;
  private Aggregator aggregator;
  private StatViewer viewer;

  public EmailReporter(MetricsStorage metricsStorage, Aggregator aggregator, StatViewer viewer) {
    this.metricsStorage = metricsStorage;
    this.aggregator = aggregator;
    this.viewer = viewer;
  }

  public void startDailyReport() {
    Calendar calendar = Calendar.getInstance();
    calendar.add(Calendar.DATE, 1);
    calendar.set(Calendar.HOUR_OF_DAY, 0);
    calendar.set(Calendar.MINUTE, 0);
    calendar.set(Calendar.SECOND, 0);
    calendar.set(Calendar.MILLISECOND, 0);
    Date firstTime = calendar.getTime();

    Timer timer = new Timer();
    timer.schedule(new TimerTask() {
      @Override
      public void run() {
        long durationInMillis = DAY_HOURS_IN_SECONDS * 1000;
        long endTimeInMillis = System.currentTimeMillis();
        long startTimeInMillis = endTimeInMillis - durationInMillis;
        doStatAndReport(startTimeInMillis, endTimeInMillis);
      }
    }, firstTime, DAY_HOURS_IN_SECONDS * 1000);
  }
}
~~~

EmailReporterå¯æµ‹è¯•æ€§ä¸å¥½ï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºç”¨åˆ°äº†çº¿ç¨‹ï¼Œå¦ä¸€æ–¹é¢æ˜¯å› ä¸ºæ¶‰åŠæ—¶é—´çš„è®¡ç®—é€»è¾‘ã€‚æ­¤æ—¶startDailyReport()ä¸­æ¯”è¾ƒå¤æ‚çš„éƒ¨åˆ†å°±æ˜¯è®¡ç®—firstTimeçš„é‚£éƒ¨åˆ†ä»£ç ã€‚æˆ‘ä»¬å°†è¿™éƒ¨åˆ†ä»£ç ç»§ç»­æŠ½ç¦»å‡ºæ¥ï¼Œå°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œç„¶åï¼Œå•ç‹¬é’ˆå¯¹è¿™ä¸ªå‡½æ•°å†™å•å…ƒæµ‹è¯•ã€‚é‡æ„ä¹‹åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~java
public class EmailReporter extends ScheduledReporter {
  // çœç•¥å…¶ä»–ä»£ç ...
  public void startDailyReport() {
    Date firstTime = trimTimeFieldsToZeroOfNextDay();
    Timer timer = new Timer();
    timer.schedule(new TimerTask() {
      @Override
      public void run() {
        // çœç•¥å…¶ä»–ä»£ç ...
      }
    }, firstTime, DAY_HOURS_IN_SECONDS * 1000);
  }

  // è®¾ç½®æˆprotectedè€Œéprivateæ˜¯ä¸ºäº†æ–¹ä¾¿å†™å•å…ƒæµ‹è¯•
  @VisibleForTesting
  protected Date trimTimeFieldsToZeroOfNextDay() {
    Calendar calendar = Calendar.getInstance(); // è¿™é‡Œå¯ä»¥è·å–å½“å‰æ—¶é—´
    calendar.add(Calendar.DATE, 1);
    calendar.set(Calendar.HOUR_OF_DAY, 0);
    calendar.set(Calendar.MINUTE, 0);
    calendar.set(Calendar.SECOND, 0);
    calendar.set(Calendar.MILLISECOND, 0);
    return calendar.getTime();
  }
}
~~~

è¿™ä¸ªtrimTimeFieldsToZeroOfNextDay()çš„å¯æµ‹è¯•æ€§ä»ç„¶ä¸å¥½ï¼Œå› ä¸ºå®ƒå¼ºä¾èµ–å½“å‰çš„ç³»ç»Ÿæ—¶é—´ã€‚ä¸€èˆ¬çš„è§£å†³æ–¹æ³•æ˜¯ï¼Œå°†å¼ºä¾èµ–çš„éƒ¨åˆ†é€šè¿‡å‚æ•°ä¼ é€’è¿›æ¥ï¼Œç±»ä¼¼äºä¾èµ–æ³¨å…¥ã€‚æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬å†å¯¹trimTimeFieldsToZeroOfNextDay()å‡½æ•°è¿›è¡Œé‡æ„ï¼š

~~~java
public class EmailReporter extends ScheduledReporter {
  // çœç•¥å…¶ä»–ä»£ç ...
  public void startDailyReport() {
    // new Date()å¯ä»¥è·å–å½“å‰æ—¶é—´
    Date firstTime = trimTimeFieldsToZeroOfNextDay(new Date());
    Timer timer = new Timer();
    timer.schedule(new TimerTask() {
      @Override
      public void run() {
        // çœç•¥å…¶ä»–ä»£ç ...
      }
    }, firstTime, DAY_HOURS_IN_SECONDS * 1000);
  }

  protected Date trimTimeFieldsToZeroOfNextDay(Date date) {
    Calendar calendar = Calendar.getInstance(); // è¿™é‡Œå¯ä»¥è·å–å½“å‰æ—¶é—´
    calendar.setTime(date); // é‡æ–°è®¾ç½®æ—¶é—´
    calendar.add(Calendar.DATE, 1);
    calendar.set(Calendar.HOUR_OF_DAY, 0);
    calendar.set(Calendar.MINUTE, 0);
    calendar.set(Calendar.SECOND, 0);
    calendar.set(Calendar.MILLISECOND, 0);
    return calendar.getTime();
  }
}
~~~

ä¸è¿‡ï¼ŒEmailReporterç±»ä¸­startDailyReport()è¿˜æ˜¯æ¶‰åŠå¤šçº¿ç¨‹ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬æ— éœ€ç»§ç»­ç¼–å†™å•å…ƒæµ‹è¯•äº†ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿæˆ‘ä»¬è¦å›åˆ°å†™å•å…ƒæµ‹è¯•çš„åˆè¡·â€”â€”æé«˜ä»£ç è´¨é‡ï¼Œå‡å°‘bugã€‚å¦‚æœä»£ç è¶³å¤Ÿç®€å•ï¼Œç®€å•åˆ°bugæ— å¤„éšè—ï¼Œé‚£æˆ‘ä»¬å°±æ²¡å¿…è¦ä¸ºäº†å†™å•å…ƒæµ‹è¯•è€Œå†™å•å…ƒæµ‹è¯•äº†ï¼



æˆ‘ä»¬ç»§ç»­å®Œå–„æ¡†æ¶çš„éåŠŸèƒ½æ€§éœ€æ±‚ã€‚é¦–å…ˆæ¥çœ‹çœ‹æ˜“ç”¨æ€§ï¼š

~~~java
MetricsStorage storage = new RedisMetricsStorage();
Aggregator aggregator = new Aggregator();

// å®šæ—¶è§¦å‘ç»Ÿè®¡å¹¶å°†ç»“æœæ˜¾ç¤ºåˆ°ç»ˆç«¯
ConsoleViewer consoleViewer = new ConsoleViewer();
ConsoleReporter consoleReporter = new ConsoleReporter(storage, aggregator, consoleViewer);
consoleReporter.startRepeatedReport(60, 60);

// å®šæ—¶è§¦å‘ç»Ÿè®¡å¹¶å°†ç»“æœè¾“å‡ºåˆ°é‚®ä»¶
EmailViewer emailViewer = new EmailViewer();
emailViewer.addToAddress("wangzheng@xzg.com");
EmailReporter emailReporter = new EmailReporter(storage, aggregator, emailViewer);
emailReporter.startDailyReport();
~~~

æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ¡†æ¶ç”¨èµ·æ¥è¿˜æ˜¯ç¨å¾®æœ‰äº›å¤æ‚çš„ï¼Œéœ€è¦ç»„è£…å„ç§ç±»ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¯èƒ½å­˜åœ¨è¯¯ç”¨çš„æƒ…å†µï¼Œæ¯”å¦‚æŠŠEmailViewerä¼ é€’è¿›äº†ConsoleReporterä¸­ã€‚æ€»ä½“ä¸Šæ¥è®²ï¼Œæ¡†æ¶çš„ä½¿ç”¨æ–¹å¼æš´éœ²äº†å¤ªå¤šç»†èŠ‚ç»™ç”¨æˆ·ï¼Œè¿‡äºçµæ´»ä¹Ÿå¸¦æ¥äº†æ˜“ç”¨æ€§çš„é™ä½ã€‚

æˆ‘ä»¬å¯ä»¥æä¾›é¢å¤–çš„æ„é€ å‡½æ•°ï¼Œè®©ç”¨æˆ·åœ¨çµæ´»æ€§ä¸æ˜“ç”¨æ€§ä¹‹é—´è‡ªä¸»åšå‡ºé€‰æ‹©ï¼š

~~~java
public class MetricsCollector {
  private MetricsStorage metricsStorage;

  // å…¼é¡¾ä»£ç çš„æ˜“ç”¨æ€§ï¼Œæ–°å¢ä¸€ä¸ªå°è£…äº†é»˜è®¤ä¾èµ–çš„æ„é€ å‡½æ•°
  public MetricsCollectorB() {
    this(new RedisMetricsStorage());
  }

  // å…¼é¡¾çµæ´»æ€§å’Œä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œè¿™ä¸ªæ„é€ å‡½æ•°ç»§ç»­ä¿ç•™
  public MetricsCollectorB(MetricsStorage metricsStorage) {
    this.metricsStorage = metricsStorage;
  }
  // çœç•¥å…¶ä»–ä»£ç ...
}

public class ConsoleReporter extends ScheduledReporter {
  private ScheduledExecutorService executor;
  
  // å…¼é¡¾ä»£ç çš„æ˜“ç”¨æ€§ï¼Œæ–°å¢ä¸€ä¸ªå°è£…äº†é»˜è®¤ä¾èµ–çš„æ„é€ å‡½æ•°
  public ConsoleReporter() {
    this(new RedisMetricsStorage(), new Aggregator(), new ConsoleViewer());
  }

  // å…¼é¡¾çµæ´»æ€§å’Œä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œè¿™ä¸ªæ„é€ å‡½æ•°ç»§ç»­ä¿ç•™
  public ConsoleReporter(MetricsStorage metricsStorage, Aggregator aggregator, StatViewer viewer) {
    super(metricsStorage, aggregator, viewer);
    this.executor = Executors.newSingleThreadScheduledExecutor();
  }
  // çœç•¥å…¶ä»–ä»£ç ...
}

public class EmailReporter extends ScheduledReporter {
  private static final Long DAY_HOURS_IN_SECONDS = 86400L;

  // å…¼é¡¾ä»£ç çš„æ˜“ç”¨æ€§ï¼Œæ–°å¢ä¸€ä¸ªå°è£…äº†é»˜è®¤ä¾èµ–çš„æ„é€ å‡½æ•°
  public EmailReporter(List<String> emailToAddresses) {
    this(new RedisMetricsStorage(), new Aggregator(), new EmailViewer(emailToAddresses));
  }
  
  // å…¼é¡¾çµæ´»æ€§å’Œä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œè¿™ä¸ªæ„é€ å‡½æ•°ç»§ç»­ä¿ç•™
  public EmailReporter(MetricsStorage metricsStorage, Aggregator aggregator, StatViewer viewer) {
    super(metricsStorage, aggregator, viewer);
  }
  // çœç•¥å…¶ä»–ä»£ç ...
}
~~~

ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹æ¡†æ¶å¦‚ä½•æ¥ä½¿ç”¨ï¼š

~~~java
ConsoleReporter consoleReporter = new ConsoleReporter();
consoleReporter.startRepeatedReport(60, 60);

List<String> emailToAddresses = new ArrayList<>();
emailToAddresses.add("wangzheng@xzg.com");
EmailReporter emailReporter = new EmailReporter(emailToAddresses);
emailReporter.startDailyReport();
~~~

æ˜¯ä¸æ˜¯ç®€å•å¤šäº†ã€‚ç„¶è€Œè¿™è¿˜æ˜¯æœ‰ç‚¹å°ç¼ºé™·çš„ï¼ŒRedisMeticsStorageå’ŒEmailViewerè¿˜éœ€è¦å¦å¤–ä¸€äº›é…ç½®ä¿¡æ¯æ‰èƒ½æ„å»ºæˆåŠŸï¼ˆä¾‹å¦‚Redisçš„åœ°å€ï¼ŒEmailé‚®ç®±çš„POP3åœ°å€ï¼‰ã€‚

æˆ‘ä»¬å¯ä»¥å°†è¿™äº›é…ç½®ä¿¡æ¯æ”¾åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œåœ¨æ¡†æ¶å¯åŠ¨çš„æ—¶å€™ï¼Œè¯»å–é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯åˆ°ä¸€ä¸ªConfigurationå•ä¾‹ç±»ã€‚RedisMetricsStorageç±»å’ŒEmailViewerç±»éƒ½å¯ä»¥ä»è¿™ä¸ªConfigurationç±»ä¸­è·å–éœ€è¦çš„é…ç½®ä¿¡æ¯æ¥æ„å»ºè‡ªå·±ã€‚ï¼ˆæœ‰ç‚¹Springæ¡†æ¶çš„å‘³é“äº†ğŸ˜ï¼‰



åŒæ—¶å¯¹äºéœ€è¦é›†æˆåˆ°ä¸šåŠ¡ç³»ç»Ÿçš„æ¡†æ¶æ¥è¯´ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æ¡†æ¶æœ¬èº«ä»£ç çš„æ‰§è¡Œæ•ˆç‡ï¼Œå¯¹ä¸šåŠ¡ç³»ç»Ÿæœ‰å¤ªå¤šæ€§èƒ½ä¸Šçš„å½±å“ã€‚å¯¹äºé«˜æ€§èƒ½è®¡æ•°å™¨è¿™ä¸ªæ¡†æ¶æ¥è¯´ï¼Œä¸€æ–¹é¢ï¼Œå¸Œæœ›å®ƒæ˜¯ä½å»¶è¿Ÿçš„ï¼ˆå°½é‡é™ä½å¯¹æ¥å£å“åº”æ—¶é—´çš„å½±å“ï¼‰ï¼›å¦ä¸€æ–¹é¢ï¼Œå¸Œæœ›å®ƒå¯¹å†…å­˜çš„è´Ÿæ‹…å½±å“å°ã€‚è¿™äº›æ›´å¤šæ¶‰åŠåˆ°ç®—æ³•ï¼Œè€Œä¸æ˜¯è®¾è®¡æ¨¡å¼ã€‚æ‰€ä»¥å°±ç®€å•ä»‹ç»ä¸€äº›ä½å»¶è¿Ÿçš„éƒ¨åˆ†ã€‚

æˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„å­˜å‚¨æ˜¯åŸºäºå¤–éƒ¨çš„ï¼ˆæ¯”å¦‚`Redis`ï¼‰ï¼Œä¼šæ¯”è¾ƒæ…¢ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨`MetricsCollector`ä¸­å¼•å…¥`Google Guava EventBus`å¼‚æ­¥å­˜å‚¨æ¥è§£å†³ï¼Œå³å…ˆå°†é‡‡é›†çš„æ•°æ®æ”¾å…¥å†…å­˜å…±äº«é˜Ÿåˆ—ä¸­ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¯»å–å…±äº«é˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œå†™å…¥åˆ°å¤–éƒ¨å­˜å‚¨ï¼ˆæ¯”å¦‚Redisï¼‰ä¸­ï¼š

~~~java
public class MetricsCollector {
  private static final int DEFAULT_STORAGE_THREAD_POOL_SIZE = 20;

  private MetricsStorage metricsStorage;
  private EventBus eventBus;

  public MetricsCollector(MetricsStorage metricsStorage) {
    this(metricsStorage, DEFAULT_STORAGE_THREAD_POOL_SIZE);
  }

  public MetricsCollector(MetricsStorage metricsStorage, int threadNumToSaveData) {
    this.metricsStorage = metricsStorage;
    this.eventBus = new AsyncEventBus(Executors.newFixedThreadPool(threadNumToSaveData));
    this.eventBus.register(new EventListener());
  }

  public void recordRequest(RequestInfo requestInfo) {
    if (requestInfo == null || StringUtils.isBlank(requestInfo.getApiName())) {
      return;
    }
    eventBus.post(requestInfo);
  }
}


public class EventListener {
    @Subscribe
    public void saveRequestInfo(RequestInfo requestInfo) {
      metricsStorage.saveRequestInfo(requestInfo);
    }
  }
}
~~~

